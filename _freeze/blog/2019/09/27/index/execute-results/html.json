{
  "hash": "f54e054186490b761c0af7684ddbc037",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Predicting t-shirt size from height and weight'\ndate: 2019-09-27\ndescription: \"Using body measurement data from the National Health and Nutrition Examination Survey (NHANES), I created a model that predicts Gildan t-shirt sizes from height and weight.\"\nimage: gildan_unisex_size_chart.png\ntwitter-card:\n  image: \"gildan_unisex_size_chart.png\"\nopen-graph:\n  image: \"gildan_unisex_size_chart.png\"\ncategories:\n  - machine-learning\n  - R\nfreeze: true\n---\n\n\n\nToday I was given a task that sounded pretty straight-forward: What t-shirt size would you send to someone if you don't know their shirt size, but instead you know their height, weight, and gender? \n\nIn fact, it seemed *so straight-forward* that I was sure there must be prior art out there that I could re-use. A StackOverflow, a mathematical formula, a GitHub repo, a blog post -- there had to be something! To my surprise, there wasn't any, not that I could find anyway. \n\nI guess this is a problem that hasn't received a lot of attention. Or at least, it's not the sort of problem that someone in the open source / open science community has tackled.\n\nSo I set out to build my own predictive algorithm. \n\n# The model and the data\n\nFirst I would need to model the problem and identify data to build the model. What are the inputs and the outputs? How do the inputs map onto the outputs?\n\nI knew that the only information I'd have to predict shirt sizes from was: gender, height and weight. Sometimes I'd have body mass index (BMI) instead of height and weight.\n\nI also knew that I'd be sending \"unisex\" t-shirts. I've done my share of online t-shirt shopping, so it occurred to me to look at how online clothing stores solve this problem -- enter the \"size chart\". Okay, so now I'd found a measurement that could be used to classify shirt sizes: **chest size**.\n\n![](gildan_unisex_size_chart.png)\n\nSo now I just had to find a way to get from gender, height, and weight to chest size.\n\nI know from experience that there are several large public datasets that contain health and health-related measurements. One of these is the [The National Health and Nutrition Examination Survey (NHANES)](https://www.cdc.gov/nchs/nhanes), which is run by the CDC. I decided to poke around there and see what I could find. I found the [variable search tool](https://wwwn.cdc.gov/nchs/nhanes/Search/default.aspx) and started keying in some of these variables: \"height\", \"weight\", \"chest\", \"bmi\", \"gender\".\n\nOf course they would have gender, height, weight and BMI. It would be a pretty odd health and nutrition study if they didn't have basic demographics and measurements. But chest measurement? The context seemed a bit odd. What does chest circumference have to do with health and nutrition?\n\nMaybe chest circumference is important if we're talking about breathing? Eureka! NHANES does have chest measurements for inhalation and exhalation as part of the arthritis datasets!\n\nThe final piece of the puzzle was identifying a single year cohort that contained all of these measures together, because I would want the data to be at the level of individual persons. I found all of these measurements were contained in the [2009-2010 cohort](https://wwwn.cdc.gov/nchs/nhanes/Search/DataPage.aspx?Component=Examination&CycleBeginYear=2009), so I downloaded the dataset files for that cohort.\n\n![](nhanes_chest.png)\n\nNow my model was complete. I would run a linear regression that predicts chest circumference from gender, height and weight (or bmi). I would train this model on the NHANES data, and I would then use the predicted chest circumference to determine shirt size.\n\n# Data wrangling\n\n## Read in the data\n\nOf course the data had to be in a SAS format. ðŸ™„\n\nLuckily there's an R package for reading SAS data files.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(foreign)\nlibrary(tidyverse)\nlibrary(MASS)\n\na <- read.xport(\"ARX_F.XPT\") # Arthritis data\nb <- read.xport(\"BMX_F.XPT\") # Body measurements\nd <- read.xport(\"DEMO_F.XPT\") # Demographics\n```\n:::\n\n\n\nThese are the variables I'll pull out from the different dataframes.\n\n- SEQN - Participant ID\n- ARXCCIN - Inhale chest circumference in CM\n- BMXWT - Weight in KG\n- BMXHT - Height in CM\n- BMXBMI - Body Mass Index (BMI)\n- DMDHRGND - Gender of participant (1 = Male, 2 = Female)\n\nI'm using the inhale chest circumference because I found in some exploratory analyses (not reported here) that it has a stronger correlation to the other measurements. I guess the exhale circumference was more noisy for some reason?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\na %>% dplyr::select(id = SEQN, chest_in_cm = ARXCCIN) -> chest_measures\nb %>% dplyr::select(id = SEQN, weight_kg = BMXWT, height_cm = BMXHT, bmi = BMXBMI) -> height_weight\nd %>% dplyr::select(id = SEQN, gender = DMDHRGND) %>%\n  mutate(gender = case_when(gender == 1 ~ \"M\", TRUE ~ \"F\")) -> gender\n\n# Join datasets and select only the rows that have all measurements\nchest_measures %>%\n  left_join(., height_weight, by = c('id')) %>%\n  left_join(., gender, by = c('id')) %>%\n  filter(!is.na(chest_in_cm),\n         !is.na(height_cm), \n         !is.na(weight_kg),\n         !is.na(gender), \n         !is.na(bmi)) -> df\n```\n:::\n\n\n\n# Correlations\n\nI'll check some basic correlations and descriptives. I see that men have larger chests than women, on average. And importantly, BMI does not correlate with chest size as well as weight.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncor(df$weight_kg, df$chest_in_cm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.9006851\n```\n\n\n:::\n\n```{.r .cell-code}\ncor(df$height_cm, df$chest_in_cm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.4174028\n```\n\n\n:::\n\n```{.r .cell-code}\ncor(df$bmi, df$chest_in_cm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.7850526\n```\n\n\n:::\n\n```{.r .cell-code}\ndf %>%\n  group_by(gender) %>%\n  summarize(mean = mean(chest_in_cm))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 Ã— 2\n  gender  mean\n  <chr>  <dbl>\n1 F       95.1\n2 M       98.0\n```\n\n\n:::\n:::\n\n\n\n# Model building\n\nI decided to build two models because sometimes I know a person's height and weight but not their BMI, and other times I know their BMI but not their height and weight. \n\nAlthough I could take all of the heights and weights and convert them into BMIs, I'm guessing this could lead a loss of information. The correlation above suggests that weight is the best predictor of chest size (better than BMI), so that tells me it might be better to use height and weight when it's available, but use BMI as a fallback when height and weight are not available.\n\n## Height and weight model\n\nTo build a model, I'll run a stepwise linear regression to determine the model of best fit. I'll enter height, weight, and gender as predictors and allow interaction terms. I'll use AIC (Akaike's Information Criterion) for model selection, since it penalizes models with added complexity and I want a parsimonious model that doesn't overfit the data. \n\nI see that the best model includes all terms, including `weight*height` and `weight*gender` interaction terms.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm(data = subset(df, select= c(chest_in_cm, height_cm, weight_kg, gender)), \n   chest_in_cm ~ .) -> mod\nstep.model <- stepAIC(mod, direction = \"both\", trace = TRUE, scope = . ~ .^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStart:  AIC=14857.43\nchest_in_cm ~ height_cm + weight_kg + gender\n\n                      Df Sum of Sq    RSS   AIC\n+ height_cm:weight_kg  1       220 115291 14851\n- height_cm            1         2 115513 14856\n+ weight_kg:gender     1        89 115421 14856\n<none>                             115510 14857\n+ height_cm:gender     1         7 115503 14859\n- gender               1      2052 117563 14937\n- weight_kg            1    397116 512627 21725\n\nStep:  AIC=14850.64\nchest_in_cm ~ height_cm + weight_kg + gender + height_cm:weight_kg\n\n                      Df Sum of Sq    RSS   AIC\n+ weight_kg:gender     1    144.02 115147 14847\n<none>                             115291 14851\n+ height_cm:gender     1     13.37 115277 14852\n- height_cm:weight_kg  1    219.87 115510 14857\n- gender               1   2064.63 117355 14930\n\nStep:  AIC=14846.88\nchest_in_cm ~ height_cm + weight_kg + gender + height_cm:weight_kg + \n    weight_kg:gender\n\n                      Df Sum of Sq    RSS   AIC\n<none>                             115147 14847\n+ height_cm:gender     1     3.499 115143 14849\n- weight_kg:gender     1   144.020 115291 14851\n- height_cm:weight_kg  1   274.743 115421 14856\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(step.model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = chest_in_cm ~ height_cm + weight_kg + gender + height_cm:weight_kg + \n    weight_kg:gender, data = subset(df, select = c(chest_in_cm, \n    height_cm, weight_kg, gender)))\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-21.3179  -3.2347   0.2087   3.4462  15.4911 \n\nCoefficients:\n                     Estimate Std. Error t value Pr(>|t|)    \n(Intercept)         41.491415   4.708485   8.812  < 2e-16 ***\nheight_cm            0.086786   0.028263   3.071 0.002148 ** \nweight_kg            0.666925   0.055507  12.015  < 2e-16 ***\ngenderM             -0.030639   0.599462  -0.051 0.959239    \nheight_cm:weight_kg -0.001087   0.000328  -3.314 0.000925 ***\nweight_kg:genderM    0.016955   0.007065   2.400 0.016449 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 5.001 on 4604 degrees of freedom\nMultiple R-squared:  0.8152,\tAdjusted R-squared:  0.815 \nF-statistic:  4061 on 5 and 4604 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n\n```{.r .cell-code}\n# Save the model for later\nheight_weight_model <- step.model\n```\n:::\n\n\n\n## Body Mass Index (BMI) model\n\nNow I'll do the same with BMI and gender.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm(data = subset(df, select= c(chest_in_cm, bmi, gender)), chest_in_cm ~ .) -> mod\nstep.model <- stepAIC(mod, direction = \"both\", trace = TRUE, scope = . ~ .^2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nStart:  AIC=17986.13\nchest_in_cm ~ bmi + gender\n\n             Df Sum of Sq    RSS   AIC\n+ bmi:gender  1       725 227076 17973\n<none>                    227801 17986\n- gender      1     11229 239030 18206\n- bmi         1    385144 612946 22547\n\nStep:  AIC=17973.44\nchest_in_cm ~ bmi + gender + bmi:gender\n\n             Df Sum of Sq    RSS   AIC\n<none>                    227076 17973\n- bmi:gender  1    724.73 227801 17986\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(step.model)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = chest_in_cm ~ bmi + gender + bmi:gender, data = subset(df, \n    select = c(chest_in_cm, bmi, gender)))\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-26.7682  -5.0630   0.2613   5.2463  23.2969 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) 56.77733    0.66042  85.971  < 2e-16 ***\nbmi          1.31235    0.02203  59.573  < 2e-16 ***\ngenderM     -0.34122    0.92789  -0.368 0.713084    \nbmi:genderM  0.11906    0.03105   3.834 0.000128 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 7.021 on 4606 degrees of freedom\nMultiple R-squared:  0.6355,\tAdjusted R-squared:  0.6353 \nF-statistic:  2677 on 3 and 4606 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n\n```{.r .cell-code}\n# Save the model for later\nbmi_model <- step.model\n```\n:::\n\n\n\n# Predicting chest size from height, weight, BMI, and gender\n\nNow that I have the models, I can use them to generate chest size predictions.\n\n\n## Predict chest size given height, weight, and gender\n\nNext we'll take the final model selected from the above procedure and use it to predict chest circumference, in inches, given height, weight, and gender.\n\nTo test the model, I'll use average values.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(df$weight_kg)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 82.48026\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(df$height_cm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 168.0299\n```\n\n\n:::\n\n```{.r .cell-code}\nmean(df$bmi)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 29.12334\n```\n\n\n:::\n:::\n\n\n\n\n### Height, weight, and gender\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninput <- data.frame(height_cm = 168, weight_kg = 83, gender = \"F\")\n\n# 1 cm = 0.393701 inches\npredict(height_weight_model, input) * 0.393701\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       1 \n37.90109 \n```\n\n\n:::\n:::\n\n\n\n### BMI and gender\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninput <- data.frame(bmi = 29, gender = \"F\")\npredict(bmi_model, input) * 0.393701\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       1 \n37.33684 \n```\n\n\n:::\n:::\n\n\n\n\n## Chest size to shirt size\n\nFinally, I'll need to take the chest size prediction and convert it to a shirt size. Remember the size chart? \n\n![](gildan_unisex_size_chart.png)\n\nFor some reason the chart leaves out \"XS\" and the ranges lso don't provide full coverage of the possible chest size values (34-36\" and then 38-40\"???). So I'll extend the upper bound of each range to meet the lower bound of each size above it. This will cause the predictions to err on the size of larger sizes rather than smaller sizes, which I think is better because if a shirt is too big, at least you can still wear it!\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninput <- data.frame(height_cm = 168, weight_kg = 83, gender = \"F\")\n\ndata.frame(chest = predict(height_weight_model,input)[[1]] * 0.393701) %>%\n  mutate(shirt_size = case_when(\n          chest < 32 ~ \"XS\",\n          between(chest, 32, 36) ~ \"S\",\n          between(chest, 36, 40) ~ \"M\",\n          between(chest, 40, 44) ~ \"L\",\n          between(chest, 44, 48) ~ \"XL\",\n          between(chest, 48, 52) ~ \"2XL\",\n          between(chest, 52, 56) ~ \"3XL\",\n          between(chest, 56, 64) ~ \"4XL\",\n          chest > 64 ~ \"5XL\"\n    )\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     chest shirt_size\n1 37.90109          M\n```\n\n\n:::\n:::\n\n\n\n# Wrapping it up in a function\n\nAnd finally, I can put it in a function that will select the model to use for me, based on the information it's been given.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict_shirt_size <- function(height_cm, weight_kg, bmi, gender){\n  \n  if(!is.na(height_cm) & !is.na(weight_kg)){\n    input <- data.frame(height_cm = height_cm, weight_kg = weight_kg, gender = gender)\n    chest <- predict(height_weight_model, input)[[1]] * 0.393701\n  } else if(!is.na(bmi)){\n    input <- data.frame(bmi = bmi, gender = gender)\n    chest <- predict(bmi_model, input)[[1]] * 0.393701\n  } else {\n    # Just in case height, weight, and BMI are all missing\n    chest <- -99 # A value that gets ignored below\n  }\n  \n  shirt_size = case_when(\n              between(chest, 0, 32) ~ \"XS\",\n              between(chest, 32, 36) ~ \"S\",\n              between(chest, 36, 40) ~ \"M\",\n              between(chest, 40, 44) ~ \"L\",\n              between(chest, 44, 48) ~ \"XL\",\n              between(chest, 48, 52) ~ \"2XL\",\n              between(chest, 52, 56) ~ \"3XL\",\n              between(chest, 56, 64) ~ \"4XL\",\n              chest > 64 ~ \"5XL\",\n              \n              # Defaults in case height, weight, BMI are missing\n              # but gender is not\n              gender == \"F\" ~ \"M\",\n              gender == \"M\" ~ \"L\",\n              \n              # Last resort\n              TRUE ~ \"L\"\n            )\n  \n  return(shirt_size)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npredict_shirt_size(height_cm = 168, weight_kg = 83, gender = \"F\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"M\"\n```\n\n\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}