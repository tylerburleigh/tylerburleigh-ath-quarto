<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tyler Burleigh">
<meta name="description" content="In this post I consider a model for evaluating LLM outputs through an iterative debate process that was reported in a recent paper in arXiv. I find that the baseline model reported in this paper did not implement what I would consider to be standard best practices and therefore is not a fair comparison for the newly proposed method. I then implement a new baseline model that does implement these best practices, and find that this improved baseline model yields better agreement with human judges than an implementation of the proposed method. This serves to highlight the importance of implementing standard best practices in baseline models, as well as the being skeptical of claims in research papers that compare new methods to a baseline.">

<title>A test of the Single Advocate Multi-Round Evaluation (SAMRE) method for LLM evaluation, and the importance of using a baseline model that implements standard best practices | Tyler Burleigh – Tyler Burleigh</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../..//files/favico.png" rel="icon" type="image/png">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-dd08061cb7210c315e315379d94beb87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-9f5ddf0f04a2e96700b10066b57d40ff.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PRHQZ8HPLB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-PRHQZ8HPLB', { 'anonymize_ip': true});
</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Tyler Burleigh</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/users/tylerburleigh" rel="me"> <i class="bi bi-mastodon" role="img" aria-label="mastodon">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/tylerburleigh.bsky.social" rel="me"> <i class="bi bi-square" role="img" aria-label="bluesky">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tylerburleigh" rel="me"> <i class="bi bi-github" role="img" aria-label="github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/tylerburleigh" rel="me"> <i class="bi bi-linkedin" role="img" aria-label="linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:tylerburleigh@gmail.com" rel="me"> <i class="bi bi-envelope" role="img" aria-label="email">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">A test of the Single Advocate Multi-Round Evaluation (SAMRE) method for LLM evaluation, and the importance of using a baseline model that implements standard best practices</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                  <div>
        <div class="description">
          In this post I consider a model for evaluating LLM outputs through an iterative debate process that was reported in a recent paper in arXiv. I find that the baseline model reported in this paper did not implement what I would consider to be standard best practices and therefore is not a fair comparison for the newly proposed method. I then implement a new baseline model that does implement these best practices, and find that this improved baseline model yields better agreement with human judges than an implementation of the proposed method. This serves to highlight the importance of implementing standard best practices in baseline models, as well as the being skeptical of claims in research papers that compare new methods to a baseline.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">prompt-engineering</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">LLM-as-judge</div>
                <div class="quarto-category">LLM-evals</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.tylerburleigh.com/">Tyler Burleigh</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Sunday, January 5, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#baseline-model-inadequacies" id="toc-baseline-model-inadequacies" class="nav-link active" data-scroll-target="#baseline-model-inadequacies">Baseline model inadequacies</a></li>
  <li><a href="#my-implementation-of-samre-and-baseline" id="toc-my-implementation-of-samre-and-baseline" class="nav-link" data-scroll-target="#my-implementation-of-samre-and-baseline">My implementation of SAMRE and Baseline</a></li>
  <li><a href="#load-the-mt-bench-dataset" id="toc-load-the-mt-bench-dataset" class="nav-link" data-scroll-target="#load-the-mt-bench-dataset">Load the MT-bench dataset</a></li>
  <li><a href="#evaluate-mt-bench-with-samre-and-baseline-methods" id="toc-evaluate-mt-bench-with-samre-and-baseline-methods" class="nav-link" data-scroll-target="#evaluate-mt-bench-with-samre-and-baseline-methods">Evaluate MT-bench with SAMRE and Baseline methods</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>I’ve been doing a lot of work with LLM-based evaluations lately, and I’ve been thinking about how to improve the quality of these evaluations.</p>
<p>I like to read research papers from arXiv for inspiration, and I recently came across a paper called <a href="https://arxiv.org/abs/2410.04663">Adversarial Multi-Agent Evaluation of Large Language Models through Iterative Debates</a>, which introduces a new method inspired by judicial process called Single Advocate Multi-Round Evaluation (SAMRE). Briefly, the SAMRE method evaluates the quality of different LLM outputs through an iterative debate process.</p>
<p>I was initially impressed by the results, as they reported a gain of 6-8% over the baseline method. However, I am often skeptical of comparisons to “baseline” in these research papers, as I find that they often fail to implement standard best practices and are therefore not represenative of a true baseline model.</p>
<p>I decided to try and reproduce some of the methods of the paper, while creating a baseline that does implement standard best practices for prompt engineering.</p>
<p>Using a sample of 500 conversations from MT-bench for testing and evaluation, I find that contrary to the paper, SAMRE is inferior to baseline.</p>
<p>This serves to highlight the importance of implementing standard best practices in baseline models, as well as being skeptical of claims in research papers that compare new methods to a “baseline model”.</p>
<section id="baseline-model-inadequacies" class="level1">
<h1>Baseline model inadequacies</h1>
<p>First, let’s consider some of the inadequacies in the Baseline model’s prompt reported in the paper. The prompt they used was as follows:</p>
<pre><code>You are a fair, impartial judge scoring a debate on the following question:
question.
Answer 1: answer1
Answer 2: answer2
Score each answer on a scale of 1-20 for each of the following criteria:
1. Relevance to the question
2. Accuracy of information and use of credible sources
3. Depth of analysis and completeness of argument
4. Clarity of expression and logical flow
5. Strength of reasoning and factual support
6. Effectiveness in addressing opponent’s points
Provide scores as [Answer1_score, Answer2_score] for each criterion in a list format, then sum for final scores. Please keep an eye on the slightest difference that should make a difference in the scoring. Don’t overthink!
Relevance:
Accuracy:
Depth:
Clarity:
Logic and Factuality:
Addressing opponent’s points:
Final Scores (sum of above) as a tuple (example: (18, 9)):
Explain your scoring, focusing on why one answer is better than the other based on the criteria above. Keep your explanation concise but informative.
Finally, return the final score tuple (score1, score2) as a tuple (in parentheses).
Example: (18, 9)
Your scores and explanation:</code></pre>
<p>First, the prompt does not use any delimiters for the inputs. I would enclose the inputs inside XML tags like <question></question>, <answer1></answer1>, and <answer2></answer2>, but in a pinch delimiters like triple backticks can be used.</p>
<p>Second, the prompt instructs the model to first generate scores in list format, and then to sum them. But as we know, language models models often make arithmetic mistakes. It would be better to ask the model to generate scores for each criterion, and then to programmatically extract and summarize them in python (or another programming language) from which the routine is run.</p>
<p>Third, although the prompt asks the model to “explain your scoring”, it is not clear if the model should be reasoning about each criterion before it scores them, or if it should provide reasoning at the end when giving its final score. I would ask the model to provide reasoning for each criterion that it is asked to score, and ask it to reason before scoring.</p>
<p>Fourth, it’s unclear why a scale of 1-20 is used. This is not a standard scale for scoring. I would use a scale of 1-10 or 0-10 which is likely more familiar to the model and can be expected to be used more consistently.</p>
<p>Fifth, although the prompt does suggest that the model provide its scores in tuple format, it would be better to provide more explicit format instructions.</p>
<p>Finally, although this goes beyond the prompt itself (and is not something that I address with my improved baseline), it is worth noting that comparing a multi-round method to a single-round method is also an unfair comparison. Instead, it would be better to compare the SAMRE method to a baseline that uses the same number of rounds and then similarly averages its scores.</p>
<p>With all of that in mind, here’s how I would rewrite the prompt:</p>
<pre><code>You're a critical, impartial judge scoring the performance of
two answers, Answer1 and Answer2, on a list of Criteria, using
the DefenseForAnswer1 and DefenseForAnswer2. 

&lt;Answer1&gt;
{answer1}
&lt;/Answer1&gt;

&lt;Answer2&gt;
{answer2}
&lt;/Answer2&gt;

&lt;DefenseForAnswer1&gt;
{defense1}
&lt;/DefenseForAnswer1&gt;

&lt;DefenseForAnswer2&gt;
{defense2}
&lt;/DefenseForAnswer2&gt;

&lt;Criteria&gt;
&lt;Criterion1&gt;Relevance to their task&lt;/Criterion1&gt;
&lt;Criterion2&gt;Accuracy and credible sources&lt;/Criterion2&gt;
&lt;Criterion3&gt;Depth and completeness&lt;/Criterion3&gt;
&lt;Criterion4&gt;Clarity and logical flow&lt;/Criterion4&gt;
&lt;Criterion5&gt;Reasoning and factual support&lt;/Criterion5&gt;
&lt;Criterion6&gt;Effectiveness addressing opponent&lt;/Criterion6&gt;
&lt;/Criteria&gt;

For each Criterion in the Criteria, briefly analyze 
the performance of the two answers based on the 
DefenseForAnswer1 and DefenseForAnswer2, then 
render a score between 0 and 10.

Respond as follows:
&lt;Criterion1&gt;
&lt;Analysis&gt;
Answer 1: [Brief thoughts about Answer 1's performance on the Criterion, based on the DefenseForAnswer1]
Answer 2: [Brief thoughts about Answer 2's performance on the Criterion, based on the DefenseForAnswer2]
&lt;/Analysis&gt;
&lt;Scores&gt;
&lt;Answer1Score&gt;[score between 0 and 10]&lt;/Answer1Score&gt;
&lt;Answer2Score&gt;[score between 0 and 10]&lt;/Answer2Score&gt;
&lt;/Scores&gt;
&lt;/Criterion1&gt;
&lt;Criterion2&gt;
&lt;Analysis&gt;
Answer 1: [Brief thoughts about Answer 1's performance on the Criterion, based on the DefenseForAnswer1]
Answer 2: [Brief thoughts about Answer 2's performance on the Criterion, based on the DefenseForAnswer2]
&lt;/Analysis&gt;
&lt;Scores&gt;
&lt;Answer1Score&gt;[score between 0 and 10]&lt;/Answer1Score&gt;
&lt;Answer2Score&gt;[score between 0 and 10]&lt;/Answer2Score&gt;
&lt;/Scores&gt;
&lt;/Criterion2&gt;
...</code></pre>
<p>Notice that the prompt now uses XML tags to structure the instructions, that it asks the model to provide reasoning for each criterion before scoring, and that it gives the model a clear format for its response that reinforces analysis before scoring for each criterion.</p>
<p>I’ve also change the scale from 1-20 to 1-10, and removed the instruction to summarize the scores, as I would handle this within the code.</p>
</section>
<section id="my-implementation-of-samre-and-baseline" class="level1">
<h1>My implementation of SAMRE and Baseline</h1>
<p>Okay, so with that criticism out of the way, let’s implement the SAMRE and Baseline methods. Below is my python implementation of the SAMRE and Baseline methods. I’ve modified the “scorer prompt” within the SAMRE method to use the same format as the Baseline method, and I’ve made a few adjustments to the prompts so they can handle conversation data as input (which is what the MT-bench dataset contains by default) instead of question-answer pairs. For example, instead of asking the model to score two answers to a question, the model is asked to score two “candidates” in a debate. I’ve also modified the structure of prompts to use XML tags throughout.</p>
<div id="beef51bf" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Dict</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> AsyncOpenAI</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> asynccontextmanager</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the prompts</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>PROMPTS <span class="op">=</span> {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="st">"defend_prompt"</span>: <span class="st">"""</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="st">You're an eloquent advocate (Advocate </span><span class="sc">{advocate_id}</span><span class="st">), making</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">a case for Candidate A. Your Opponent is advocating for Candidate B.</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="st">Use the Latest Feedback, Opponent's Last Argument, and Your Team's Previous Arguments to improve your case for Candidate A.</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;LatestFeedback&gt;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="sc">{feedback}</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/LatestFeedback&gt;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;OpponentLastArgument&gt;</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="sc">{opponent_argument}</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/OpponentLastArgument&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;TeamPreviousArguments&gt;</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="sc">{team_arguments}</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/TeamPreviousArguments&gt;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="st">Respond in under 80 words.</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="st">Your defense:</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="st">"judge_prompt"</span>: <span class="st">"""</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="st">You're a fair, impartial judge in a competition between two</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="st">candidates, Candidate A and Candidate B, to determine which</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="st">is performing better at their task.</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="st">Advocates are making their case for their respective candidates.</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="st">Your task is to provide feedback that will help advocates improve </span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="st">and differentiate their arguments more clearly. Use the following</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="st">information to guide your feedback:</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CurrentRound&gt;</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="sc">{current_round}</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CurrentRound&gt;</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;TotalRounds&gt;</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="sc">{total_rounds}</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/TotalRounds&gt;</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;PreviousScores&gt;</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="sc">{previous_scores}</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/PreviousScores&gt;</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateA&gt;</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense1}</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateA&gt;</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateB&gt;</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense2}</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateB&gt;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="st">Provide specific, constructive feedback in under 50 words:</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="st">"score_prompt_samre"</span>: <span class="st">"""</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="st">You're a critical, impartial judge scoring the performance of</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="st">two candidates, Candidate A and Candidate B, on a list of Criteria,</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a><span class="st">using the DefenseForCandidateA and DefenseForCandidateB. </span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateA&gt;</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense1}</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateA&gt;</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateB&gt;</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense2}</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateB&gt;</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criteria&gt;</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;Relevance to their task&lt;/Criterion1&gt;</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;Accuracy and credible sources&lt;/Criterion2&gt;</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion3&gt;Depth and completeness&lt;/Criterion3&gt;</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion4&gt;Clarity and logical flow&lt;/Criterion4&gt;</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion5&gt;Reasoning and factual support&lt;/Criterion5&gt;</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion6&gt;Effectiveness addressing opponent&lt;/Criterion6&gt;</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criteria&gt;</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a><span class="st">For each Criterion in the Criteria, briefly analyze </span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="st">the performance of the two candidates based on the </span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="st">DefenseForCandidateA and DefenseForCandidateB, then </span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="st">render a score between 0 and 10.</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a><span class="st">Respond as follows:</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion, based on the DefenseForCandidateA]</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion, based on the DefenseForCandidateB]</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion1&gt;</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion, based on the DefenseForCandidateA]</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion, based on the DefenseForCandidateB]</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion2&gt;</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a><span class="st">...</span></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a><span class="st">"score_prompt_baseline"</span>: <span class="st">"""</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a><span class="st">You're a critical, impartial judge scoring the performance of</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a><span class="st">two candidates, Candidate A and Candidate B, on a list of Criteria. </span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criteria&gt;</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;Relevance to their task&lt;/Criterion1&gt;</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;Accuracy and credible sources&lt;/Criterion2&gt;</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion3&gt;Depth and completeness&lt;/Criterion3&gt;</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion4&gt;Clarity and logical flow&lt;/Criterion4&gt;</span></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion5&gt;Reasoning and factual support&lt;/Criterion5&gt;</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion6&gt;Effectiveness addressing opponent&lt;/Criterion6&gt;</span></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criteria&gt;</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a><span class="st">For each Criterion in the Criteria, briefly analyze </span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a><span class="st">the performance of the two candidates, then render a score </span></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a><span class="st">between 0 and 10.</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a><span class="st">Respond as follows:</span></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion]</span></span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion]</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion1&gt;</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion]</span></span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion]</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion2&gt;</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a><span class="st">...</span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Memory:</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>    arguments: List[Tuple[<span class="bu">str</span>, <span class="bu">str</span>]] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>    scores: List[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>    feedback: List[<span class="bu">str</span>] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelEvaluator:</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">@asynccontextmanager</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> create(cls, mode<span class="op">=</span><span class="st">"samre"</span>, model<span class="op">=</span><span class="st">"gpt-4o-mini"</span>, logging_level<span class="op">=</span>logging.WARNING):</span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>        instance <span class="op">=</span> cls(mode<span class="op">=</span>mode, model<span class="op">=</span>model, logging_level<span class="op">=</span>logging_level)</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>        instance.client <span class="op">=</span> AsyncOpenAI()</span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> instance</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> instance.client.close()</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _setup_logger(<span class="va">self</span>, logging_level):</span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Setup logger with word wrapping."""</span></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>        logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>        logger.setLevel(logging_level)</span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> logger.handlers:</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>            handler <span class="op">=</span> logging.StreamHandler()</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>            <span class="kw">class</span> WrapFormatter(logging.Formatter):</span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>                <span class="kw">def</span> <span class="bu">format</span>(<span class="va">self</span>, record):</span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>                    <span class="im">import</span> textwrap</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>                    message <span class="op">=</span> <span class="bu">super</span>().<span class="bu">format</span>(record)</span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(textwrap.fill(line, width<span class="op">=</span><span class="dv">80</span>) </span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">for</span> line <span class="kw">in</span> message.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>))</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>            formatter <span class="op">=</span> WrapFormatter(<span class="st">'</span><span class="sc">%(message)s</span><span class="st">'</span>)</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>            handler.setFormatter(formatter)</span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>            logger.addHandler(handler)</span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logger</span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mode<span class="op">=</span><span class="st">"samre"</span>, model<span class="op">=</span><span class="st">"gpt-4o-mini"</span>, logging_level<span class="op">=</span>logging.WARNING):</span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mode <span class="op">=</span> mode</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_rounds <span class="op">=</span> <span class="dv">4</span> <span class="cf">if</span> mode <span class="op">==</span> <span class="st">"samre"</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger <span class="op">=</span> <span class="va">self</span>._setup_logger(logging_level)</span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize all prompts</span></span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.defend_prompt <span class="op">=</span> PROMPTS[<span class="st">"defend_prompt"</span>]</span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.judge_prompt <span class="op">=</span> PROMPTS[<span class="st">"judge_prompt"</span>]</span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> get_completion(<span class="va">self</span>, prompt: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get a completion from the OpenAI API."""</span></span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client:</span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"Evaluator must be created using 'async with ModelEvaluator.create() as evaluator:'"</span>)</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.client.chat.completions.create(</span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="dv">0</span></span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _extract_final_scores(<span class="va">self</span>, score_response: <span class="bu">str</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract and sum scores from all criteria sections."""</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>        score_a_pattern <span class="op">=</span> <span class="vs">r'&lt;CandidateAScore&gt;\s*(\d+\.?\d*)\s*&lt;/CandidateAScore&gt;'</span></span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>        score_b_pattern <span class="op">=</span> <span class="vs">r'&lt;CandidateBScore&gt;\s*(\d+\.?\d*)\s*&lt;/CandidateBScore&gt;'</span></span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>        scores_a <span class="op">=</span> [<span class="bu">float</span>(match.group(<span class="dv">1</span>)) <span class="cf">for</span> match <span class="kw">in</span> re.finditer(score_a_pattern, score_response)]</span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>        scores_b <span class="op">=</span> [<span class="bu">float</span>(match.group(<span class="dv">1</span>)) <span class="cf">for</span> match <span class="kw">in</span> re.finditer(score_b_pattern, score_response)]</span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> scores_a <span class="kw">or</span> <span class="kw">not</span> scores_b:</span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Could not find scores for both candidates"</span>)</span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(scores_a) <span class="op">!=</span> <span class="bu">len</span>(scores_b):</span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Mismatched number of scores: A=</span><span class="sc">{</span><span class="bu">len</span>(scores_a)<span class="sc">}</span><span class="ss">, B=</span><span class="sc">{</span><span class="bu">len</span>(scores_b)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>        final_score_a <span class="op">=</span> <span class="bu">sum</span>(scores_a) <span class="op">/</span> <span class="bu">len</span>(scores_a)</span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>        final_score_b <span class="op">=</span> <span class="bu">sum</span>(scores_b) <span class="op">/</span> <span class="bu">len</span>(scores_b)</span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (final_score_a, final_score_b)</span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> evaluate(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Main evaluation method that branches based on mode."""</span></span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client:</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"Evaluator must be created using 'async with ModelEvaluator.create() as evaluator:'"</span>)</span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.mode <span class="op">==</span> <span class="st">"baseline"</span>:</span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Starting Baseline Evaluation ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>._evaluate_baseline(candidate_a, candidate_b)</span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Starting SAMRE Evaluation ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>._evaluate_samre(candidate_a, candidate_b)</span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _evaluate_baseline(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Simple baseline evaluation."""</span></span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>        score_prompt <span class="op">=</span> PROMPTS[<span class="st">"score_prompt_baseline"</span>].<span class="bu">format</span>(</span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>        score_response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(score_prompt)</span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"Score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="va">self</span>._extract_final_scores(score_response)</span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Score parsing error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Raw score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> (<span class="fl">10.0</span>, <span class="fl">10.0</span>)</span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a>            <span class="st">"winner"</span>: <span class="st">'model_a'</span> <span class="cf">if</span> scores[<span class="dv">0</span>] <span class="op">&gt;</span> scores[<span class="dv">1</span>] <span class="cf">else</span> <span class="st">'model_b'</span> <span class="cf">if</span> scores[<span class="dv">1</span>] <span class="op">&gt;</span> scores[<span class="dv">0</span>] <span class="cf">else</span> <span class="st">'tie'</span>,</span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>            <span class="st">"average_scores"</span>: scores,</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rounds"</span>: <span class="dv">1</span>,</span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>            <span class="st">"score_history"</span>: [<span class="bu">list</span>(scores)],</span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>            <span class="st">"full_response"</span>: score_response</span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _evaluate_samre(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Full SAMRE evaluation with debate rounds."""</span></span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a>        local_memory <span class="op">=</span> Memory()</span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Starting SAMRE Evaluation ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> round_num <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.max_rounds):</span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Round </span><span class="sc">{</span>round_num <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._run_debate_round(</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>                candidate_a, </span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>                candidate_b, </span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>                round_num,</span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>                local_memory</span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._has_scores_converged(round_num, local_memory):</span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">Scores have converged - ending debate early."</span>)</span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._prepare_results(local_memory)</span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> defend_answer(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>, </span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>                          advocate_id: <span class="bu">int</span>, feedback: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>, </span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>                          opponent_argument: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>                          team_arguments: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get defense from an advocate."""</span></span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> team_arguments <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>            team_arguments <span class="op">=</span> []</span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> <span class="va">self</span>.defend_prompt.<span class="bu">format</span>(</span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>            advocate_id<span class="op">=</span>advocate_id,</span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b,</span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>            feedback<span class="op">=</span>feedback,</span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>            opponent_argument<span class="op">=</span>opponent_argument,</span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a>            team_arguments<span class="op">=</span><span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(team_arguments)</span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(prompt)</span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_debate(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>,</span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a>                          defense1: <span class="bu">str</span>, defense2: <span class="bu">str</span>, </span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a>                          current_round: <span class="bu">int</span>,</span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a>                          memory: Memory) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Judge the debate between two answers."""</span></span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>        feedback_prompt <span class="op">=</span> <span class="va">self</span>.judge_prompt.<span class="bu">format</span>(</span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b,</span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>            current_round<span class="op">=</span>current_round,</span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a>            total_rounds<span class="op">=</span><span class="va">self</span>.max_rounds,</span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a>            previous_scores<span class="op">=</span>memory.scores,</span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a>            defense1<span class="op">=</span>defense1,</span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>            defense2<span class="op">=</span>defense2</span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a>        feedback <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(feedback_prompt)</span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>        score_prompt <span class="op">=</span> PROMPTS[<span class="st">"score_prompt_baseline"</span>].<span class="bu">format</span>(</span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b,</span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a>            defense1<span class="op">=</span>defense1,</span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>            defense2<span class="op">=</span>defense2</span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>        score_response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(score_prompt)    </span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"Score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="va">self</span>._extract_final_scores(score_response)</span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Score parsing error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Raw score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> (<span class="fl">10.0</span>, <span class="fl">10.0</span>)</span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> feedback, scores</span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _run_debate_round(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>, </span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>                               round_num: <span class="bu">int</span>, memory: Memory) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Execute a single round of debate between advocates."""</span></span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a>        defenses <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._get_advocate_defenses(candidate_a, candidate_b, memory)</span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>        memory.arguments.append(defenses)</span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>        feedback, scores <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.judge_debate(</span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>            candidate_a, candidate_b, defenses[<span class="dv">0</span>], defenses[<span class="dv">1</span>], round_num <span class="op">+</span> <span class="dv">1</span>, memory</span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._store_round_results(feedback, scores, memory)</span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._display_round_results(defenses, feedback, scores)</span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scores</span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _get_advocate_defenses(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>,</span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>                                   memory: Memory) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>]:</span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get defenses from both advocates."""</span></span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a>        defense1 <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.defend_answer(</span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>            candidate_a, candidate_b, <span class="dv">1</span>,</span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>            feedback<span class="op">=</span>memory.feedback[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> memory.feedback <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>            opponent_argument<span class="op">=</span>memory.arguments[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>] <span class="cf">if</span> memory.arguments <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>            team_arguments<span class="op">=</span>[args[<span class="dv">0</span>] <span class="cf">for</span> args <span class="kw">in</span> memory.arguments]</span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>        defense2 <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.defend_answer(</span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a>            candidate_a, candidate_b, <span class="dv">2</span>,</span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a>            feedback<span class="op">=</span>memory.feedback[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> memory.feedback <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a>            opponent_argument<span class="op">=</span>memory.arguments[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>] <span class="cf">if</span> memory.arguments <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a>            team_arguments<span class="op">=</span>[args[<span class="dv">1</span>] <span class="cf">for</span> args <span class="kw">in</span> memory.arguments]</span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (defense1, defense2)</span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _store_round_results(<span class="va">self</span>, feedback: <span class="bu">str</span>, scores: Tuple[<span class="bu">float</span>, <span class="bu">float</span>],</span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a>                           memory: Memory) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Store feedback and scores from the round."""</span></span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>        memory.feedback.append(feedback)</span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a>        memory.scores.append(scores)</span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _display_round_results(<span class="va">self</span>, defenses: Tuple[<span class="bu">str</span>, <span class="bu">str</span>], </span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>                             feedback: <span class="bu">str</span>, scores: Tuple[<span class="bu">float</span>, <span class="bu">float</span>]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Display the results of the current round."""</span></span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Advocate 1's defense:</span><span class="ch">\n</span><span class="sc">{</span>defenses[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Advocate 2's defense:</span><span class="ch">\n</span><span class="sc">{</span>defenses[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Judge's feedback:</span><span class="ch">\n</span><span class="sc">{</span>feedback<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"Scores for this round: Answer 1 = </span><span class="sc">{</span><span class="bu">round</span>(scores[<span class="dv">0</span>], <span class="dv">2</span>)<span class="sc">}</span><span class="ss">, Answer 2 = </span><span class="sc">{</span><span class="bu">round</span>(scores[<span class="dv">1</span>], <span class="dv">2</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _has_scores_converged(<span class="va">self</span>, round_num: <span class="bu">int</span>, memory: Memory) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if scores have converged (same winner twice in a row)."""</span></span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> round_num <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>            prev_diff <span class="op">=</span> memory.scores[<span class="op">-</span><span class="dv">2</span>][<span class="dv">0</span>] <span class="op">-</span> memory.scores[<span class="op">-</span><span class="dv">2</span>][<span class="dv">1</span>]</span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>            curr_diff <span class="op">=</span> memory.scores[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>] <span class="op">-</span> memory.scores[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (prev_diff <span class="op">*</span> curr_diff) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-436"><a href="#cb3-436" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _prepare_results(<span class="va">self</span>, memory: Memory) <span class="op">-&gt;</span> Dict:</span>
<span id="cb3-437"><a href="#cb3-437" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Prepare the final results dictionary."""</span></span>
<span id="cb3-438"><a href="#cb3-438" aria-hidden="true" tabindex="-1"></a>        avg_scores <span class="op">=</span> [</span>
<span id="cb3-439"><a href="#cb3-439" aria-hidden="true" tabindex="-1"></a>            <span class="bu">round</span>(<span class="bu">sum</span>(scores[i] <span class="cf">for</span> scores <span class="kw">in</span> memory.scores) <span class="op">/</span> <span class="bu">len</span>(memory.scores), <span class="dv">2</span>)</span>
<span id="cb3-440"><a href="#cb3-440" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>)</span>
<span id="cb3-441"><a href="#cb3-441" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-442"><a href="#cb3-442" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-443"><a href="#cb3-443" aria-hidden="true" tabindex="-1"></a>        winner <span class="op">=</span> (</span>
<span id="cb3-444"><a href="#cb3-444" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model_a'</span> <span class="cf">if</span> avg_scores[<span class="dv">0</span>] <span class="op">&gt;</span> avg_scores[<span class="dv">1</span>]</span>
<span id="cb3-445"><a href="#cb3-445" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="st">'model_b'</span> <span class="cf">if</span> avg_scores[<span class="dv">0</span>] <span class="op">&lt;</span> avg_scores[<span class="dv">1</span>]</span>
<span id="cb3-446"><a href="#cb3-446" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="st">'tie'</span></span>
<span id="cb3-447"><a href="#cb3-447" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-448"><a href="#cb3-448" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-449"><a href="#cb3-449" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb3-450"><a href="#cb3-450" aria-hidden="true" tabindex="-1"></a>            <span class="st">"winner"</span>: winner,</span>
<span id="cb3-451"><a href="#cb3-451" aria-hidden="true" tabindex="-1"></a>            <span class="st">"average_scores"</span>: avg_scores,</span>
<span id="cb3-452"><a href="#cb3-452" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rounds"</span>: <span class="bu">len</span>(memory.scores),</span>
<span id="cb3-453"><a href="#cb3-453" aria-hidden="true" tabindex="-1"></a>            <span class="st">"score_history"</span>: [[<span class="bu">round</span>(s[<span class="dv">0</span>], <span class="dv">2</span>), <span class="bu">round</span>(s[<span class="dv">1</span>], <span class="dv">2</span>)] <span class="cf">for</span> s <span class="kw">in</span> memory.scores],</span>
<span id="cb3-454"><a href="#cb3-454" aria-hidden="true" tabindex="-1"></a>            <span class="st">"argument_history"</span>: memory.arguments,</span>
<span id="cb3-455"><a href="#cb3-455" aria-hidden="true" tabindex="-1"></a>            <span class="st">"feedback_history"</span>: memory.feedback</span>
<span id="cb3-456"><a href="#cb3-456" aria-hidden="true" tabindex="-1"></a>        }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-the-mt-bench-dataset" class="level1">
<h1>Load the MT-bench dataset</h1>
<p>Next I will read in the MT-bench dataset from disk and prepare it for evaluation.</p>
<div id="8710dcc7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the MT-bench dataset from disk</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>data_list <span class="op">=</span> []</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'mt_bench_human_judgments.jsonl'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> json.loads(line)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        data_list.append(data)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data_list)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a random sample of 615 rows, which</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># with this seed yields 500 unique conversations</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sample(n<span class="op">=</span><span class="dv">615</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique combinations of conversations and models</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'conversation_a_str'</span>] <span class="op">=</span> df[<span class="st">'conversation_a'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'conversation_b_str'</span>] <span class="op">=</span> df[<span class="st">'conversation_b'</span>].astype(<span class="bu">str</span>) </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">'model_a'</span>, <span class="st">'model_b'</span>, <span class="st">'conversation_a_str'</span>, <span class="st">'conversation_b_str'</span>])</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique conversations: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unique conversations: 500</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">split</th>
<th data-quarto-table-cell-role="th">question_id</th>
<th data-quarto-table-cell-role="th">model_a</th>
<th data-quarto-table-cell-role="th">model_b</th>
<th data-quarto-table-cell-role="th">winner</th>
<th data-quarto-table-cell-role="th">judge</th>
<th data-quarto-table-cell-role="th">conversation_a</th>
<th data-quarto-table-cell-role="th">conversation_b</th>
<th data-quarto-table-cell-role="th">turn</th>
<th data-quarto-table-cell-role="th">conversation_a_str</th>
<th data-quarto-table-cell-role="th">conversation_b_str</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3250</td>
<td>human</td>
<td>159</td>
<td>alpaca-13b</td>
<td>vicuna-13b-v1.2</td>
<td>model_b</td>
<td>expert_2</td>
<td>[{'content': 'What are some business etiquette...</td>
<td>[{'content': 'What are some business etiquette...</td>
<td>2</td>
<td>[{'content': 'What are some business etiquette...</td>
<td>[{'content': 'What are some business etiquette...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">596</td>
<td>human</td>
<td>95</td>
<td>llama-13b</td>
<td>gpt-3.5-turbo</td>
<td>model_b</td>
<td>expert_39</td>
<td>[{'content': 'Please assume the role of an Eng...</td>
<td>[{'content': 'Please assume the role of an Eng...</td>
<td>2</td>
<td>[{'content': 'Please assume the role of an Eng...</td>
<td>[{'content': 'Please assume the role of an Eng...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2236</td>
<td>human</td>
<td>134</td>
<td>gpt-4</td>
<td>llama-13b</td>
<td>model_a</td>
<td>expert_42</td>
<td>[{'content': 'Given the following data, identi...</td>
<td>[{'content': 'Given the following data, identi...</td>
<td>2</td>
<td>[{'content': "Given the following data, identi...</td>
<td>[{'content': "Given the following data, identi...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1064</td>
<td>human</td>
<td>106</td>
<td>claude-v1</td>
<td>alpaca-13b</td>
<td>model_a</td>
<td>expert_10</td>
<td>[{'content': 'Each problem consists of three s...</td>
<td>[{'content': 'Each problem consists of three s...</td>
<td>1</td>
<td>[{'content': 'Each problem consists of three s...</td>
<td>[{'content': 'Each problem consists of three s...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">315</td>
<td>human</td>
<td>89</td>
<td>gpt-3.5-turbo</td>
<td>llama-13b</td>
<td>model_a</td>
<td>expert_26</td>
<td>[{'content': 'Help me construct a catchy, yet ...</td>
<td>[{'content': 'Help me construct a catchy, yet ...</td>
<td>2</td>
<td>[{'content': 'Help me construct a catchy, yet ...</td>
<td>[{'content': 'Help me construct a catchy, yet ...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="evaluate-mt-bench-with-samre-and-baseline-methods" class="level1">
<h1>Evaluate MT-bench with SAMRE and Baseline methods</h1>
<p>Next, for each conversation in the dataset, I will evaluate the two models using both the SAMRE and Baseline methods.</p>
<div id="b4a0924a" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> asyncio <span class="im">import</span> Semaphore</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.WARNING)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> evaluate_conversation_pair(row, evaluators, semaphore, idx, total):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Evaluate a single conversation pair with all evaluators"""</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> semaphore:</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate pair_id from conversation hash</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        pair_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'model_a'</span>]<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>row[<span class="st">'model_b'</span>]<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>hashlib<span class="sc">.</span>sha256(<span class="bu">str</span>(row[<span class="st">'conversation_a'</span>]).encode())<span class="sc">.</span>hexdigest()[:<span class="dv">12</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        checkpoint_file <span class="op">=</span> <span class="ss">f'checkpoints/</span><span class="sc">{</span>pair_id<span class="sc">}</span><span class="ss">.json'</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return existing checkpoint if available</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(checkpoint_file):</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            logging.info(<span class="ss">f"Found existing checkpoint file for </span><span class="sc">{</span>pair_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> json.load(<span class="bu">open</span>(checkpoint_file))</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"No checkpoint file found for </span><span class="sc">{</span>pair_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model_a'</span>: row[<span class="st">'model_a'</span>],</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model_b'</span>: row[<span class="st">'model_b'</span>],</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'human_winner'</span>: row[<span class="st">'winner'</span>],</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pair_id'</span>: pair_id</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate with each evaluator</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, evaluator <span class="kw">in</span> evaluators.items():</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                eval_result <span class="op">=</span> <span class="cf">await</span> evaluator.evaluate(row[<span class="st">'conversation_a'</span>], row[<span class="st">'conversation_b'</span>])</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                result[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_winner'</span>] <span class="op">=</span> eval_result[<span class="st">'winner'</span>]</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add common evaluation details</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>                result.update({<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>: eval_result[k] <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'average_scores'</span>, <span class="st">'rounds'</span>, <span class="st">'score_history'</span>]})</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add mode-specific details</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> evaluator.mode <span class="op">==</span> <span class="st">"samre"</span>:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                    result.update({</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'samre_argument_history'</span>: eval_result[<span class="st">'argument_history'</span>],</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'samre_feedback_history'</span>: eval_result[<span class="st">'feedback_history'</span>]</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> evaluator.mode <span class="op">==</span> <span class="st">"baseline"</span>:</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                    result[<span class="st">'baseline_full_response'</span>] <span class="op">=</span> eval_result[<span class="st">'full_response'</span>]</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error with </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> evaluator on row </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                result[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_winner'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save checkpoint</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">'checkpoints'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        json.dump(result, <span class="bu">open</span>(checkpoint_file, <span class="st">'w'</span>))</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (idx <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>idx <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total<span class="sc">}</span><span class="ss"> conversations"</span>)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> evaluate_conversations_async(df, evaluators, semaphore_limit<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Evaluate conversations asynchronously"""</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'checkpoints'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    tasks <span class="op">=</span> [evaluate_conversation_pair(row[<span class="dv">1</span>], evaluators, Semaphore(semaphore_limit), idx, <span class="bu">len</span>(df))</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>             <span class="cf">for</span> idx, row <span class="kw">in</span> <span class="bu">enumerate</span>(df.iterrows())]</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(<span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks))</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> ModelEvaluator.create(mode<span class="op">=</span><span class="st">"samre"</span>) <span class="im">as</span> samre_evaluator, <span class="op">\</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>               ModelEvaluator.create(mode<span class="op">=</span><span class="st">"baseline"</span>) <span class="im">as</span> baseline_evaluator:</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> evaluate_conversations_async(</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>            df,</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'samre'</span>: samre_evaluator, <span class="st">'baseline'</span>: baseline_evaluator},</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>            semaphore_limit<span class="op">=</span><span class="dv">7</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Run evaluation with checkpoint recovery</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    eval_df <span class="op">=</span> <span class="cf">await</span> main()</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error during evaluation: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ch">\n</span><span class="ss">Recovering from checkpoints..."</span>)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    eval_df <span class="op">=</span> pd.DataFrame([json.load(<span class="bu">open</span>(<span class="ss">f'checkpoints/</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>)) </span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">for</span> f <span class="kw">in</span> os.listdir(<span class="st">'checkpoints'</span>) </span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> f.endswith(<span class="st">'.json'</span>)])</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    eval_df.to_csv(<span class="st">'eval_df.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    eval_df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="results" class="level1">
<h1>Results</h1>
<p>Finally, I will evaluate the performance of the methods by looking at how well each method agreed with the human judgments. I’ll use Krippendorff’s alpha to measure agreement, since it is a robust measure of agreement that can handle non-binary ratings (among other things).</p>
<div id="aecfb567" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> krippendorff <span class="im">import</span> alpha</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_agreement(df, rater1_col, rater2_col):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate Krippendorff's alpha between two raters.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">        df: DataFrame containing the ratings</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">        rater1_col: Name of first rater's column</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">        rater2_col: Name of second rater's column</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">        float: Krippendorff's alpha score</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create label encoder</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    le <span class="op">=</span> LabelEncoder()</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all unique values from both columns</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    all_values <span class="op">=</span> pd.concat([df[rater1_col], df[rater2_col]]).unique()</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    le.fit(all_values)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the ratings to numeric values</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    ratings1 <span class="op">=</span> le.transform(df[rater1_col].fillna(<span class="st">'missing'</span>))</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    ratings2 <span class="op">=</span> le.transform(df[rater2_col].fillna(<span class="st">'missing'</span>))</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape data for krippendorff alpha calculation</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Each row represents one item, each column represents one rater</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    reliability_data <span class="op">=</span> np.vstack([ratings1, ratings2])</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha(reliability_data<span class="op">=</span>reliability_data, level_of_measurement<span class="op">=</span><span class="st">'nominal'</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate agreement scores</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>human_baseline_agreement <span class="op">=</span> calculate_agreement(eval_df, <span class="st">'human_winner'</span>, <span class="st">'baseline_winner'</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>human_samre_agreement <span class="op">=</span> calculate_agreement(eval_df, <span class="st">'human_winner'</span>, <span class="st">'samre_winner'</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with the agreement scores</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>agreement_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Evaluator Pair'</span>: [<span class="st">'Human-Baseline'</span>, <span class="st">'Human-SAMRE'</span>],</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Krippendorff Alpha'</span>: [human_baseline_agreement, human_samre_agreement]</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Round the scores to 3 decimal places</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>agreement_df[<span class="st">'Krippendorff Alpha'</span>] <span class="op">=</span> agreement_df[<span class="st">'Krippendorff Alpha'</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>agreement_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Evaluator Pair</th>
<th data-quarto-table-cell-role="th">Krippendorff Alpha</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Human-Baseline</td>
<td>0.364</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Human-SAMRE</td>
<td>0.215</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Although neither method yielded particularly strong agreement with the human judges, the Baseline method yielded significantly better agreement than the SAMRE method: 0.364 vs.&nbsp;0.215. This is contrary to the paper, which reported a gain of 6-8% for SAMRE over baseline.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tylerburleigh\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="tylerburleigh/tylerburleigh.github.io" data-repo-id="R_kgDOKMo8ww" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb8" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "A test of the Single Advocate Multi-Round Evaluation (SAMRE) method for LLM evaluation, and the importance of using a baseline model that implements standard best practices"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-01-05</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "In this post I consider a model for evaluating LLM outputs through an iterative debate process that was reported in a recent paper in arXiv. I find that the baseline model reported in this paper did not implement what I would consider to be standard best practices and therefore is not a fair comparison for the newly proposed method. I then implement a new baseline model that does implement these best practices, and find that this improved baseline model yields better agreement with human judges than an implementation of the proposed method. This serves to highlight the importance of implementing standard best practices in baseline models, as well as the being skeptical of claims in research papers that compare new methods to a baseline."</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - prompt-engineering</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - python</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - LLM-as-judge</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - LLM-evals</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="an">freeze:</span><span class="co"> true</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>I've been doing a lot of work with LLM-based evaluations lately, and I've been thinking about how to improve the quality of these evaluations.</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>I like to read research papers from arXiv for inspiration, and I recently came across a paper called <span class="co">[</span><span class="ot">Adversarial Multi-Agent Evaluation of Large Language Models through Iterative Debates</span><span class="co">](https://arxiv.org/abs/2410.04663)</span>, which introduces a new method inspired by judicial process called Single Advocate Multi-Round Evaluation (SAMRE). Briefly, the SAMRE method evaluates the quality of different LLM outputs through an iterative debate process.</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>I was initially impressed by the results, as they reported a gain of 6-8% over the baseline method. However, I am often skeptical of comparisons to "baseline" in these research papers, as I find that they often fail to implement standard best practices and are therefore not represenative of a true baseline model.</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>I decided to try and reproduce some of the methods of the paper, while creating a baseline that does implement standard best practices for prompt engineering.</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>Using a sample of 500 conversations from MT-bench for testing and evaluation, I find that contrary to the paper, SAMRE is inferior to baseline.</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>This serves to highlight the importance of implementing standard best practices in baseline models, as well as being skeptical of claims in research papers that compare new methods to a "baseline model".</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="fu"># Baseline model inadequacies</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>First, let's consider some of the inadequacies in the Baseline model's prompt reported in the paper. The prompt they used was as follows:</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="in">You are a fair, impartial judge scoring a debate on the following question:</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="in">question.</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="in">Answer 1: answer1</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="in">Answer 2: answer2</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="in">Score each answer on a scale of 1-20 for each of the following criteria:</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="in">1. Relevance to the question</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="in">2. Accuracy of information and use of credible sources</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="in">3. Depth of analysis and completeness of argument</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="in">4. Clarity of expression and logical flow</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="in">5. Strength of reasoning and factual support</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="in">6. Effectiveness in addressing opponent’s points</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="in">Provide scores as [Answer1_score, Answer2_score] for each criterion in a list format, then sum for final scores. Please keep an eye on the slightest difference that should make a difference in the scoring. Don’t overthink!</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="in">Relevance:</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="in">Accuracy:</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="in">Depth:</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="in">Clarity:</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="in">Logic and Factuality:</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="in">Addressing opponent’s points:</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="in">Final Scores (sum of above) as a tuple (example: (18, 9)):</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="in">Explain your scoring, focusing on why one answer is better than the other based on the criteria above. Keep your explanation concise but informative.</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="in">Finally, return the final score tuple (score1, score2) as a tuple (in parentheses).</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="in">Example: (18, 9)</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="in">Your scores and explanation:</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>First, the prompt does not use any delimiters for the inputs. I would enclose the inputs inside XML tags like &lt;Question&gt;&lt;/Question&gt;, &lt;Answer1&gt;&lt;/Answer1&gt;, and &lt;Answer2&gt;&lt;/Answer2&gt;, but in a pinch delimiters like triple backticks can be used.</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>Second, the prompt instructs the model to first generate scores in list format, and then to sum them. But as we know, language models models often make arithmetic mistakes. It would be better to ask the model to generate scores for each criterion, and then to programmatically extract and summarize them in python (or another programming language) from which the routine is run.</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>Third, although the prompt asks the model to "explain your scoring", it is not clear if the model should be reasoning about each criterion before it scores them, or if it should provide reasoning at the end when giving its final score. I would ask the model to provide reasoning for each criterion that it is asked to score, and ask it to reason before scoring.</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>Fourth, it's unclear why a scale of 1-20 is used. This is not a standard scale for scoring. I would use a scale of 1-10 or 0-10 which is likely more familiar to the model and can be expected to be used more consistently.</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>Fifth, although the prompt does suggest that the model provide its scores in tuple format, it would be better to provide more explicit format instructions.</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>Finally, although this goes beyond the prompt itself (and is not something that I address with my improved baseline), it is worth noting that comparing a multi-round method to a single-round method is also an unfair comparison. Instead, it would be better to compare the SAMRE method to a baseline that uses the same number of rounds and then similarly averages its scores.</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>With all of that in mind, here's how I would rewrite the prompt:</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a><span class="in">You're a critical, impartial judge scoring the performance of</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="in">two answers, Answer1 and Answer2, on a list of Criteria, based on</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="in">the DefenseForAnswer1 and DefenseForAnswer2. </span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Answer1&gt;</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="in">{answer1}</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Answer1&gt;</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Answer2&gt;</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="in">{answer2}</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Answer2&gt;</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;DefenseForAnswer1&gt;</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="in">{defense1}</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/DefenseForAnswer1&gt;</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;DefenseForAnswer2&gt;</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="in">{defense2}</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/DefenseForAnswer2&gt;</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criteria&gt;</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion1&gt;Relevance to their task&lt;/Criterion1&gt;</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion2&gt;Accuracy and credible sources&lt;/Criterion2&gt;</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion3&gt;Depth and completeness&lt;/Criterion3&gt;</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion4&gt;Clarity and logical flow&lt;/Criterion4&gt;</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion5&gt;Reasoning and factual support&lt;/Criterion5&gt;</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion6&gt;Effectiveness addressing opponent&lt;/Criterion6&gt;</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Criteria&gt;</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a><span class="in">For each Criterion in the Criteria, briefly analyze </span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a><span class="in">the performance of the two answers based on the </span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a><span class="in">DefenseForAnswer1 and DefenseForAnswer2, then </span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a><span class="in">render a score between 0 and 10.</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a><span class="in">Respond as follows:</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion1&gt;</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Analysis&gt;</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="in">Answer 1: [Brief thoughts about Answer 1 performance on the Criterion, based on the DefenseForAnswer1]</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a><span class="in">Answer 2: [Brief thoughts about Answer 2 performance on the Criterion, based on the DefenseForAnswer2]</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Analysis&gt;</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Scores&gt;</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Answer1Score&gt;[score between 0 and 10]&lt;/Answer1Score&gt;</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Answer2Score&gt;[score between 0 and 10]&lt;/Answer2Score&gt;</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Scores&gt;</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Criterion1&gt;</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Criterion2&gt;</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Analysis&gt;</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a><span class="in">Answer 1: [Brief thoughts about Answer 1 performance on the Criterion, based on the DefenseForAnswer1]</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="in">Answer 2: [Brief thoughts about Answer 2 performance on the Criterion, based on the DefenseForAnswer2]</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Analysis&gt;</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Scores&gt;</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Answer1Score&gt;[score between 0 and 10]&lt;/Answer1Score&gt;</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;Answer2Score&gt;[score between 0 and 10]&lt;/Answer2Score&gt;</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Scores&gt;</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/Criterion2&gt;</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a><span class="in">...</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>Notice that the prompt now uses XML tags to structure the instructions, that it asks the model to provide reasoning for each criterion before scoring, and that it gives the model a clear format for its response that reinforces analysis before scoring for each criterion.</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>I've also change the scale from 1-20 to 1-10, and removed the instruction to summarize the scores, as I would handle this within the code.</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a><span class="fu"># My implementation of SAMRE and Baseline</span></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>Okay, so with that criticism out of the way, let's implement the SAMRE and Baseline methods. Below is my python implementation of the SAMRE and Baseline methods. I've modified the "scorer prompt" within the SAMRE method to use the same format as the Baseline method, and I've made a few adjustments to the prompts so they can handle conversation data as input (which is what the MT-bench dataset contains by default) instead of question-answer pairs. For example, instead of asking the model to score two answers to a question, the model is asked to score two "candidates" in a debate. I've also modified the structure of prompts to use XML tags throughout.</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass, field</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Dict</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> AsyncOpenAI</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> asynccontextmanager</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the prompts</span></span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>PROMPTS <span class="op">=</span> {</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a><span class="st">"defend_prompt"</span>: <span class="st">"""</span></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a><span class="st">You're an eloquent advocate (Advocate </span><span class="sc">{advocate_id}</span><span class="st">), making</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a><span class="st">a case for Candidate A. Your Opponent is advocating for Candidate B.</span></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a><span class="st">Use the Latest Feedback, Opponent's Last Argument, and Your Team's</span></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a><span class="st">Previous Arguments to improve your case for Candidate A.</span></span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;LatestFeedback&gt;</span></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a><span class="sc">{feedback}</span></span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/LatestFeedback&gt;</span></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;OpponentLastArgument&gt;</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a><span class="sc">{opponent_argument}</span></span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/OpponentLastArgument&gt;</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;TeamPreviousArguments&gt;</span></span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a><span class="sc">{team_arguments}</span></span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/TeamPreviousArguments&gt;</span></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a><span class="st">Respond in under 80 words.</span></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a><span class="st">Your defense:</span></span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a><span class="st">"judge_prompt"</span>: <span class="st">"""</span></span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a><span class="st">You're a fair, impartial judge in a competition between two</span></span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a><span class="st">candidates, Candidate A and Candidate B, to determine which</span></span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a><span class="st">is performing better at their task.</span></span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a><span class="st">Advocates are making their case for their respective candidates.</span></span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a><span class="st">Your task is to provide feedback that will help advocates improve </span></span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a><span class="st">and differentiate their arguments more clearly. Use the following</span></span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a><span class="st">information to guide your feedback:</span></span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CurrentRound&gt;</span></span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a><span class="sc">{current_round}</span></span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CurrentRound&gt;</span></span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;TotalRounds&gt;</span></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a><span class="sc">{total_rounds}</span></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/TotalRounds&gt;</span></span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;PreviousScores&gt;</span></span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a><span class="sc">{previous_scores}</span></span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/PreviousScores&gt;</span></span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateA&gt;</span></span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense1}</span></span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateA&gt;</span></span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateB&gt;</span></span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense2}</span></span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateB&gt;</span></span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a><span class="st">Provide specific, constructive feedback in under 50 words:</span></span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a><span class="st">"score_prompt_samre"</span>: <span class="st">"""</span></span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a><span class="st">You're a critical, impartial judge scoring the performance of</span></span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a><span class="st">two candidates, Candidate A and Candidate B, on a list of Criteria,</span></span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a><span class="st">based on the DefenseForCandidateA and DefenseForCandidateB. </span></span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateA&gt;</span></span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense1}</span></span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateA&gt;</span></span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;DefenseForCandidateB&gt;</span></span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a><span class="sc">{defense2}</span></span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/DefenseForCandidateB&gt;</span></span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criteria&gt;</span></span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;Relevance to their task&lt;/Criterion1&gt;</span></span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;Accuracy and credible sources&lt;/Criterion2&gt;</span></span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion3&gt;Depth and completeness&lt;/Criterion3&gt;</span></span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion4&gt;Clarity and logical flow&lt;/Criterion4&gt;</span></span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion5&gt;Reasoning and factual support&lt;/Criterion5&gt;</span></span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion6&gt;Effectiveness addressing opponent&lt;/Criterion6&gt;</span></span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criteria&gt;</span></span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a><span class="st">For each Criterion in the Criteria, briefly analyze </span></span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a><span class="st">the performance of the two candidates based on the </span></span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a><span class="st">DefenseForCandidateA and DefenseForCandidateB, then </span></span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a><span class="st">render a score between 0 and 10.</span></span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a><span class="st">Respond as follows:</span></span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;</span></span>
<span id="cb8-260"><a href="#cb8-260" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb8-261"><a href="#cb8-261" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion, based on the DefenseForCandidateA]</span></span>
<span id="cb8-262"><a href="#cb8-262" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion, based on the DefenseForCandidateB]</span></span>
<span id="cb8-263"><a href="#cb8-263" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb8-264"><a href="#cb8-264" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb8-265"><a href="#cb8-265" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb8-266"><a href="#cb8-266" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb8-267"><a href="#cb8-267" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb8-268"><a href="#cb8-268" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion1&gt;</span></span>
<span id="cb8-269"><a href="#cb8-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-270"><a href="#cb8-270" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;</span></span>
<span id="cb8-271"><a href="#cb8-271" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb8-272"><a href="#cb8-272" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion, based on the DefenseForCandidateA]</span></span>
<span id="cb8-273"><a href="#cb8-273" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion, based on the DefenseForCandidateB]</span></span>
<span id="cb8-274"><a href="#cb8-274" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb8-275"><a href="#cb8-275" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb8-276"><a href="#cb8-276" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb8-277"><a href="#cb8-277" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb8-278"><a href="#cb8-278" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb8-279"><a href="#cb8-279" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion2&gt;</span></span>
<span id="cb8-280"><a href="#cb8-280" aria-hidden="true" tabindex="-1"></a><span class="st">...</span></span>
<span id="cb8-281"><a href="#cb8-281" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>,</span>
<span id="cb8-282"><a href="#cb8-282" aria-hidden="true" tabindex="-1"></a><span class="st">"score_prompt_baseline"</span>: <span class="st">"""</span></span>
<span id="cb8-283"><a href="#cb8-283" aria-hidden="true" tabindex="-1"></a><span class="st">You're a critical, impartial judge scoring the performance of</span></span>
<span id="cb8-284"><a href="#cb8-284" aria-hidden="true" tabindex="-1"></a><span class="st">two candidates, Candidate A and Candidate B, on a list of Criteria. </span></span>
<span id="cb8-285"><a href="#cb8-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-286"><a href="#cb8-286" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateA&gt;</span></span>
<span id="cb8-287"><a href="#cb8-287" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_a}</span></span>
<span id="cb8-288"><a href="#cb8-288" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateA&gt;</span></span>
<span id="cb8-289"><a href="#cb8-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-290"><a href="#cb8-290" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateB&gt;</span></span>
<span id="cb8-291"><a href="#cb8-291" aria-hidden="true" tabindex="-1"></a><span class="sc">{candidate_b}</span></span>
<span id="cb8-292"><a href="#cb8-292" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/CandidateB&gt;</span></span>
<span id="cb8-293"><a href="#cb8-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-294"><a href="#cb8-294" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criteria&gt;</span></span>
<span id="cb8-295"><a href="#cb8-295" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;Relevance to their task&lt;/Criterion1&gt;</span></span>
<span id="cb8-296"><a href="#cb8-296" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;Accuracy and credible sources&lt;/Criterion2&gt;</span></span>
<span id="cb8-297"><a href="#cb8-297" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion3&gt;Depth and completeness&lt;/Criterion3&gt;</span></span>
<span id="cb8-298"><a href="#cb8-298" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion4&gt;Clarity and logical flow&lt;/Criterion4&gt;</span></span>
<span id="cb8-299"><a href="#cb8-299" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion5&gt;Reasoning and factual support&lt;/Criterion5&gt;</span></span>
<span id="cb8-300"><a href="#cb8-300" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion6&gt;Effectiveness addressing opponent&lt;/Criterion6&gt;</span></span>
<span id="cb8-301"><a href="#cb8-301" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criteria&gt;</span></span>
<span id="cb8-302"><a href="#cb8-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-303"><a href="#cb8-303" aria-hidden="true" tabindex="-1"></a><span class="st">For each Criterion in the Criteria, briefly analyze </span></span>
<span id="cb8-304"><a href="#cb8-304" aria-hidden="true" tabindex="-1"></a><span class="st">the performance of the two candidates, then render a score </span></span>
<span id="cb8-305"><a href="#cb8-305" aria-hidden="true" tabindex="-1"></a><span class="st">between 0 and 10.</span></span>
<span id="cb8-306"><a href="#cb8-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-307"><a href="#cb8-307" aria-hidden="true" tabindex="-1"></a><span class="st">Respond as follows:</span></span>
<span id="cb8-308"><a href="#cb8-308" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion1&gt;</span></span>
<span id="cb8-309"><a href="#cb8-309" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb8-310"><a href="#cb8-310" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion]</span></span>
<span id="cb8-311"><a href="#cb8-311" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion]</span></span>
<span id="cb8-312"><a href="#cb8-312" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb8-313"><a href="#cb8-313" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb8-314"><a href="#cb8-314" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb8-315"><a href="#cb8-315" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb8-316"><a href="#cb8-316" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb8-317"><a href="#cb8-317" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion1&gt;</span></span>
<span id="cb8-318"><a href="#cb8-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-319"><a href="#cb8-319" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Criterion2&gt;</span></span>
<span id="cb8-320"><a href="#cb8-320" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Analysis&gt;</span></span>
<span id="cb8-321"><a href="#cb8-321" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate A: [Brief thoughts about Candidate A's performance on the Criterion]</span></span>
<span id="cb8-322"><a href="#cb8-322" aria-hidden="true" tabindex="-1"></a><span class="st">Candidate B: [Brief thoughts about Candidate B's performance on the Criterion]</span></span>
<span id="cb8-323"><a href="#cb8-323" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Analysis&gt;</span></span>
<span id="cb8-324"><a href="#cb8-324" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;Scores&gt;</span></span>
<span id="cb8-325"><a href="#cb8-325" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateAScore&gt;[score between 0 and 10]&lt;/CandidateAScore&gt;</span></span>
<span id="cb8-326"><a href="#cb8-326" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;CandidateBScore&gt;[score between 0 and 10]&lt;/CandidateBScore&gt;</span></span>
<span id="cb8-327"><a href="#cb8-327" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Scores&gt;</span></span>
<span id="cb8-328"><a href="#cb8-328" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/Criterion2&gt;</span></span>
<span id="cb8-329"><a href="#cb8-329" aria-hidden="true" tabindex="-1"></a><span class="st">...</span></span>
<span id="cb8-330"><a href="#cb8-330" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb8-331"><a href="#cb8-331" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-332"><a href="#cb8-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-333"><a href="#cb8-333" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb8-334"><a href="#cb8-334" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Memory:</span>
<span id="cb8-335"><a href="#cb8-335" aria-hidden="true" tabindex="-1"></a>    arguments: List[Tuple[<span class="bu">str</span>, <span class="bu">str</span>]] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb8-336"><a href="#cb8-336" aria-hidden="true" tabindex="-1"></a>    scores: List[Tuple[<span class="bu">float</span>, <span class="bu">float</span>]] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb8-337"><a href="#cb8-337" aria-hidden="true" tabindex="-1"></a>    feedback: List[<span class="bu">str</span>] <span class="op">=</span> field(default_factory<span class="op">=</span><span class="bu">list</span>)</span>
<span id="cb8-338"><a href="#cb8-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-339"><a href="#cb8-339" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelEvaluator:</span>
<span id="cb8-340"><a href="#cb8-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb8-341"><a href="#cb8-341" aria-hidden="true" tabindex="-1"></a>    <span class="at">@asynccontextmanager</span></span>
<span id="cb8-342"><a href="#cb8-342" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> create(cls, mode<span class="op">=</span><span class="st">"samre"</span>, model<span class="op">=</span><span class="st">"gpt-4o-mini"</span>, logging_level<span class="op">=</span>logging.WARNING):</span>
<span id="cb8-343"><a href="#cb8-343" aria-hidden="true" tabindex="-1"></a>        instance <span class="op">=</span> cls(mode<span class="op">=</span>mode, model<span class="op">=</span>model, logging_level<span class="op">=</span>logging_level)</span>
<span id="cb8-344"><a href="#cb8-344" aria-hidden="true" tabindex="-1"></a>        instance.client <span class="op">=</span> AsyncOpenAI()</span>
<span id="cb8-345"><a href="#cb8-345" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-346"><a href="#cb8-346" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> instance</span>
<span id="cb8-347"><a href="#cb8-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb8-348"><a href="#cb8-348" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> instance.client.close()</span>
<span id="cb8-349"><a href="#cb8-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-350"><a href="#cb8-350" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _setup_logger(<span class="va">self</span>, logging_level):</span>
<span id="cb8-351"><a href="#cb8-351" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Setup logger with word wrapping."""</span></span>
<span id="cb8-352"><a href="#cb8-352" aria-hidden="true" tabindex="-1"></a>        logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb8-353"><a href="#cb8-353" aria-hidden="true" tabindex="-1"></a>        logger.setLevel(logging_level)</span>
<span id="cb8-354"><a href="#cb8-354" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> logger.handlers:</span>
<span id="cb8-355"><a href="#cb8-355" aria-hidden="true" tabindex="-1"></a>            handler <span class="op">=</span> logging.StreamHandler()</span>
<span id="cb8-356"><a href="#cb8-356" aria-hidden="true" tabindex="-1"></a>            <span class="kw">class</span> WrapFormatter(logging.Formatter):</span>
<span id="cb8-357"><a href="#cb8-357" aria-hidden="true" tabindex="-1"></a>                <span class="kw">def</span> <span class="bu">format</span>(<span class="va">self</span>, record):</span>
<span id="cb8-358"><a href="#cb8-358" aria-hidden="true" tabindex="-1"></a>                    <span class="im">import</span> textwrap</span>
<span id="cb8-359"><a href="#cb8-359" aria-hidden="true" tabindex="-1"></a>                    message <span class="op">=</span> <span class="bu">super</span>().<span class="bu">format</span>(record)</span>
<span id="cb8-360"><a href="#cb8-360" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join(textwrap.fill(line, width<span class="op">=</span><span class="dv">80</span>) </span>
<span id="cb8-361"><a href="#cb8-361" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">for</span> line <span class="kw">in</span> message.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>))</span>
<span id="cb8-362"><a href="#cb8-362" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-363"><a href="#cb8-363" aria-hidden="true" tabindex="-1"></a>            formatter <span class="op">=</span> WrapFormatter(<span class="st">'</span><span class="sc">%(message)s</span><span class="st">'</span>)</span>
<span id="cb8-364"><a href="#cb8-364" aria-hidden="true" tabindex="-1"></a>            handler.setFormatter(formatter)</span>
<span id="cb8-365"><a href="#cb8-365" aria-hidden="true" tabindex="-1"></a>            logger.addHandler(handler)</span>
<span id="cb8-366"><a href="#cb8-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> logger</span>
<span id="cb8-367"><a href="#cb8-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-368"><a href="#cb8-368" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, mode<span class="op">=</span><span class="st">"samre"</span>, model<span class="op">=</span><span class="st">"gpt-4o-mini"</span>, logging_level<span class="op">=</span>logging.WARNING):</span>
<span id="cb8-369"><a href="#cb8-369" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mode <span class="op">=</span> mode</span>
<span id="cb8-370"><a href="#cb8-370" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb8-371"><a href="#cb8-371" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_rounds <span class="op">=</span> <span class="dv">4</span> <span class="cf">if</span> mode <span class="op">==</span> <span class="st">"samre"</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb8-372"><a href="#cb8-372" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger <span class="op">=</span> <span class="va">self</span>._setup_logger(logging_level)</span>
<span id="cb8-373"><a href="#cb8-373" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-374"><a href="#cb8-374" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize all prompts</span></span>
<span id="cb8-375"><a href="#cb8-375" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.defend_prompt <span class="op">=</span> PROMPTS[<span class="st">"defend_prompt"</span>]</span>
<span id="cb8-376"><a href="#cb8-376" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.judge_prompt <span class="op">=</span> PROMPTS[<span class="st">"judge_prompt"</span>]</span>
<span id="cb8-377"><a href="#cb8-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-378"><a href="#cb8-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> get_completion(<span class="va">self</span>, prompt: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-379"><a href="#cb8-379" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get a completion from the OpenAI API."""</span></span>
<span id="cb8-380"><a href="#cb8-380" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client:</span>
<span id="cb8-381"><a href="#cb8-381" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"Evaluator must be created using 'async with ModelEvaluator.create() as evaluator:'"</span>)</span>
<span id="cb8-382"><a href="#cb8-382" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-383"><a href="#cb8-383" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.client.chat.completions.create(</span>
<span id="cb8-384"><a href="#cb8-384" aria-hidden="true" tabindex="-1"></a>            model<span class="op">=</span><span class="va">self</span>.model,</span>
<span id="cb8-385"><a href="#cb8-385" aria-hidden="true" tabindex="-1"></a>            messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: prompt}],</span>
<span id="cb8-386"><a href="#cb8-386" aria-hidden="true" tabindex="-1"></a>            temperature<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-387"><a href="#cb8-387" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-388"><a href="#cb8-388" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="cb8-389"><a href="#cb8-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-390"><a href="#cb8-390" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _extract_final_scores(<span class="va">self</span>, score_response: <span class="bu">str</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb8-391"><a href="#cb8-391" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Extract and sum scores from all criteria sections."""</span></span>
<span id="cb8-392"><a href="#cb8-392" aria-hidden="true" tabindex="-1"></a>        score_a_pattern <span class="op">=</span> <span class="vs">r'&lt;CandidateAScore&gt;\s*(\d+\.?\d*)\s*&lt;/CandidateAScore&gt;'</span></span>
<span id="cb8-393"><a href="#cb8-393" aria-hidden="true" tabindex="-1"></a>        score_b_pattern <span class="op">=</span> <span class="vs">r'&lt;CandidateBScore&gt;\s*(\d+\.?\d*)\s*&lt;/CandidateBScore&gt;'</span></span>
<span id="cb8-394"><a href="#cb8-394" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-395"><a href="#cb8-395" aria-hidden="true" tabindex="-1"></a>        scores_a <span class="op">=</span> [<span class="bu">float</span>(match.group(<span class="dv">1</span>)) <span class="cf">for</span> match <span class="kw">in</span> re.finditer(score_a_pattern, score_response)]</span>
<span id="cb8-396"><a href="#cb8-396" aria-hidden="true" tabindex="-1"></a>        scores_b <span class="op">=</span> [<span class="bu">float</span>(match.group(<span class="dv">1</span>)) <span class="cf">for</span> match <span class="kw">in</span> re.finditer(score_b_pattern, score_response)]</span>
<span id="cb8-397"><a href="#cb8-397" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-398"><a href="#cb8-398" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> scores_a <span class="kw">or</span> <span class="kw">not</span> scores_b:</span>
<span id="cb8-399"><a href="#cb8-399" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Could not find scores for both candidates"</span>)</span>
<span id="cb8-400"><a href="#cb8-400" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-401"><a href="#cb8-401" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(scores_a) <span class="op">!=</span> <span class="bu">len</span>(scores_b):</span>
<span id="cb8-402"><a href="#cb8-402" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Mismatched number of scores: A=</span><span class="sc">{</span><span class="bu">len</span>(scores_a)<span class="sc">}</span><span class="ss">, B=</span><span class="sc">{</span><span class="bu">len</span>(scores_b)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-403"><a href="#cb8-403" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-404"><a href="#cb8-404" aria-hidden="true" tabindex="-1"></a>        final_score_a <span class="op">=</span> <span class="bu">sum</span>(scores_a) <span class="op">/</span> <span class="bu">len</span>(scores_a)</span>
<span id="cb8-405"><a href="#cb8-405" aria-hidden="true" tabindex="-1"></a>        final_score_b <span class="op">=</span> <span class="bu">sum</span>(scores_b) <span class="op">/</span> <span class="bu">len</span>(scores_b)</span>
<span id="cb8-406"><a href="#cb8-406" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-407"><a href="#cb8-407" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (final_score_a, final_score_b)</span>
<span id="cb8-408"><a href="#cb8-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-409"><a href="#cb8-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> evaluate(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb8-410"><a href="#cb8-410" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Main evaluation method that branches based on mode."""</span></span>
<span id="cb8-411"><a href="#cb8-411" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client:</span>
<span id="cb8-412"><a href="#cb8-412" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">RuntimeError</span>(<span class="st">"Evaluator must be created using 'async with ModelEvaluator.create() as evaluator:'"</span>)</span>
<span id="cb8-413"><a href="#cb8-413" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-414"><a href="#cb8-414" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.mode <span class="op">==</span> <span class="st">"baseline"</span>:</span>
<span id="cb8-415"><a href="#cb8-415" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Starting Baseline Evaluation ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb8-416"><a href="#cb8-416" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>._evaluate_baseline(candidate_a, candidate_b)</span>
<span id="cb8-417"><a href="#cb8-417" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-418"><a href="#cb8-418" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Starting SAMRE Evaluation ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb8-419"><a href="#cb8-419" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>._evaluate_samre(candidate_a, candidate_b)</span>
<span id="cb8-420"><a href="#cb8-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-421"><a href="#cb8-421" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _evaluate_baseline(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb8-422"><a href="#cb8-422" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Simple baseline evaluation."""</span></span>
<span id="cb8-423"><a href="#cb8-423" aria-hidden="true" tabindex="-1"></a>        score_prompt <span class="op">=</span> PROMPTS[<span class="st">"score_prompt_baseline"</span>].<span class="bu">format</span>(</span>
<span id="cb8-424"><a href="#cb8-424" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb8-425"><a href="#cb8-425" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b</span>
<span id="cb8-426"><a href="#cb8-426" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-427"><a href="#cb8-427" aria-hidden="true" tabindex="-1"></a>        score_response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(score_prompt)</span>
<span id="cb8-428"><a href="#cb8-428" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"Score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-429"><a href="#cb8-429" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-430"><a href="#cb8-430" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-431"><a href="#cb8-431" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="va">self</span>._extract_final_scores(score_response)</span>
<span id="cb8-432"><a href="#cb8-432" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-433"><a href="#cb8-433" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Score parsing error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-434"><a href="#cb8-434" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Raw score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-435"><a href="#cb8-435" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> (<span class="fl">10.0</span>, <span class="fl">10.0</span>)</span>
<span id="cb8-436"><a href="#cb8-436" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-437"><a href="#cb8-437" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-438"><a href="#cb8-438" aria-hidden="true" tabindex="-1"></a>            <span class="st">"winner"</span>: <span class="st">'model_a'</span> <span class="cf">if</span> scores[<span class="dv">0</span>] <span class="op">&gt;</span> scores[<span class="dv">1</span>] <span class="cf">else</span> <span class="st">'model_b'</span> <span class="cf">if</span> scores[<span class="dv">1</span>] <span class="op">&gt;</span> scores[<span class="dv">0</span>] <span class="cf">else</span> <span class="st">'tie'</span>,</span>
<span id="cb8-439"><a href="#cb8-439" aria-hidden="true" tabindex="-1"></a>            <span class="st">"average_scores"</span>: scores,</span>
<span id="cb8-440"><a href="#cb8-440" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rounds"</span>: <span class="dv">1</span>,</span>
<span id="cb8-441"><a href="#cb8-441" aria-hidden="true" tabindex="-1"></a>            <span class="st">"score_history"</span>: [<span class="bu">list</span>(scores)],</span>
<span id="cb8-442"><a href="#cb8-442" aria-hidden="true" tabindex="-1"></a>            <span class="st">"full_response"</span>: score_response</span>
<span id="cb8-443"><a href="#cb8-443" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-444"><a href="#cb8-444" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-445"><a href="#cb8-445" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _evaluate_samre(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb8-446"><a href="#cb8-446" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Full SAMRE evaluation with debate rounds."""</span></span>
<span id="cb8-447"><a href="#cb8-447" aria-hidden="true" tabindex="-1"></a>        local_memory <span class="op">=</span> Memory()</span>
<span id="cb8-448"><a href="#cb8-448" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-449"><a href="#cb8-449" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">=== Starting SAMRE Evaluation ===</span><span class="ch">\n</span><span class="st">"</span>)</span>
<span id="cb8-450"><a href="#cb8-450" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-451"><a href="#cb8-451" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> round_num <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.max_rounds):</span>
<span id="cb8-452"><a href="#cb8-452" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Round </span><span class="sc">{</span>round_num <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb8-453"><a href="#cb8-453" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-454"><a href="#cb8-454" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._run_debate_round(</span>
<span id="cb8-455"><a href="#cb8-455" aria-hidden="true" tabindex="-1"></a>                candidate_a, </span>
<span id="cb8-456"><a href="#cb8-456" aria-hidden="true" tabindex="-1"></a>                candidate_b, </span>
<span id="cb8-457"><a href="#cb8-457" aria-hidden="true" tabindex="-1"></a>                round_num,</span>
<span id="cb8-458"><a href="#cb8-458" aria-hidden="true" tabindex="-1"></a>                local_memory</span>
<span id="cb8-459"><a href="#cb8-459" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-460"><a href="#cb8-460" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-461"><a href="#cb8-461" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._has_scores_converged(round_num, local_memory):</span>
<span id="cb8-462"><a href="#cb8-462" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="st">"</span><span class="ch">\n</span><span class="st">Scores have converged - ending debate early."</span>)</span>
<span id="cb8-463"><a href="#cb8-463" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb8-464"><a href="#cb8-464" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-465"><a href="#cb8-465" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._prepare_results(local_memory)</span>
<span id="cb8-466"><a href="#cb8-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-467"><a href="#cb8-467" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> defend_answer(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>, </span>
<span id="cb8-468"><a href="#cb8-468" aria-hidden="true" tabindex="-1"></a>                          advocate_id: <span class="bu">int</span>, feedback: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>, </span>
<span id="cb8-469"><a href="#cb8-469" aria-hidden="true" tabindex="-1"></a>                          opponent_argument: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span id="cb8-470"><a href="#cb8-470" aria-hidden="true" tabindex="-1"></a>                          team_arguments: List[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb8-471"><a href="#cb8-471" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get defense from an advocate."""</span></span>
<span id="cb8-472"><a href="#cb8-472" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> team_arguments <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb8-473"><a href="#cb8-473" aria-hidden="true" tabindex="-1"></a>            team_arguments <span class="op">=</span> []</span>
<span id="cb8-474"><a href="#cb8-474" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-475"><a href="#cb8-475" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> <span class="va">self</span>.defend_prompt.<span class="bu">format</span>(</span>
<span id="cb8-476"><a href="#cb8-476" aria-hidden="true" tabindex="-1"></a>            advocate_id<span class="op">=</span>advocate_id,</span>
<span id="cb8-477"><a href="#cb8-477" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb8-478"><a href="#cb8-478" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b,</span>
<span id="cb8-479"><a href="#cb8-479" aria-hidden="true" tabindex="-1"></a>            feedback<span class="op">=</span>feedback,</span>
<span id="cb8-480"><a href="#cb8-480" aria-hidden="true" tabindex="-1"></a>            opponent_argument<span class="op">=</span>opponent_argument,</span>
<span id="cb8-481"><a href="#cb8-481" aria-hidden="true" tabindex="-1"></a>            team_arguments<span class="op">=</span><span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(team_arguments)</span>
<span id="cb8-482"><a href="#cb8-482" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-483"><a href="#cb8-483" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(prompt)</span>
<span id="cb8-484"><a href="#cb8-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-485"><a href="#cb8-485" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_debate(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>,</span>
<span id="cb8-486"><a href="#cb8-486" aria-hidden="true" tabindex="-1"></a>                          defense1: <span class="bu">str</span>, defense2: <span class="bu">str</span>, </span>
<span id="cb8-487"><a href="#cb8-487" aria-hidden="true" tabindex="-1"></a>                          current_round: <span class="bu">int</span>,</span>
<span id="cb8-488"><a href="#cb8-488" aria-hidden="true" tabindex="-1"></a>                          memory: Memory) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, Tuple[<span class="bu">float</span>, <span class="bu">float</span>]]:</span>
<span id="cb8-489"><a href="#cb8-489" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Judge the debate between two answers."""</span></span>
<span id="cb8-490"><a href="#cb8-490" aria-hidden="true" tabindex="-1"></a>        feedback_prompt <span class="op">=</span> <span class="va">self</span>.judge_prompt.<span class="bu">format</span>(</span>
<span id="cb8-491"><a href="#cb8-491" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb8-492"><a href="#cb8-492" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b,</span>
<span id="cb8-493"><a href="#cb8-493" aria-hidden="true" tabindex="-1"></a>            current_round<span class="op">=</span>current_round,</span>
<span id="cb8-494"><a href="#cb8-494" aria-hidden="true" tabindex="-1"></a>            total_rounds<span class="op">=</span><span class="va">self</span>.max_rounds,</span>
<span id="cb8-495"><a href="#cb8-495" aria-hidden="true" tabindex="-1"></a>            previous_scores<span class="op">=</span>memory.scores,</span>
<span id="cb8-496"><a href="#cb8-496" aria-hidden="true" tabindex="-1"></a>            defense1<span class="op">=</span>defense1,</span>
<span id="cb8-497"><a href="#cb8-497" aria-hidden="true" tabindex="-1"></a>            defense2<span class="op">=</span>defense2</span>
<span id="cb8-498"><a href="#cb8-498" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-499"><a href="#cb8-499" aria-hidden="true" tabindex="-1"></a>        feedback <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(feedback_prompt)</span>
<span id="cb8-500"><a href="#cb8-500" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-501"><a href="#cb8-501" aria-hidden="true" tabindex="-1"></a>        score_prompt <span class="op">=</span> PROMPTS[<span class="st">"score_prompt_baseline"</span>].<span class="bu">format</span>(</span>
<span id="cb8-502"><a href="#cb8-502" aria-hidden="true" tabindex="-1"></a>            candidate_a<span class="op">=</span>candidate_a,</span>
<span id="cb8-503"><a href="#cb8-503" aria-hidden="true" tabindex="-1"></a>            candidate_b<span class="op">=</span>candidate_b,</span>
<span id="cb8-504"><a href="#cb8-504" aria-hidden="true" tabindex="-1"></a>            defense1<span class="op">=</span>defense1,</span>
<span id="cb8-505"><a href="#cb8-505" aria-hidden="true" tabindex="-1"></a>            defense2<span class="op">=</span>defense2</span>
<span id="cb8-506"><a href="#cb8-506" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-507"><a href="#cb8-507" aria-hidden="true" tabindex="-1"></a>        score_response <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.get_completion(score_prompt)    </span>
<span id="cb8-508"><a href="#cb8-508" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"Score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-509"><a href="#cb8-509" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-510"><a href="#cb8-510" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-511"><a href="#cb8-511" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="va">self</span>._extract_final_scores(score_response)</span>
<span id="cb8-512"><a href="#cb8-512" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-513"><a href="#cb8-513" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Score parsing error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-514"><a href="#cb8-514" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f"Raw score response: </span><span class="sc">{</span>score_response<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-515"><a href="#cb8-515" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> (<span class="fl">10.0</span>, <span class="fl">10.0</span>)</span>
<span id="cb8-516"><a href="#cb8-516" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-517"><a href="#cb8-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> feedback, scores</span>
<span id="cb8-518"><a href="#cb8-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-519"><a href="#cb8-519" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _run_debate_round(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>, </span>
<span id="cb8-520"><a href="#cb8-520" aria-hidden="true" tabindex="-1"></a>                               round_num: <span class="bu">int</span>, memory: Memory) <span class="op">-&gt;</span> Tuple[<span class="bu">float</span>, <span class="bu">float</span>]:</span>
<span id="cb8-521"><a href="#cb8-521" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Execute a single round of debate between advocates."""</span></span>
<span id="cb8-522"><a href="#cb8-522" aria-hidden="true" tabindex="-1"></a>        defenses <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._get_advocate_defenses(candidate_a, candidate_b, memory)</span>
<span id="cb8-523"><a href="#cb8-523" aria-hidden="true" tabindex="-1"></a>        memory.arguments.append(defenses)</span>
<span id="cb8-524"><a href="#cb8-524" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-525"><a href="#cb8-525" aria-hidden="true" tabindex="-1"></a>        feedback, scores <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.judge_debate(</span>
<span id="cb8-526"><a href="#cb8-526" aria-hidden="true" tabindex="-1"></a>            candidate_a, candidate_b, defenses[<span class="dv">0</span>], defenses[<span class="dv">1</span>], round_num <span class="op">+</span> <span class="dv">1</span>, memory</span>
<span id="cb8-527"><a href="#cb8-527" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-528"><a href="#cb8-528" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-529"><a href="#cb8-529" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._store_round_results(feedback, scores, memory)</span>
<span id="cb8-530"><a href="#cb8-530" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._display_round_results(defenses, feedback, scores)</span>
<span id="cb8-531"><a href="#cb8-531" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-532"><a href="#cb8-532" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> scores</span>
<span id="cb8-533"><a href="#cb8-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-534"><a href="#cb8-534" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _get_advocate_defenses(<span class="va">self</span>, candidate_a: <span class="bu">str</span>, candidate_b: <span class="bu">str</span>,</span>
<span id="cb8-535"><a href="#cb8-535" aria-hidden="true" tabindex="-1"></a>                                   memory: Memory) <span class="op">-&gt;</span> Tuple[<span class="bu">str</span>, <span class="bu">str</span>]:</span>
<span id="cb8-536"><a href="#cb8-536" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Get defenses from both advocates."""</span></span>
<span id="cb8-537"><a href="#cb8-537" aria-hidden="true" tabindex="-1"></a>        defense1 <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.defend_answer(</span>
<span id="cb8-538"><a href="#cb8-538" aria-hidden="true" tabindex="-1"></a>            candidate_a, candidate_b, <span class="dv">1</span>,</span>
<span id="cb8-539"><a href="#cb8-539" aria-hidden="true" tabindex="-1"></a>            feedback<span class="op">=</span>memory.feedback[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> memory.feedback <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb8-540"><a href="#cb8-540" aria-hidden="true" tabindex="-1"></a>            opponent_argument<span class="op">=</span>memory.arguments[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>] <span class="cf">if</span> memory.arguments <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb8-541"><a href="#cb8-541" aria-hidden="true" tabindex="-1"></a>            team_arguments<span class="op">=</span>[args[<span class="dv">0</span>] <span class="cf">for</span> args <span class="kw">in</span> memory.arguments]</span>
<span id="cb8-542"><a href="#cb8-542" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-543"><a href="#cb8-543" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-544"><a href="#cb8-544" aria-hidden="true" tabindex="-1"></a>        defense2 <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.defend_answer(</span>
<span id="cb8-545"><a href="#cb8-545" aria-hidden="true" tabindex="-1"></a>            candidate_a, candidate_b, <span class="dv">2</span>,</span>
<span id="cb8-546"><a href="#cb8-546" aria-hidden="true" tabindex="-1"></a>            feedback<span class="op">=</span>memory.feedback[<span class="op">-</span><span class="dv">1</span>] <span class="cf">if</span> memory.feedback <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb8-547"><a href="#cb8-547" aria-hidden="true" tabindex="-1"></a>            opponent_argument<span class="op">=</span>memory.arguments[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>] <span class="cf">if</span> memory.arguments <span class="cf">else</span> <span class="st">""</span>,</span>
<span id="cb8-548"><a href="#cb8-548" aria-hidden="true" tabindex="-1"></a>            team_arguments<span class="op">=</span>[args[<span class="dv">1</span>] <span class="cf">for</span> args <span class="kw">in</span> memory.arguments]</span>
<span id="cb8-549"><a href="#cb8-549" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-550"><a href="#cb8-550" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-551"><a href="#cb8-551" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (defense1, defense2)</span>
<span id="cb8-552"><a href="#cb8-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-553"><a href="#cb8-553" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _store_round_results(<span class="va">self</span>, feedback: <span class="bu">str</span>, scores: Tuple[<span class="bu">float</span>, <span class="bu">float</span>],</span>
<span id="cb8-554"><a href="#cb8-554" aria-hidden="true" tabindex="-1"></a>                           memory: Memory) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-555"><a href="#cb8-555" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Store feedback and scores from the round."""</span></span>
<span id="cb8-556"><a href="#cb8-556" aria-hidden="true" tabindex="-1"></a>        memory.feedback.append(feedback)</span>
<span id="cb8-557"><a href="#cb8-557" aria-hidden="true" tabindex="-1"></a>        memory.scores.append(scores)</span>
<span id="cb8-558"><a href="#cb8-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-559"><a href="#cb8-559" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _display_round_results(<span class="va">self</span>, defenses: Tuple[<span class="bu">str</span>, <span class="bu">str</span>], </span>
<span id="cb8-560"><a href="#cb8-560" aria-hidden="true" tabindex="-1"></a>                             feedback: <span class="bu">str</span>, scores: Tuple[<span class="bu">float</span>, <span class="bu">float</span>]) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb8-561"><a href="#cb8-561" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Display the results of the current round."""</span></span>
<span id="cb8-562"><a href="#cb8-562" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Advocate 1's defense:</span><span class="ch">\n</span><span class="sc">{</span>defenses[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-563"><a href="#cb8-563" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Advocate 2's defense:</span><span class="ch">\n</span><span class="sc">{</span>defenses[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-564"><a href="#cb8-564" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Judge's feedback:</span><span class="ch">\n</span><span class="sc">{</span>feedback<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-565"><a href="#cb8-565" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f"Scores for this round: Answer 1 = </span><span class="sc">{</span><span class="bu">round</span>(scores[<span class="dv">0</span>], <span class="dv">2</span>)<span class="sc">}</span><span class="ss">, Answer 2 = </span><span class="sc">{</span><span class="bu">round</span>(scores[<span class="dv">1</span>], <span class="dv">2</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-566"><a href="#cb8-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-567"><a href="#cb8-567" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _has_scores_converged(<span class="va">self</span>, round_num: <span class="bu">int</span>, memory: Memory) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb8-568"><a href="#cb8-568" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if scores have converged (same winner twice in a row)."""</span></span>
<span id="cb8-569"><a href="#cb8-569" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> round_num <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-570"><a href="#cb8-570" aria-hidden="true" tabindex="-1"></a>            prev_diff <span class="op">=</span> memory.scores[<span class="op">-</span><span class="dv">2</span>][<span class="dv">0</span>] <span class="op">-</span> memory.scores[<span class="op">-</span><span class="dv">2</span>][<span class="dv">1</span>]</span>
<span id="cb8-571"><a href="#cb8-571" aria-hidden="true" tabindex="-1"></a>            curr_diff <span class="op">=</span> memory.scores[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>] <span class="op">-</span> memory.scores[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb8-572"><a href="#cb8-572" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (prev_diff <span class="op">*</span> curr_diff) <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb8-573"><a href="#cb8-573" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-574"><a href="#cb8-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-575"><a href="#cb8-575" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _prepare_results(<span class="va">self</span>, memory: Memory) <span class="op">-&gt;</span> Dict:</span>
<span id="cb8-576"><a href="#cb8-576" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Prepare the final results dictionary."""</span></span>
<span id="cb8-577"><a href="#cb8-577" aria-hidden="true" tabindex="-1"></a>        avg_scores <span class="op">=</span> [</span>
<span id="cb8-578"><a href="#cb8-578" aria-hidden="true" tabindex="-1"></a>            <span class="bu">round</span>(<span class="bu">sum</span>(scores[i] <span class="cf">for</span> scores <span class="kw">in</span> memory.scores) <span class="op">/</span> <span class="bu">len</span>(memory.scores), <span class="dv">2</span>)</span>
<span id="cb8-579"><a href="#cb8-579" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>)</span>
<span id="cb8-580"><a href="#cb8-580" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb8-581"><a href="#cb8-581" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-582"><a href="#cb8-582" aria-hidden="true" tabindex="-1"></a>        winner <span class="op">=</span> (</span>
<span id="cb8-583"><a href="#cb8-583" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model_a'</span> <span class="cf">if</span> avg_scores[<span class="dv">0</span>] <span class="op">&gt;</span> avg_scores[<span class="dv">1</span>]</span>
<span id="cb8-584"><a href="#cb8-584" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="st">'model_b'</span> <span class="cf">if</span> avg_scores[<span class="dv">0</span>] <span class="op">&lt;</span> avg_scores[<span class="dv">1</span>]</span>
<span id="cb8-585"><a href="#cb8-585" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="st">'tie'</span></span>
<span id="cb8-586"><a href="#cb8-586" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-587"><a href="#cb8-587" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-588"><a href="#cb8-588" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb8-589"><a href="#cb8-589" aria-hidden="true" tabindex="-1"></a>            <span class="st">"winner"</span>: winner,</span>
<span id="cb8-590"><a href="#cb8-590" aria-hidden="true" tabindex="-1"></a>            <span class="st">"average_scores"</span>: avg_scores,</span>
<span id="cb8-591"><a href="#cb8-591" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rounds"</span>: <span class="bu">len</span>(memory.scores),</span>
<span id="cb8-592"><a href="#cb8-592" aria-hidden="true" tabindex="-1"></a>            <span class="st">"score_history"</span>: [[<span class="bu">round</span>(s[<span class="dv">0</span>], <span class="dv">2</span>), <span class="bu">round</span>(s[<span class="dv">1</span>], <span class="dv">2</span>)] <span class="cf">for</span> s <span class="kw">in</span> memory.scores],</span>
<span id="cb8-593"><a href="#cb8-593" aria-hidden="true" tabindex="-1"></a>            <span class="st">"argument_history"</span>: memory.arguments,</span>
<span id="cb8-594"><a href="#cb8-594" aria-hidden="true" tabindex="-1"></a>            <span class="st">"feedback_history"</span>: memory.feedback</span>
<span id="cb8-595"><a href="#cb8-595" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-596"><a href="#cb8-596" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-597"><a href="#cb8-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-598"><a href="#cb8-598" aria-hidden="true" tabindex="-1"></a><span class="fu"># Load the MT-bench dataset</span></span>
<span id="cb8-599"><a href="#cb8-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-600"><a href="#cb8-600" aria-hidden="true" tabindex="-1"></a>Next I will read in the MT-bench dataset from disk and prepare it for evaluation.</span>
<span id="cb8-601"><a href="#cb8-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-604"><a href="#cb8-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb8-605"><a href="#cb8-605" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb8-606"><a href="#cb8-606" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-607"><a href="#cb8-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-608"><a href="#cb8-608" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the MT-bench dataset from disk</span></span>
<span id="cb8-609"><a href="#cb8-609" aria-hidden="true" tabindex="-1"></a>data_list <span class="op">=</span> []</span>
<span id="cb8-610"><a href="#cb8-610" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'mt_bench_human_judgments.jsonl'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-611"><a href="#cb8-611" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb8-612"><a href="#cb8-612" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> json.loads(line)</span>
<span id="cb8-613"><a href="#cb8-613" aria-hidden="true" tabindex="-1"></a>        data_list.append(data)</span>
<span id="cb8-614"><a href="#cb8-614" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-615"><a href="#cb8-615" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data_list)</span>
<span id="cb8-616"><a href="#cb8-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-617"><a href="#cb8-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Take a random sample of 615 rows, which</span></span>
<span id="cb8-618"><a href="#cb8-618" aria-hidden="true" tabindex="-1"></a><span class="co"># with this seed yields 500 unique conversations</span></span>
<span id="cb8-619"><a href="#cb8-619" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.sample(n<span class="op">=</span><span class="dv">615</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb8-620"><a href="#cb8-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-621"><a href="#cb8-621" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique combinations of conversations and models</span></span>
<span id="cb8-622"><a href="#cb8-622" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'conversation_a_str'</span>] <span class="op">=</span> df[<span class="st">'conversation_a'</span>].astype(<span class="bu">str</span>)</span>
<span id="cb8-623"><a href="#cb8-623" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'conversation_b_str'</span>] <span class="op">=</span> df[<span class="st">'conversation_b'</span>].astype(<span class="bu">str</span>) </span>
<span id="cb8-624"><a href="#cb8-624" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">'model_a'</span>, <span class="st">'model_b'</span>, <span class="st">'conversation_a_str'</span>, <span class="st">'conversation_b_str'</span>])</span>
<span id="cb8-625"><a href="#cb8-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-626"><a href="#cb8-626" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop conversation_a and conversation_b</span></span>
<span id="cb8-627"><a href="#cb8-627" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">'conversation_a'</span>, <span class="st">'conversation_b'</span>])</span>
<span id="cb8-628"><a href="#cb8-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-629"><a href="#cb8-629" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique conversations: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-630"><a href="#cb8-630" aria-hidden="true" tabindex="-1"></a>df.head()</span>
<span id="cb8-631"><a href="#cb8-631" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-632"><a href="#cb8-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-633"><a href="#cb8-633" aria-hidden="true" tabindex="-1"></a><span class="fu"># Evaluate MT-bench with SAMRE and Baseline methods</span></span>
<span id="cb8-634"><a href="#cb8-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-635"><a href="#cb8-635" aria-hidden="true" tabindex="-1"></a>Next, for each conversation in the dataset, I will evaluate the two models using both the SAMRE and Baseline methods.</span>
<span id="cb8-636"><a href="#cb8-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-639"><a href="#cb8-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb8-640"><a href="#cb8-640" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb8-641"><a href="#cb8-641" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> asyncio <span class="im">import</span> Semaphore</span>
<span id="cb8-642"><a href="#cb8-642" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb8-643"><a href="#cb8-643" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-644"><a href="#cb8-644" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb8-645"><a href="#cb8-645" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.WARNING)</span>
<span id="cb8-646"><a href="#cb8-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-647"><a href="#cb8-647" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> evaluate_conversation_pair(row, evaluators, semaphore, idx, total):</span>
<span id="cb8-648"><a href="#cb8-648" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Evaluate a single conversation pair with all evaluators"""</span></span>
<span id="cb8-649"><a href="#cb8-649" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> semaphore:</span>
<span id="cb8-650"><a href="#cb8-650" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate pair_id from conversation hash</span></span>
<span id="cb8-651"><a href="#cb8-651" aria-hidden="true" tabindex="-1"></a>        pair_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'model_a'</span>]<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>row[<span class="st">'model_b'</span>]<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>hashlib<span class="sc">.</span>sha256(<span class="bu">str</span>(row[<span class="st">'conversation_a'</span>]).encode())<span class="sc">.</span>hexdigest()[:<span class="dv">12</span>]<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-652"><a href="#cb8-652" aria-hidden="true" tabindex="-1"></a>        checkpoint_file <span class="op">=</span> <span class="ss">f'checkpoints/</span><span class="sc">{</span>pair_id<span class="sc">}</span><span class="ss">.json'</span></span>
<span id="cb8-653"><a href="#cb8-653" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-654"><a href="#cb8-654" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return existing checkpoint if available</span></span>
<span id="cb8-655"><a href="#cb8-655" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> os.path.exists(checkpoint_file):</span>
<span id="cb8-656"><a href="#cb8-656" aria-hidden="true" tabindex="-1"></a>            logging.info(<span class="ss">f"Found existing checkpoint file for </span><span class="sc">{</span>pair_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-657"><a href="#cb8-657" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> json.load(<span class="bu">open</span>(checkpoint_file))</span>
<span id="cb8-658"><a href="#cb8-658" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-659"><a href="#cb8-659" aria-hidden="true" tabindex="-1"></a>        logging.info(<span class="ss">f"No checkpoint file found for </span><span class="sc">{</span>pair_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-660"><a href="#cb8-660" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {</span>
<span id="cb8-661"><a href="#cb8-661" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model_a'</span>: row[<span class="st">'model_a'</span>],</span>
<span id="cb8-662"><a href="#cb8-662" aria-hidden="true" tabindex="-1"></a>            <span class="st">'model_b'</span>: row[<span class="st">'model_b'</span>],</span>
<span id="cb8-663"><a href="#cb8-663" aria-hidden="true" tabindex="-1"></a>            <span class="st">'human_winner'</span>: row[<span class="st">'winner'</span>],</span>
<span id="cb8-664"><a href="#cb8-664" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pair_id'</span>: pair_id</span>
<span id="cb8-665"><a href="#cb8-665" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-666"><a href="#cb8-666" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-667"><a href="#cb8-667" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate with each evaluator</span></span>
<span id="cb8-668"><a href="#cb8-668" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, evaluator <span class="kw">in</span> evaluators.items():</span>
<span id="cb8-669"><a href="#cb8-669" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb8-670"><a href="#cb8-670" aria-hidden="true" tabindex="-1"></a>                eval_result <span class="op">=</span> <span class="cf">await</span> evaluator.evaluate(row[<span class="st">'conversation_a'</span>], row[<span class="st">'conversation_b'</span>])</span>
<span id="cb8-671"><a href="#cb8-671" aria-hidden="true" tabindex="-1"></a>                result[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_winner'</span>] <span class="op">=</span> eval_result[<span class="st">'winner'</span>]</span>
<span id="cb8-672"><a href="#cb8-672" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-673"><a href="#cb8-673" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add common evaluation details</span></span>
<span id="cb8-674"><a href="#cb8-674" aria-hidden="true" tabindex="-1"></a>                result.update({<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>: eval_result[k] <span class="cf">for</span> k <span class="kw">in</span> [<span class="st">'average_scores'</span>, <span class="st">'rounds'</span>, <span class="st">'score_history'</span>]})</span>
<span id="cb8-675"><a href="#cb8-675" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-676"><a href="#cb8-676" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add mode-specific details</span></span>
<span id="cb8-677"><a href="#cb8-677" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> evaluator.mode <span class="op">==</span> <span class="st">"samre"</span>:</span>
<span id="cb8-678"><a href="#cb8-678" aria-hidden="true" tabindex="-1"></a>                    result.update({</span>
<span id="cb8-679"><a href="#cb8-679" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'samre_argument_history'</span>: eval_result[<span class="st">'argument_history'</span>],</span>
<span id="cb8-680"><a href="#cb8-680" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'samre_feedback_history'</span>: eval_result[<span class="st">'feedback_history'</span>]</span>
<span id="cb8-681"><a href="#cb8-681" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb8-682"><a href="#cb8-682" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> evaluator.mode <span class="op">==</span> <span class="st">"baseline"</span>:</span>
<span id="cb8-683"><a href="#cb8-683" aria-hidden="true" tabindex="-1"></a>                    result[<span class="st">'baseline_full_response'</span>] <span class="op">=</span> eval_result[<span class="st">'full_response'</span>]</span>
<span id="cb8-684"><a href="#cb8-684" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-685"><a href="#cb8-685" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-686"><a href="#cb8-686" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"Error with </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss"> evaluator on row </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-687"><a href="#cb8-687" aria-hidden="true" tabindex="-1"></a>                result[<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_winner'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-688"><a href="#cb8-688" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-689"><a href="#cb8-689" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save checkpoint</span></span>
<span id="cb8-690"><a href="#cb8-690" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="st">'checkpoints'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-691"><a href="#cb8-691" aria-hidden="true" tabindex="-1"></a>        json.dump(result, <span class="bu">open</span>(checkpoint_file, <span class="st">'w'</span>))</span>
<span id="cb8-692"><a href="#cb8-692" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-693"><a href="#cb8-693" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (idx <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb8-694"><a href="#cb8-694" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Processed </span><span class="sc">{</span>idx <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total<span class="sc">}</span><span class="ss"> conversations"</span>)</span>
<span id="cb8-695"><a href="#cb8-695" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-696"><a href="#cb8-696" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb8-697"><a href="#cb8-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-698"><a href="#cb8-698" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> evaluate_conversations_async(df, evaluators, semaphore_limit<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb8-699"><a href="#cb8-699" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Evaluate conversations asynchronously"""</span></span>
<span id="cb8-700"><a href="#cb8-700" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">'checkpoints'</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-701"><a href="#cb8-701" aria-hidden="true" tabindex="-1"></a>    tasks <span class="op">=</span> [evaluate_conversation_pair(row[<span class="dv">1</span>], evaluators, Semaphore(semaphore_limit), idx, <span class="bu">len</span>(df))</span>
<span id="cb8-702"><a href="#cb8-702" aria-hidden="true" tabindex="-1"></a>             <span class="cf">for</span> idx, row <span class="kw">in</span> <span class="bu">enumerate</span>(df.iterrows())]</span>
<span id="cb8-703"><a href="#cb8-703" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(<span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks))</span>
<span id="cb8-704"><a href="#cb8-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-705"><a href="#cb8-705" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb8-706"><a href="#cb8-706" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> ModelEvaluator.create(mode<span class="op">=</span><span class="st">"samre"</span>) <span class="im">as</span> samre_evaluator, <span class="op">\</span></span>
<span id="cb8-707"><a href="#cb8-707" aria-hidden="true" tabindex="-1"></a>               ModelEvaluator.create(mode<span class="op">=</span><span class="st">"baseline"</span>) <span class="im">as</span> baseline_evaluator:</span>
<span id="cb8-708"><a href="#cb8-708" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cf">await</span> evaluate_conversations_async(</span>
<span id="cb8-709"><a href="#cb8-709" aria-hidden="true" tabindex="-1"></a>            df,</span>
<span id="cb8-710"><a href="#cb8-710" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'samre'</span>: samre_evaluator, <span class="st">'baseline'</span>: baseline_evaluator},</span>
<span id="cb8-711"><a href="#cb8-711" aria-hidden="true" tabindex="-1"></a>            semaphore_limit<span class="op">=</span><span class="dv">7</span></span>
<span id="cb8-712"><a href="#cb8-712" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-713"><a href="#cb8-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-714"><a href="#cb8-714" aria-hidden="true" tabindex="-1"></a><span class="co"># Run evaluation with checkpoint recovery</span></span>
<span id="cb8-715"><a href="#cb8-715" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb8-716"><a href="#cb8-716" aria-hidden="true" tabindex="-1"></a>    eval_df <span class="op">=</span> <span class="cf">await</span> main()</span>
<span id="cb8-717"><a href="#cb8-717" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-718"><a href="#cb8-718" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Error during evaluation: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ch">\n</span><span class="ss">Recovering from checkpoints..."</span>)</span>
<span id="cb8-719"><a href="#cb8-719" aria-hidden="true" tabindex="-1"></a>    eval_df <span class="op">=</span> pd.DataFrame([json.load(<span class="bu">open</span>(<span class="ss">f'checkpoints/</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>)) </span>
<span id="cb8-720"><a href="#cb8-720" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">for</span> f <span class="kw">in</span> os.listdir(<span class="st">'checkpoints'</span>) </span>
<span id="cb8-721"><a href="#cb8-721" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> f.endswith(<span class="st">'.json'</span>)])</span>
<span id="cb8-722"><a href="#cb8-722" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb8-723"><a href="#cb8-723" aria-hidden="true" tabindex="-1"></a>    eval_df.to_csv(<span class="st">'eval_df.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-724"><a href="#cb8-724" aria-hidden="true" tabindex="-1"></a>    eval_df.head()</span>
<span id="cb8-725"><a href="#cb8-725" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-726"><a href="#cb8-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-727"><a href="#cb8-727" aria-hidden="true" tabindex="-1"></a><span class="fu"># Results</span></span>
<span id="cb8-728"><a href="#cb8-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-729"><a href="#cb8-729" aria-hidden="true" tabindex="-1"></a>Finally, I will evaluate the performance of the methods by looking at how well each method agreed with the human judgments. I'll use Krippendorff's alpha to measure agreement, since it is a robust measure of agreement that can handle non-binary ratings (among other things).</span>
<span id="cb8-730"><a href="#cb8-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-733"><a href="#cb8-733" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb8-734"><a href="#cb8-734" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> krippendorff <span class="im">import</span> alpha</span>
<span id="cb8-735"><a href="#cb8-735" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-736"><a href="#cb8-736" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb8-737"><a href="#cb8-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-738"><a href="#cb8-738" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_agreement(df, rater1_col, rater2_col):</span>
<span id="cb8-739"><a href="#cb8-739" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-740"><a href="#cb8-740" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate Krippendorff's alpha between two raters.</span></span>
<span id="cb8-741"><a href="#cb8-741" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-742"><a href="#cb8-742" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb8-743"><a href="#cb8-743" aria-hidden="true" tabindex="-1"></a><span class="co">        df: DataFrame containing the ratings</span></span>
<span id="cb8-744"><a href="#cb8-744" aria-hidden="true" tabindex="-1"></a><span class="co">        rater1_col: Name of first rater's column</span></span>
<span id="cb8-745"><a href="#cb8-745" aria-hidden="true" tabindex="-1"></a><span class="co">        rater2_col: Name of second rater's column</span></span>
<span id="cb8-746"><a href="#cb8-746" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-747"><a href="#cb8-747" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-748"><a href="#cb8-748" aria-hidden="true" tabindex="-1"></a><span class="co">        float: Krippendorff's alpha score</span></span>
<span id="cb8-749"><a href="#cb8-749" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-750"><a href="#cb8-750" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create label encoder</span></span>
<span id="cb8-751"><a href="#cb8-751" aria-hidden="true" tabindex="-1"></a>    le <span class="op">=</span> LabelEncoder()</span>
<span id="cb8-752"><a href="#cb8-752" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-753"><a href="#cb8-753" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all unique values from both columns</span></span>
<span id="cb8-754"><a href="#cb8-754" aria-hidden="true" tabindex="-1"></a>    all_values <span class="op">=</span> pd.concat([df[rater1_col], df[rater2_col]]).unique()</span>
<span id="cb8-755"><a href="#cb8-755" aria-hidden="true" tabindex="-1"></a>    le.fit(all_values)</span>
<span id="cb8-756"><a href="#cb8-756" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-757"><a href="#cb8-757" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the ratings to numeric values</span></span>
<span id="cb8-758"><a href="#cb8-758" aria-hidden="true" tabindex="-1"></a>    ratings1 <span class="op">=</span> le.transform(df[rater1_col].fillna(<span class="st">'missing'</span>))</span>
<span id="cb8-759"><a href="#cb8-759" aria-hidden="true" tabindex="-1"></a>    ratings2 <span class="op">=</span> le.transform(df[rater2_col].fillna(<span class="st">'missing'</span>))</span>
<span id="cb8-760"><a href="#cb8-760" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-761"><a href="#cb8-761" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reshape data for krippendorff alpha calculation</span></span>
<span id="cb8-762"><a href="#cb8-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Each row represents one item, each column represents one rater</span></span>
<span id="cb8-763"><a href="#cb8-763" aria-hidden="true" tabindex="-1"></a>    reliability_data <span class="op">=</span> np.vstack([ratings1, ratings2])</span>
<span id="cb8-764"><a href="#cb8-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-765"><a href="#cb8-765" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> alpha(reliability_data<span class="op">=</span>reliability_data, level_of_measurement<span class="op">=</span><span class="st">'nominal'</span>)</span>
<span id="cb8-766"><a href="#cb8-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-767"><a href="#cb8-767" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate agreement scores</span></span>
<span id="cb8-768"><a href="#cb8-768" aria-hidden="true" tabindex="-1"></a>human_baseline_agreement <span class="op">=</span> calculate_agreement(eval_df, <span class="st">'human_winner'</span>, <span class="st">'baseline_winner'</span>)</span>
<span id="cb8-769"><a href="#cb8-769" aria-hidden="true" tabindex="-1"></a>human_samre_agreement <span class="op">=</span> calculate_agreement(eval_df, <span class="st">'human_winner'</span>, <span class="st">'samre_winner'</span>)</span>
<span id="cb8-770"><a href="#cb8-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-771"><a href="#cb8-771" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame with the agreement scores</span></span>
<span id="cb8-772"><a href="#cb8-772" aria-hidden="true" tabindex="-1"></a>agreement_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-773"><a href="#cb8-773" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Evaluator Pair'</span>: [<span class="st">'Human-Baseline'</span>, <span class="st">'Human-SAMRE'</span>],</span>
<span id="cb8-774"><a href="#cb8-774" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Krippendorff Alpha'</span>: [human_baseline_agreement, human_samre_agreement]</span>
<span id="cb8-775"><a href="#cb8-775" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-776"><a href="#cb8-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-777"><a href="#cb8-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Round the scores to 3 decimal places</span></span>
<span id="cb8-778"><a href="#cb8-778" aria-hidden="true" tabindex="-1"></a>agreement_df[<span class="st">'Krippendorff Alpha'</span>] <span class="op">=</span> agreement_df[<span class="st">'Krippendorff Alpha'</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb8-779"><a href="#cb8-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-780"><a href="#cb8-780" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the DataFrame</span></span>
<span id="cb8-781"><a href="#cb8-781" aria-hidden="true" tabindex="-1"></a>agreement_df</span>
<span id="cb8-782"><a href="#cb8-782" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb8-783"><a href="#cb8-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-784"><a href="#cb8-784" aria-hidden="true" tabindex="-1"></a>Although neither method yielded particularly strong agreement with the human judges, the Baseline method yielded significantly better agreement than the SAMRE method: 0.364 vs. 0.215. This is contrary to the paper, which reported a gain of 6-8% for SAMRE over baseline.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i></a> 2014–2025 Tyler Burleigh</span></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i>, <a href="https://quarto.org/">Quarto</a>, and the <a href="https://github.com/andrewheiss/ath-quarto">ath-quarto</a> theme</span></p>
</div>
  </div>
</footer>




</body></html>