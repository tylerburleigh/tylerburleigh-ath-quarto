<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Tyler Burleigh</title>
<link>https://tylerburleigh.com/blog/</link>
<atom:link href="https://tylerburleigh.com/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>{{&lt; meta description-meta &gt;}}</description>
<generator>quarto-1.6.39</generator>
<lastBuildDate>Sat, 09 Dec 2023 05:00:00 GMT</lastBuildDate>
<item>
  <title>AI Math Tutoring: Using GPT to generate “step-by-step guidance”</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/12/09/</link>
  <description><![CDATA[ <p>Imagine you’re developing an AI Math Tutor application: You have a set of math questions that student users can answer, along with the correct answers to those questions. Students will sometimes get stuck answering multi-step problems, and in those situations you want them to be able to ask an AI tutor for help. An AI Tutoring interaction that can be helpful is one where a student asks the tutor for step-by-step guidance.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="https://tylerburleigh.com/blog/2023/12/09/mockup.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Simple AI Math Tutor mock-up (mouse cursor is from kindpng.com)</figcaption></figure>
</div>
<p>In this blog post, I show how a “step-by-step guidance” feature could be developed using GPT and prompt engineering, and how this guidance can be validated. As a demonstration, I use a multi-step math problem that I’ve found GPT-3.5 often struggles to answer. I show how this step-by-step guidance can be validated by asking GPT to solve the problem using its own instructions and then comparing its “stepwise” performance against the performance of a baseline model.</p>
<section id="imports-and-setup" class="level1"><h1>Imports and setup</h1>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://rstudio.github.io/reticulate/">reticulate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add OpenAI key to environment</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rstudio.github.io/reticulate/reference/py_run.html">py_run_string</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"import os"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rstudio.github.io/reticulate/reference/py_run.html">py_run_string</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"os.environ['OPENAI_API_KEY'] = '"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPENAI_API_KEY'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ujson <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> json</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> inspect</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> textwrap</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> multiprocessing.pool <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ThreadPool</span>
<span id="cb2-7">pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ThreadPool()</span></code></pre></div>
</div>
</div>
</section><section id="import-python-prompting-functions" class="level1"><h1>Import python prompting functions</h1>
<p>In order to use parallelization within an interactive notebook using the <code>multiprocessing</code> package, it’s necessary to write the python functions to-be-parallelized to disk and import them. I’ll import the functions here, and introduce these functions later in the post as I use them.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> prompt_functions <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> get_response, baseline_solver, step_generator, stepwise_solver</span></code></pre></div>
</div>
</div>
</section><section id="test-case" class="level1"><h1>Test case</h1>
<p>As a test case, I’ll use a math problem that I’ve found GPT has some difficulty solving. This problem comes from the <a href="https://github.com/openai/grade-school-math">GSM8K</a> dataset. Although it’s a grade school math problem which should be very easy, it requires multiple reasoning steps. If any one step is wrong, the final answer is likely to be incorrect.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gail has two fish tanks. The first tank is twice the size of the second tank. There are 48 gallons of water in the first tank. She follows the rule of one gallon of water per inch of fish. If she keeps two-inch fish in the second tank and three-inch fish in the first tank, how many more fish would Gail have in the first tank than the second tank if one of the first tank fish eats another?'</span></span>
<span id="cb4-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(textwrap.fill(question, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>))</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Gail has two fish tanks. The first tank is twice the size of the second tank.
There are 48 gallons of water in the first tank. She follows the rule of one
gallon of water per inch of fish. If she keeps two-inch fish in the second tank
and three-inch fish in the first tank, how many more fish would Gail have in the
first tank than the second tank if one of the first tank fish eats another?</code></pre>
</div>
</div>
</section><section id="baseline-solver" class="level1"><h1>Baseline solver</h1>
<p>In order to generate steps that an AI Tutor could suggest to a student, I’ll first get GPT to “discover” how to correctly solve the problem on its own. I’ll use the <code>baseline_solver()</code> function, which implements a simple chain-of-thought prompt.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(inspect.getsource(baseline_solver))</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>def baseline_solver(question):
    instructions = "Solve the math problem delimited by triple backticks."
    user_content = f"```{question}```\nLet's work this out in a step by step way to be sure we have the right answer"
    msg = [
        {"role": "system", "content": instructions},
        {"role": "user", "content": user_content}
    ]
    solution = get_response(msg=msg, temp=0.5)
    answer = identify_final_answer(solution)
    return {
      'is_correct': answer == '3',
      'solution': solution,
      'question': question,
      'answer': answer
    }</code></pre>
</div>
</div>
<p>I’ll give it 100 attempts to solve the problem.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read from disk if I've done this already</span></span>
<span id="cb8-2">  df_baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_json(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_solver_results.ndjson'</span>)</span>
<span id="cb8-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb8-4">  baseline_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(baseline_solver, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[question])</span>
<span id="cb8-5">  df_baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(baseline_results, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'solution'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'question'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer'</span>])</span>
<span id="cb8-6">  df_baseline.to_json(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline_solver_results.ndjson'</span>, orient<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'records'</span>)</span></code></pre></div>
</div>
</div>
</section><section id="identify-solution-steps" class="level1"><h1>Identify solution steps</h1>
<p>Using correct answers from the 100 attempts above, I’ll pick a few examples and ask GPT to synthesize and generalize the steps.</p>
<p>For this task I’ll use the <code>step_generator()</code> function, which asks GPT to synthesize the steps from three different solutions provided as input. It also asks GPT to remove any calculations from those steps, which is important for an AI Tutor – after all, we don’t want to give away the answer!</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(inspect.getsource(step_generator))</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>def step_generator(solutions):
    instructions = '''
      You're given three different solutions to a single math problem, delimited by
      triple hashtags. Synthesize the solutions into a final set of steps to solve
      the problem. Remove any calculations from the instructions, leaving only the
      steps.
    '''
    user_content = f'''
      ###
      Solution 1: 
      {solutions[0]}
      ---
      
      Solution 2: 
      {solutions[1]}
      ---
      
      Solution 3: 
      {solutions[2]}
      ###
      
      Synthesize the three solutions above. Remove any calculations from the 
      instructions, leaving only the steps.
    '''
    msg = [
        {"role": "system", "content": instructions},
        {"role": "user", "content": user_content}
    ]
    return get_response(msg=msg, temp=0.3)</code></pre>
</div>
</div>
<p>Here’s what the final set of steps looks like:</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read from disk if I've done this already</span></span>
<span id="cb11-2">  f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steps.txt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>)</span>
<span id="cb11-3">  steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f.read()</span>
<span id="cb11-4">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(steps)</span>
<span id="cb11-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb11-6">  solutions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df_baseline[df_baseline[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'solution'</span>].values[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb11-7">  steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> step_generator(solutions)</span>
<span id="cb11-8">  </span>
<span id="cb11-9">  f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steps.txt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>)</span>
<span id="cb11-10">  f.write(steps)</span>
<span id="cb11-11">  f.close()</span>
<span id="cb11-12">  </span>
<span id="cb11-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(steps)</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>To solve the problem, follow these steps:

1. Find the size of the second tank by dividing the size of the first tank by 2.
2. Determine the number of fish that can be kept in each tank based on the rule of one gallon of water per inch of fish.
3. Calculate the number of fish that can be kept in the second tank by dividing the size of the second tank by 2.
4. Calculate the number of fish that can be kept in the first tank by dividing the size of the first tank by 3.
5. Subtract 1 from the number of fish in the first tank to account for one fish eating another.
6. Subtract the number of fish in the second tank from the number of fish in the first tank to find the difference.
7. Determine the final answer, which is the difference in the number of fish between the two tanks.</code></pre>
</div>
</div>
</section><section id="stepwise-solver" class="level1"><h1>Stepwise solver</h1>
<p>Next, I’ll validate the steps generated above using <code>stepwise_solver()</code>, a function that asks GPT to solve the problem using the steps provided. I expect that providing GPT with the steps above will improve its performance by a significant margin.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(inspect.getsource(stepwise_solver))</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>def stepwise_solver(question, steps):
    instructions = "Solve the math problem in triple backticks, using the steps provided in triple hashtags."
    user_content = f"```{question}```\n\n###{steps}###"
    msg = [
        {"role": "system", "content": instructions},
        {"role": "user", "content": user_content}
    ]
    solution = get_response(msg=msg, temp=0.5)
    answer = identify_final_answer(solution)
    return {
      'is_correct': answer == '3',
      'solution': solution,
      'question': question,
      'steps': steps,
      'answer': answer
    }</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read from disk if I've done this already</span></span>
<span id="cb15-2">  df_stepwise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_json(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'stepwise_solver_results.ndjson'</span>)</span>
<span id="cb15-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb15-4">  stepwise_results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.starmap(stepwise_solver, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[question], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[steps]))</span>
<span id="cb15-5">  df_stepwise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(stepwise_results, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'solution'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'question'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'steps'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answer'</span>])</span>
<span id="cb15-6">  df_stepwise.to_json(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'stepwise_solver_results.ndjson'</span>, orient<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'records'</span>)</span></code></pre></div>
</div>
</div>
<p>Here we can see that by providing the GPT solver with steps derived from correct solutions, performance was almost doubled (from 39% to 77% correct responses). This provides important validation for an AI Tutor with “step-by-step guidance” functionality, because now we know that by following these steps the student would be likely to arrive at the correct answer.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'''</span></span>
<span id="cb16-2"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Baseline solver: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(np.mean(df_baseline[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% correct</span></span>
<span id="cb16-3"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Stepwise solver: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(np.mean(df_stepwise[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'is_correct'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">% correct</span></span>
<span id="cb16-4"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span>)</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Baseline solver: 39% correct
Stepwise solver: 77% correct</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>`Baseline Solver` <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">39</span>, `Stepwise Solver` <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">name</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">value</span>, fill <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">name</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">value</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">value</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, vjust<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>      x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>,</span>
<span>      y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% correct (out of 100)'</span>,</span>
<span>      title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Validating the step-by-step guidance, performance of the\nStepwise Solver was roughly double the Baseline Solver.'</span></span>
<span>    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>legend.position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>,</span>
<span>          text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>          axis.text.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>          axis.text.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,  </span>
<span>          axis.title.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>          axis.title.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/12/09/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="ai-tutor-interaction" class="level1"><h1>AI Tutor interaction</h1>
<p>Having generated and validated the step-by-step guidance, we can now begin to imagine what the user interaction would look like. It could take the form of a single interaction, where a student asks for help and the AI Tutor provides all of the steps at once.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(steps)</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>To solve the problem, follow these steps:

1. Find the size of the second tank by dividing the size of the first tank by 2.
2. Determine the number of fish that can be kept in each tank based on the rule of one gallon of water per inch of fish.
3. Calculate the number of fish that can be kept in the second tank by dividing the size of the second tank by 2.
4. Calculate the number of fish that can be kept in the first tank by dividing the size of the first tank by 3.
5. Subtract 1 from the number of fish in the first tank to account for one fish eating another.
6. Subtract the number of fish in the second tank from the number of fish in the first tank to find the difference.
7. Determine the final answer, which is the difference in the number of fish between the two tanks.</code></pre>
</div>
</div>
<p>Or the AI Tutor could provide the steps one at a time – i.e., one step is given each time the student asks for help.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print step 1</span></span>
<span id="cb21-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(steps.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>1. Find the size of the second tank by dividing the size of the first tank by 2.</code></pre>
</div>
</div>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print step 2</span></span>
<span id="cb23-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(steps.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>2. Determine the number of fish that can be kept in each tank based on the rule of one gallon of water per inch of fish.</code></pre>
</div>
</div>
<p>Providing steps one-at-a-time could be implemented as part of a “progressive” hint system. In an educational math game, for example, the student could receive full points for giving a correct answer with zero assistance, and the number of points earned could be reduced every time they ask for a step hint.</p>
<p>In this implementation I’ve deliberately removed the results from each step. But we could imagine an interaction where the AI first gives a step, and then optionally provides the result obtained at that step. This could help the student figure out at which step they’re making a mistake.</p>


<!-- -->

</section> ]]></description>
  <category>GPT</category>
  <category>prompt-engineering</category>
  <category>python</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/12/09/</guid>
  <pubDate>Sat, 09 Dec 2023 05:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/12/09/social-image.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Tackling the GSM8K (grade school math) with GPT-3.5 and self-consistency prompting</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/12/04/</link>
  <description><![CDATA[ <p>I’ve been interested in AI tutoring applications for education for a long time, and with today’s Large Language Models like GPT, which have been shown to <a href="https://openai.com/research/gpt-4">perform extremely well on standardized tests</a> like the SAT and GRE, it seems that building these applications is now achievable. In fact, some companies have already started building these applications, like Khan Academy’s own <a href="https://www.khanacademy.org/khan-labs">Khanmigo</a>.</p>
<p>The current generation of LLMs perform pretty well at many tasks, and research (like <a href="https://arxiv.org/abs/2201.11903">this paper on chain-of-thought prompting</a>) has shown that there are a variety of “prompt engineering” techniques that can be used to boost performance even further. Basically, prompt engineering refers to the process of writing effective instructions for the model, as well as the process of breaking a complex task into sub-tasks and “chaining” prompts together.</p>
<p>In this post, I use the <code>Self-Consistency</code> prompt engineering strategy to improve the performance of a GPT-3.5 based model tasked with solving problems from the <a href="https://github.com/openai/grade-school-math">GSM8K (grade school math)</a> benchmark dataset. Conceptually, the <code>Self-Consistency</code> strategy involves asking the LLM to follow multiple reasoning paths to generate multiple answers, and then taking a majority vote of its answers.</p>
<p>I explore implementing the <code>Self-Consistency</code> strategy first by using a single prompt that instructs the model to generate multiple reasoning paths and answers, followed by identifying the majority vote of its own answers – all within a single response. In addition, I explore an implementation in which the LLM is asked to generate an answer multiple times using independent requests to the API, followed by using a simple frequency count to obtain the majority vote of its answers.</p>
<p>Using the <code>Self-Consistency</code> strategy, model performance was increased from 75% correct answers at baseline to 93% with the multiple-attempts implementation. Overall, this analysis suggests that <code>Self-Consistency</code> is an effective strategy to improve LLM performance on cognitive tasks like answering grade school math questions.</p>
<p>(Note: This blog post uses a mix of <code>python</code> and <code>R</code> code.)</p>
<section id="sample-test-cases" class="level1"><h1>Sample test cases</h1>
<p>First, I’ll sample 100 test cases at random from the <a href="https://github.com/openai/grade-school-math">GSM8K</a> training dataset. The GSM8K has 8000 cases in total, but every API request takes time and costs money, and I want to keep this reasonable. :)</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2">train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_json(path_or_buf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.jsonl'</span>, lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-3">sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train.sample(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Random sample of 100 items</span></span></code></pre></div>
</div>
</div>
</section><section id="openai-client" class="level1"><h1>OpenAI client</h1>
<p>Next, I’ll define a client function for interfacing with GPT.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb2-2">client <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI()</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_response(msg, mod<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-3.5-turbo"</span>, temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb2-5">    response <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> client.chat.completions.create(</span>
<span id="cb2-6">      model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mod,</span>
<span id="cb2-7">      messages<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>msg,</span>
<span id="cb2-8">      temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temp</span>
<span id="cb2-9">    )</span>
<span id="cb2-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> response.choices[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].message.content</span></code></pre></div>
</div>
</div>
</section><section id="prompt-functions" class="level1"><h1>Prompt functions</h1>
<p>Next, I’ll define some custom prompt functions.</p>
<p><code>self_consistency_solver()</code> is an implementation of the <code>Self-Consistency</code> prompting strategy within a single prompt. This prompt asks the LLM to “imagine N completely independent experts who reason differently” and also asking it to take the majority vote across these imagined experts. The <code>n_experts</code> parameter identifies how many experts the LLM will be instructed to imagine.</p>
<p><code>identify_final_answer()</code> is a prompt that takes an LLM’s answer and basically extracts and refines it, because in many cases the answer given will contain lots of extra text.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> self_consistency_solver(queston, n_experts):</span>
<span id="cb3-4">    instructions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'''</span></span>
<span id="cb3-5"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Imagine </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_experts<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> completely independent experts who reason differently </span></span>
<span id="cb3-6"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    are answering a question. The question is delimited by triple backticks.</span></span>
<span id="cb3-7"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    The final answer is obtained by majority vote.</span></span>
<span id="cb3-8"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb3-9"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Step 1. For each of the experts, give their step-by-step </span></span>
<span id="cb3-10"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    reasoning and answer</span></span>
<span id="cb3-11"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Step 2. Determine the final answer by majority vote</span></span>
<span id="cb3-12"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    Step 3. Return the final answer, obtained by majority vote, </span></span>
<span id="cb3-13"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    prefixed by 'Final answer:'</span></span>
<span id="cb3-14"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">    '''</span>    </span>
<span id="cb3-15">    user_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'```</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>queston<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">```'</span></span>
<span id="cb3-16">    </span>
<span id="cb3-17">    msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-18">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: instructions},</span>
<span id="cb3-19">        {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: user_content}</span>
<span id="cb3-20">    ]</span>
<span id="cb3-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> get_response(msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>msg, temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb3-22"></span>
<span id="cb3-23"></span>
<span id="cb3-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> identify_final_answer(question, solution):</span>
<span id="cb3-25">    instructions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span>
<span id="cb3-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    You will be provided with the answer to a math question. </span></span>
<span id="cb3-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    The question is delimited by triple backticks, </span></span>
<span id="cb3-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    and the answer is delimited by triple hashtags.</span></span>
<span id="cb3-29"></span>
<span id="cb3-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Step 1. Determine if the answer is expressed as a single number</span></span>
<span id="cb3-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Step 2. If the answer is not expressed as a single number, </span></span>
<span id="cb3-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    find a way to express it as a single number</span></span>
<span id="cb3-33"></span>
<span id="cb3-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Return the final answer, expressed as a single number, </span></span>
<span id="cb3-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    prefixed by 'Final answer:'</span></span>
<span id="cb3-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    '''</span></span>
<span id="cb3-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb3-38">        answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> solution.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Final answer: '</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-39">        answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'###</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>answer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">###'</span></span>
<span id="cb3-40">        user_content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'```</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>question<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">```'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> answer</span>
<span id="cb3-41"></span>
<span id="cb3-42">        msg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb3-43">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"system"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: instructions},</span>
<span id="cb3-44">            {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"role"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content"</span>: user_content}</span>
<span id="cb3-45">        ]</span>
<span id="cb3-46">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> get_response(msg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>msg, temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb3-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NA'</span></span></code></pre></div>
</div>
</div>
<p>Next, I’ll define several other functions. Some of these are used for data wrangling. The most important functions here are <code>multi_step_solver()</code> and <code>get_best_answer</code>, which underlie the second implementation of the <code>Self-Consistency</code> strategy.</p>
<p>This implementation involves asking the LLM to generate a response several times using independent requests to the API, and then using a simple frequency count to obtain the majority vote across its responses. The multiple-attempts implementation is simple: Given a parameter, <code>n_attempts</code>, an API request is sent that many times and the responses are collected into an array, then <code>get_best_answer()</code> is used to find the “best answer” which is the answer most frequently given.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> multiprocessing.pool <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ThreadPool </span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> clean_answer(answer):</span>
<span id="cb4-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove everything but numbers in integer or decimal form</span></span>
<span id="cb4-5">    answer_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[^\d\.]'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, answer)</span>
<span id="cb4-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the last character is a decimal, remove it, it was probably presented as a sentence</span></span>
<span id="cb4-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> answer_clean[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb4-8">        answer_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> answer_clean[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]    </span>
<span id="cb4-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If number contains decimal, decide if it should be removed</span></span>
<span id="cb4-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> answer_clean:</span>
<span id="cb4-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the number contains only trailing zeroes, strip them and remove it</span></span>
<span id="cb4-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> answer_clean[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> answer_clean[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0'</span>:</span>
<span id="cb4-13">            answer_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> answer_clean.rstrip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0'</span>)</span>
<span id="cb4-14">            answer_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> answer_clean[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the decimal is now the last character, remove it</span></span>
<span id="cb4-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> answer_clean[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>:</span>
<span id="cb4-17">            answer_clean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> answer_clean[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> answer_clean</span>
<span id="cb4-19"></span>
<span id="cb4-20"></span>
<span id="cb4-21"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> parse_final_answer(evaluation):</span>
<span id="cb4-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb4-23">        answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> evaluation.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Final answer: '</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-24">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> clean_answer(answer)</span>
<span id="cb4-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb4-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NA'</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return NA if a final answer could not be found</span></span>
<span id="cb4-27"></span>
<span id="cb4-28"></span>
<span id="cb4-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_best_answer(options):</span>
<span id="cb4-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The best answer is determined by a majority vote;</span></span>
<span id="cb4-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in other words, the one with the highest frequency</span></span>
<span id="cb4-32">    answer_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[x, options.count(x)] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(options) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NA'</span>]]</span>
<span id="cb4-33">    answer_count_sorted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(answer_count, key<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], reverse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb4-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(answer_count_sorted) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb4-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> answer_count_sorted[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb4-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NA'</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return NA if there were no correct answers</span></span>
<span id="cb4-38"></span>
<span id="cb4-39"></span>
<span id="cb4-40"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_true_answer(answer):</span>
<span id="cb4-41">    answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> answer.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'### '</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove anything other than a decimal form number (e.g., commas)</span></span>
<span id="cb4-43">    answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.sub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'[^\d\.]'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, answer)</span>
<span id="cb4-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> answer</span>
<span id="cb4-45"></span>
<span id="cb4-46"></span>
<span id="cb4-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> multi_step_solver(question, n_experts, n_attempts):</span>
<span id="cb4-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pool for parallelization</span></span>
<span id="cb4-49">    pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ThreadPool(n_attempts)</span>
<span id="cb4-50">    </span>
<span id="cb4-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate attempts</span></span>
<span id="cb4-52">    attempts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.starmap(self_consistency_solver, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>([question]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_attempts, [n_experts]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_attempts))</span>
<span id="cb4-53"></span>
<span id="cb4-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify the final answers</span></span>
<span id="cb4-55">    answers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pool.starmap(identify_final_answer, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>([question]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n_attempts, attempts))</span>
<span id="cb4-56">    </span>
<span id="cb4-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse the final answers</span></span>
<span id="cb4-58">    answers_parsed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [parse_final_answer(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> answers]</span>
<span id="cb4-59">    </span>
<span id="cb4-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify the best answer</span></span>
<span id="cb4-61">    best_answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_best_answer(answers_parsed)</span>
<span id="cb4-62"></span>
<span id="cb4-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Results</span></span>
<span id="cb4-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> {</span>
<span id="cb4-65">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best_answer"</span>: best_answer,</span>
<span id="cb4-66">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"attempts"</span>: attempts,</span>
<span id="cb4-67">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answers"</span>: answers,</span>
<span id="cb4-68">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answers_parsed"</span>: answers_parsed</span>
<span id="cb4-69">    }</span></code></pre></div>
</div>
</div>
</section><section id="run-test-cases" class="level1"><h1>Run test cases</h1>
<p>I’ll use a few loops to run through the test cases, and save the results to a newline-delimited JSON after each one is processed.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>python</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ujson <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> json</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read previous answers from disk if they exist</span></span>
<span id="cb5-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">try</span>:</span>
<span id="cb5-5">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_json(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answers.ndjson'</span>, lines<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)        </span>
<span id="cb5-6">    start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df[(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_experts'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_attempts'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify where we left off</span></span>
<span id="cb5-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">except</span>:</span>
<span id="cb5-8">    start <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(start, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sample)):</span>
<span id="cb5-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n_attempts <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb5-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> n_experts <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]:</span>
<span id="cb5-13">            question <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sample.iloc[i].question</span>
<span id="cb5-14">            true_answer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_true_answer(sample.iloc[i].answer)</span>
<span id="cb5-15">            results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multi_step_solver(question, n_experts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_experts, n_attempts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_attempts)</span>
<span id="cb5-16"></span>
<span id="cb5-17">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'answers.ndjson'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'a+'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb5-18">                json.dump({</span>
<span id="cb5-19">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_experts"</span>: n_experts,</span>
<span id="cb5-20">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n_attempts"</span>: n_attempts,</span>
<span id="cb5-21">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"question"</span>: question,</span>
<span id="cb5-22">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"true_answer"</span>: true_answer,</span>
<span id="cb5-23">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best_answer"</span>: results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'best_answer'</span>],</span>
<span id="cb5-24">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"attempts"</span>: results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'attempts'</span>],</span>
<span id="cb5-25">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answers"</span>: results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answers'</span>],</span>
<span id="cb5-26">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"answers_parsed"</span>: results[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answers_parsed'</span>]</span>
<span id="cb5-27">                }, f)</span>
<span id="cb5-28">                f.write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</div>
</div>
</section><section id="analysis-of-performance" class="level1"><h1>Analysis of performance</h1>
<p>Alright! Now that all of the responses has been generated, it’s time for the analysis.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jsonlite</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/jsonlite/man/stream_in.html">stream_in</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/connections.html">file</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'answers.ndjson'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">F</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>is_correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">best_answer</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">true_answer</span>,</span>
<span>         n_experts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         n_attempts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</div>
<section id="validity-checks" class="level2"><h2 class="anchored" data-anchor-id="validity-checks">Validity checks</h2>
<p>Check that there are 1200 total records.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1200</code></pre>
</div>
</div>
<p>Check that each of the 12 levels has 100 questions each.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
# Groups:   n_experts, n_attempts [12]
   n_experts n_attempts     n
   &lt;fct&gt;     &lt;fct&gt;      &lt;int&gt;
 1 1         1            100
 2 1         3            100
 3 1         5            100
 4 1         10           100
 5 3         1            100
 6 3         3            100
 7 3         5            100
 8 3         10           100
 9 5         1            100
10 5         3            100
11 5         5            100
12 5         10           100</code></pre>
</div>
</div>
</section><section id="baseline-performance" class="level2"><h2 class="anchored" data-anchor-id="baseline-performance">Baseline performance</h2>
<p>As a baseline, I’ll use performance when the model is given 1 attempt using 1 expert.</p>
<p>Baseline performance is 75%.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pct_correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  pct_correct
1          75</code></pre>
</div>
</div>
</section><section id="single-prompt-imagined-experts" class="level2"><h2 class="anchored" data-anchor-id="single-prompt-imagined-experts">Single-prompt “imagined experts”</h2>
<p>If the single-prompt “imagined experts” implementation improves performance, then I would expect that prompting the model to imagine 3 (or 5) experts would perform better than asking it to imagine only 1 expert. Contrary to this expectation, I see no improvement.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pct_correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# of Imagined Experts"</span>,</span>
<span>         y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% Correct Answers'</span>,</span>
<span>         title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Imagined experts had minimal benefits when averaged over\ndifferent numbers of attempts"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, vjust<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/12/04/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>However, it’s possible that the improvement is obscured by the fact that I’m taking the average across number of attempts. It’s possible that the two implementations are redundant, and that the single-prompt “imagined experts” implementation is only beneficial when the model is given a single attempt.</p>
<p>Below we can see that if the model is given only 1 attempt, the prompt with 3 experts performed better than the prompt with only 1 imagined expert. There’s also a non-linear pattern, which may suggest that asking the model to imagine too many experts with different reasoning leads to some experts engaging sub-optimal reasoning, which then leads to poorer performance.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pct_correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# of Imagined Experts"</span>,</span>
<span>         y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% Correct Answers'</span>,</span>
<span>         title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"In the absence of multiple attempts, imagining 3 experts was best"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, vjust<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/12/04/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="multiple-attempts" class="level2"><h2 class="anchored" data-anchor-id="multiple-attempts">Multiple attempts</h2>
<p>I expect that when I take the most frequent answer across attempts, performance would improve with the number of attempts (at least, up to a certain point). This would support the multiple-attempts implementation. Indeed this does seem to be the case: Model performance increased linearly with number of attempts, with 10 attempts performing better than 5, 5 better than 3, and 3 better than 1.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pct_correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# of Attempts"</span>,</span>
<span>         y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% Correct Answers'</span>,</span>
<span>         title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"More attempts means more accuracy"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, vjust<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/12/04/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The strongest model was one that was given 10 attempts, with only 1 imagined expert per attempt, which achieved 93% correct answers. This suggests that giving the model multiple attempts, while generating only 1 answer per attempt may be the best implementation of the <code>Self-Consistency</code> strategy.</p>
<div class="cell">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>R</strong></pre>
</div>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pct_correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, .groups <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'drop'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_experts</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# of Attempts"</span>,</span>
<span>         y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% Correct Answers'</span>,</span>
<span>         color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"# of Imagined Experts"</span>,</span>
<span>         title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The best implementation: 10 attempts with 1 imagined expert"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_attempts</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_correct</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'%'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, vjust<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/12/04/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Overall, this analysis provides strong evidence in favor of the multiple-attempts implementation of <code>Self-Consistency</code>, and weaker evidence in favor of the single-prompt “imagined experts” implementation. The best implementation involved asking the LLM to generate only 1 answer per attempt, while giving it 10 attempts in total. Using this implementation of the strategy, performance was increased from 75% correct answers at baseline to 93% correct answers.</p>


<!-- -->

</section></section> ]]></description>
  <category>GPT</category>
  <category>prompt-engineering</category>
  <category>python</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/12/04/</guid>
  <pubDate>Mon, 04 Dec 2023 05:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/12/04/social-image.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Using GPT-4 for classification</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/10/08/</link>
  <description><![CDATA[ <p>GPT is a powerful new tool in the Data Science toolkit. Used correctly, it can increase productivity while decreasing the “drudgery” of boring tasks like data cleaning. I’ve been trying to find ways to integrate GPT into my data science workflow, and I thought it might be fun to use it with the latest Tidy Tuesday. (<a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-10-03/readme.md">US Government Grant Opportunities</a>). So in this blog post, I use GPT to classify US grant-funding agencies into categories using government agency names.</p>
<section id="load-libraries-and-data" class="level1"><h1>Load libraries and data</h1>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://andrisignorell.github.io/DescTools/">DescTools</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://keyring.r-lib.org/">keyring</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/">httr</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://jeroen.r-universe.dev/jsonlite">jsonlite</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/trinker/numform">numform</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://scales.r-lib.org">scales</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/Tazinho/snakecase">snakecase</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">grants</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-10-03/grants.csv'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">grant_opportunity_details</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-10-03/grant_opportunity_details.csv'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load cached ChatGPT results from disk</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'categories.Rdata'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'agencies_categorized.Rdata'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="gpt-function" class="level1"><h1>GPT function</h1>
<p>I’ll define a function for querying ChatGPT (<a href="https://www.listendata.com/2023/05/chatgpt-in-r.html">source</a>). This function will use GPT-4 as the model, and the temperature will be set to 0. Temperature defines how stable the responses will be. A temperature closer to 1 is better for creative tasks where high variability is desired, like creative writing. A temperature of 0 is more “boring” but also more stable. This is desirable for classification tasks.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ChatGPT function</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">chatGPT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">prompt</span>, </span>
<span>                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">modelName</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4"</span>,</span>
<span>                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">temperature</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span>                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">apiKey</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">keyring</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://keyring.r-lib.org/reference/key_get.html">key_get</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'openai'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">response</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/reference/POST.html">POST</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>    url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.openai.com/v1/chat/completions"</span>, </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/reference/add_headers.html">add_headers</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>Authorization <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bearer"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">apiKey</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/reference/content_type.html">content_type_json</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>    encode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json"</span>,</span>
<span>    body <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>      model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">modelName</span>,</span>
<span>      temperature <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">temperature</span>,</span>
<span>      messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>        role <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, </span>
<span>        content <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">prompt</span></span>
<span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/reference/status_code.html">status_code</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">response</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">response</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://httr.r-lib.org/reference/content.html">content</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">response</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">choices</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">message</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">content</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</div>
</section><section id="list-of-agencies" class="level1"><h1>List of agencies</h1>
<p>I’ll generate a distinct list of US government agencies in the dataset, and then format them as a comma-separated string. This will make it easy to append to a prompt string when querying GPT.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">grants</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agency_name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies</span>,collapse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_str</span></span></code></pre></div>
</div>
</section><section id="using-gpt-for-classification" class="level1"><h1>Using GPT for classification</h1>
<p>I’ll split the classification task into two parts:</p>
<ol type="1">
<li>Give GPT the full list of agency names, and ask it to come up with N categories</li>
<li>For each of the N categories, give GPT the full list of agency names, and ask it to identify the agencies that belong in each category</li>
</ol></section><section id="ask-it-to-come-up-with-categories" class="level1"><h1>1. Ask it to come up with categories</h1>
<p>First I’ll ask GPT to define a fixed number of categories. Somewhat arbitrarily, I’ll ask for 10.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'categories'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">query</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I'm going to present a list of US agencies. </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your task is to identify the 10 best categories </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    to represent them. The categories should be based </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    on activities they're involved with, such as Defense </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    and Military, Science and Technology, Arts and Culture, </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Health and Medicine, Education, International Aid, </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    etc... I want you to give me the list of categories </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    as a comma-separated list.</span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ```"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_str</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```"</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">results</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chatGPT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">query</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">results</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save to disk</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories</span>, file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'categories.Rdata'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Defense and Military"                     
 [2] "Science and Technology"                   
 [3] "Health and Medicine"                      
 [4] "International Aid"                        
 [5] "Education and Research"                   
 [6] "Agriculture and Environment"              
 [7] "Infrastructure and Transportation"        
 [8] "Business and Economic Development"        
 [9] "Arts and Culture"                         
[10] "Social Services and Community Development"</code></pre>
</div>
</div>
<section id="ask-it-to-classify-agencies-using-agency-names-and-categories" class="level2"><h2 class="anchored" data-anchor-id="ask-it-to-classify-agencies-using-agency-names-and-categories">2. Ask it to classify agencies using agency names and categories</h2>
<p>Next, using the agency names and categories generated above I’ll ask GPT to do classification. First, I’ll define a function that takes a category as input and runs a query against GPT asking it to put the agencies into the provided category, returning a list of agencies that it put in that category. Although I could ask GPT to classify agencies using all categories in a single query, I expect this would be less reliable than tackling each category separately. One of the trade-offs here is that I won’t get mutual exclusivity of the categories, since GPT won’t know how it’s already classified agencies. For this analysis, let’s assume I don’t want mutual exclusivity.</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">get_agencies_in_category</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">query</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I'm going to present a comma-separated list of US agencies,</span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    delimited by triple backticks (```), and a single category to </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    which some of the agencies belong, delimited by triple hashtags (###). </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Your task is to provide a comma-separated list of agency names that </span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    belong in the category provided.</span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ```"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_str</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```</span></span>
<span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    ###"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"###"</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">results</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chatGPT</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">query</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return as a vector</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">results</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</div>
<p>Using the function above, I’ll query GPT for each of the categories, saving the results into a list called <code>agencies_categorized</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'agencies_categorized'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_categorized</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Other'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>      <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_categorized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_agencies_in_category</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span>
<span>    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save to disk</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_categorized</span>, file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'agencies_categorized.Rdata'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span>  </span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_categorized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$`Defense and Military`
 [1] "69A345 Office of the Under Secretary for Policy"   
 [2] "69A350 OSDBU"                                      
 [3] "69A355 Research and Technology"                    
 [4] "ACC APG - Natick"                                  
 [5] "ACC-APG-Aberdeen Division A"                       
 [6] "ACC-APG-Belvoir"                                   
 [7] "ACC-APG-Detrick"                                   
 [8] "ACC-APG-Edgewood"                                  
 [9] "ACC-APG-Fort Huachuca"                             
[10] "Air Force -- Materiel Command"                     
[11] "Air Force -- Research Lab"                         
[12] "Air Force Academy"                                 
[13] "Air Force Office of Scientific Research"           
[14] "Alaska District"                                   
[15] "Army Contracting Command - Benet Laboratories"     
[16] "Army Contracting Command - New Jersey"             
[17] "Army Contracting Command Rock Island"              
[18] "Bureau of Diplomatic Security"                     
[19] "Bureau of International Security-Nonproliferation" 
[20] "Bureau of Political-Military Affairs - GPI"        
[21] "Bureau of Political-Military Affairs - WRA"        
[22] "DARPA - Biological Technologies Office"            
[23] "DARPA - Defense Sciences Office"                   
[24] "DARPA - Information Innovation Office"             
[25] "DARPA - Information Processing Technology Office"  
[26] "DARPA - Microsystems Technology Office"            
[27] "DARPA - Strategic Technology Office"               
[28] "DARPA - Tactical Technology Office"                
[29] "DARPA - Transformational Convergence Technology"   
[30] "DARPA-MTO-BAA-09-25"                               
[31] "Defense Advanced Research Projects Agency"         
[32] "Defense Health Agency"                             
[33] "Defense Intelligence Agency"                       
[34] "Defense Logistics Agency"                          
[35] "Defense Threat Reduction Agency"                   
[36] "Department of Defense"                             
[37] "Dept of the Army -- Materiel Command"              
[38] "Dept. of the Army  --  Corps of Engineers"         
[39] "Dept. of the Army -- Space &amp; Missle Defense Comman"
[40] "Dept. of the Army -- USAMRAA"                      
[41] "DoD Education Activity"                            
[42] "DOT - FAA Aviation Research Grants"                
[43] "DOT - FAA Centers of Excellence"                   
[44] "DOT Federal Aviation Administration"               
[45] "Engineer Research and Development Center"          
[46] "Fort Worth District"                               
[47] "Kansas City District"                              
[48] "Missile Defense Agency"                            
[49] "Mission and Install. Cmd. JBSA Ft. Sam Houston"    
[50] "NAVAIR"                                            
[51] "Naval Air Warfare Center Aircraft Div. Lakehurst"  
[52] "NAVAL FACILITIES ENGINEERING COMMAND"              
[53] "Naval Facilities Engineering Command Southwest"    
[54] "Naval Information Warfare Center Pacific"          
[55] "NAVAL MEDICAL LOGISTICS COMMAND"                   
[56] "Naval Research Laboratory"                         
[57] "Naval Supply Systems Command"                      
[58] "Naval Surface Warfare Center - Carderock"          
[59] "NAVFAC Atlantic"                                   
[60] "NAVFAC Washington DC"                              
[61] "NCA Contracting"                                   
[62] "NEA Cooperative Agreements Office"                 
[63] "NSWC - CRANE"                                      
[64] "NSWC Indian Head"                                  
[65] "NUWC Division Keyport"                             
[66] "Office of Local Defense Community Cooperation"     
[67] "Office of Naval Research"                          
[68] "Office of the Director of National Intelligence"   
[69] "Omaha District"                                    
[70] "Savannah District"                                 
[71] "Seattle District"                                  
[72] "SPAWAR SYSTEMS CENTER"                             
[73] "U.S. Dept. of Treasury RESTORE Act Program"        
[74] "U.S. Mission to NATO"                              
[75] "United States Coast Guard"                         
[76] "United States Marine Corps"                        
[77] "USAF 347 Contracting Squadron"                     
[78] "Washington Headquarters Services"                  

$`Science and Technology`
 [1] "69A345 Office of the Under Secretary for Policy"   
 [2] "69A355 Research and Technology"                    
 [3] "Advanced Research Projects Agency Energy"          
 [4] "Advanced Research Projects Agency for Health"      
 [5] "Agency for Health Care Research and Quality"       
 [6] "Agricultural Research Service"                     
 [7] "Air Force -- Research Lab"                         
 [8] "Air Force Office of Scientific Research"           
 [9] "Army Contracting Command - Benet Laboratories"     
[10] "Bureau of Oceans - Int. Environmental - Scientific"
[11] "Centers for Disease Control - ATSDR"               
[12] "Centers for Disease Control - CFA"                 
[13] "Centers for Disease Control - CGH"                 
[14] "Centers for Disease Control - CSELS"               
[15] "Centers for Disease Control - NCBDDD"              
[16] "Centers for Disease Control - NCCDPHP"             
[17] "Centers for Disease Control - NCEH"                
[18] "Centers for Disease Control - NCEZID"              
[19] "Centers for Disease Control - NCHHSTP"             
[20] "Centers for Disease Control - NCHS"                
[21] "Centers for Disease Control - NCIPC"               
[22] "Centers for Disease Control - NCIRD"               
[23] "Centers for Disease Control - NIOSH"               
[24] "Centers for Disease Control - OD"                  
[25] "Centers for Disease Control - OPHPR"               
[26] "Centers for Disease Control - OSTLTS"              
[27] "Centers for Disease Control and Prevention"        
[28] "Centers for Disease Control and Prevention - ERA"  
[29] "DARPA - Biological Technologies Office"            
[30] "DARPA - Defense Sciences Office"                   
[31] "DARPA - Information Innovation Office"             
[32] "DARPA - Information Processing Technology Office"  
[33] "DARPA - Microsystems Technology Office"            
[34] "DARPA - Strategic Technology Office"               
[35] "DARPA - Tactical Technology Office"                
[36] "DARPA - Transformational Convergence Technology"   
[37] "Defense Advanced Research Projects Agency"         
[38] "Defense Health Agency"                             
[39] "Defense Intelligence Agency"                       
[40] "Defense Threat Reduction Agency"                   
[41] "Department of Energy"                              
[42] "DoD Education Activity"                            
[43] "DOT - FAA Aviation Research Grants"                
[44] "DOT - FAA Centers of Excellence"                   
[45] "DOT Federal Aviation Administration"               
[46] "Economic Research Service"                         
[47] "Engineer Research and Development Center"          
[48] "Environmental Protection Agency"                   
[49] "FAA - Aviation Next Gen"                           
[50] "FAA-COE-AJFE"                                      
[51] "FAA-COE-GA"                                        
[52] "FAA-COE-TTHP"                                      
[53] "Food and Drug Administration"                      
[54] "Geological Survey"                                 
[55] "Health Resources and Services Administration"      
[56] "Indian Health Service"                             
[57] "Institute of Museum and Library Services"          
[58] "National Aeronautics and Space Administration"     
[59] "National Energy Technology Laboratory"             
[60] "National Geospatial-Intelligence Agency"           
[61] "National Highway Traffic Safety Administration"    
[62] "National Institute of Food and Agriculture"        
[63] "National Institute of Justice"                     
[64] "National Institute of Standards and Technology"    
[65] "National Institutes of Health"                     
[66] "National Oceanic and Atmospheric Administration"   
[67] "National Park Service"                             
[68] "National Science Foundation"                       
[69] "National Telecommunications and Information Admini"
[70] "Naval Research Laboratory"                         
[71] "Naval Supply Systems Command"                      
[72] "Naval Surface Warfare Center - Carderock"          
[73] "NNSA"                                              
[74] "Nuclear Regulatory Commission"                     
[75] "NUWC Division Keyport"                             
[76] "Oak Ridge Office"                                  
[77] "Office of Science"                                 
[78] "Office of the Assistant Secretary for Health"      
[79] "Office of the Director of National Intelligence"   
[80] "Office of the National Coordinator"                
[81] "Pipeline and Hazardous Materials Safety Admin"     
[82] "Risk Management Agency"                            
[83] "Science and Technology Directorate"                
[84] "Substance Abuse and Mental Health Services Admin"  
[85] "Substance Abuse and Mental Health Services Adminis"
[86] "Uniformed Services Univ. of the Health Sciences"   
[87] "USUHS Medical - Non- Research Projects"            
[88] "USUHS Medical Research Projects"                   
[89] "USAID"                                             
[90] "Woodrow Wilson Center"                             

$`Health and Medicine`
 [1] "Administration for Children &amp; Families - ACYF/FYSB"
 [2] "Administration for Children and Families"          
 [3] "Administration for Children and Families - ACYF/CB"
 [4] "Administration for Children and Families - ANA"    
 [5] "Administration for Children and Families - OCC"    
 [6] "Administration for Children and Families - OCS"    
 [7] "Administration for Children and Families - OCSE"   
 [8] "Administration for Children and Families - OFA"    
 [9] "Administration for Children and Families - OHS"    
[10] "Administration for Children and Families - OHSEPR" 
[11] "Administration for Children and Families - OPRE"   
[12] "Administration for Children and Families - ORR"    
[13] "Administration for Children and Families-IOAS-OTIP"
[14] "Administration for Community Living"               
[15] "Administration on Aging"                           
[16] "Advanced Research Projects Agency for Health"      
[17] "Agency for Health Care Research and Quality"       
[18] "Centers for Disease Control - ATSDR"               
[19] "Centers for Disease Control - CFA"                 
[20] "Centers for Disease Control - CGH"                 
[21] "Centers for Disease Control - CSELS"               
[22] "Centers for Disease Control - NCBDDD"              
[23] "Centers for Disease Control - NCCDPHP"             
[24] "Centers for Disease Control - NCEH"                
[25] "Centers for Disease Control - NCEZID"              
[26] "Centers for Disease Control - NCHHSTP"             
[27] "Centers for Disease Control - NCHS"                
[28] "Centers for Disease Control - NCIPC"               
[29] "Centers for Disease Control - NCIRD"               
[30] "Centers for Disease Control - NIOSH"               
[31] "Centers for Disease Control - OD"                  
[32] "Centers for Disease Control - OPHPR"               
[33] "Centers for Disease Control - OSTLTS"              
[34] "Centers for Disease Control and Prevention"        
[35] "Centers for Disease Control and Prevention - ERA"  
[36] "Centers for Medicare &amp; Medicaid Services"          
[37] "CMS Consumer Operated and Oriented Plan Program"   
[38] "CMS-Consumer Information &amp; Insurance Oversight"    
[39] "Defense Health Agency"                             
[40] "Department of Health and Human Services"           
[41] "Food and Drug Administration"                      
[42] "Health Resources and Services Administration"      
[43] "Indian Health Service"                             
[44] "National Institute of Food and Agriculture"        
[45] "National Institutes of Health"                     
[46] "Office of the Assistant Secretary for Health"      
[47] "Office of the National Coordinator"                
[48] "Substance Abuse and Mental Health Services Admin"  
[49] "Substance Abuse and Mental Health Services Adminis"
[50] "Uniformed Services Univ. of the Health Sciences"   
[51] "USUHS Medical - Non- Research Projects"            
[52] "USUHS Medical Research Projects"                   
[53] "VA Office of Mental Health"                        
[54] "VHA Member Services-Veterans Transportation"       

$`International Aid`
 [1] "Afghanistan USAID-Kabul"                        
 [2] "Africa Regional Services"                       
 [3] "Agency for International Development"           
 [4] "Albania USAID-Tirana"                           
 [5] "Armenia USAID-Yerevan"                          
 [6] "Azerbaijan USAID-Baku"                          
 [7] "Bangladesh USAID-Dhaka"                         
 [8] "Benin USAID-Cotonou"                            
 [9] "Bolivia USAID-La Paz"                           
[10] "Bosnia USAID-Herzegovina"                       
[11] "Brazil USAID-Brasilia"                          
[12] "Burma USAID - Rangoon"                          
[13] "Burundi USAID-Bujumbura"                        
[14] "Cambodia USAID-Phnom Penh"                      
[15] "Colombia USAID-Bogota"                          
[16] "Democratic Republic of the Congo USAID-Kinshasa"
[17] "Dominican Republic USAID-Santo Domingo"         
[18] "East Africa USAID-Kenya"                        
[19] "Ecuador USAID-Quito"                            
[20] "Egypt USAID-Cairo"                              
[21] "El Salvador USAID-San Salvador"                 
[22] "Ethiopia USAID-Addis Ababa"                     
[23] "Georgia USAID-Tbilisi"                          
[24] "Ghana USAID-Accra"                              
[25] "Guatemala USAID-Guatemala City"                 
[26] "Guinea USAID-Conakry"                           
[27] "Haiti USAID-Port Au Prince"                     
[28] "Honduras USAID-Tegucigalpa"                     
[29] "Hungary USAID-Budapest"                         
[30] "India USAID-New Delhi"                          
[31] "Indonesia USAID-Jakarta"                        
[32] "Iraq Assistance Office"                         
[33] "Iraq USAID-Baghdad"                             
[34] "Jamaica USAID-Kingston"                         
[35] "Jordan USAID-Amman"                             
[36] "Kazakhstan USAID-Almaty"                        
[37] "Kenya USAID-Nairobi"                            
[38] "Kosovo USAID-Pristina"                          
[39] "Lebanon USAID-Beirut"                           
[40] "Liberia USAID-Monrovia"                         
[41] "Macedonia USAID-Skopje"                         
[42] "Madagascar USAID-Antananarivo"                  
[43] "Malawi USAID-Lilongwe"                          
[44] "Mali USAID -Bamako"                             
[45] "Mexico USAID-Mexico City"                       
[46] "Middle East Regional Platform USAID-MERP"       
[47] "Moldova USAID-Chisinau"                         
[48] "Mongolia USAID-Ulaanbaatar"                     
[49] "Morocco USAID-Rabat"                            
[50] "Mozambique USAID-Maputo"                        
[51] "Nepal USAID-Kathmandu"                          
[52] "Nicaragua USAID-Managua"                        
[53] "Nigeria USAID-Abuja"                            
[54] "Pakistan USAID-Islamabad"                       
[55] "Panama USAID-Panama City"                       
[56] "Paraguay USAID-Asuncion"                        
[57] "Peru USAID-Lima"                                
[58] "Philippines USAID-Manila"                       
[59] "Rwanda USAID-Kigali"                            
[60] "Senegal USAID-Dakar"                            
[61] "Serbia USAID-Belgrade"                          
[62] "South Africa USAID-Pretoria"                    
[63] "South Sudan (USAID)-Juba"                       
[64] "Sri Lanka USAID-Colombo"                        
[65] "Sudan USAID-Khartoum"                           
[66] "Tajikistan USAID-Dushanbe"                      
[67] "Tanzania USAID-Dar es Salaam"                   
[68] "Thailand USAID-Bangkok"                         
[69] "Uganda USAID-Kampala"                           
[70] "Ukraine USAID-Kiev"                             
[71] "Uzbekistan USAID-Tashkent"                      
[72] "West Africa USAID-Ghana"                        
[73] "West Bank"                                      
[74] "Gaza USAID-West Bank"                           
[75] "Yemen USAID-Sanaa"                              
[76] "Zambia USAID-Lusaka"                            
[77] "Zimbabwe USAID-Harare"                          
[78] "USAID"                                          
[79] "USAID - Barbados and Eastern Caribbean"         
[80] "USAID-VIETNAM"                                  

$`Education and Research`
  [1] "Advanced Research Projects Agency Energy"          
  [2] "Advanced Research Projects Agency for Health"      
  [3] "Agency for Health Care Research and Quality"       
  [4] "Air Force Academy"                                 
  [5] "Air Force Office of Scientific Research"           
  [6] "Army Contracting Command - Benet Laboratories"     
  [7] "Bureau Of Educational and Cultural Affairs"        
  [8] "Centers for Disease Control - ATSDR"               
  [9] "Centers for Disease Control - CFA"                 
 [10] "Centers for Disease Control - CGH"                 
 [11] "Centers for Disease Control - CSELS"               
 [12] "Centers for Disease Control - NCBDDD"              
 [13] "Centers for Disease Control - NCCDPHP"             
 [14] "Centers for Disease Control - NCEH"                
 [15] "Centers for Disease Control - NCEZID"              
 [16] "Centers for Disease Control - NCHHSTP"             
 [17] "Centers for Disease Control - NCHS"                
 [18] "Centers for Disease Control - NCIPC"               
 [19] "Centers for Disease Control - NCIRD"               
 [20] "Centers for Disease Control - NIOSH"               
 [21] "Centers for Disease Control - OD"                  
 [22] "Centers for Disease Control - OPHPR"               
 [23] "Centers for Disease Control - OSTLTS"              
 [24] "Centers for Disease Control and Prevention"        
 [25] "Centers for Disease Control and Prevention - ERA"  
 [26] "Centers for Medicare &amp; Medicaid Services"          
 [27] "Chief Evaluation Office"                           
 [28] "CMS Consumer Operated and Oriented Plan Program"   
 [29] "CMS-Consumer Information &amp; Insurance Oversight"    
 [30] "DARPA - Biological Technologies Office"            
 [31] "DARPA - Defense Sciences Office"                   
 [32] "DARPA - Information Innovation Office"             
 [33] "DARPA - Information Processing Technology Office"  
 [34] "DARPA - Microsystems Technology Office"            
 [35] "DARPA - Strategic Technology Office"               
 [36] "DARPA - Tactical Technology Office"                
 [37] "DARPA - Transformational Convergence Technology"   
 [38] "DARPA-MTO-BAA-09-25"                               
 [39] "Defense Advanced Research Projects Agency"         
 [40] "Defense Health Agency"                             
 [41] "Defense Intelligence Agency"                       
 [42] "Department of Education"                           
 [43] "DoD Education Activity"                            
 [44] "DOT - FAA Aviation Research Grants"                
 [45] "DOT - FAA Centers of Excellence"                   
 [46] "DOT Federal Aviation Administration"               
 [47] "Economic Research Service"                         
 [48] "Engineer Research and Development Center"          
 [49] "FAA - Aviation Next Gen"                           
 [50] "FAA-COE-AJFE"                                      
 [51] "FAA-COE-GA"                                        
 [52] "FAA-COE-TTHP"                                      
 [53] "Faculty Exchange Program 10.613"                   
 [54] "Fish and Wildlife Service"                         
 [55] "Fisheries &amp; Habitat Conservation"                  
 [56] "Food and Drug Administration"                      
 [57] "Food and Nutrition Service"                        
 [58] "Food Safety Inspection Service"                    
 [59] "Foreign Agricultural Service"                      
 [60] "Forest Service"                                    
 [61] "Geological Survey"                                 
 [62] "Health Resources and Services Administration"      
 [63] "Indian Health Service"                             
 [64] "Institute of Museum and Library Services"          
 [65] "Internal Revenue Service"                          
 [66] "International Agricultural Educ Fellowship 10.619" 
 [67] "Library of Congress"                               
 [68] "NASA Ames Research Center"                         
 [69] "NASA Armstrong Flight Research Center"             
 [70] "NASA Glenn Research Center"                        
 [71] "NASA Goddard Space Flight Center"                  
 [72] "NASA Headquarters"                                 
 [73] "NASA Johnson Space Center"                         
 [74] "NASA Kennedy Space Center"                         
 [75] "NASA Langley Research Center"                      
 [76] "NASA Marshall Space Flight Center"                 
 [77] "NASA Stennis Space Center"                         
 [78] "National Aeronautics and Space Administration"     
 [79] "National Archives and Records Administration"      
 [80] "National Endowment for the Arts"                   
 [81] "National Endowment for the Humanities"             
 [82] "National Energy Technology Laboratory"             
 [83] "National Geospatial-Intelligence Agency"           
 [84] "National Highway Traffic Safety Administration"    
 [85] "National Institute of Corrections"                 
 [86] "National Institute of Food and Agriculture"        
 [87] "National Institute of Justice"                     
 [88] "National Institute of Standards and Technology"    
 [89] "National Institutes of Health"                     
 [90] "National Oceanic and Atmospheric Administration"   
 [91] "National Park Service"                             
 [92] "National Science Foundation"                       
 [93] "National Telecommunications and Information Admini"
 [94] "National Veterans Sports Programs"                 
 [95] "Natural Resources Conservation Service"            
 [96] "Naval Research Laboratory"                         
 [97] "Nuclear Regulatory Commission"                     
 [98] "Office of Science"                                 
 [99] "Office of the Assistant Secretary for Health"      
[100] "Office of the Director of National Intelligence"   
[101] "Office of the National Coordinator"                
[102] "Office of the Secretary"                           
[103] "Occupational Safety and Health Administration"     
[104] "Pipeline and Hazardous Materials Safety Admin"     
[105] "Risk Management Agency"                            
[106] "Risk Management Education"                         
[107] "Rural Business-Cooperative Service"                
[108] "Rural Housing Service"                             
[109] "Rural Utilities Service"                           
[110] "Scientific Cooperation and Research 10.961"        
[111] "Social Security Administration"                    
[112] "Substance Abuse and Mental Health Services Admin"  
[113] "Substance Abuse and Mental Health Services Adminis"
[114] "Technical Agricultural Assistance 10.960"          
[115] "Uniformed Services Univ. of the Health Sciences"   
[116] "USUHS Medical - Non- Research Projects"            
[117] "USUHS Medical Research Projects"                   
[118] "Veterans Employment and Training Service"          
[119] "Volunteer Income Tax Assistance"                   
[120] "Woodrow Wilson Center"                             

$`Agriculture and Environment`
 [1] "Agricultural Marketing Service"                    
 [2] "Agricultural Trade Promotion Program 10.618"       
 [3] "Animal and Plant Health Inspection Service"        
 [4] "Bureau of Land Management"                         
 [5] "Bureau of Ocean Energy Management"                 
 [6] "Bureau of Reclamation"                             
 [7] "Bureau of Reclamation - Denver Office"             
 [8] "Bureau of Reclamation - Great Plains Region"       
 [9] "Bureau of Reclamation - Lower Colorado Region"     
[10] "Bureau of Reclamation - Mid-Pacific Region"        
[11] "Bureau of Reclamation - Pacific Northwest Region"  
[12] "Bureau of Reclamation - Upper Colorado Region"     
[13] "Bureau of Reclamation-Upper Columbia Area Office"  
[14] "Bureau of Reclamation"                             
[15] "Denver Office"                                     
[16] "Bureau of Reclamation"                             
[17] "Mid-Pacific Regional Office"                       
[18] "Bureau of Safety and Environmental Enforcement"    
[19] "Department of Agriculture"                         
[20] "Endangered Species"                                
[21] "Environmental Management Consolidated Business Cen"
[22] "Environmental Protection Agency"                   
[23] "Farm Production and Conservation Business Center"  
[24] "Farm Service Agency"                               
[25] "Fish and Wildlife Service"                         
[26] "Fisheries &amp; Habitat Conservation"                  
[27] "Forest Service"                                    
[28] "Migratory Birds"                                   
[29] "National Energy Technology Laboratory"             
[30] "National Oceanic and Atmospheric Administration"   
[31] "Natural Resources Conservation Service"            
[32] "Office of Science"                                 
[33] "Risk Management Agency"                            
[34] "Rural Business-Cooperative Service"                
[35] "Rural Housing Service"                             
[36] "Rural Utilities Service"                           

$`Infrastructure and Transportation`
  [1] "```69A345 Office of the Under Secretary for Policy"
  [2] "69A350 OSDBU"                                      
  [3] "69A355 Research and Technology"                    
  [4] "ACC APG - Natick"                                  
  [5] "ACC-APG-Aberdeen Division A"                       
  [6] "ACC-APG-Belvoir"                                   
  [7] "ACC-APG-Detrick"                                   
  [8] "ACC-APG-Edgewood"                                  
  [9] "ACC-APG-Fort Huachuca"                             
 [10] "Air Force -- Materiel Command"                     
 [11] "Air Force -- Research Lab"                         
 [12] "Air Force Academy"                                 
 [13] "Air Force Office of Scientific Research"           
 [14] "Airport Improvement Program Discretionary Grants"  
 [15] "Alaska District"                                   
 [16] "Army Contracting Command - Benet Laboratories"     
 [17] "Army Contracting Command - New Jersey"             
 [18] "Army Contracting Command Rock Island"              
 [19] "Bureau of Land Management"                         
 [20] "Bureau of Ocean Energy Management"                 
 [21] "Bureau of Reclamation"                             
 [22] "Bureau of Reclamation - Denver Office"             
 [23] "Bureau of Reclamation - Great Plains Region"       
 [24] "Bureau of Reclamation - Lower Colorado Region"     
 [25] "Bureau of Reclamation - Mid-Pacific Region"        
 [26] "Bureau of Reclamation - Pacific Northwest Region"  
 [27] "Bureau of Reclamation - Upper Colorado Region"     
 [28] "Bureau of Reclamation-Upper Columbia Area Office"  
 [29] "Bureau of Reclamation"                             
 [30] "Denver Office"                                     
 [31] "Bureau of Reclamation"                             
 [32] "Mid-Pacific Regional Office"                       
 [33] "Bureau of Safety and Environmental Enforcement"    
 [34] "Chicago Service Center"                            
 [35] "DARPA - Biological Technologies Office"            
 [36] "DARPA - Defense Sciences Office"                   
 [37] "DARPA - Information Innovation Office"             
 [38] "DARPA - Information Processing Technology Office"  
 [39] "DARPA - Microsystems Technology Office"            
 [40] "DARPA - Strategic Technology Office"               
 [41] "DARPA - Tactical Technology Office"                
 [42] "DARPA - Transformational Convergence Technology"   
 [43] "Defense Advanced Research Projects Agency"         
 [44] "Defense Health Agency"                             
 [45] "Defense Intelligence Agency"                       
 [46] "Defense Logistics Agency"                          
 [47] "Defense Threat Reduction Agency"                   
 [48] "Department of Transportation"                      
 [49] "Dept of the Army -- Materiel Command"              
 [50] "Dept. of the Army  --  Corps of Engineers"         
 [51] "Dept. of the Army -- Space &amp; Missle Defense Comman"
 [52] "Dept. of the Army -- USAMRAA"                      
 [53] "DOT - FAA Aviation Research Grants"                
 [54] "DOT - FAA Centers of Excellence"                   
 [55] "DOT - Federal Railroad Administration"             
 [56] "DOT Federal Aviation Administration"               
 [57] "DOT Federal Highway Administration"                
 [58] "DOT OSDBU"                                         
 [59] "DOT-Federal Motor Carrier Safety Administration"   
 [60] "DOT-Federal Transit Administration - Inactive Site"
 [61] "DOT/Federal Transit Administration"                
 [62] "Economic Development Administration"               
 [63] "Engineer Research and Development Center"          
 [64] "FAA - Aviation Next Gen"                           
 [65] "FAA-COE-AJFE"                                      
 [66] "FAA-COE-GA"                                        
 [67] "FAA-COE-TTHP"                                      
 [68] "Federal Communications Commission"                 
 [69] "Federal Mediation and Conciliation Service"        
 [70] "Federal Motor Carrier Safety Administration"       
 [71] "Federal Transit Administration"                    
 [72] "Fort Worth District"                               
 [73] "Kansas City District"                              
 [74] "Maritime Administration"                           
 [75] "NASA Ames Research Center"                         
 [76] "NASA Armstrong Flight Research Center"             
 [77] "NASA Glenn Research Center"                        
 [78] "NASA Goddard Space Flight Center"                  
 [79] "NASA Headquarters"                                 
 [80] "NASA Johnson Space Center"                         
 [81] "NASA Kennedy Space Center"                         
 [82] "NASA Langley Research Center"                      
 [83] "NASA Marshall Space Flight Center"                 
 [84] "NASA Stennis Space Center"                         
 [85] "National Aeronautics and Space Administration"     
 [86] "National Highway Traffic Safety Administration"    
 [87] "National Oceanic and Atmospheric Administration"   
 [88] "National Telecommunications and Information Admini"
 [89] "Naval Air Warfare Center Aircraft Div. Lakehurst"  
 [90] "NAVAL FACILITIES ENGINEERING COMMAND"              
 [91] "Naval Facilities Engineering Command Southwest"    
 [92] "Naval Information Warfare Center Pacific"          
 [93] "NAVAL MEDICAL LOGISTICS COMMAND"                   
 [94] "Naval Research Laboratory"                         
 [95] "Naval Supply Systems Command"                      
 [96] "Naval Surface Warfare Center - Carderock"          
 [97] "NAVFAC Atlantic"                                   
 [98] "NAVFAC Washington DC"                              
 [99] "NCA Contracting"                                   
[100] "Nebraska State Office"                             
[101] "Nuclear Regulatory Commission"                     
[102] "NUWC Division Keyport"                             
[103] "Office of Local Defense Community Cooperation"     
[104] "Office of the Secretary"                           
[105] "Omaha District"                                    
[106] "Pipeline and Hazardous Materials Safety Admin"     
[107] "Region 1"                                          
[108] "Region 10"                                         
[109] "Region 2"                                          
[110] "Region 3"                                          
[111] "Region 4"                                          
[112] "Region 5"                                          
[113] "Region 6"                                          
[114] "Region 7"                                          
[115] "Region 8"                                          
[116] "Region 9"                                          
[117] "Risk Management Agency"                            
[118] "Rural Utilities Service"                           
[119] "Savannah District"                                 
[120] "Seattle District"                                  
[121] "SPAWAR SYSTEMS CENTER"                             
[122] "Transportation Security Administration"            
[123] "U.S. Dept. of Treasury RESTORE Act Program"        
[124] "United States Coast Guard"                         
[125] "United States Marine Corps"                        
[126] "USACE Portland District"                           
[127] "USAF 347 Contracting Squadron"                     
[128] "Walla Walla District"                              
[129] "Washington Headquarters Services```"               

$`Business and Economic Development`
 [1] "Economic Development Administration"               
 [2] "Small Business Administration"                     
 [3] "Community Development Financial Institutions"      
 [4] "Rural Business-Cooperative Service"                
 [5] "Employment and Training Administration"            
 [6] "Office of Local Defense Community Cooperation"     
 [7] "Economic Research Service"                         
 [8] "Agricultural Marketing Service"                    
 [9] "Agricultural Trade Promotion Program 10.618"       
[10] "Bureau of Economic and Business Affairs"           
[11] "Trade Policy and Geographic Affairs"               
[12] "Market Access Program 10.601"                      
[13] "Foreign Agricultural Service"                      
[14] "Foreign Market Development Cooperator Prog 10600"  
[15] "Technical Assistance for Specialty Crops 10.604"   
[16] "Jobs and Innovation Accelerator Challenge"         
[17] "Energy Cluster Program"                            
[18] "DOT - FAA Centers of Excellence"                   
[19] "DOT Federal Highway Administration"                
[20] "DOT OSDBU"                                         
[21] "DOT-Federal Motor Carrier Safety Administration"   
[22] "DOT-Federal Transit Administration - Inactive Site"
[23] "DOT/Federal Transit Administration"                
[24] "Federal Communications Commission"                 
[25] "National Business Center"                          
[26] "National Telecommunications and Information Admini"
[27] "U.S. Dept. of Treasury RESTORE Act Program"        
[28] "Volunteer Income Tax Assistance"                   
[29] "Low Income Taxpayer Clinic"                        
[30] "Tax Counseling for the Elderly"                    
[31] "CMS Consumer Operated and Oriented Plan Program"   
[32] "CMS-Consumer Information &amp; Insurance Oversight"    
[33] "Office of Acquisitions Management"                 
[34] "Office of Procurement Operations - Grants Division"
[35] "Office of the Secretary"                           
[36] "Office on Violence Against Women"                  
[37] "Veterans Employment and Training Service"          
[38] "Veterans Employment Pay for Success"               
[39] "Office of Disability Employment Policy"            
[40] "Office of Partnerships and Public Engagements"     
[41] "Risk Management Agency"                            
[42] "Risk Management Education"                         
[43] "Office of the Assistant Secretary for Health"      
[44] "Office of the National Coordinator"                
[45] "Office of the Director of National Intelligence"   
[46] "Office of the Middle East Partnership Initiative"  
[47] "Office to Monitor-Combat Trafficking in Persons"   
[48] "Office of Global Womens Issues"                    
[49] "Office of Global Criminal Justice"                 
[50] "Office of Justice Programs"                        
[51] "Office of Juvenile Justice Delinquency Prevention" 
[52] "Office for Victims of Crime"                       
[53] "Office of Science"                                 
[54] "Office of Surface Mining"                          
[55] "Office of Mental Health and Suicide Prevention"    
[56] "Office of National Drug Control Policy"            
[57] "Office of the Secretary"                           
[58] "Office of Policy ORES"                             
[59] "Office of Acquisitions Management"                 
[60] "Office of Procurement Operations - Grants Division"
[61] "Office of the Secretary"                           
[62] "Office on Violence Against Women"                  
[63] "Veterans Employment and Training Service"          
[64] "Veterans Employment Pay for Success"               
[65] "Office of Disability Employment Policy"            
[66] "Office of Partnerships and Public Engagements"     
[67] "Risk Management Agency"                            
[68] "Risk Management Education"                         
[69] "Office of the Assistant Secretary for Health"      
[70] "Office of the National Coordinator"                
[71] "Office of the Director of National Intelligence"   
[72] "Office of the Middle East Partnership Initiative"  
[73] "Office to Monitor-Combat Trafficking in Persons"   
[74] "Office of Global Womens Issues"                    
[75] "Office of Global Criminal Justice"                 
[76] "Office of Justice Programs"                        
[77] "Office of Juvenile Justice Delinquency Prevention" 
[78] "Office for Victims of Crime"                       
[79] "Office of Science"                                 
[80] "Office of Surface Mining"                          
[81] "Office of Mental Health and Suicide Prevention"    
[82] "Office of National Drug Control Policy"            

$`Arts and Culture`
[1] "National Endowment for the Arts"             
[2] "National Endowment for the Humanities"       
[3] "Institute of Museum and Library Services"    
[4] "Library of Congress"                         
[5] "National Archives and Records Administration"
[6] "Smithsonian Institution"                     

$`Social Services and Community Development`
 [1] "Administration for Children &amp; Families - ACYF/FYSB"
 [2] "Administration for Children and Families"          
 [3] "Administration for Children and Families - ACYF/CB"
 [4] "Administration for Children and Families - ANA"    
 [5] "Administration for Children and Families - OCC"    
 [6] "Administration for Children and Families - OCS"    
 [7] "Administration for Children and Families - OCSE"   
 [8] "Administration for Children and Families - OFA"    
 [9] "Administration for Children and Families - OHS"    
[10] "Administration for Children and Families - OHSEPR" 
[11] "Administration for Children and Families - OPRE"   
[12] "Administration for Children and Families - ORR"    
[13] "Administration for Children and Families-IOAS-OTIP"
[14] "Administration for Community Living"               
[15] "Administration on Aging"                           
[16] "AmeriCorps"                                        
[17] "Community Capacity Development Office"             
[18] "Community Development Financial Institutions"      
[19] "Community Oriented Policing Services"              
[20] "Corporation for National and Community Service"    
[21] "Department of Housing and Urban Development"       
[22] "Employment and Training Administration"            
[23] "Health Resources and Services Administration"      
[24] "Homeless Providers Grant and Per Diem Program"     
[25] "Housing and Urban Development"                     
[26] "Office of Juvenile Justice Delinquency Prevention" 
[27] "Office of Local Defense Community Cooperation"     
[28] "Office of the Assistant Secretary for Health"      
[29] "Office on Violence Against Women"                  
[30] "Rural Business-Cooperative Service"                
[31] "Rural Housing Service"                             
[32] "Rural Utilities Service"                           
[33] "Social Security Administration"                    
[34] "Substance Abuse and Mental Health Services Admin"  
[35] "Substance Abuse and Mental Health Services Adminis"
[36] "Supportive Services for Veteran Families"          
[37] "Veterans Employment and Training Service"          
[38] "Veterans Employment Pay for Success"               
[39] "Veterans Legacy Grants Program"                    
[40] "Volunteer Income Tax Assistance"                   
[41] "Womens Bureau"                                     </code></pre>
</div>
</div>
</section><section id="add-categories-to-dataframe" class="level2"><h2 class="anchored" data-anchor-id="add-categories-to-dataframe">Add categories to dataframe</h2>
<p>Finally, I’ll add the category labels to the <code>grant_opportunity_details</code> dataframe. Since the categories are not mutually exclusive, I’ll encode them as boolean.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories_snakecase</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">snakecase</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/snakecase/man/caseconverter.html">to_snake_case</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">i</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories_snakecase</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">grant_opportunity_details</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">grant_opportunity_details</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories_snakecase</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">i</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agency_name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">agencies_categorized</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">i</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</div>
</section></section><section id="data-analysis" class="level1"><h1>Data analysis</h1>
<p>Now that I have a list of agency categories, I can do some analysis. One question I might ask is how much total estimated funding is allocated to each of the agency categories?</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'category'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'estimated_total_funding'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">categories_snakecase</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'category'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span>,</span>
<span>        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'estimated_total_funding'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">grant_opportunity_details</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_program_funding</span>, na.rm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>      <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>funding_billions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numform</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/numform/man/f_denom.html">f_bills</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span>, digits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">funding_billions</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                    category funding_billions
1                     science_and_technology            52.9B
2                agriculture_and_environment            39.7B
3                     education_and_research            20.3B
4          infrastructure_and_transportation            17.7B
5          business_and_economic_development              16B
6  social_services_and_community_development            12.6B
7                       defense_and_military             9.4B
8                        health_and_medicine             2.6B
9                          international_aid             2.6B
10                          arts_and_culture              .1B</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding_ordered</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding_ordered</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert back from snake case to sentence case for better human readability</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">snakecase</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/snakecase/man/caseconverter.html">to_sentence_case</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">estimated_total_funding_ordered</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">category</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scales</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://scales.r-lib.org/reference/unit_format.html">unit_format</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>unit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, scale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-9</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Funding in Billions'</span>, title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Funding by US Government Agency Category'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/10/08/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#ggsave("social-image.png", height=960, width=1344, units = 'px', dpi=150)</span></span></code></pre></div>
</div>


<!-- -->

</section> ]]></description>
  <category>GPT</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/10/08/</guid>
  <pubDate>Sun, 08 Oct 2023 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/10/08/social-image.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Encoding high cardinality features with “embeddings”</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/09/19/</link>
  <description><![CDATA[ <p>Embedding is categorical encoding method that that uses deep learning to represent categorical features as vectors. It’s particularly useful for categorical features with many levels, since it can be used to project high-dimensional features into low-dimensional space.</p>
<p>In this blog post, I’ll show how ML models with embedding encoding outperform models with other common categorical encoding methods (frequency, label, one-hot, and target). For this demonstration, I’ll be using the dataset from <a href="https://www.kaggle.com/competitions/playground-series-s3e22/data">Kaggle’s Playground Series S3E22: Predict Health Outcomes of Horses</a>.</p>
<section id="load-libraries" class="level1"><h1>Load libraries</h1>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/laresbernardo/lares">lares</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/imbs-hl/ranger">ranger</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tensorflow.rstudio.com/">keras</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/h2oai/h2o-3">h2o</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/UBC-MDS/encodeR">encodeR</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html">h2o.init</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Connection successful!

R is connected to the H2O cluster: 
    H2O cluster uptime:         6 days 23 hours 
    H2O cluster timezone:       America/New_York 
    H2O data parsing timezone:  UTC 
    H2O cluster version:        3.42.0.2 
    H2O cluster version age:    1 month and 30 days 
    H2O cluster name:           H2O_started_from_R_tyler_wkj161 
    H2O cluster total nodes:    1 
    H2O cluster total memory:   3.11 GB 
    H2O cluster total cores:    8 
    H2O cluster allowed cores:  8 
    H2O cluster healthy:        TRUE 
    H2O Connection ip:          localhost 
    H2O Connection port:        54321 
    H2O Connection proxy:       NA 
    H2O Internal Security:      FALSE 
    R Version:                  R version 4.3.1 (2023-06-16) </code></pre>
</div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.no_progress.html">h2o.no_progress</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="load-the-data" class="level1"><h1>Load the data</h1>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/playground-series-s3e22/train.csv'</span>, show_col_types <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">F</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="categorical-variables" class="level1"><h1>Categorical variables</h1>
<p>This dataset contains 17 character columns.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'character'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "surgery"               "age"                   "temp_of_extremities"  
 [4] "peripheral_pulse"      "mucous_membrane"       "capillary_refill_time"
 [7] "pain"                  "peristalsis"           "abdominal_distention" 
[10] "nasogastric_tube"      "nasogastric_reflux"    "rectal_exam_feces"    
[13] "abdomen"               "abdomo_appearance"     "surgical_lesion"      
[16] "cp_data"               "outcome"              </code></pre>
</div>
</div>
<p>However, there are also several numeric categorical columns: <code>hospital_number</code>, <code>lesion_1</code>, <code>lesion_2</code>, and <code>lesion_3</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">hospital_number</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_2</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  hospital_number lesion_1 lesion_2 lesion_3
            &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1          530001     2209        0        0
2          533836     2208        0        0
3          529812     5124        0        0
4         5262541     2208        0        0
5         5299629        0        0        0
6          529642        0        0        0</code></pre>
</div>
</div>
<p><code>hospital_number</code> and <code>lesion_1</code> are of particular interest because they have so many levels.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">hospital_number</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 255</code></pre>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 57</code></pre>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
</div>
<p>Looking at the character columns, I see some case inconsistency (i.e., some columns have both “None” and “none”). Converting all strings to lowercase would help to at least combine the “none” types.</p>
<div class="cell">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">char_cols</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is.character</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">char_cols</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/chartr.html">toupper</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">': '</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>, collapse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "SURGERY: yes, no"
[1] "AGE: adult, young"
[1] "TEMP_OF_EXTREMITIES: cool, cold, normal, warm, None"
[1] "PERIPHERAL_PULSE: reduced, normal, None, absent, increased"
[1] "MUCOUS_MEMBRANE: dark_cyanotic, pale_cyanotic, pale_pink, normal_pink, bright_pink, bright_red, None"
[1] "CAPILLARY_REFILL_TIME: more_3_sec, less_3_sec, None, 3"
[1] "PAIN: depressed, mild_pain, extreme_pain, alert, severe_pain, None, slight"
[1] "PERISTALSIS: absent, hypomotile, normal, hypermotile, None, distend_small"
[1] "ABDOMINAL_DISTENTION: slight, moderate, none, severe, None"
[1] "NASOGASTRIC_TUBE: slight, none, significant, None"
[1] "NASOGASTRIC_REFLUX: less_1_liter, more_1_liter, none, None, slight"
[1] "RECTAL_EXAM_FECES: decreased, absent, None, normal, increased, serosanguious"
[1] "ABDOMEN: distend_small, distend_large, normal, firm, None, other"
[1] "ABDOMO_APPEARANCE: serosanguious, cloudy, clear, None"
[1] "SURGICAL_LESION: yes, no"
[1] "CP_DATA: no, yes"
[1] "OUTCOME: died, euthanized, lived"</code></pre>
</div>
</div>
</section><section id="traintest-split" class="level1"><h1>Train/test split</h1>
<p>Before diving into categorical encoding methods, I’ll do a train/test split. I’ll also convert the character columns to lowercase to address the problem I mentioned above (“None” vs.&nbsp;“none”), and I’ll convert <code>hospital_number</code> to categorical.</p>
<div class="cell">
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is.character</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, .funs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">tolower</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>outcome <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is.character</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">factor</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         hospital_number <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">hospital_number</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         lesion_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         lesion_2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         lesion_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.factor.html">as.factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial_split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="categorical-encoding" class="level1"><h1>Categorical encoding</h1>
<section id="one-hot-encoding" class="level2"><h2 class="anchored" data-anchor-id="one-hot-encoding">One-hot encoding</h2>
<div class="cell">
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_1hot_with_novel</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_novel</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_nominal_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, new_level <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NA"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_dummy</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_nominal_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, one_hot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<p>The first – and probably most popular – type of categorical encoding is one-hot encoding. One-hot encoding transforms a single categorical variable with N levels into binary variables encoding each of the N levels.</p>
<p>For example, <code>age</code> is a categorical variable with 2 levels.</p>
<div class="cell">
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">age</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "adult" "young"</code></pre>
</div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">age</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2</code></pre>
</div>
</div>
<p>When <code>age</code> is one-hot encoded, a column is created for each level to encode the value (e.g., if the original value was <code>adult</code>, then the <code>age_adult</code> column gets a 1 and the other columns get a 0). And since I’ve also included a step to encode novel levels as <code>NA</code>, there is also a third column for that.</p>
<div class="cell">
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_1hot_with_novel</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bake</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'age'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  age_adult age_young age_NA.
      &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
1         1         0       0
2         1         0       0
3         1         0       0</code></pre>
</div>
</div>
</section><section id="label-encoding" class="level2"><h2 class="anchored" data-anchor-id="label-encoding">Label encoding</h2>
<div class="cell">
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_label</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_integer</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_nominal_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<p>With label encoding, each level of the categorical variable is given an (arbitrary) number. In the <code>tidymodels</code> framework, <code>step_integer</code> works like scikit’s <code>LabelEncoder</code>, and encodes new values as zero. Here we see that one level of <code>age</code> was encoded as “1” and the other was encoded as “2”.</p>
<div class="cell">
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_label</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bake</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">age</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">distinct</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 1
    age
  &lt;int&gt;
1     1
2     2</code></pre>
</div>
</div>
</section><section id="frequency-encoding" class="level2"><h2 class="anchored" data-anchor-id="frequency-encoding">Frequency encoding</h2>
<div class="cell">
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">freq_encoding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">encodeR</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/encodeR/man/frequency_encoder.html">frequency_encoder</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>  X_train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span>,</span>
<span>  X_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span>, </span>
<span>  cat_columns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is.factor</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">freq_encoding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">freq_encoding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span></span></code></pre></div>
</div>
<p>With frequency encoding, levels of the categorical variable are replaced with their frequency. Here, we can see how the levels of <code>age</code> have been replaced with their frequency in the training set. (When this is applied to the test set, these same training frequencies will be used.)</p>
<div class="cell">
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">age</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 1
     age
   &lt;dbl&gt;
1 0.937 
2 0.0626</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="target-encoding" class="level2"><h2 class="anchored" data-anchor-id="target-encoding">Target encoding</h2>
<p>For target encoding (also called “effect encoding” or “likelihood encoding”), I’ll be using the <code>h2o</code> package because it supports multi-class targets. (The <code>embed</code> package can also do target encoding and integrates better with a tidymodels workflow, but at the moment it only supports binary targets.)</p>
<p>Using <code>h2o</code> requires some additional setup.</p>
<div class="cell">
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to h2o format</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_h2o</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split the dataset into train and test</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">splits_h2o</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.splitFrame.html">h2o.splitFrame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_h2o</span>, ratios <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.8</span>, seed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_h2o</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">splits_h2o</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_h2o</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">splits_h2o</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
</div>
<p>With target encoding, the levels of the categorical variable are replaced with their mean value on the target. For example, if the level “young” was associated with a mean target value of 0.75, then this is the value with which that level would be replaced.</p>
<p>Because the outcome is being used for encoding, care needs to be taken when using this method to avoid leakage and overfitting. In this case, I’ll use the “Leave One Out” method: for each row, the mean is calculated over all rows excluding that row.</p>
<div class="cell">
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Choose which columns to encode</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encode_columns</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is.factor</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All categorical variables</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train a TE model</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">te_model</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.targetencoder.html">h2o.targetencoder</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encode_columns</span>,</span>
<span>                              y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outcome'</span>, </span>
<span>                              keep_original_categorical_columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span>,</span>
<span>                              training_frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_h2o</span>,</span>
<span>                              noise<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span>                              seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span>                              blending <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Blending helps with levels that are more rare</span></span>
<span>                              data_leakage_handling <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LeaveOneOut"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># New target encoded training and test datasets</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.transform.html">h2o.transform</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">te_model</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_h2o</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.transform.html">h2o.transform</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">te_model</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_h2o</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<p>Here we can see how the target encoding strategy encoded <code>age</code>: Two new variables are created, <code>age_euthanized_te</code> and <code>age_lived_te</code>. The encoded values represent the proportion of cases that were euthanized, or lived, for each level of <code>age</code>. (Note: The “died” level of the outcome variable is missing. This is because if we know the proportion that were euthanized and lived, we also know the proportion that died.)</p>
<div class="cell">
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'age'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'te'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">age</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  age_euthanized_te age_lived_te   age
1        0.20937841    0.4776445 adult
2        0.06005923    0.2157985 young</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drop the unencoded columns</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encode_columns</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_te</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encode_columns</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_te</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a recipe to use later</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_target</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section></section><section id="embedding-encoding" class="level1"><h1>Embedding encoding</h1>
<p>Embedding is categorical encoding method that that uses deep learning to represent categorical features as vectors. It’s particularly useful for categorical features with many levels, since it can be used to project high-dimensional features into low-dimensional space.</p>
<p>For example, the variable <code>pain</code> has 7 levels.</p>
<div class="cell">
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pain</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "alert"        "depressed"    "extreme_pain" "mild_pain"    "none"        
[6] "severe_pain"  "slight"      </code></pre>
</div>
</div>
<p>But using embeddings, I can “project” these 7 levels onto a smaller set of dimensions – say 3.</p>
<div class="cell">
<div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pain_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">embed</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://embed.tidymodels.org/reference/step_embed.html">step_embed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pain</span>, </span>
<span>                    outcome <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    predictors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    hidden_units <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span>                    num_terms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span>                    keep_original_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensorflow</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pain_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prep</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bake</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>new_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pain'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  pain         pain_embed_1 pain_embed_2 pain_embed_3
  &lt;fct&gt;               &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
1 mild_pain         0.0466      -0.00297     0.000295
2 depressed         0.0470      -0.0332      0.00238 
3 severe_pain      -0.00442     -0.0437     -0.0509  
4 alert             0.0450      -0.0422      0.0152  
5 extreme_pain      0.0131      -0.0414     -0.00536 
6 none              0.0293      -0.0480     -0.0285  </code></pre>
</div>
</div>
<p>I want to use embedding strategically. Since embeddings are particularly useful to project into lower-dimensional space, this means it’s going to be most useful for categorical variables that have many levels. For variables with fewer than 3 levels, I’ll use one-hot encoding. For variables with more than 3 levels, I’ll use embeddings and project them onto 3 levels. I’ll project <code>hospital_number</code> onto 50 levels, and <code>lesion_1</code> onto 25 levels. (This is somewhat arbitrary; I did a quick few tests – not shown here – to arrive at these numbers.)</p>
<div class="cell">
<div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">hospital_number</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 255</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cat_cols</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">is.factor</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">hospital_number</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_onehot</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_embedding_special</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lesion_1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hospital_number'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cat_cols</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_onehot</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/append.html">append</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_onehot</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/append.html">append</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">col</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_embedding_special</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_normalize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_novel</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_onehot</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, new_level <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NA"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step_dummy</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_onehot</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, one_hot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">embed</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://embed.tidymodels.org/reference/step_embed.html">step_embed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cols_for_embedding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                    outcome <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    predictors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    hidden_units <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span>                    num_terms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span>                    keep_original_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">F</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">embed</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://embed.tidymodels.org/reference/step_embed.html">step_embed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">hospital_number</span>, </span>
<span>                    outcome <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    predictors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    hidden_units <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span>                    num_terms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span>                    keep_original_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">F</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">embed</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://embed.tidymodels.org/reference/step_embed.html">step_embed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">lesion_1</span>, </span>
<span>                    outcome <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    predictors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_numeric_predictors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>                    hidden_units <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span>                    num_terms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span>                    keep_original_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">F</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="modeling" class="level1"><h1>Modeling</h1>
<p>Now onto some modeling.</p>
<p>I’ll define 3 models to evaluate: multinomial logistic regression, random forest, and xgboost.</p>
<div class="cell">
<div class="sourceCode" id="cb47" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">multinom_mod</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multinom_reg</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Need to bump the max weights, otherwise it won't run</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nnet"</span>, MaxNWts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_mod</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand_forest</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>trees<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ranger"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">xgboost_mod</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boost_tree</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>trees<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"xgboost"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<section id="model-fit-function" class="level2"><h2 class="anchored" data-anchor-id="model-fit-function">Model fit function</h2>
<p>With 3 models and 5 categorical encodings, I’ll need to fit 15 models. To streamline this process, I’ll define two functions:</p>
<ul>
<li>
<code>fit_model()</code>: Given training and test datasets, a workflow containing a recipe for the categorical encoding, a model type, and an encoding type, this function will evaluate the model in-sample using cross-validation, then evaluate it out-of-sample, and then return a dataframe containing the results</li>
<li>
<code>fit_encodings()</code>: Given a model and model type, this function will generate recipes for each of the 5 categorical encodings, fit the 5 encodings using the model, and then return a dataframe with the results</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_model</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">workflow</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encoding_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">folds</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span>, v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">resampled_fit</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">workflow</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_resamples</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">folds</span>,</span>
<span>                  metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_set</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">f_meas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get in-sample F1</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">resampled_fit</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">mean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get out-of-sample F1</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">workflow</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pred</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.pred_class</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_meas</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pred</span>, estimator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'micro'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.estimate</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine in-sample and out-of-sample into a dataframe</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_perf</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>model_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>,</span>
<span>                        encoding_type <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encoding_type</span>,</span>
<span>                        train_perf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span>,</span>
<span>                        test_perf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Given a model, run it across the 4 encodings and return a dataframe that summarizes the results</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_encodings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensorflow</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/tensorflow/man/set_random_seed.html">set_random_seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># One-hot encoded model</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_1hot</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_1hot_with_novel</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_1hot</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>,</span>
<span>            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'onehot'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">onehot_model_results</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Label encoded model</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_label</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_label</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_label</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>,</span>
<span>            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">label_model_results</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Frequency encoded model</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_freq</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_freq</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_freq</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>,</span>
<span>            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'frequency'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">freq_model_results</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Target encoded model</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_target</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_target</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_te</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_target</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>,</span>
<span>            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'target'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">target_model_results</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Embedding encoded model</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_embedding</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">recipe_embedding</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">wflow_embedding</span>, </span>
<span>            <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>,</span>
<span>            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'embedding'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">embedding_model_results</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compile results into a dataframe</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">onehot_model_results</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">label_model_results</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">freq_model_results</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">target_model_results</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">embedding_model_results</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">results</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">results</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</div>
<p>I’ll run each of the models using the <code>fit_encodings()</code> and <code>fit_model()</code> functions that I just defined.</p>
<div class="cell">
<div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_encodings</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">multinom_mod</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'multinomial logistic'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">multinom_results</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_encodings</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_mod</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'random forest'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rf_results</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_encodings</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">xgboost_mod</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'xgboost'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">xgb_results</span></span></code></pre></div>
</div>
</section></section><section id="model-results" class="level1"><h1>Model results</h1>
<p>Looking at the results, I can see that best models used embedding encoding.</p>
<div class="cell">
<div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">multinom_results</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rf_results</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">xgb_results</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_results</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_results</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             model_type encoding_type train_perf test_perf
1         random forest     embedding  0.6929861 0.7411003
2               xgboost     embedding  0.6605987 0.7346278
3         random forest        onehot  0.6987098 0.7184466
4               xgboost        onehot  0.6767644 0.7055016
5               xgboost     frequency  0.6420888 0.7055016
6               xgboost         label  0.6731541 0.7022654
7         random forest     frequency  0.6880972 0.6990291
8         random forest        target  0.7679964 0.6964981
9         random forest         label  0.6880056 0.6925566
10 multinomial logistic         label  0.6304815 0.6828479
11 multinomial logistic     frequency  0.6343780 0.6796117
12 multinomial logistic     embedding  0.6223733 0.6699029
13 multinomial logistic        target  0.7761116 0.6614786
14              xgboost        target  0.7694992 0.6498054
15 multinomial logistic        onehot  0.5479512 0.6084142</code></pre>
</div>
<div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_results</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encoding_type</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'embedding'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'0'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_type</span>, </span>
<span>                 group <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encoding_type</span>, </span>
<span>                 fill <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">encoding_type</span>, </span>
<span>                 y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span>,</span>
<span>                 color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">colors</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, position<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dodge'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>limits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.60</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, oob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rescale_none</span>, breaks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.60</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F1 score by model type and categorical encoding method'</span>, </span>
<span>         subtitle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'The best models used embedding encoding'</span>,</span>
<span>         fill <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Encoding'</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'F1 score'</span>, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Model'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>colour <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/09/19/index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb53" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#ggsave &lt;- function(..., bg = 'white') ggplot2::ggsave(..., bg = bg)</span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#ggsave('social-image.png', width=1600, height=900, units='px')</span></span></code></pre></div>
</div>


<!-- -->

</section> ]]></description>
  <category>machine-learning</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/09/19/</guid>
  <pubDate>Tue, 19 Sep 2023 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/09/19/social-image.png" medium="image" type="image/png" height="81" width="144"/>
</item>
<item>
  <title>Using random forest based outlier detection to clean a training dataset</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/09/08/</link>
  <description><![CDATA[ <section id="the-challenge" class="level1"><h1>The Challenge</h1>
<p>For this blog post, I will be tackling the Kaggle compettition <a href="https://www.kaggle.com/competitions/playground-series-s3e21/overview">Improve a Fixed Model the Data-Centric Way!</a></p>
<p>This is the challenge of the competition: Improve a dataset that is being used to train a random forest model. The model is fixed, so model performance can only be improved by modifying the dataset. In terms of dataset modifications, there are some additional limitations:</p>
<ul>
<li>Rows can be removed, but not added</li>
<li>Columns cannot be removed or added</li>
<li>Values in the dataset that are used to train the model can be transformed, but those transformations will not be applied to the validation dataset (which is held out until the challenge comes to an end)</li>
</ul>
<p>This means that many of the tools available to a data scientist for improving an ML model, such as hyperparameter tuning, or data pre-processing applied to both training and test/validation datasets, are not available. The best options, therefore, will be to find ways to clean the training dataset that will yield better performance in the untouched validation dataset.</p>
<p>In this post, I will explore whether the training data can be improved using multivariate outlier imputation and by reducing feature multicollinearity.</p>
</section><section id="load-libraries" class="level1"><h1>Load libraries</h1>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/imbs-hl/ranger">ranger</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/mfrasco/Metrics">Metrics</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="parallel-backend" class="level1"><h1>Parallel backend</h1>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://doFuture.futureverse.org">doFuture</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://doFuture.futureverse.org/reference/registerDoFuture.html">registerDoFuture</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">multisession</span>, workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="load-the-data" class="level1"><h1>Load the data</h1>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sample_submission</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>, show_col_types <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">F</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="traintest-split" class="level1"><h1>Train/test split</h1>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_ids</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sample_submission</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_frac</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_ids</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sample_submission</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_ids</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sample_submission</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_ids</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sample_submission</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_ids</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="model-pipeline-and-baseline" class="level1"><h1>Model pipeline and baseline</h1>
<section id="model-pipeline" class="level2"><h2 class="anchored" data-anchor-id="model-pipeline">Model pipeline</h2>
<p>Before doing anything else, I want to create a model pipeline function and establish a baseline of model performance. This pipeline and baseline model will allow me to quickly iterate, test, and benchmark changes to the training dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_ranger_cv</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_ranger</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span></span>
<span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The parameters here mirror those that</span></span>
<span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># will be used in the competition model</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand_forest</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>trees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, </span>
<span>                min_n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ranger"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"regression"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">workflow_ranger</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_formula</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">target</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_ranger</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">folds</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span>, v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_ranger</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">workflow_ranger</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_resamples</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">folds</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get in-sample performance over resamples</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_ranger</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.metric</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rmse'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">mean</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate performance on out-of-sample (test) data</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">workflow_ranger</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/Metrics/man/rmse.html">rmse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">target</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.pred</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span></span>
<span>  </span>
<span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine in-sample and out-of-sample into a dataframe</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_perf</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">model_name</span>,</span>
<span>                        train_perf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span>,</span>
<span>                        test_perf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</div>
</section><section id="baseline-performance" class="level2"><h2 class="anchored" data-anchor-id="baseline-performance">Baseline performance</h2>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_ranger_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     model train_perf test_perf
1 baseline      1.231     2.134</code></pre>
</div>
</div>
<p>I’m going to run that again so I can be sure the RNG seed is set properly and the results are reproducible – otherwise I’ll be chasing a moving target!</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_ranger_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'baseline'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     model train_perf test_perf
1 baseline      1.231     2.134</code></pre>
</div>
</div>
</section></section><section id="outlier-detection-and-removal-imputation" class="level1"><h1>Outlier detection and removal / imputation</h1>
<p>Outlier detection, sometimes called anomaly detection, involves identifying values that are “extreme” in relation to other records in the dataset. For example, a value might be considered an outlier if it deviates from the mean by more than 3 standard deviations. The impact of outliers on model performance will depend on the model. Linear regressions are fairly sensitive to outliers, whereas random forest models tend to be fairly robust to them. Nevertheless, multivariate outliers can still be a source of noise in training datasets, particularly smaller datasets.</p>
<p>Here I will consider several methods of outlier detection, pick one, and then proceed to consider removal/imputation.</p>
<section id="outlier-detection" class="level2"><h2 class="anchored" data-anchor-id="outlier-detection">1. Outlier detection</h2>
<section id="univariate-outlier-detection" class="level3"><h3 class="anchored" data-anchor-id="univariate-outlier-detection">Univariate outlier detection</h3>
<p>One simple univariate outlier detection method involves a “Z-score threshold”. In a normally distributed dataset, 99% of values will tend to fall between a Z-score of -3 to +3. This is why a Z-score threshold of +/- 3 is often used to identify outliers in practice.</p>
<p>For example, here’s a plot of the percentage of outliers found for each variable. I can see that some variables contained more outliers than others. In particular, there were 6 features with more than 3% extreme values.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">outliers</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/outliers/man/scores.html">scores</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"z"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n_outlier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">value</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>            pct_outlier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">value</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_outlier</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_pct_outlier</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_pct_outlier</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_outlier</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'identity'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Feature"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"% values exceeding 3 z-score threshold"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>yintercept <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/09/08/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_pct_outlier</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_outlier</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pct_outlier</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  name   n_outlier pct_outlier
  &lt;chr&gt;      &lt;int&gt;       &lt;dbl&gt;
1 NH4_7        137        5.22
2 NH4_1        122        4.65
3 BOD5_3       113        4.3 
4 O2_2         111        4.23
5 NO2_1        104        3.96
6 NH4_2         99        3.77</code></pre>
</div>
</div>
<p>Other options for univariate outlier detection include using the inter-quartile range (IQR) or percentile-based thresholds.</p>
</section><section id="multivariate-outlier-detection" class="level3"><h3 class="anchored" data-anchor-id="multivariate-outlier-detection">Multivariate outlier detection</h3>
<p>Another option is multivariate outlier detection. For multivariate outlier detection, random forest based methods have been growing in popularity within the data science community. There are two methods that I’ll consider here.</p>
<section id="isolation-forest" class="level4"><h4 class="anchored" data-anchor-id="isolation-forest">Isolation forest</h4>
<p>The “isolation forest” works by trying to identify variables that can be isolated in branches when randomly splitting the data. From the <code>isotree</code> <a href="https://search.r-project.org/CRAN/refmans/isotree/html/isolation.forest.html">package documentation</a>:</p>
<blockquote class="blockquote">
<p>Isolation Forest is an algorithm originally developed for outlier detection that consists in splitting sub-samples of the data according to some attribute/feature/column at random. The idea is that, the rarer the observation, the more likely it is that a random uniform split on some feature would put outliers alone in one branch, and the fewer splits it will take to isolate an outlier observation like this.</p>
</blockquote>
<p>Importantly, this method operates at the row level, allowing us to identify anomalous records, but not pinpoint specifically which features on which those records may have been outliers.</p>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/david-cortes/isotree">isotree</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">isofor</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/isotree/man/isolation.forest.html">isolation.forest</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, ntrees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, nthreads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iso_preds</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">isofor</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iso_preds</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 37
     id target  O2_1  O2_2  O2_3  O2_4  O2_5  O2_6  O2_7 NH4_1 NH4_2 NH4_3 NH4_4
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  2662   15.9  15.9  14.9  8.98  6.17  2.28  8.98  7.15 0.573  0.54 0.208   2.3
# ℹ 24 more variables: NH4_5 &lt;dbl&gt;, NH4_6 &lt;dbl&gt;, NH4_7 &lt;dbl&gt;, NO2_1 &lt;dbl&gt;,
#   NO2_2 &lt;dbl&gt;, NO2_3 &lt;dbl&gt;, NO2_4 &lt;dbl&gt;, NO2_5 &lt;dbl&gt;, NO2_6 &lt;dbl&gt;,
#   NO2_7 &lt;dbl&gt;, NO3_1 &lt;dbl&gt;, NO3_2 &lt;dbl&gt;, NO3_3 &lt;dbl&gt;, NO3_4 &lt;dbl&gt;,
#   NO3_5 &lt;dbl&gt;, NO3_6 &lt;dbl&gt;, NO3_7 &lt;dbl&gt;, BOD5_1 &lt;dbl&gt;, BOD5_2 &lt;dbl&gt;,
#   BOD5_3 &lt;dbl&gt;, BOD5_4 &lt;dbl&gt;, BOD5_5 &lt;dbl&gt;, BOD5_6 &lt;dbl&gt;, BOD5_7 &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="outforest" class="level4"><h4 class="anchored" data-anchor-id="outforest">outForest</h4>
<p>The <code>outForest</code> package implements a different random forest method of outlier detection in which each variable is regressed onto all others, and outliers are detected based on the difference between the observed value and the out-of-bag predicted value. This has the advantage of identifying outliers on both a row and column basis, providing more flexibility in terms of how outliers can be dealt with.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/mayer79/outForest">outForest</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outfor</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/outForest/man/outForest.html">outForest</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                    verbose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">outForest</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/outForest/man/outliers.html">outliers</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outfor</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rmse</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">threshold</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      row    col observed  predicted    score replacement
453  2003  NH4_5  3026.00 14.0353304 50.63951      12.175
811  1021  NO2_3     2.05  0.1152134 25.71619       0.064
4     237 target    40.78 11.1135703 23.52858       8.100
1315 2556 BOD5_4    55.40  5.8114438 21.74855       5.800
340  2149  NH4_1     4.20  0.4161047 21.17629       0.360
1327  241 BOD5_5    82.45  9.2994377 20.80525       8.400</code></pre>
</div>
</div>
<p>Below we can see the outliers identified for each variable and how anomalous those outliers were. Using this data, I can then choose a threshold and replace anomalous values by imputation. The <code>outForest</code> package provides different methods of imputation out of the box, defaulting to predictive mean matching.</p>
<p>I’ll use this method for detection because it’s multivariate, intuitive, and flexible.</p>
<div class="cell">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outfor</span>, what <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scores"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/09/08/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section></section><section id="outlier-removal-or-imputation" class="level2"><h2 class="anchored" data-anchor-id="outlier-removal-or-imputation">2. Outlier removal or imputation</h2>
<p>Now that I’ve decided on an outlier detection method, the next step is to decide what to do about the outliers. There’s two main ways outliers can be handled: Removal or imputation. Removal is often an extreme measure that can lead to information loss, so I tend to prefer imputation over removal.</p>
<p>Since I’ve decided to use <code>outForest</code>, I can also use its out-of-the-box imputation methods.</p>
<p>First, I’ll go back to the dataframe containing the outliers that it had detected and try to refine the threshold. By default, it was using a score threshold of 3. But I’m not comfortable with imputing so many values. My gut tells me that if I’m identifying more than 3-5% of the records as outliers, then my threshold is too low and I’m catching too many potentially legitimate values.</p>
<p>Here I can see that a score threshold of 8 yields around 2% outliers on a row-basis. That seems more reasonable</p>
<div class="cell">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">outForest</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/outForest/man/outliers.html">outliers</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outfor</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">replacement</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">rmse</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">threshold</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">score</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">row</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sample_submission</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.9</code></pre>
</div>
</div>
<p>Using this threshold, I will now impute the values.</p>
<div class="cell">
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outfor2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/outForest/man/outForest.html">outForest</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                      verbose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span>                      replace <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pmm"</span>,</span>
<span>                      threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_outlier_adjusted</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outfor2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">Data</span></span></code></pre></div>
</div>
<p>Here I can see one of the outliers previously identified, and the value that was imputed for it.</p>
<div class="cell">
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1021</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO2_3</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.05</code></pre>
</div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_outlier_adjusted</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1021</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO2_3</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.064</code></pre>
</div>
</div>
<p>And now I can quickly run the random forest model again, with the new imputed training dataset, and compare it against the baseline model.</p>
<p>I see that outlier imputation has improved in-sample performance considerably (which is to be expected since the training dataset on which the cross-validation was performed is now much cleaner!), but it actually had a fairly marginal impact on out-of-sample performance.</p>
<div class="cell">
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_ranger_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_outlier_adjusted</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outliers imputed'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>train_pct_improved <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         test_pct_improved <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_1</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_1</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             model train_perf test_perf train_pct_improved test_pct_improved
1 outliers imputed      1.080     2.128              12.27              0.28
2         baseline      1.231     2.134                 NA                NA</code></pre>
</div>
</div>
</section></section><section id="feature-multicollinearity" class="level1"><h1>Feature multicollinearity</h1>
<p>Another option for data cleanup I can explore is addressing feature multicollinearity. This is when two or more features in the dataset are highly correlated. Like outliers, the impact of this will depend on the model. Random forest models are typically robust to multicollinearity when it comes to model performance, but it can severely impact the feature importances.</p>
<p>Nevertheless, I can explore whether addressing feature multicollinearity would improve model performance.</p>
<p>Some of the features are highly correlated (at r &gt; .6), namely:</p>
<ul>
<li><p><code>NH4_1</code> with <code>NH4_2</code></p></li>
<li><p><code>NO3_1</code> with <code>NO3_2</code></p></li>
<li><p><code>NO3_6</code> with <code>NO3_7</code></p></li>
<li><p><code>NO3_3</code> with <code>NO3_6</code></p></li>
<li><p><code>BOD5_1</code> with <code>BOD5_7</code></p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lares</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://laresbernardo.github.io/lares/reference/corr_cross.html">corr_cross</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">target</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">id</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>  max_pvalue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span>  top <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in .font_global(font, quiet = FALSE): Font 'Arial Narrow' is not
installed, has other name, or can't be found</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/09/08/index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>A simple fix for collinearity here would be to remove one variable from each of these pairs. I’ll remove the one with the larger numerical suffix. This is somewhat arbitrary. And fitting the model again, I see that removing collinear features improved in-sample and out-of-sample performance only marginally.</p>
<div class="cell">
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NH4_2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO3_2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO3_7</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO3_6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">BOD5_2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_with_collinearity_fix</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NH4_2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO3_2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO3_7</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">NO3_6</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">BOD5_2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_with_collinearity_fix</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_ranger_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_with_collinearity_fix</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_with_collinearity_fix</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fix collinearity'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>train_pct_improved <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         test_pct_improved <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_perf</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_2</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_fit_2</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             model train_perf test_perf train_pct_improved test_pct_improved
1 fix collinearity      1.217     2.123               1.14              0.52
2 outliers imputed      1.080     2.128              12.27              0.28
3         baseline      1.231     2.134                 NA                NA</code></pre>
</div>
</div>
<p>So to summarize: I’ve used two methods to clean the dataset: 1) random forest based multivariate outlier detection and imputation, and 2) removing multicollinear features. These cleanup techniques achieved only marginal gains in out-of-sample model performance with a random forest model, supporting the common wisdom that random forest models are robust to outliers and multicollinearity.</p>


<!-- -->

</section> ]]></description>
  <category>machine-learning</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/09/08/</guid>
  <pubDate>Fri, 08 Sep 2023 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/09/08/social-image.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Joining messy dataframes using fuzzy joining, string cleaning, and column binding</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/08/31/</link>
  <description><![CDATA[ <p>From the <a href="https://github.com/rfordatascience/tidytuesday/blob/master/data/2023/2023-08-29/readme.md">dataset description</a>:</p>
<blockquote class="blockquote">
<p>The data this week comes from the U.S. Copyright Office Fair Use Index.</p>
</blockquote>
<blockquote class="blockquote">
<blockquote class="blockquote">
<p>Fair use is a longstanding and vital aspect of American copyright law. The goal of the Index is to make the principles and application of fair use more accessible and understandable to the public by presenting a searchable database of court opinions, including by category and type of use (e.g., music, internet/digitization, parody).</p>
</blockquote>
</blockquote>
<blockquote class="blockquote">
<p>There are two datasets this week for which the rows align, but the values might not precisely line up for a clean join – a case you often have to deal with in real-world data.</p>
</blockquote>
<p>This last point is what I’ll be focusing on in this post: The challenge of joining two datasets together that don’t line up for a clean join.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/dgrtwo/fuzzyjoin">fuzzyjoin</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-08-29/fair_use_cases.csv'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-08-29/fair_use_findings.csv'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<section id="glimpse" class="level1"><h1>Glimpse</h1>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 251
Columns: 7
$ case           &lt;chr&gt; "De Fontbrune v. Wofsy, 39 F.4th 1214 (9th Cir. 2022)",…
$ year           &lt;dbl&gt; 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2…
$ court          &lt;chr&gt; "9th Circuit", "C.D. Cal.", "S.D.N.Y.", "D.D.C.", "2d C…
$ jurisdiction   &lt;chr&gt; "9th Circuit", "9th Circuit", "2nd Circuit", "District …
$ categories     &lt;chr&gt; "Education/Scholarship/Research; Photograph", "Painting…
$ outcome        &lt;chr&gt; "Fair use not found", "Preliminary finding; Fair use no…
$ fair_use_found &lt;lgl&gt; FALSE, FALSE, TRUE, FALSE, TRUE, FALSE, FALSE, TRUE, TR…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 251
Columns: 9
$ title       &lt;chr&gt; "De Fontbrune v. Wofsy", "Sedlik v. Von Drachenberg", "Ske…
$ case_number &lt;chr&gt; "39 F.4th 1214 (9th Cir. 2022)", "No. CV 21-1102, 2022 WL …
$ year        &lt;chr&gt; "2022", "2022", "2022", "2022", "2022", "2022", "2022", "2…
$ court       &lt;chr&gt; "United States Court of Appeals for the Ninth Circuit", "U…
$ key_facts   &lt;chr&gt; "Plaintiffs own the rights to a catalogue comprised of 16,…
$ issue       &lt;chr&gt; "Whether reproduction of photographs documenting artwork i…
$ holding     &lt;chr&gt; "The panel held that the first factor, the purpose and cha…
$ tags        &lt;chr&gt; "Education/Scholarship/Research; Photograph", "Painting/Dr…
$ outcome     &lt;chr&gt; "Fair use not found", "Preliminary finding; Fair use not f…</code></pre>
</div>
</div>
</section><section id="approach-0-column-binding" class="level1"><h1>Approach 0: column binding</h1>
<p>I’ll start with the simplest approach: Could a <code><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols()</a></code> work?</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_sorted</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_number</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">court</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_sorted</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_sorted</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_sorted</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">bind_cols_join</span></span></code></pre></div>
</div>
<p>No, there is mis-alignment as we can see in the table of results: <code>case</code> and <code>title</code> do not match.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">bind_cols_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">111</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bind_cols() results"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="ispukiymsm" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ispukiymsm table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ispukiymsm thead, #ispukiymsm tbody, #ispukiymsm tfoot, #ispukiymsm tr, #ispukiymsm td, #ispukiymsm th {
  border-style: none;
}

#ispukiymsm p {
  margin: 0;
  padding: 0;
}

#ispukiymsm .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ispukiymsm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ispukiymsm .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#ispukiymsm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#ispukiymsm .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ispukiymsm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ispukiymsm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ispukiymsm .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ispukiymsm .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ispukiymsm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ispukiymsm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ispukiymsm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ispukiymsm .gt_spanner_row {
  border-bottom-style: hidden;
}

#ispukiymsm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ispukiymsm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ispukiymsm .gt_from_md > :first-child {
  margin-top: 0;
}

#ispukiymsm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ispukiymsm .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ispukiymsm .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ispukiymsm .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ispukiymsm .gt_row_group_first td {
  border-top-width: 2px;
}

#ispukiymsm .gt_row_group_first th {
  border-top-width: 2px;
}

#ispukiymsm .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ispukiymsm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ispukiymsm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ispukiymsm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ispukiymsm .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ispukiymsm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ispukiymsm .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ispukiymsm .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ispukiymsm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ispukiymsm .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ispukiymsm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ispukiymsm .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ispukiymsm .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ispukiymsm .gt_left {
  text-align: left;
}

#ispukiymsm .gt_center {
  text-align: center;
}

#ispukiymsm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ispukiymsm .gt_font_normal {
  font-weight: normal;
}

#ispukiymsm .gt_font_bold {
  font-weight: bold;
}

#ispukiymsm .gt_font_italic {
  font-style: italic;
}

#ispukiymsm .gt_super {
  font-size: 65%;
}

#ispukiymsm .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ispukiymsm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ispukiymsm .gt_indent_1 {
  text-indent: 5px;
}

#ispukiymsm .gt_indent_2 {
  text-indent: 10px;
}

#ispukiymsm .gt_indent_3 {
  text-indent: 15px;
}

#ispukiymsm .gt_indent_4 {
  text-indent: 20px;
}

#ispukiymsm .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">bind_cols() results</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="ispukiymsm" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="ispukiymsm">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"case":["Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","House of Bryant Publ’ns, L.L.C. v. A&E Television Networks, No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","Hustler Magazine, Inc. v. Moral Majority, Inc., 796 F.2d 1148 (9th Cir. 1986)"],"title":["House of Bryant Publ’ns, L.L.C. v. A&E Television Networks,","Hustler Magazine, Inc. v. Moral Majority, Inc.,","In re DMCA Subpoena to Reddit, Inc."]},"columns":[{"id":"case","name":"case","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","House of Bryant Publ’ns, L.L.C. v. A&amp;E Television Networks, No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","Hustler Magazine, Inc. v. Moral Majority, Inc., 796 F.2d 1148 (9th Cir. 1986)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"title","name":"title","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["House of Bryant Publ’ns, L.L.C. v. A&amp;E Television Networks,","Hustler Magazine, Inc. v. Moral Majority, Inc.,","In re DMCA Subpoena to Reddit, Inc."],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"ispukiymsm","dataKey":"4bc66e0deccb2b01fd7be29cef506e3a"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style"],"jsHooks":[]}</script>
</div>
</div>
</div>
</section><section id="approach-1-fuzzy-joining" class="level1"><h1>Approach 1: Fuzzy joining</h1>
<p>I noticed that <code>title</code> tends to be a substring of <code>case</code>. Given this, I can try “fuzzy joining” using the <code>fuzzyjoin</code> library. I’ll also join with year, just in case there are multiple substring matches this should help to better resolve them to their correct match.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/fuzzyjoin/man/fuzzy_join.html">fuzzy_left_join</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">court</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                  by <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"case"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                  match_fun <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">str_detect</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year.y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>year <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year.x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span></span>
<span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 37</code></pre>
</div>
</div>
<p>This seems promising: only 37 records did not match. Can I fine-tune it?</p>
<p>I find that it always helps to look at examples of errors and see what can be learned.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Identify the missing cases from each set</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cases_without_match</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">findings_without_match</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cases_without_match</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cases without a match in Findings"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="kssmnjnyij" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#kssmnjnyij table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#kssmnjnyij thead, #kssmnjnyij tbody, #kssmnjnyij tfoot, #kssmnjnyij tr, #kssmnjnyij td, #kssmnjnyij th {
  border-style: none;
}

#kssmnjnyij p {
  margin: 0;
  padding: 0;
}

#kssmnjnyij .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#kssmnjnyij .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#kssmnjnyij .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#kssmnjnyij .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#kssmnjnyij .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kssmnjnyij .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kssmnjnyij .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#kssmnjnyij .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#kssmnjnyij .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#kssmnjnyij .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#kssmnjnyij .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#kssmnjnyij .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#kssmnjnyij .gt_spanner_row {
  border-bottom-style: hidden;
}

#kssmnjnyij .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#kssmnjnyij .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#kssmnjnyij .gt_from_md > :first-child {
  margin-top: 0;
}

#kssmnjnyij .gt_from_md > :last-child {
  margin-bottom: 0;
}

#kssmnjnyij .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#kssmnjnyij .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#kssmnjnyij .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#kssmnjnyij .gt_row_group_first td {
  border-top-width: 2px;
}

#kssmnjnyij .gt_row_group_first th {
  border-top-width: 2px;
}

#kssmnjnyij .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kssmnjnyij .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#kssmnjnyij .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#kssmnjnyij .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kssmnjnyij .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#kssmnjnyij .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#kssmnjnyij .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#kssmnjnyij .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#kssmnjnyij .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#kssmnjnyij .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kssmnjnyij .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kssmnjnyij .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#kssmnjnyij .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#kssmnjnyij .gt_left {
  text-align: left;
}

#kssmnjnyij .gt_center {
  text-align: center;
}

#kssmnjnyij .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#kssmnjnyij .gt_font_normal {
  font-weight: normal;
}

#kssmnjnyij .gt_font_bold {
  font-weight: bold;
}

#kssmnjnyij .gt_font_italic {
  font-style: italic;
}

#kssmnjnyij .gt_super {
  font-size: 65%;
}

#kssmnjnyij .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#kssmnjnyij .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#kssmnjnyij .gt_indent_1 {
  text-indent: 5px;
}

#kssmnjnyij .gt_indent_2 {
  text-indent: 10px;
}

#kssmnjnyij .gt_indent_3 {
  text-indent: 15px;
}

#kssmnjnyij .gt_indent_4 {
  text-indent: 20px;
}

#kssmnjnyij .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">Cases without a match in Findings</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="kssmnjnyij" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="kssmnjnyij">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"case":["Am. Geophysical Union v. Texaco, Inc., 60 F.3d 913 (2d Cir. 1994)","Barcroft Media, Ltd. v. Coed Media Group, LLC, No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","Benny v. Loew's, Inc., 239 F.2d 532 (9th Cir. 1956)","Bouchat v. Balt. Ravens Ltd. P'ship, 619 F.3d 301 (4th Cir. 2010)","Bouchat v. Balt. Ravens Ltd. P'ship, 737 F.3d 932 (4th Cir. 2013)","Brownmark Films, L.L.C. v. Comedy Partners, 682 F.3d 687 (7th Cir. 2012)","CCA and B, LLC v. F + W Media, Inc., 819 F. Supp. 2d 1310 (Ν.D. Ga. 2011)","Cambridge Univ. Press v. Becker, No. No. 1:08-cv-1425-ODE (N.D. Ga. Mar. 2, 2020)","Cambridge University Press v. Becker, 1:08-cv-01425-ODE (N.D. Ga. March 31, 2016)","Castle Rock Entm’t, Inc. v. Carol Publ’g Grp., Inc., 150 F.3d 132 (2d Cir. 1998)","Consumers Union, Inc. v. Gen. Signal Corp., 724 F.2d 1044 (2d Cir. 1983)","DC Comics, Inc. v. Crazy Eddie, Inc., No. 79 Civ. 3786 (PNL) (S.D.N.Y. Aug. 3, 1979)","Dow Jones & Co. v. Brd. of Trade of Chi., 546 F. Supp. 113 (S.D.N.Y. 1982)","Dr. Seuss Enters., L.P. v. Penguin Books USA, Inc., 109 F.3d 1394 (9th Cir. 1997)","Duffy v. Penguin Books USA, Inc., 4 F. Supp. 2d 268 (S.D.N.Y. 1998)","Educ. Testing Servs. v. Katzman, 793 F.2d 533 (3d Cir. 1986)","Eisenschiml v. Fawcett Publ’ns, Inc., 246 F.2d 598 (7th Cir. 1957)","Faulkner Literary Rights, L.L.C. v. Sony Pictures Classics, Inc., 953 F. Supp. 2d 701 (N.D. Miss. 2013)","Fox Broad. Co. v. Dish Network, L.L.C., 723 F.3d 1067 (9th Cir. 2013)","Harper & Row Publishers, Inc. v. Nation Enters., 471 U.S. 539 (1985)","Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","Katz v. Google Inc., No. 14-14525 (11th Cir. Sept. 17, 2015)","L.A. News Serv. v. Reuters Television Int'l, Ltd., 149 F.3d 987 (9th Cir. 1998)","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P., No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017)","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., 900 F. Supp. 1287 (C.D. Cal. 1995)","Nat'l Acad. of TV Arts & Scis., Inc., v. Multimedia Sys. Design, Inc. No. 20-CV-7269 (VEC) (S.D.N.Y. July 30, 2021)","Nat’l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio, 15 F.3d 559 (6th Cir. 1994)","Northland Family Planning Clinic, Inc. v. Crt. for Bio-Ethical Reform, 868 F. Supp. 2d 962 (C.D. Cal. 2012)","Paramount Pictures, Corp. v. Axanar Prods., Inc., No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","Penguin Grp. (USA), Inc. v. Am. Buddha, No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","Penguin Random House v. Colting, No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","Peteski Productions, Inc. v. Rothman, No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","Rotbart v. J.R. O’Dwyer Co., No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","Sony Computer Entm't. Inc. v. Connectix Corp., 203 F. 3d 596 (9th Cir. 2000)","Sundeman v. Seajay Soc’y, Inc., 142 F.3d 194 (4th Cir. 1998)","Tresóna Multimedia v. Burbank High School Vocal Music Ass’n, Nos. 17-56006, 17-56417, 17-56419 (9th Cir. Mar. 24, 2020)","Veeck v. S. Bldg. Code Cong. Int’l, 241 F.3d 398 (5th Cir. 2001)"],"year":[1994,2017,1956,2010,2013,2012,2011,2020,2016,1998,1983,1979,1982,1997,1998,1986,1957,2013,2013,1985,2017,2015,1998,2017,1995,2021,1994,2012,2017,2015,2017,2017,1995,2000,1998,2020,2001]},"columns":[{"id":"case","name":"case","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Am. Geophysical Union v. Texaco, Inc., 60 F.3d 913 (2d Cir. 1994)","Barcroft Media, Ltd. v. Coed Media Group, LLC, No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","Benny v. Loew's, Inc., 239 F.2d 532 (9th Cir. 1956)","Bouchat v. Balt. Ravens Ltd. P'ship, 619 F.3d 301 (4th Cir. 2010)","Bouchat v. Balt. Ravens Ltd. P'ship, 737 F.3d 932 (4th Cir. 2013)","Brownmark Films, L.L.C. v. Comedy Partners, 682 F.3d 687 (7th Cir. 2012)","CCA and B, LLC v. F + W Media, Inc., 819 F. Supp. 2d 1310 (Ν.D. Ga. 2011)","Cambridge Univ. Press v. Becker, No. No. 1:08-cv-1425-ODE (N.D. Ga. Mar. 2, 2020)","Cambridge University Press v. Becker, 1:08-cv-01425-ODE (N.D. Ga. March 31, 2016)","Castle Rock Entm’t, Inc. v. Carol Publ’g Grp., Inc., 150 F.3d 132 (2d Cir. 1998)","Consumers Union, Inc. v. Gen. Signal Corp., 724 F.2d 1044 (2d Cir. 1983)","DC Comics, Inc. v. Crazy Eddie, Inc., No. 79 Civ. 3786 (PNL) (S.D.N.Y. Aug. 3, 1979)","Dow Jones &amp; Co. v. Brd. of Trade of Chi., 546 F. Supp. 113 (S.D.N.Y. 1982)","Dr. Seuss Enters., L.P. v. Penguin Books USA, Inc., 109 F.3d 1394 (9th Cir. 1997)","Duffy v. Penguin Books USA, Inc., 4 F. Supp. 2d 268 (S.D.N.Y. 1998)","Educ. Testing Servs. v. Katzman, 793 F.2d 533 (3d Cir. 1986)","Eisenschiml v. Fawcett Publ’ns, Inc., 246 F.2d 598 (7th Cir. 1957)","Faulkner Literary Rights, L.L.C. v. Sony Pictures Classics, Inc., 953 F. Supp. 2d 701 (N.D. Miss. 2013)","Fox Broad. Co. v. Dish Network, L.L.C., 723 F.3d 1067 (9th Cir. 2013)","Harper &amp; Row Publishers, Inc. v. Nation Enters., 471 U.S. 539 (1985)","Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","Katz v. Google Inc., No. 14-14525 (11th Cir. Sept. 17, 2015)","L.A. News Serv. v. Reuters Television Int'l, Ltd., 149 F.3d 987 (9th Cir. 1998)","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P., No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017)","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., 900 F. Supp. 1287 (C.D. Cal. 1995)","Nat'l Acad. of TV Arts &amp; Scis., Inc., v. Multimedia Sys. Design, Inc. No. 20-CV-7269 (VEC) (S.D.N.Y. July 30, 2021)","Nat’l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio, 15 F.3d 559 (6th Cir. 1994)","Northland Family Planning Clinic, Inc. v. Crt. for Bio-Ethical Reform, 868 F. Supp. 2d 962 (C.D. Cal. 2012)","Paramount Pictures, Corp. v. Axanar Prods., Inc., No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","Penguin Grp. (USA), Inc. v. Am. Buddha, No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","Penguin Random House v. Colting, No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","Peteski Productions, Inc. v. Rothman, No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","Rotbart v. J.R. O’Dwyer Co., No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","Sony Computer Entm't. Inc. v. Connectix Corp., 203 F. 3d 596 (9th Cir. 2000)","Sundeman v. Seajay Soc’y, Inc., 142 F.3d 194 (4th Cir. 1998)","Tresóna Multimedia v. Burbank High School Vocal Music Ass’n, Nos. 17-56006, 17-56417, 17-56419 (9th Cir. Mar. 24, 2020)","Veeck v. S. Bldg. Code Cong. Int’l, 241 F.3d 398 (5th Cir. 2001)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"year","name":"year","type":"numeric","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["1994","2017","1956","2010","2013","2012","2011","2020","2016","1998","1983","1979","1982","1997","1998","1986","1957","2013","2013","1985","2017","2015","1998","2017","1995","2021","1994","2012","2017","2015","2017","2017","1995","2000","1998","2020","2001"],"html":true,"align":"right","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"kssmnjnyij","dataKey":"0b7ff3df3811c4bfa71c93b0c90e533f"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style"],"jsHooks":[]}</script>
</div>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">findings_without_match</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_number</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Findings without a match in Cases"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="guzgixqkto" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#guzgixqkto table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#guzgixqkto thead, #guzgixqkto tbody, #guzgixqkto tfoot, #guzgixqkto tr, #guzgixqkto td, #guzgixqkto th {
  border-style: none;
}

#guzgixqkto p {
  margin: 0;
  padding: 0;
}

#guzgixqkto .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#guzgixqkto .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#guzgixqkto .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#guzgixqkto .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#guzgixqkto .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#guzgixqkto .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#guzgixqkto .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#guzgixqkto .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#guzgixqkto .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#guzgixqkto .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#guzgixqkto .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#guzgixqkto .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#guzgixqkto .gt_spanner_row {
  border-bottom-style: hidden;
}

#guzgixqkto .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#guzgixqkto .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#guzgixqkto .gt_from_md > :first-child {
  margin-top: 0;
}

#guzgixqkto .gt_from_md > :last-child {
  margin-bottom: 0;
}

#guzgixqkto .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#guzgixqkto .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#guzgixqkto .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#guzgixqkto .gt_row_group_first td {
  border-top-width: 2px;
}

#guzgixqkto .gt_row_group_first th {
  border-top-width: 2px;
}

#guzgixqkto .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#guzgixqkto .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#guzgixqkto .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#guzgixqkto .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#guzgixqkto .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#guzgixqkto .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#guzgixqkto .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#guzgixqkto .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#guzgixqkto .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#guzgixqkto .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#guzgixqkto .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#guzgixqkto .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#guzgixqkto .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#guzgixqkto .gt_left {
  text-align: left;
}

#guzgixqkto .gt_center {
  text-align: center;
}

#guzgixqkto .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#guzgixqkto .gt_font_normal {
  font-weight: normal;
}

#guzgixqkto .gt_font_bold {
  font-weight: bold;
}

#guzgixqkto .gt_font_italic {
  font-style: italic;
}

#guzgixqkto .gt_super {
  font-size: 65%;
}

#guzgixqkto .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#guzgixqkto .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#guzgixqkto .gt_indent_1 {
  text-indent: 5px;
}

#guzgixqkto .gt_indent_2 {
  text-indent: 10px;
}

#guzgixqkto .gt_indent_3 {
  text-indent: 15px;
}

#guzgixqkto .gt_indent_4 {
  text-indent: 20px;
}

#guzgixqkto .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">Findings without a match in Cases</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="guzgixqkto" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="guzgixqkto">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"title":["Am. Geophysical Union v. Texaco, Inc.,","Barcroft Media, Ltd. V. Coed Media Group, LLC","Benny v. Loew's, Inc.,","Bouchat v. Balt. Ravens Ltd. P’ship,","Bouchat v. Balt. Ravens Ltd. P’ship,","Brownmark Films, LLC v. Comedy Partners,","CCA and B, LLC v. F + W Media, Inc.,","Cambridge University Press v. Becker","Cambridge University Press v. Mark P. Becker","Castle Rock Entm’t, Inc. v. Carol Publ. Group, Inc.,","Consumers Union of U.S., Inc. v. Gen. Signal Corp.,","DC Comics Inc. v. Crazy Eddie, Inc.,","Dow Jones & Co., Inc. v. Bd. of Trade of the City of Chi.,","Dr. Seuss Enters., LP v. Penguin Books USA, Inc.,","Duffy v. Penguin Books USA, Inc.,","Educ. Testing Serv. v. Katzman,","Eisenschiml v. Fawcett Publ’n, Inc.,","Faulkner Literary Rights, LLC v. Sony Pictures Classics, Inc.,","Harper & Row Publishers, Inc. v. Nation Enterprises,","Katz v. Google, Inc.","L.A. News Serv. v. Reuters Television Int’l, Ltd.,","Matt Hosseinzadeh v. Ethan Klein and Hila Klein","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P.","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., Inc.,","Nat'l Acad. of TV Arts & Scis., Inc. v. Multimedia Sys. Design, Inc.","Nat'l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio,","Northland Family Planning Clinic, Inc. v. Ctr. for Bio-Ethical Reform,","Paramount Pictures Corp. v. Axanar Prods., Inc.","Penguin Grp. (USA), Inc. v. Am. Buddha,","Penguin Random House LLC, et al. v. Frederik Colting and Melissa Medina, d/b/a Moppet Books","Peteski Productions, Inc. v. Leah Rothman","Rotbart v. J.R. O’Dwyer Co., Inc.,","Sony Computer Entm’t, Inc. v. Connectix Corp.,","Sundeman v. The Seajay Soc’y, Inc.,","Tresóna Multimedia, LLC v. Burbank High School Vocal Music Ass’n","Veeck v. S. Bldg. Code Congress Int’l,"],"case_number":["60 F.3d 913 (2d Cir. 1995)","No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","239 F.2d 532 (9th Cir. 1956), aff’d by an equally divided court, 356 U.S. 43 (1958)","619 F.3d 301 (4th Cir. 2010)","737 F.3d 932 (4th Cir. 2013)","682 F.3d 687 (7th Cir. 2012)","819 F. Supp. 2d 1310 (N.D. Ga. 2011)","No. 1:08-cv-1425-ODE, 2020 U.S. Dist. LEXIS 35134 (N.D. Ga. Mar. 2, 2020)","No. 1:08-cv-01425-ODE (N.D. Ga. Mar. 31, 2016) appeal docketed, Aug. 26, 2016","150 F.3d 132 (2d Cir. 1998)","724 F.2d 1044 (2d Cir. 1983)","No. 79 Civ. 3786-PNL (S.D.N.Y. Aug. 3, 1979)","546 F. Supp. 113 (S.D.N.Y. 1982)","109 F.3d 1394 (9th Cir. 1997)","4 F. Supp. 2d 268 (S.D.N.Y. 1998)","793 F.2d 533 (3d Cir. 1986), abrogated on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","246 F.2d 598 (7th Cir. 1957)","953 F. Supp. 2d 701 (N.D. Miss. 2013)","471 U.S. 539 (1985)","No. 14-14525 (11th Cir. Sept. 17, 2015)","149 F.3d 987 (9th Cir. 1998)","No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017) aff’d, No. 17-2952-cv, 2018 WL 3323476 (2d Cir. July 6, 2018)","900 F. Supp. 1287 (C.D. Cal. 1995)","No. 20-CV-7269 (VEC), 2021 U.S. Dist. LEXIS 142733 (S.D.N.Y. July 30, 2021)","15 F.3d 559 (6th Cir. 1994)","868 F. Supp. 2d 962 (C.D. Cal. 2012)","No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","203 F.3d 596 (9th Cir. 2000)","142 F.3d 194 (4th Cir. 1998)","Nos. 17-56006, 17-56417, 17-56419, 2020 U.S. App. LEXIS 9128 (9th Cir. Mar. 24, 2020)","241 F.3d 398 (5th Cir. 2001)"],"year":["1995","2017","1958","2010","2013","2012","2011","2020","2016","1998","1983","1979","1982","1997","1989","1986","1957","2013","1985","2015","1998","2017","2017, affirmed 2018","1995","2021","1994","2012","2017","2015","2017","2017","1995","2000","1998","2020","2001"]},"columns":[{"id":"title","name":"title","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Am. Geophysical Union v. Texaco, Inc.,","Barcroft Media, Ltd. V. Coed Media Group, LLC","Benny v. Loew's, Inc.,","Bouchat v. Balt. Ravens Ltd. P’ship,","Bouchat v. Balt. Ravens Ltd. P’ship,","Brownmark Films, LLC v. Comedy Partners,","CCA and B, LLC v. F + W Media, Inc.,","Cambridge University Press v. Becker","Cambridge University Press v. Mark P. Becker","Castle Rock Entm’t, Inc. v. Carol Publ. Group, Inc.,","Consumers Union of U.S., Inc. v. Gen. Signal Corp.,","DC Comics Inc. v. Crazy Eddie, Inc.,","Dow Jones &amp; Co., Inc. v. Bd. of Trade of the City of Chi.,","Dr. Seuss Enters., LP v. Penguin Books USA, Inc.,","Duffy v. Penguin Books USA, Inc.,","Educ. Testing Serv. v. Katzman,","Eisenschiml v. Fawcett Publ’n, Inc.,","Faulkner Literary Rights, LLC v. Sony Pictures Classics, Inc.,","Harper &amp; Row Publishers, Inc. v. Nation Enterprises,","Katz v. Google, Inc.","L.A. News Serv. v. Reuters Television Int’l, Ltd.,","Matt Hosseinzadeh v. Ethan Klein and Hila Klein","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P.","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., Inc.,","Nat'l Acad. of TV Arts &amp; Scis., Inc. v. Multimedia Sys. Design, Inc.","Nat'l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio,","Northland Family Planning Clinic, Inc. v. Ctr. for Bio-Ethical Reform,","Paramount Pictures Corp. v. Axanar Prods., Inc.","Penguin Grp. (USA), Inc. v. Am. Buddha,","Penguin Random House LLC, et al. v. Frederik Colting and Melissa Medina, d/b/a Moppet Books","Peteski Productions, Inc. v. Leah Rothman","Rotbart v. J.R. O’Dwyer Co., Inc.,","Sony Computer Entm’t, Inc. v. Connectix Corp.,","Sundeman v. The Seajay Soc’y, Inc.,","Tresóna Multimedia, LLC v. Burbank High School Vocal Music Ass’n","Veeck v. S. Bldg. Code Congress Int’l,"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"case_number","name":"case_number","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["60 F.3d 913 (2d Cir. 1995)","No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","239 F.2d 532 (9th Cir. 1956), aff’d by an equally divided court, 356 U.S. 43 (1958)","619 F.3d 301 (4th Cir. 2010)","737 F.3d 932 (4th Cir. 2013)","682 F.3d 687 (7th Cir. 2012)","819 F. Supp. 2d 1310 (N.D. Ga. 2011)","No. 1:08-cv-1425-ODE, 2020 U.S. Dist. LEXIS 35134 (N.D. Ga. Mar. 2, 2020)","No. 1:08-cv-01425-ODE (N.D. Ga. Mar. 31, 2016) appeal docketed, Aug. 26, 2016","150 F.3d 132 (2d Cir. 1998)","724 F.2d 1044 (2d Cir. 1983)","No. 79 Civ. 3786-PNL (S.D.N.Y. Aug. 3, 1979)","546 F. Supp. 113 (S.D.N.Y. 1982)","109 F.3d 1394 (9th Cir. 1997)","4 F. Supp. 2d 268 (S.D.N.Y. 1998)","793 F.2d 533 (3d Cir. 1986), abrogated on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","246 F.2d 598 (7th Cir. 1957)","953 F. Supp. 2d 701 (N.D. Miss. 2013)","471 U.S. 539 (1985)","No. 14-14525 (11th Cir. Sept. 17, 2015)","149 F.3d 987 (9th Cir. 1998)","No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017) aff’d, No. 17-2952-cv, 2018 WL 3323476 (2d Cir. July 6, 2018)","900 F. Supp. 1287 (C.D. Cal. 1995)","No. 20-CV-7269 (VEC), 2021 U.S. Dist. LEXIS 142733 (S.D.N.Y. July 30, 2021)","15 F.3d 559 (6th Cir. 1994)","868 F. Supp. 2d 962 (C.D. Cal. 2012)","No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","203 F.3d 596 (9th Cir. 2000)","142 F.3d 194 (4th Cir. 1998)","Nos. 17-56006, 17-56417, 17-56419, 2020 U.S. App. LEXIS 9128 (9th Cir. Mar. 24, 2020)","241 F.3d 398 (5th Cir. 2001)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"year","name":"year","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["1995","2017","1958","2010","2013","2012","2011","2020","2016","1998","1983","1979","1982","1997","1989","1986","1957","2013","1985","2015","1998","2017","2017, affirmed 2018","1995","2021","1994","2012","2017","2015","2017","2017","1995","2000","1998","2020","2001"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"guzgixqkto","dataKey":"8870cf44b3eb8f607423158849c0328b"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style","tag.attribs.columns.2.style"],"jsHooks":[]}</script>
</div>
</div>
</div>
<p>Some observations about these examples that may have caused mis-matching:</p>
<ul>
<li><p>Non-ASCII characters like <code>ó</code> or ```</p></li>
<li><p><code>Serv.</code> vs.&nbsp;<code>Servs.</code></p></li>
<li><p>Punctuation inconsistencies, like <code>Nat'l Acad. of TV Arts &amp; Scis., Inc.</code> vs.&nbsp;<code>Nat'l Acad. of TV Arts &amp; Scis., Inc.,</code></p></li>
<li><p><code>LLC</code> is sometimes missing, like <code>Tresona Multimedia, LLC</code> vs.&nbsp;<code>Tresona Multimedia v.</code></p></li>
</ul>
<p>These steps could improve the match rate:</p>
<ol type="1">
<li><p>Convert to ASCII</p></li>
<li><p>Convert to lowercase</p></li>
<li><p>Remove occurrences of <code>LLC</code></p></li>
</ol>
<p>I’ll perform these standardizations and try joining again.</p>
</section><section id="approach-2-fuzzy-joining-string-cleaning" class="level1"><h1>Approach 2: Fuzzy joining + string cleaning</h1>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mutate a standardized variable: case_std</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASCII//TRANSLIT'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[^[:alnum:][:space:]]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_std</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mutate a standardized variable: title_std</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>year <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>, to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASCII//TRANSLIT'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[^[:alnum:][:space:]]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_std</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform a fuzzy join</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_std</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/fuzzyjoin/man/fuzzy_join.html">fuzzy_left_join</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_std</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">court</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                  by <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"case_std"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title_std"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                  match_fun <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">str_detect</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Identify the missing cases from each set</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_remainder</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_std</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_remainder</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_remainder</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cases without a match in Findings"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="hnolkxvwdh" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#hnolkxvwdh table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#hnolkxvwdh thead, #hnolkxvwdh tbody, #hnolkxvwdh tfoot, #hnolkxvwdh tr, #hnolkxvwdh td, #hnolkxvwdh th {
  border-style: none;
}

#hnolkxvwdh p {
  margin: 0;
  padding: 0;
}

#hnolkxvwdh .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hnolkxvwdh .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#hnolkxvwdh .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#hnolkxvwdh .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#hnolkxvwdh .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hnolkxvwdh .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hnolkxvwdh .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hnolkxvwdh .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hnolkxvwdh .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hnolkxvwdh .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hnolkxvwdh .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hnolkxvwdh .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hnolkxvwdh .gt_spanner_row {
  border-bottom-style: hidden;
}

#hnolkxvwdh .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#hnolkxvwdh .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hnolkxvwdh .gt_from_md > :first-child {
  margin-top: 0;
}

#hnolkxvwdh .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hnolkxvwdh .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hnolkxvwdh .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hnolkxvwdh .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hnolkxvwdh .gt_row_group_first td {
  border-top-width: 2px;
}

#hnolkxvwdh .gt_row_group_first th {
  border-top-width: 2px;
}

#hnolkxvwdh .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnolkxvwdh .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hnolkxvwdh .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hnolkxvwdh .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hnolkxvwdh .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnolkxvwdh .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hnolkxvwdh .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#hnolkxvwdh .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hnolkxvwdh .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hnolkxvwdh .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hnolkxvwdh .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnolkxvwdh .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hnolkxvwdh .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hnolkxvwdh .gt_left {
  text-align: left;
}

#hnolkxvwdh .gt_center {
  text-align: center;
}

#hnolkxvwdh .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hnolkxvwdh .gt_font_normal {
  font-weight: normal;
}

#hnolkxvwdh .gt_font_bold {
  font-weight: bold;
}

#hnolkxvwdh .gt_font_italic {
  font-style: italic;
}

#hnolkxvwdh .gt_super {
  font-size: 65%;
}

#hnolkxvwdh .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#hnolkxvwdh .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hnolkxvwdh .gt_indent_1 {
  text-indent: 5px;
}

#hnolkxvwdh .gt_indent_2 {
  text-indent: 10px;
}

#hnolkxvwdh .gt_indent_3 {
  text-indent: 15px;
}

#hnolkxvwdh .gt_indent_4 {
  text-indent: 20px;
}

#hnolkxvwdh .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">Cases without a match in Findings</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="hnolkxvwdh" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="hnolkxvwdh">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"case":["Cambridge Univ. Press v. Becker, No. No. 1:08-cv-1425-ODE (N.D. Ga. Mar. 2, 2020)","Castle Rock Entm’t, Inc. v. Carol Publ’g Grp., Inc., 150 F.3d 132 (2d Cir. 1998)","Consumers Union, Inc. v. Gen. Signal Corp., 724 F.2d 1044 (2d Cir. 1983)","Dow Jones & Co. v. Brd. of Trade of Chi., 546 F. Supp. 113 (S.D.N.Y. 1982)","Educ. Testing Servs. v. Katzman, 793 F.2d 533 (3d Cir. 1986)","Eisenschiml v. Fawcett Publ’ns, Inc., 246 F.2d 598 (7th Cir. 1957)","Harper & Row Publishers, Inc. v. Nation Enters., 471 U.S. 539 (1985)","Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., 900 F. Supp. 1287 (C.D. Cal. 1995)","Northland Family Planning Clinic, Inc. v. Crt. for Bio-Ethical Reform, 868 F. Supp. 2d 962 (C.D. Cal. 2012)","Penguin Random House v. Colting, No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","Peteski Productions, Inc. v. Rothman, No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","Rotbart v. J.R. O’Dwyer Co., No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","Sundeman v. Seajay Soc’y, Inc., 142 F.3d 194 (4th Cir. 1998)","Tresóna Multimedia v. Burbank High School Vocal Music Ass’n, Nos. 17-56006, 17-56417, 17-56419 (9th Cir. Mar. 24, 2020)","Veeck v. S. Bldg. Code Cong. Int’l, 241 F.3d 398 (5th Cir. 2001)"],"year":[2020,1998,1983,1982,1986,1957,1985,2017,1995,2012,2017,2017,1995,1998,2020,2001]},"columns":[{"id":"case","name":"case","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Cambridge Univ. Press v. Becker, No. No. 1:08-cv-1425-ODE (N.D. Ga. Mar. 2, 2020)","Castle Rock Entm’t, Inc. v. Carol Publ’g Grp., Inc., 150 F.3d 132 (2d Cir. 1998)","Consumers Union, Inc. v. Gen. Signal Corp., 724 F.2d 1044 (2d Cir. 1983)","Dow Jones &amp; Co. v. Brd. of Trade of Chi., 546 F. Supp. 113 (S.D.N.Y. 1982)","Educ. Testing Servs. v. Katzman, 793 F.2d 533 (3d Cir. 1986)","Eisenschiml v. Fawcett Publ’ns, Inc., 246 F.2d 598 (7th Cir. 1957)","Harper &amp; Row Publishers, Inc. v. Nation Enters., 471 U.S. 539 (1985)","Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., 900 F. Supp. 1287 (C.D. Cal. 1995)","Northland Family Planning Clinic, Inc. v. Crt. for Bio-Ethical Reform, 868 F. Supp. 2d 962 (C.D. Cal. 2012)","Penguin Random House v. Colting, No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","Peteski Productions, Inc. v. Rothman, No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","Rotbart v. J.R. O’Dwyer Co., No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","Sundeman v. Seajay Soc’y, Inc., 142 F.3d 194 (4th Cir. 1998)","Tresóna Multimedia v. Burbank High School Vocal Music Ass’n, Nos. 17-56006, 17-56417, 17-56419 (9th Cir. Mar. 24, 2020)","Veeck v. S. Bldg. Code Cong. Int’l, 241 F.3d 398 (5th Cir. 2001)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"year","name":"year","type":"numeric","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["2020","1998","1983","1982","1986","1957","1985","2017","1995","2012","2017","2017","1995","1998","2020","2001"],"html":true,"align":"right","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"hnolkxvwdh","dataKey":"f4814cef8de612352d945d7266ea236e"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style"],"jsHooks":[]}</script>
</div>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_remainder</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_number</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Findings without a match in Cases"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="ouqisbaqya" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ouqisbaqya table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ouqisbaqya thead, #ouqisbaqya tbody, #ouqisbaqya tfoot, #ouqisbaqya tr, #ouqisbaqya td, #ouqisbaqya th {
  border-style: none;
}

#ouqisbaqya p {
  margin: 0;
  padding: 0;
}

#ouqisbaqya .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ouqisbaqya .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ouqisbaqya .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#ouqisbaqya .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#ouqisbaqya .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ouqisbaqya .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ouqisbaqya .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ouqisbaqya .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ouqisbaqya .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ouqisbaqya .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ouqisbaqya .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ouqisbaqya .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ouqisbaqya .gt_spanner_row {
  border-bottom-style: hidden;
}

#ouqisbaqya .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ouqisbaqya .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ouqisbaqya .gt_from_md > :first-child {
  margin-top: 0;
}

#ouqisbaqya .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ouqisbaqya .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ouqisbaqya .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ouqisbaqya .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ouqisbaqya .gt_row_group_first td {
  border-top-width: 2px;
}

#ouqisbaqya .gt_row_group_first th {
  border-top-width: 2px;
}

#ouqisbaqya .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ouqisbaqya .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ouqisbaqya .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ouqisbaqya .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ouqisbaqya .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ouqisbaqya .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ouqisbaqya .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ouqisbaqya .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ouqisbaqya .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ouqisbaqya .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ouqisbaqya .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ouqisbaqya .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ouqisbaqya .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ouqisbaqya .gt_left {
  text-align: left;
}

#ouqisbaqya .gt_center {
  text-align: center;
}

#ouqisbaqya .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ouqisbaqya .gt_font_normal {
  font-weight: normal;
}

#ouqisbaqya .gt_font_bold {
  font-weight: bold;
}

#ouqisbaqya .gt_font_italic {
  font-style: italic;
}

#ouqisbaqya .gt_super {
  font-size: 65%;
}

#ouqisbaqya .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ouqisbaqya .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ouqisbaqya .gt_indent_1 {
  text-indent: 5px;
}

#ouqisbaqya .gt_indent_2 {
  text-indent: 10px;
}

#ouqisbaqya .gt_indent_3 {
  text-indent: 15px;
}

#ouqisbaqya .gt_indent_4 {
  text-indent: 20px;
}

#ouqisbaqya .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">Findings without a match in Cases</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="ouqisbaqya" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="ouqisbaqya">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"title":["Cambridge University Press v. Mark P. Becker","Castle Rock Entm’t, Inc. v. Carol Publ. Group, Inc.,","Consumers Union of U.S., Inc. v. Gen. Signal Corp.,","Dow Jones & Co., Inc. v. Bd. of Trade of the City of Chi.,","Educ. Testing Serv. v. Katzman,","Eisenschiml v. Fawcett Publ’n, Inc.,","Harper & Row Publishers, Inc. v. Nation Enterprises,","Matt Hosseinzadeh v. Ethan Klein and Hila Klein","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., Inc.,","Northland Family Planning Clinic, Inc. v. Ctr. for Bio-Ethical Reform,","Penguin Random House LLC, et al. v. Frederik Colting and Melissa Medina, d/b/a Moppet Books","Peteski Productions, Inc. v. Leah Rothman","Rotbart v. J.R. O’Dwyer Co., Inc.,","Sundeman v. The Seajay Soc’y, Inc.,","Tresóna Multimedia, LLC v. Burbank High School Vocal Music Ass’n","Veeck v. S. Bldg. Code Congress Int’l,"],"case_number":["No. 1:08-cv-01425-ODE (N.D. Ga. Mar. 31, 2016) appeal docketed, Aug. 26, 2016","150 F.3d 132 (2d Cir. 1998)","724 F.2d 1044 (2d Cir. 1983)","546 F. Supp. 113 (S.D.N.Y. 1982)","793 F.2d 533 (3d Cir. 1986), abrogated on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","246 F.2d 598 (7th Cir. 1957)","471 U.S. 539 (1985)","No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","900 F. Supp. 1287 (C.D. Cal. 1995)","868 F. Supp. 2d 962 (C.D. Cal. 2012)","No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","142 F.3d 194 (4th Cir. 1998)","Nos. 17-56006, 17-56417, 17-56419, 2020 U.S. App. LEXIS 9128 (9th Cir. Mar. 24, 2020)","241 F.3d 398 (5th Cir. 2001)"],"year":["2016","1998","1983","1982","1986","1957","1985","2017","1995","2012","2017","2017","1995","1998","2020","2001"]},"columns":[{"id":"title","name":"title","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Cambridge University Press v. Mark P. Becker","Castle Rock Entm’t, Inc. v. Carol Publ. Group, Inc.,","Consumers Union of U.S., Inc. v. Gen. Signal Corp.,","Dow Jones &amp; Co., Inc. v. Bd. of Trade of the City of Chi.,","Educ. Testing Serv. v. Katzman,","Eisenschiml v. Fawcett Publ’n, Inc.,","Harper &amp; Row Publishers, Inc. v. Nation Enterprises,","Matt Hosseinzadeh v. Ethan Klein and Hila Klein","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., Inc.,","Northland Family Planning Clinic, Inc. v. Ctr. for Bio-Ethical Reform,","Penguin Random House LLC, et al. v. Frederik Colting and Melissa Medina, d/b/a Moppet Books","Peteski Productions, Inc. v. Leah Rothman","Rotbart v. J.R. O’Dwyer Co., Inc.,","Sundeman v. The Seajay Soc’y, Inc.,","Tresóna Multimedia, LLC v. Burbank High School Vocal Music Ass’n","Veeck v. S. Bldg. Code Congress Int’l,"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"case_number","name":"case_number","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["No. 1:08-cv-01425-ODE (N.D. Ga. Mar. 31, 2016) appeal docketed, Aug. 26, 2016","150 F.3d 132 (2d Cir. 1998)","724 F.2d 1044 (2d Cir. 1983)","546 F. Supp. 113 (S.D.N.Y. 1982)","793 F.2d 533 (3d Cir. 1986), abrogated on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","246 F.2d 598 (7th Cir. 1957)","471 U.S. 539 (1985)","No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","900 F. Supp. 1287 (C.D. Cal. 1995)","868 F. Supp. 2d 962 (C.D. Cal. 2012)","No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","142 F.3d 194 (4th Cir. 1998)","Nos. 17-56006, 17-56417, 17-56419, 2020 U.S. App. LEXIS 9128 (9th Cir. Mar. 24, 2020)","241 F.3d 398 (5th Cir. 2001)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"year","name":"year","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["2016","1998","1983","1982","1986","1957","1985","2017","1995","2012","2017","2017","1995","1998","2020","2001"],"html":true,"align":"right","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"ouqisbaqya","dataKey":"63341a157ca3f5cf85f6b3b3dd80a7f8"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style","tag.attribs.columns.2.style"],"jsHooks":[]}</script>
</div>
</div>
</div>
<p>I can see that 16 are missing in each case, and what’s interesting about these two sets is they appear to be the same items, in the same order. This means we can simply do a <code><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols()</a></code> operation to join them together.</p>
</section><section id="final-solution-fuzzy-joining-string-cleaning-column-binding" class="level1"><h1>Final solution: Fuzzy joining + string cleaning + column binding</h1>
<p>Here I put all of the lessons learned so far in fuzzy joining together into one final chunk of code.</p>
<div class="cell">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mutate a standardized variable: case_std</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASCII//TRANSLIT'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[^[:alnum:][:space:]]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         case_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">court</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_std</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mutate a standardized variable: title_std</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>year <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/chartr.html">tolower</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>, to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ASCII//TRANSLIT'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[^[:alnum:][:space:]]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>         title_std <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'llc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_std</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform a fuzzy join</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_std</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/fuzzyjoin/man/fuzzy_join.html">fuzzy_left_join</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_std</span>, </span>
<span>                  by <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"case_std"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"title_std"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                  match_fun <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">str_detect</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_std</span>, </span>
<span>         <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title_std</span>,</span>
<span>         <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year.y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>year <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year.x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identify the missing cases from each set</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_remainder</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_std</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">court</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">outcome</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_remainder</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Bind the columns together</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases_remainder</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_cases</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fair_use_findings_remainder</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">remainders_join</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Join together the two subsets</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fuzzy_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">remainders_join</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">final_join</span></span></code></pre></div>
</div>
<section id="validation-checks" class="level2"><h2 class="anchored" data-anchor-id="validation-checks">Validation checks</h2>
<p>When inspecting the final result I expect to see 251 rows; none of which should be duplicates, and I do.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">final_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>    n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>    n_distinct_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  n_rows n_distinct_rows
   &lt;int&gt;           &lt;int&gt;
1    251             251</code></pre>
</div>
</div>
<p>As another check, I can look at the same records that were misaligned with the first approach. I can see they are now aligned.</p>
<div class="cell">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">final_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_number</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">111</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rows that were previously misaligned with bind_cols() are now aligned"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="ovvegwobgo" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ovvegwobgo table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ovvegwobgo thead, #ovvegwobgo tbody, #ovvegwobgo tfoot, #ovvegwobgo tr, #ovvegwobgo td, #ovvegwobgo th {
  border-style: none;
}

#ovvegwobgo p {
  margin: 0;
  padding: 0;
}

#ovvegwobgo .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ovvegwobgo .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ovvegwobgo .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#ovvegwobgo .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#ovvegwobgo .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ovvegwobgo .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ovvegwobgo .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ovvegwobgo .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ovvegwobgo .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ovvegwobgo .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ovvegwobgo .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ovvegwobgo .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ovvegwobgo .gt_spanner_row {
  border-bottom-style: hidden;
}

#ovvegwobgo .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ovvegwobgo .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ovvegwobgo .gt_from_md > :first-child {
  margin-top: 0;
}

#ovvegwobgo .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ovvegwobgo .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ovvegwobgo .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ovvegwobgo .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ovvegwobgo .gt_row_group_first td {
  border-top-width: 2px;
}

#ovvegwobgo .gt_row_group_first th {
  border-top-width: 2px;
}

#ovvegwobgo .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ovvegwobgo .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ovvegwobgo .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ovvegwobgo .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ovvegwobgo .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ovvegwobgo .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ovvegwobgo .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ovvegwobgo .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ovvegwobgo .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ovvegwobgo .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ovvegwobgo .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ovvegwobgo .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ovvegwobgo .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ovvegwobgo .gt_left {
  text-align: left;
}

#ovvegwobgo .gt_center {
  text-align: center;
}

#ovvegwobgo .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ovvegwobgo .gt_font_normal {
  font-weight: normal;
}

#ovvegwobgo .gt_font_bold {
  font-weight: bold;
}

#ovvegwobgo .gt_font_italic {
  font-style: italic;
}

#ovvegwobgo .gt_super {
  font-size: 65%;
}

#ovvegwobgo .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ovvegwobgo .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ovvegwobgo .gt_indent_1 {
  text-indent: 5px;
}

#ovvegwobgo .gt_indent_2 {
  text-indent: 10px;
}

#ovvegwobgo .gt_indent_3 {
  text-indent: 15px;
}

#ovvegwobgo .gt_indent_4 {
  text-indent: 20px;
}

#ovvegwobgo .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">Rows that were previously misaligned with bind_cols() are now aligned</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="ovvegwobgo" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="ovvegwobgo">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"case":["Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","House of Bryant Publ’ns, L.L.C. v. A&E Television Networks, No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","Hustler Magazine, Inc. v. Moral Majority, Inc., 796 F.2d 1148 (9th Cir. 1986)"],"title":["Matt Hosseinzadeh v. Ethan Klein and Hila Klein","House of Bryant Publ’ns, L.L.C. v. A&E Television Networks,","Hustler Magazine, Inc. v. Moral Majority, Inc.,"],"case_number":["No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","796 F.2d 1148 (9th Cir. 1986)"]},"columns":[{"id":"case","name":"case","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","House of Bryant Publ’ns, L.L.C. v. A&amp;E Television Networks, No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","Hustler Magazine, Inc. v. Moral Majority, Inc., 796 F.2d 1148 (9th Cir. 1986)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"title","name":"title","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["Matt Hosseinzadeh v. Ethan Klein and Hila Klein","House of Bryant Publ’ns, L.L.C. v. A&amp;E Television Networks,","Hustler Magazine, Inc. v. Moral Majority, Inc.,"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"case_number","name":"case_number","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","796 F.2d 1148 (9th Cir. 1986)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"ovvegwobgo","dataKey":"dc7c0b7f25566892fc1761623459bafd"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style","tag.attribs.columns.2.style"],"jsHooks":[]}</script>
</div>
</div>
</div>
<p>And here is the full table.</p>
<div class="cell">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">final_join</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">title</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">case_number</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/gt.html">gt</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/opt_interactive.html">opt_interactive</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_header.html">tab_header</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final results table (case, title, case_number)"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://gt.rstudio.com/reference/tab_options.html">tab_options</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>table.background.color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f1f3f5'</span>,</span>
<span>              ihtml.page_size_default <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div id="ccqdsrgqzz" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ccqdsrgqzz table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ccqdsrgqzz thead, #ccqdsrgqzz tbody, #ccqdsrgqzz tfoot, #ccqdsrgqzz tr, #ccqdsrgqzz td, #ccqdsrgqzz th {
  border-style: none;
}

#ccqdsrgqzz p {
  margin: 0;
  padding: 0;
}

#ccqdsrgqzz .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #F1F3F5;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ccqdsrgqzz .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ccqdsrgqzz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #F1F3F5;
  border-bottom-width: 0;
}

#ccqdsrgqzz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #F1F3F5;
  border-top-width: 0;
}

#ccqdsrgqzz .gt_heading {
  background-color: #F1F3F5;
  text-align: center;
  border-bottom-color: #F1F3F5;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ccqdsrgqzz .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ccqdsrgqzz .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ccqdsrgqzz .gt_col_heading {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ccqdsrgqzz .gt_column_spanner_outer {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ccqdsrgqzz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ccqdsrgqzz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ccqdsrgqzz .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ccqdsrgqzz .gt_spanner_row {
  border-bottom-style: hidden;
}

#ccqdsrgqzz .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ccqdsrgqzz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ccqdsrgqzz .gt_from_md > :first-child {
  margin-top: 0;
}

#ccqdsrgqzz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ccqdsrgqzz .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ccqdsrgqzz .gt_stub {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ccqdsrgqzz .gt_stub_row_group {
  color: #333333;
  background-color: #F1F3F5;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ccqdsrgqzz .gt_row_group_first td {
  border-top-width: 2px;
}

#ccqdsrgqzz .gt_row_group_first th {
  border-top-width: 2px;
}

#ccqdsrgqzz .gt_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccqdsrgqzz .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ccqdsrgqzz .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ccqdsrgqzz .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ccqdsrgqzz .gt_grand_summary_row {
  color: #333333;
  background-color: #F1F3F5;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccqdsrgqzz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ccqdsrgqzz .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ccqdsrgqzz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ccqdsrgqzz .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ccqdsrgqzz .gt_footnotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ccqdsrgqzz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccqdsrgqzz .gt_sourcenotes {
  color: #333333;
  background-color: #F1F3F5;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ccqdsrgqzz .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ccqdsrgqzz .gt_left {
  text-align: left;
}

#ccqdsrgqzz .gt_center {
  text-align: center;
}

#ccqdsrgqzz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ccqdsrgqzz .gt_font_normal {
  font-weight: normal;
}

#ccqdsrgqzz .gt_font_bold {
  font-weight: bold;
}

#ccqdsrgqzz .gt_font_italic {
  font-style: italic;
}

#ccqdsrgqzz .gt_super {
  font-size: 65%;
}

#ccqdsrgqzz .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ccqdsrgqzz .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ccqdsrgqzz .gt_indent_1 {
  text-indent: 5px;
}

#ccqdsrgqzz .gt_indent_2 {
  text-indent: 10px;
}

#ccqdsrgqzz .gt_indent_3 {
  text-indent: 15px;
}

#ccqdsrgqzz .gt_indent_4 {
  text-indent: 20px;
}

#ccqdsrgqzz .gt_indent_5 {
  text-indent: 25px;
}
</style>
<div style="font-family:system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;border-top-style:solid;border-top-width:2px;border-top-color:#D3D3D3;">
<div class="gt_heading gt_title gt_font_normal" style="text-size:bigger;">Final results table (case, title, case_number)</div>
<div class="gt_heading gt_subtitle "></div>
</div>
<div id="ccqdsrgqzz" class="reactable html-widget " style="width:auto;height:auto;"></div>
<script type="application/json" data-for="ccqdsrgqzz">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"case":["A&M Records, Inc. v. Napster, Inc., 239 F.3d 1004 (9th Cir. 2001)","A.V. ex rel. Vanderhye v. iParadigms, L.L.C., 562 F.3d 630 (4th Cir. 2009)","Adjmi v. DLT Entm’t, Ltd., No. 1:14-cv-00568-LAP (S.D.N.Y. Mar. 31, 2015)","Am. Geophysical Union v. Texaco, Inc., 60 F.3d 913 (2d Cir. 1994)","Am. Inst. of Physics v. Schwegman, Lundberg & Woessner, P.A., Civ. No. 12-528 (RHK/JJK) (D. Minn. July. 30, 2013)","Am. Soc'y for Testing & Materials v. Public.Resource.Org, Inc., No. 13-cv-1215 (D.D.C. Mar. 31, 2022)","Andy Warhol Found. for the Visual Arts, Inc. v. Goldsmith, 19-2420-cv (2d Cir. Aug. 24, 2021)","Apple Inc. v. Corellium, LLC, Case No. 9:19-cv-81160-RS (S.D. Fla. Dec. 29, 2020)","Arica Inst., Inc. v. Palmer, 970 F.2d 1067 (2d Cir. 1992)","Arrow Prods., Ltd. v. The Weinstein Co., LLC,44 F. Supp. 3d 359 (S.D.N.Y. Aug. 25, 2014)","Associated Press v. Meltwater U.S. Holdings, Inc., 931 F. Supp. 2d 537 (S.D.N.Y. 2013)","Ass’n of Am. Med. Colls. v. Cuomo, 928 F.2d 519 (2d Cir. 1991)","Ass’n of Am. Med. Colls. v. Mikaelian, 571 F. Supp. 144 (E.D. Pa. 1983)","Atari Games Corp. v. Nintendo of Am. Inc., 975 F. 2d 832 (Fed. Cir. 1992)","Authors Guild, Inc. v. Google Inc., No. 13-04829 (2d Cir. Oct. 16, 2015)","Authors Guild, Inc. v. HathiTrust, 755 F.3d 87 (2d Cir. 2014)","BMG Music v. Gonzalez, 430 F.3d 888 (7th Cir. 2005)","BWP Media USA, Inc. v. Gossip Cop Media, Inc. No. 13-cv-7574-KPF (S.D.N.Y. Jul. 20, 2016)","Bain v. Film Indep., Inc. No. CV 18-4126 PA (JEMx) (C.D. Cal. Aug. 6, 2020)","Balsley v. LFP, Inc., 691 F.3d 747 (6th Cir. 2012)","Baraban v. Time Warner, Inc., No. 99 Civ. 1569 (JSM) (S.D.N.Y. Apr. 6, 2000)","Barcroft Media, Ltd. v. Coed Media Group, LLC, No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","Basic Books, Inc. v. Kinko’s Graphics Corp., 758 F. Supp. 1522 (S.D.N.Y. 1991)","Bell v. Eagle Mt. Saginaw Indep. Sch. Distr., 27 F.4th 313 (5th Cir. 2022)","Bell v. Worthington City Sch. Dist., No. 2:18-cv-961 (S.D. Ohio June 2, 2020)","Benny v. Loew's, Inc., 239 F.2d 532 (9th Cir. 1956)","Berlin v. E.C. Publ’ns, Inc., 329 F.2d 541 (2d Cir. 1964)","Bill Graham Archives v. Dorling Kindersley Ltd., 448 F.3d 605 (2d Cir. 2006)","Blackwell Publ’g, Inc. v. Excel Research Grp., LLC, 661 F. Supp. 2d 786 (E.D. Mich. 2009)","Blanch v. Koons, 467 F.3d 244 (2d Cir. 2006)","Boesen v. United Sports Publs., Ltd., No. 20-CV-1552 (ARR) (SIL) (E.D.N.Y. Nov. 2, 2020), reconsideration denied (Dec. 22, 2020)","Bond v. Blum, 317 F.3d 385 (4th Cir. 2003)","Bouchat v. Balt. Ravens Ltd. P'ship, 619 F.3d 301 (4th Cir. 2010)","Bouchat v. Balt. Ravens Ltd. P'ship, 737 F.3d 932 (4th Cir. 2013)","Brammer v. Violent Hues Productions, LLC, No. 18-1763 (4th Cir. Apr. 26, 2019)","Brewer v. Hustler Magazine, Inc., 749 F.2d 527 (9th Cir. 1984)","Brown v. Netflix, Inc., 855 F. App’x 61 (2d Cir. 2021)","Brownmark Films, L.L.C. v. Comedy Partners, 682 F.3d 687 (7th Cir. 2012)","Byrne v. BBC, 132 F. Supp. 2d 229 (S.D.N.Y. 2001)","CCA and B, LLC v. F + W Media, Inc., 819 F. Supp. 2d 1310 (Ν.D. Ga. 2011)","Cable/Home Commc’n Corp. v. Network Prods., Inc., 902 F.2d 829 (11th Cir. 1990)","Cambridge Univ. Press v. Becker, No. No. 1:08-cv-1425-ODE (N.D. Ga. Mar. 2, 2020)","Cambridge Univ. Press v. Patton, 769 F.3d 1232 (11th Cir. 2014)","Cambridge University Press v. Albert","Cambridge University Press v. Becker, 1:08-cv-01425-ODE (N.D. Ga. March 31, 2016)","Campbell v. Acuff-Rose Music, Inc., 510 U.S. 569 (1994)","Caner v. Autry, 16 F. Supp. 3d 689 (W.D. Va. 2014)","Capitol Records, LLC v. ReDigi Inc.","Cariou v. Prince, 714 F.3d 694 (2d Cir. 2013)","Castle Rock Entm’t, Inc. v. Carol Publ’g Grp., Inc., 150 F.3d 132 (2d Cir. 1998)","Castle v. Kingsport Publ’g Corp. 2:19-CV-00092-DCLC (E.D. Tenn. Dec. 14, 2020)","Chapman v. Maraj, No. 2:18-cv 09088-VAP-SS (C.D. Cal. Sept. 16, 2020)","Chi. Bd. of Educ. v. Substance, Inc., 354 F.3d 624 (7th Cir. 2003)","Clark v. Transportation Alternatives, Inc., 18 Civ. 9985 (VM) (S.D.N.Y. Mar. 18, 2019)","Clean Flicks of Colo., LLC v. Soderbergh, 433 F. Supp. 2d 1236 (D. Colo. 2006)","Code Revision Comm. v. Public.Resource.Org, Inc., No. 1:15-cv-02594-RWS (N.D. Ga. Mar. 23, 2017)","Columbia Pictures Indus., Inc. v. Miramax Films Corp., 11 F. Supp. 2d 1179 (C.D. Cal. 1998)","Comerica Bank & Trust, N.A. v. Habib, No. 17-12418-LTS (D. Mass. Jan. 6, 2020)","Compaq Computer Corp. v. Ergonome, Inc., 387 F.3d 403 (5th Cir. 2004)","Consumers Union, Inc. v. Gen. Signal Corp., 724 F.2d 1044 (2d Cir. 1983)","Corbello v. DeVito, No. 2:08-cv-00867-RCJ-PAL (D. Nev. June 14, 2017)","DC Comics Inc. v. Reel Fantasy, Inc., 696 F.2d 24 (2d Cir. 1982)","DC Comics, Inc. v. Crazy Eddie, Inc., No. 79 Civ. 3786 (PNL) (S.D.N.Y. Aug. 3, 1979)","Dall. Cowboys Cheerleaders, Inc. v. Scoreboard Posters, Inc., 600 F.2d 1184 (5th Cir. 1979)","Davidson v. United States, No. 13-942C (Fed. Cl. June 29, 2018)","Davis v. Gap, Inc., 246 F.3d 152 (2d Cir. 2001)","De Fontbrune v. Wofsy, 39 F.4th 1214 (9th Cir. 2022)","Denison v. Larkin, 64 F. Supp. 3d 1127 (N.D. Ill. 2014)","Diamond v. Am-Law Publ’g Corp., 745 F.2d 142 (2d Cir. 1984)","Disney Enterprises, Inc. v. VidAngel, Inc., No. 2:16-CV-04109 (9th Cir. Aug. 24, 2017)","Disney Enters., Inc. v. VidAngel, Inc., No. 2:16-cv-004109-AB (C.D. Cal. Dec. 12, 2016)","Diversey v. Schmidly, 738 F.3d 1196 (10th Cir. 2013)","Dlugolecki v. Poppel, CV 18 3905 GW (GJSx) (C.D. Cal. Aug. 22, 2019)","Dominick Ranieri v. Adirondack Dev. Group LLC, No. 1.11-cv-1013-GTS-CFH (N.D.N.Y. Feb. 22, 2016)","Donald Graham v. Richard Prince, et al., No. 15-CV-10160 (S.D.N.Y. July 18, 2017)","Dow Jones & Co. v. Brd. of Trade of Chi., 546 F. Supp. 113 (S.D.N.Y. 1982)","Dr. Seuss Enters., L.P. v. ComicMix LLC, 983 F.3d 443 (9th Cir. 2020)","Dr. Seuss Enters., L.P. v. Penguin Books USA, Inc., 109 F.3d 1394 (9th Cir. 1997)","Duffy v. Penguin Books USA, Inc., 4 F. Supp. 2d 268 (S.D.N.Y. 1998)","Easter Unlimited, Inc. v. Rozier, No. 18-cv-06637 (E.D.N.Y. Sep. 17, 2021)","Educ. Testing Servs. v. Katzman, 793 F.2d 533 (3d Cir. 1986)","Eisenschiml v. Fawcett Publ’ns, Inc., 246 F.2d 598 (7th Cir. 1957)","Elsmere Music, Inc. v. NBC, 482 F. Supp. 741 (S.D.N.Y. 1980)","Elvis Presley Enters., Inc. v. Passport Video, 349 F.3d 622 (9th Cir. 2003)","Encyclopedia Brittanica Educ. Corp. v. Crooks, 542 F. Supp. 1156 (W.D.N.Y. 1982)","Erika Peterman v. Republican National Committee, No. 17-66-M-DLC (D. Mont. March 19, 2018)","Estate of Anthony Barré and Angel Barré v. Carter, et al. No. 17-1057 (E.D. Lou. July 25, 2017)","Estate of James Oscar Smith v. Cash Money Records, Inc., et al., No. 1:14-cv-02703 (S.D.N.Y. May 30, 2017)","Faulkner Literary Rights, L.L.C. v. Sony Pictures Classics, Inc., 953 F. Supp. 2d 701 (N.D. Miss. 2013)","Ferdman v. CBS Interactive Inc.","Fin. Info., Inc. v. Moody’s Investor Serv., Inc., 751 F.2d 501 (2d Cir. 1984)","Fisher v. Dees, 794 F.2d 432 (9th Cir. 1986)","Fitzgerald v. CBS Broad., Inc., 491 F. Supp. 2d 177 (D. Mass. 2007)","Folsom v. Marsh, 9 F. Cas. 342 (C.C.D. Mass. 1841)","Fox Broad. Co. v. Dish Network, L.L.C., 723 F.3d 1067 (9th Cir. 2013)","Fox Broad. Co. v. Dish Network, LLC, No. 2:12-cv-04529-DMG-SH (C.D. Cal. Jan. 12, 2015)","Fox News Network, LLC v. TVEyes, Inc., Nos. 15-3885, 15-3886 (2d Cir. Feb. 27, 2018)","Friedman v. Guetta, No. CV 10-00014 DDP (JCx) (C.D. Cal. May 27, 2011)","Furie v. Infowars, LLC, Case No. 18-1830-MWF (JPRx) (C.D. Cal. May 16, 2019)","Galvin v. Ill. Republican Party, No. 1:14-cv-00490 (N.D. Ill. Sept. 9, 2015)","Gaylord v. United States, 595 F.3d 1364 (Fed. Cir. 2010)","Golden v. Michael Grecco Prods., No. 19-CV-3156 (NGG) (RER) (E.D.N.Y. Mar. 9, 2021)","Google LLC v. Oracle Am., Inc., 141 S. Ct. 1183 (2021)","H.C. Wainwright & Co. v. Wall St. Transcript Corp., 418 F. Supp. 620 (S.D.N.Y. 1976), aff’d, 558 F.2d 91 (2d Cir. 1977), cert. denied, 434 U.S. 1014 (1978)","Haberman v. Hustler Magazine, Inc., 626 F. Supp. 201 (D. Mass. 1986)","Harper & Row Publishers, Inc. v. Nation Enters., 471 U.S. 539 (1985)","Henley v. DeVore, 733 F. Supp. 2d 1144 (C.D. Cal. 2010)","Hofheinz v. Discovery Commc’ns, Inc., No. 00 CIV. 3802 (HB) (S.D.N.Y. Sep. 20, 2001)","Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","House of Bryant Publ’ns, L.L.C. v. A&E Television Networks, No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","Hustler Magazine, Inc. v. Moral Majority, Inc., 796 F.2d 1148 (9th Cir. 1986)","In re DMCA Subpoena to Reddit, Inc., No. 19-mc-80005-SK (JD) (N.D. Cal. Mar. 2, 2020)","Infinity Broad. Corp. v. Kirkwood, 150 F.3d 104 (2d Cir. 1998)","Int’l Code Council, Inc. v. UpCodes, Inc., 17 Civ. 6261 (VM) (S.D.N.Y. May 27, 2020)","Iowa State Univ. Research Found., Inc., v. Am. Broad. Cos., Inc., 621 F.2d 57 (2d Cir. 1980)","James Castle Collection and Archive, LP v. Scholastic, Inc. and Allen Say","Jartech, Inc. v. Clancy, 666 F.2d 403 (9th Cir. 1982)","Katz v. Google Inc., No. 14-14525 (11th Cir. Sept. 17, 2015)","Kelly v. Arriba Soft Corp., 336 F.3d 811 (9th Cir. 2003)","Kennedy v. Gish, Sherwood & Friends, Inc., No. 4:13-cv-02236-JAR (E.D. Mo. Nov. 5, 2015)","Kienitz v. Sconnie Nation, LLC, 766 F.3d 756 (7th Cir. 2014)","L.A. News Serv. v. CBS Broad., Inc., 305 F.3d 924 (9th Cir. 2002)","L.A. News Serv. v. KCAL-TV Channel 9, 108 F.3d 1119 (9th Cir. 1997)","L.A. News Serv. v. Reuters Television Int'l, Ltd., 149 F.3d 987 (9th Cir. 1998)","L.A. News Serv. v. Tullo, 973 F.2d 791 (9th Cir. 1992)","Leadsinger, Inc. v. BMG Music Publ’g, 512 F.3d 522 (9th Cir. 2008)","Leibovitz v. Paramount Pictures Corp., 137 F.3d 109 (2d Cir. 1998)","Lennon v. Premise Media Corp., 556 F. Supp. 2d 310 (S.D.N.Y. 2008)","Lish v. Harper’s Magazine Found., 807 F. Supp. 1090 (S.D.N.Y. 1992)","Lucasfilm Ltd. LLC, et al. v. Ren Ventures Ltd., et al.","Lucent Info. Mgmt. v. Lucent Techs., Inc., 5 F. Supp. 2d 238 (D. Del. 1998)","MCA, Inc. v. Wilson, 677 F.2d 180 (2d Cir. 1981)","Marano v. Metro. Museum of Art, 844 F. App’x 436 (2d Cir. 2021)","Marcus v. Rowley, 695 F.2d 1171 (9th Cir. 1983)","MasterCard Int’l, Inc. v. Nader 2000 Primary Comm., Inc., No. 00 CIV. 3802 (HB) (S.D.N.Y. Mar. 8, 2004)","Mattel Inc. v. Walking Mountain Prods., 353 F.3d 792 (9th Cir. 2003)","Mattel, Inc. v. Entities Doing Bus. as Unicorn Element, 21 Civ. 2333 (VM) (S.D.N.Y. June 4, 2021)","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P., No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017)","Maxtone-Graham v. Burtchaell, 803 F.2d 1253 (2d Cir. 1986)","McGowan v. Cross, 991 F.2d 790, Nos. 92-1480, 92-1584 (4th Cir. Apr. 22, 1993)","McGucken v. Newsweek LLC, 19 Civ. 9617 (KPF) (S.D.N.Y. Mar. 21, 2020)","McGucken v. Pub Ocean Ltd., 2:20-cv-01923-RGK-AS (C.D. Cal. July 27, 2021)","Meeropol v. Nizer, 560 F.2d 1061 (2d Cir. 1977)","Merkos L’Inyonei Chinuch, Inc. v. Otsar Sifrei Lubavitch, Inc., 312 F.3d 94 (2d Cir. 2002)","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., 900 F. Supp. 1287 (C.D. Cal. 1995)","MidlevelU, Inc. v. ACI Info. Grp., 989 F.3d 1205 (11th Cir. 2021)","Monge v. Maya Magazines, Inc., 688 F.3d 1164 (9th Cir. 2012)","Monsarrat v. Newman, 28 F.4th 314 (1st Cir. 2022)","Monster Commc’ns, Inc. v. Turner Broad. Sys., Inc., 935 F. Supp. 490 (S.D.N.Y. 1996)","Morris v. Guetta, No. LA CV12-00684 JAK (RZX) (C.D. Cal. Feb. 4, 2013)","Murphy v. Millennium Radio Grp. L.L.C., 650 F.3d 295 (3d Cir. 2011)","N. Jersey Media Grp., Inc. v. Pirro, 74 F. Supp. 3d. 605 (S.D.N.Y. 2015)","N.Y. Times Co. v. Roxbury Data Interface, Inc., 434 F. Supp. 217 (D.N.J. 1977)","Narell v. Freeman, 872 F.2d 907 (9th Cir. 1989)","Nat'l Acad. of TV Arts & Scis., Inc., v. Multimedia Sys. Design, Inc. No. 20-CV-7269 (VEC) (S.D.N.Y. July 30, 2021)","Nat’l Ctr. for Jewish Film v. Riverside Films, L.L.C., No. 5:12-cv-00044-ODW (DTB) (C.D. Cal. Sept. 14, 2012)","Nat’l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio, 15 F.3d 559 (6th Cir. 1994)","Neri v. Monroe, No. 11-cv-429-slc (W.D. Wis. Feb. 26, 2014)","New Era Publ’ns Int’l, ApS v. Carol Publ’g Grp., 904 F.2d 152 (2d Cir. 1990)","New Era Publ’ns Int’l, ApS v. Henry Holt & Co., 873 F.2d 576 (2d Cir. 1989)","New Line Cinema Corp. v. Bertlesman Music Grp., Inc., 693 F. Supp. 1517 (S.D.N.Y. 1988)","Nihon Keizai Shimbun, Inc. v. Comline Bus. Data, Inc., 166 F.3d 65 (2d Cir. 1999)","Noland v. Janssen, No. 17-CV-5452 (S.D.N.Y. June 1, 2020)","Norse v. Henry Holt & Co., 847 F. Supp. 142 (N.D. Cal. 1994)","Northland Family Planning Clinic, Inc. v. Crt. for Bio-Ethical Reform, 868 F. Supp. 2d 962 (C.D. Cal. 2012)","Nunez v. Caribbean Int’l News Corp., 235 F.3d 18 (1st Cir. 2000)","Otto v. Hearst Communications, Inc.","Oyewole v. Ora, 291 F. Supp. 3d 422 (S.D.N.Y. Mar. 8, 2018)","O’Neil v. Ratajkowski, No. 19 CIV. 9769 (AT) (S.D.N.Y. Sept. 28, 2021)","Pac. & S. Co. v. Duncan, 744 F.2d 1490 (11th Cir. 1984)","Paramount Pictures, Corp. v. Axanar Prods., Inc., No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","Penguin Grp. (USA), Inc. v. Am. Buddha, No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","Penguin Random House v. Colting, No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","Perfect 10, Inc. v. Amazon.com, Inc., 508 F.3d 1146 (9th Cir. 2007)","Peter Letterese & Assocs. v. World Inst. of Scientology Enters., 533 F.3d 1287 (11th Cir. 2008)","Peterman v. Republican National Committee, No. CV 17-66-M-DLC (D. Mont. Feb. 22, 2019)","Peteski Productions, Inc. v. Rothman, No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","Philpot v. Media Research Center Inc. No. 1:17-cv-822 (E.D. Va. Jan. 8, 2018)","Philpot v. WOS, Inc., No. 1:18-CV-339-RP (W.D. Tex. Apr. 22, 2019)","Princeton Univ. Press v. Mich. Document Servs., Inc., 99 F.3d 1381 (6th Cir. 1996)","Radji v. Khakbaz, 607 F. Supp. 1296 (D.D.C. 1985)","Red Label Music Publ’g v. Chila Prods., 18 C 7252 (N.D. Ill. May 30, 2019)","Reiner v. Nishimori, No. 3:15-cv-00241 (M.D. Tenn. Apr. 28, 2017)","Reyes v. Wyeth Pharm., Inc., 603 F. Supp. 2d 289 (D.P.R. 2009)","Richards v. Merriam Webster, Inc., 55 F. Supp. 205 (D. Mass. 2014)","Righthaven, L.L.C. v. Jama, No. 2:10-CV-1322 JCM (LRL) (D. Nev. Apr. 22, 2011)","Righthaven, L.L.C. v. Realty One Grp., Inc., No. 2:10-cv-1036-LRH-PAL. (D. Nev. Oct. 19, 2010)","Rimini St. v. Oracle Int’l Corp., 473 F. Supp. 3d 1158 (D. Nev. 2020)","Ringgold v. Black Entm’t Television, Inc., 126 F.3d 70 (2d Cir. 1997)","Robinson v. Random House, Inc., 877 F. Supp. 830 (S.D.N.Y. 1995)","Rogers v. Koons, 960 F.2d 301 (2d Cir. 1992)","Rosemont Enters., Inc. v. Random House, Inc., 366 F.2d 303 (2d Cir. 1966)","Rosen v. eBay, Inc., No. 2:13-cv-06801-MWF-E (C.D. Cal. Jan. 16, 2015)","Rotbart v. J.R. O’Dwyer Co., No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","Roy Exp. Co. Establishment of Vaduz, Liech. v. CBS, Inc., 672 F.2d 1095 (2d Cir. 1982)","Rubin v. Bos. Magazine Co., 645 F.2d 80 (1st Cir. 1981)","Russell Brammer v. Violent Hues Productions, LLC, No. 1-17-cv-01009 (E.D. Va. June 11, 2018)","SOFA Entm’t, Inc. v. Dodger Prods., Inc., 709 F.3d 1273 (9th Cir. 2013)","Salinger v. Colting, 607 F.3d 68 (2d Cir. 2010)","Salinger v. Random House, Inc., 811 F.2d 90 (2d Cir. 1987)","Schwartzwald v. Oath Inc. No. 19-CV-9938 (RA) (S.D.N.Y. Sept. 10, 2020)","Sedlik v. Von Drachenberg, No. CV 21-1102 (C.D. Cal. May 31, 2022)","Sega Enters. Ltd. v. Accolade, Inc., 977 F.2d 1510 (9th Cir. 1992)","Sega Enters. Ltd. v. MAPHIA, 948 F. Supp. 923 (N.D. Cal. 1996)","Seltzer v. Green Day, Inc., 725 F.3d 1170 (9th Cir. 2013)","Shirman v. WHEC-TV, LLC, 18-CV-6508-FPG, 2019 U.S. Dist. LEXIS 83767 (W.D.N.Y. May 17, 2019)","Sketchworks Indus. Strength Comedy, Inc. v. Jacobs, No. 19-CV-7470-LTS-VF (S.D.N.Y. May 12, 2022)","Soc’y of the Holy Transfiguration Monestary, Inc. v. Gregory, 689 F.3d 29 (1st Cir. 2012)","Solid Oak Sketches, LLC v. 2K Games, Inc., No. 16-cv-724-LTS-SDA (S.D.N.Y. Mar. 26, 2020)","Sony Computer Entm't. Inc. v. Connectix Corp., 203 F. 3d 596 (9th Cir. 2000)","Sony Computer Entm’t Am., Inc. v. Bleem, L.L.C., 214 F.3d 1022 (9th Cir. 2000)","Sony Corp. of Am. v. Universal City Studios, Inc., 464 U.S. 417 (1984)","Stewart v. Abend, 495 U.S. 207 (1990)","Sundeman v. Seajay Soc’y, Inc., 142 F.3d 194 (4th Cir. 1998)","Suntrust Bank v. Houghton Mifflin Co., 268 F.3d 1257 (11th Cir. 2001)","Supermarket of Homes, Inc. v. San Fernando Valley Bd. of Realtors, 786 F.2d 1400 (9th Cir. 1986)","Swatch Grp. Mgmt. Servs. Ltd. v. Bloomberg L.P., 742 F.3d 17 (2d Cir. 2014)","TCA Television Corp. v. McCollum, No. 1:16-cv-0134 (2d Cir. Oct. 11, 2016)","TD Bank, N.A. v. Hill, No. 12-7188 (RDK/JS), 2015 WL 4523570 (D. NJ July 27, 2015)","Tavory v. NTP, Inc., 495 F. Supp. 2d 531 (E.D. Va. 2007)","Television Digest, Inc. v. U.S. Tel. Ass’n, 841 F. Supp. 5 (D.D.C. 1993)","Tiffany Design, Inc. v. Reno-Tahoe Specialty, Inc., 55 F. Supp. 2d 1113 (D. Nev. 1999)","Toksvig v. Bruce Pub. Co., 181 F.2d 664 (7th Cir. 1950)","Tresóna Multimedia v. Burbank High School Vocal Music Ass’n, Nos. 17-56006, 17-56417, 17-56419 (9th Cir. Mar. 24, 2020)","Triangle Publ’ns, Inc. v. Knight-Ridder Newspapers, Inc., 626 F.2d 1171 (5th Cir. 1980)","Twin Peaks Prods., Inc. v. Publ’ns Int’l, Ltd., 996 F.2d 1366 (2d Cir. 1993)","Ty, Inc. v. Publ'ns Int'l, Ltd., 333 F. Supp. 2d 705 (N.D. Ill. 2004)","United States v. Am. Soc’y of Composers, Authors and Publishers, 599 F. Supp. 2d 415 (S.D.N.Y. 2009), vacated, 627 F.3d 64 (2d Cir. 2010)","United States v. Slater, 348 F.3d 666 (7th Cir. 2003)","VHT, Inc. v. Zillow Group, Nos. 17-35587, 17-35588 (9th Cir. Mar. 15, 2019)","Veeck v. S. Bldg. Code Cong. Int’l, 241 F.3d 398 (5th Cir. 2001)","Viacom Int’l v. Pixi Universal, Civ. Action No H-21-2612 (S.D. Tex. Mar. 25, 2022)","Video Pipeline, Inc. v. Buena Vista Home Entm’t, Inc., 342 F.3d 191 (3d Cir. 2003)","Wall Data, Inc. v. L.A. Cnty. Sheriff’s Dep’t, 447 F.3d 769 (9th Cir. 2006)","Walsh v. Townsquare Media, Inc., No. 19-CV-4958 (VSB) (S.D.N.Y. June 1, 2020)","Walt Disney Prods. v. Air Pirates, 581 F.2d 751 (9th Cir. 1978), cert. denied, 439 U.S. 1132 (1979)","Warner Bros. Entm’t, Inc. v. RDR Books, 575 F. Supp. 2d 513 (S.D.N.Y. 2008)","Warner Bros., Inc. v. Am. Broad. Cos., Inc., 654 F.2d 204 (2d Cir. 1981)","Warner Bros., Inc. v. Am. Broad. Cos., Inc., 720 F.2d 231 (2d Cir. 1983)","Warren Publ’g Co. v. Spurlock, 645 F. Supp. 2d 402 (E.D. Pa. 2009)","Weissmann v. Freeman, 868 F.2d 1313 (2d Cir. 1989)","White v. West Pub. Corp., No. 12-cv-1340-JSR (S.D.N.Y. Jul. 3, 2014)","Wihtol v. Crow, 309 F.2d 777 (8th Cir. 1962)","Wilen v. Alt. Media Net, Inc., No. 03CIV2524 (RMB) (JCF) (S.D.N.Y. Jan. 26, 2005)","Williams & Wilkins Co. v. United States, 487 F.2d 1345 (Ct. Cl. 1973)","Wojnarowicz v. Am. Family Ass’n, 745 F. Supp. 130 (S.D.N.Y. 1990)","World Wrestling Fed’n Entm’t, Inc. v. Bozell, 142 F. Supp. 2d 514 (S.D.N.Y. 2001)","Worldwide Church of God v. Phila. Church of God, Inc., 227 F.3d 1110 (9th Cir. 2000)","Wright v. Warner Books, Inc., 953 F.2d 731 (2d Cir. 1991)","Yang v. Mic Network Inc., Nos. 20-4097-cv, 20-4201-cv (2d Cir. Mar. 29, 2022)","Zomba Enters., Inc. v. Panorama Records, Inc., 491 F.3d 574 (6th Cir. 2007)"],"title":["A&M Records, Inc. v. Napster, Inc.,","A.V. ex rel. Vanderhye v. iParadigms, L.L.C.,","Adjmi v. DLT Entm’t, Ltd.,","Am. Geophysical Union v. Texaco, Inc.,","Am. Inst. of Physics v. Schwegman, Lundberg & Woessner, P.A.,","Am. Soc'y for Testing & Materials v. Public.Resource.Org, Inc.","Andy Warhol Found. for the Visual Arts, Inc. v. Goldsmith","Apple Inc. v. Corellium, LLC","Arica Inst., Inc. v. Palmer,","Arrow Prods., Ltd. v. The Weinstein Co., LLC,","Associated Press v. Meltwater U.S. Holdings, Inc.,","Ass’n of Am. Med. Colls. v. Cuomo,","Ass’n of Am. Med. Colls. v. Mikaelian,","Atari Games Corp. v. Nintendo of Am. Inc.,","Authors Guild, Inc. v. Google Inc.,","Authors Guild, Inc. v. HathiTrust,","BMG Music v. Gonzalez,","BWP Media USA, Inc. v. Gossip Cop Media, Inc.","Bain v. Film Indep., Inc.","Balsley v. LFP, Inc.,","Baraban v. Time Warner, Inc.,","Barcroft Media, Ltd. V. Coed Media Group, LLC","Basic Books, Inc. v. Kinko’s Graphics Corp.,","Bell v. Eagle Mt. Saginaw Indep. Sch. Distr.","Bell v. Worthington City Sch. Dist.","Benny v. Loew's, Inc.,","Berlin v. E.C. Publ’ns, Inc.,","Bill Graham Archives v. Dorling Kindersley Ltd.,","Blackwell Publ’g, Inc. v. Excel Research Grp., LLC,","Blanch v. Koons,","Boesen v. United Sports Publs., Ltd.","Bond v. Blum,","Bouchat v. Balt. Ravens Ltd. P’ship,","Bouchat v. Balt. Ravens Ltd. P’ship,","Brammer v. Violent Hues Productions, LLC","Brewer v. Hustler Magazine, Inc.,","Brown v. Netflix, Inc.","Brownmark Films, LLC v. Comedy Partners,","Byrne v. BBC,","CCA and B, LLC v. F + W Media, Inc.,","Cable/Home Commc’n Corp. v. Network Prods., Inc.,","Cambridge University Press v. Becker","Cambridge Univ. Press v. Patton,","Cambridge University Press v. Albert","Cambridge University Press v. Mark P. Becker","Campbell v. Acuff-Rose Music, Inc.,","Caner v. Autry,","Capitol Records, LLC v. ReDigi Inc.","Cariou v. Prince,","Castle Rock Entm’t, Inc. v. Carol Publ. Group, Inc.,","Castle v. Kingsport Publ’g Corp.","Chapman v. Maraj","Chi. Bd. of Educ. v. Substance, Inc.,","Clark v. Transportation Alternatives, Inc.","Clean Flicks of Colo., LLC v. Soderbergh,","Code Revision Comm. v. Public.Resource.Org, Inc.","Columbia Pictures Indus., Inc. v. Miramax Films Corp.,","Comerica Bank & Trust, N.A. v. Habib","Compaq Computer Corp. v. Ergonome, Inc.,","Consumers Union of U.S., Inc. v. Gen. Signal Corp.,","Corbello v. DeVito","DC Comics Inc. v. Reel Fantasy, Inc.,","DC Comics Inc. v. Crazy Eddie, Inc.,","Dall. Cowboys Cheerleaders, Inc. v. Scoreboard Posters, Inc.,","Davidson v. United States","Davis v. Gap, Inc.,","De Fontbrune v. Wofsy","Denison v. Larkin,","Diamond v. Am-Law Publ’g Corp.,","Disney Enterprises, Inc. v. VidAngel, Inc.","Disney Enters., Inc. v. VidAngel, Inc.","Diversey v. Schmidly,","Dlugolecki v. Poppel","Dominick Ranieri v. Adirondack Dev. Group LLC,","Donald Graham v. Richard Prince, et al.","Dow Jones & Co., Inc. v. Bd. of Trade of the City of Chi.,","Dr. Seuss Enters., L.P. v. ComicMix LLC","Dr. Seuss Enters., LP v. Penguin Books USA, Inc.,","Duffy v. Penguin Books USA, Inc.,","Easter Unlimited, Inc. v. Rozier","Educ. Testing Serv. v. Katzman,","Eisenschiml v. Fawcett Publ’n, Inc.,","Elsmere Music, Inc. v. NBC,","Elvis Presley Enters., Inc. v. Passport Video,","Encyclopedia Brittanica Educ. Corp. v. Crooks,","Erika Peterman v. Republican National Committee","Estate of Anthony Barré and Angel Barré v. Carter, et al.","Estate of James Oscar Smith v. Cash Money Records, Inc., et al.","Faulkner Literary Rights, LLC v. Sony Pictures Classics, Inc.,","Ferdman v. CBS Interactive Inc.","Fin. Info., Inc. v. Moody’s Investor Serv., Inc.,","Fisher v. Dees,","Fitzgerald v. CBS Broad., Inc.,","Folsom v. Marsh,","Fox Broad. Co. v. Dish Network, LLC,","Fox Broad. Co. v. Dish Network, LLC,","Fox News Network, LLC v. TVEyes, Inc.","Friedman v. Guetta,","Furie v. Infowars, LLC","Galvin v. Ill. Republican Party","Gaylord v. United States,","Golden v. Michael Grecco Prods.","Google LLC v. Oracle Am., Inc.","H.C. Wainwright & Co. v. Wall St. Transcript Corp.,","Haberman v. Hustler Magazine, Inc.,","Harper & Row Publishers, Inc. v. Nation Enterprises,","Henley v. DeVore,","Hofheinz v. Discovery Commc’ns, Inc.,","Matt Hosseinzadeh v. Ethan Klein and Hila Klein","House of Bryant Publ’ns, L.L.C. v. A&E Television Networks,","Hustler Magazine, Inc. v. Moral Majority, Inc.,","In re DMCA Subpoena to Reddit, Inc.","Infinity Broad. Corp. v. Kirkwood,","Int’l Code Council, Inc. v. UpCodes, Inc.","Iowa State Univ. Research Found., Inc., v. Am. Broad. Cos., Inc.,","James Castle Collection and Archive, LP v. Scholastic, Inc. and Allen Say","Jartech, Inc. v. Clancy,","Katz v. Google, Inc.","Kelly v. Arriba Soft Corp.,","Kennedy v. Gish, Sherwood & Friends, Inc.,","Kienitz v. Sconnie Nation, LLC,","L.A. News Serv. v. CBS Broad., Inc.,","L.A. News Serv. v. KCAL-TV Channel 9,","L.A. News Serv. v. Reuters Television Int’l, Ltd.,","L.A. News Serv. v. Tullo,","Leadsinger, Inc. v. BMG Music Publ’g,","Leibovitz v. Paramount Pictures Corp.,","Lennon v. Premise Media Corp.,","Lish v. Harper’s Magazine Found.,","Lucasfilm Ltd. LLC, et al. v. Ren Ventures Ltd., et al.","Lucent Info. Mgmt. v. Lucent Techs., Inc.,","MCA, Inc. v. Wilson,","Marano v. Metro. Museum of Art","Marcus v. Rowley,","MasterCard Int’l, Inc. v. Nader 2000 Primary Comm., Inc.,","Mattel Inc. v. Walking Mountain Prods.,","Mattel, Inc. v. Entities Doing Bus. as Unicorn Element","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P.","Maxtone-Graham v. Burtchaell,","McGowan v. Cross,","McGucken v. Newsweek LLC","McGucken v. Pub Ocean Ltd.","Meeropol v. Nizer,","Merkos L’Inyonei Chinuch, Inc. v. Otsar Sifrei Lubavitch, Inc.,","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., Inc.,","MidlevelU, Inc. v. ACI Info. Grp.","Monge v. Maya Magazines, Inc.,","Monsarrat v. Newman","Monster Commc’ns, Inc. v. Turner Broad. Sys., Inc.,","Morris v. Guetta,","Murphy v. Millennium Radio Grp. L.L.C.,","N. Jersey Media Grp., Inc. v. Pirro","N.Y. Times Co. v. Roxbury Data Interface, Inc.,","Narell v. Freeman,","Nat'l Acad. of TV Arts & Scis., Inc. v. Multimedia Sys. Design, Inc.","Nat’l Ctr. for Jewish Film v. Riverside Films, L.L.C.,","Nat'l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio,","Neri v. Monroe,","New Era Publ’ns Int’l, ApS v. Carol Publ’g Grp.,","New Era Publ’ns Int’l, ApS v. Henry Holt & Co.,","New Line Cinema Corp. v. Bertlesman Music Grp., Inc.,","Nihon Keizai Shimbun, Inc. v. Comline Bus. Data, Inc.,","Noland v. Janssen","Norse v. Henry Holt & Co.,","Northland Family Planning Clinic, Inc. v. Ctr. for Bio-Ethical Reform,","Nunez v. Caribbean Int’l News Corp.,","Otto v. Hearst Communications, Inc.","Oyewole v. Ora","O’Neil v. Ratajkowski","Pac. & S. Co. v. Duncan,","Paramount Pictures Corp. v. Axanar Prods., Inc.","Penguin Grp. (USA), Inc. v. Am. Buddha,","Penguin Random House LLC, et al. v. Frederik Colting and Melissa Medina, d/b/a Moppet Books","Perfect 10, Inc. v. Amazon.com, Inc.,","Peter Letterese & Assocs. v. World Inst. of Scientology Enters.,","Peterman v. Republican National Committee","Peteski Productions, Inc. v. Leah Rothman","Philpot v. Media Research Center Inc.","Philpot v. WOS, Inc.","Princeton Univ. Press v. Mich. Document Servs., Inc.,","Radji v. Khakbaz,","Red Label Music Publ’g v. Chila Prods.","Reiner v. Nishimori","Reyes v. Wyeth Pharm., Inc.,","Richards v. Merriam Webster, Inc.,","Righthaven, L.L.C. v. Jama,","Righthaven, L.L.C. v. Realty One Grp., Inc.,","Rimini St. v. Oracle Int’l Corp.","Ringgold v. Black Entm’t Television, Inc.,","Robinson v. Random House, Inc.,","Rogers v. Koons,","Rosemont Enters., Inc. v. Random House, Inc.,","Rosen v. eBay, Inc.,","Rotbart v. J.R. O’Dwyer Co., Inc.,","Roy Exp. Co. Establishment of Vaduz, Liech. v. CBS, Inc.,","Rubin v. Bos. Magazine Co.,","Russell Brammer v. Violent Hues Productions, LLC","SOFA Entm’t, Inc. v. Dodger Prods., Inc.,","Salinger v. Colting,","Salinger v. Random House, Inc.,","Schwartzwald v. Oath Inc.","Sedlik v. Von Drachenberg","Sega Enters. Ltd. v. Accolade, Inc.,","Sega Enters. Ltd. v. MAPHIA,","Seltzer v. Green Day, Inc.,","Shirman v. WHEC-TV, LLC","Sketchworks Indus. Strength Comedy, Inc. v. Jacobs","Soc’y of the Holy Transfiguration Monestary, Inc. v. Gregory,","Solid Oak Sketches, LLC v. 2K Games, Inc.,","Sony Computer Entm’t, Inc. v. Connectix Corp.,","Sony Computer Entm’t Am., Inc. v. Bleem, L.L.C.,","Sony Corp. of Am. v. Universal City Studios, Inc.,","Stewart v. Abend,","Sundeman v. The Seajay Soc’y, Inc.,","Suntrust Bank v. Houghton Mifflin Co.,","Supermarket of Homes, Inc. v. San Fernando Valley Bd. of Realtors,","Swatch Grp. Mgmt. Servs. Ltd. v. Bloomberg L.P.,","TCA Television Corp. v. McCollum,","TD Bank, N.A. v. Hill","Tavory v. NTP, Inc.,","Television Digest, Inc. v. U.S. Tel. Ass’n,","Tiffany Design, Inc. v. Reno-Tahoe Specialty, Inc.,","Toksvig v. Bruce Pub. Co.,","Tresóna Multimedia, LLC v. Burbank High School Vocal Music Ass’n","Triangle Publ’ns, Inc. v. Knight-Ridder Newspapers, Inc.,","Twin Peaks Prods., Inc. v. Publ’ns Int’l, Ltd.,","Ty, Inc. v. Publ'ns Int'l, Ltd.,","United States v. Am. Soc’y of Composers, Authors and Publishers","United States v. Slater,","VHT, Inc. v. Zillow Group","Veeck v. S. Bldg. Code Congress Int’l,","Viacom Int’l v. Pixi Universal","Video Pipeline, Inc. v. Buena Vista Home Entm’t, Inc.,","Wall Data, Inc. v. L.A. Cnty. Sheriff’s Dep’t,","Walsh v. Townsquare Media, Inc.","Walt Disney Prods. v. Air Pirates,","Warner Bros. Entm’t, Inc. v. RDR Books,","Warner Bros., Inc. v. Am. Broad. Cos., Inc.,","Warner Bros., Inc. v. Am. Broad. Cos., Inc.,","Warren Publ’g Co. v. Spurlock,","Weissmann v. Freeman,","White v. West Pub. Corp.","Wihtol v. Crow,","Wilen v. Alt. Media Net, Inc.,","Williams & Wilkins Co. v. United States,","Wojnarowicz v. Am. Family Ass’n,","World Wrestling Fed’n Entm’t, Inc. v. Bozell,","Worldwide Church of God v. Phila. Church of God, Inc.,","Wright v. Warner Books, Inc.,","Yang v. Mic Network Inc.","Zomba Enters., Inc. v. Panorama Records, Inc.,"],"case_number":["239 F.3d 1004 (9th Cir. 2001)","562 F.3d 630 (4th Cir. 2009)","No. 1:14-cv-00568-LAP (S.D.N.Y. Mar. 31, 2015)","60 F.3d 913 (2d Cir. 1995)","No. 0:12-cv-00528-RHK-JJK (D. Minn. July. 30, 2013)","No. 13-cv-1215 (TSC), 2022 U.S. Dist. LEXIS 60922 (D.D.C. Mar. 31, 2022)","19-2420-cv (2d Cir. Aug. 24, 2021)","Case No. 9:19-cv-81160-RS, 2020 U.S. Dist. LEXIS 249945 (S.D. Fla. Dec. 29, 2020)","970 F.2d 1067 (2d Cir. 1992)","44 F. Supp. 3d 359 (S.D.N.Y. 2014)","931 F. Supp. 2d 537 (S.D.N.Y. 2013)","928 F.2d 519 (2d Cir. 1991)","571 F. Supp. 144 (E.D. Pa. 1983)","975 F. 2d 832 (Fed. Cir. 1992)","No. 13-4829-cv (2d Cir. Oct. 16, 2015)","755 F.3d 87 (2d Cir. 2014)","430 F.3d 888 (7th Cir. 2005)","No. 13-cv-7574-KPF (S.D.N.Y. Jul. 20, 2016)","No. CV 18-4126 PA (JEMx), 2020 U.S. Dist. LEXIS 141859 (C.D. Cal. Aug. 6, 2020)","691 F.3d 747 (6th Cir. 2012)","No. 99 Civ. 1569-JSM (S.D.N.Y. April 6, 2000)","No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","758 F. Supp. 1522 (S.D.N.Y. 1991)","27 F.4th 313 (5th Cir. 2022)","No. 2:18-cv-961, 2020 U.S. Dist. LEXIS 96464 (S.D. Ohio June 2, 2020)","239 F.2d 532 (9th Cir. 1956), aff’d by an equally divided court, 356 U.S. 43 (1958)","329 F.2d 541 (2d Cir. 1964)","448 F.3d 605 (2d Cir. 2006)","661 F. Supp. 2d 786 (E.D. Mich. 2009)","467 F.3d 244 (2d Cir. 2006)","No. 20-CV-1552 (ARR) (SIL), 2020 U.S. Dist. LEXIS 240935 (E.D.N.Y. Nov. 2, 2020), reconsideration denied by 2020 U.S. Dist. LEXIS 240935 (Dec. 22, 2020)","317 F.3d 385 (4th Cir. 2003), cert. denied 540 U.S. 820","619 F.3d 301 (4th Cir. 2010)","737 F.3d 932 (4th Cir. 2013)","No. 18-1763 (4th Cir. Apr. 26, 2019)","749 F.2d 527 (9th Cir. 1984)","855 F. App’x 61 (2d Cir. 2021)","682 F.3d 687 (7th Cir. 2012)","132 F. Supp. 2d 229 (S.D.N.Y. 2001)","819 F. Supp. 2d 1310 (N.D. Ga. 2011)","902 F.2d 829 (11th Cir. 1990)","No. 1:08-cv-1425-ODE, 2020 U.S. Dist. LEXIS 35134 (N.D. Ga. Mar. 2, 2020)","769 F.3d 1232 (11th Cir. 2014)","No. 16-15726 (11th Cir. Oct. 19, 2018)","No. 1:08-cv-01425-ODE (N.D. Ga. Mar. 31, 2016) appeal docketed, Aug. 26, 2016","510 U.S. 569 (1994)","16 F. Supp. 3d 689 (W.D. Va. 2014)","No. 16-2321 (2nd Cir. Dec. 12, 2018)","714 F.3d 694 (2d Cir. 2013) cert. denied 134 S. Ct. 618 (2013)","150 F.3d 132 (2d Cir. 1998)","2:19-CV-00092-DCLC, 2020 U.S. Dist. LEXIS 233919 (E.D. Tenn. Dec. 14, 2020)","No. 2:18-cv-09088-VAP-SS (C.D. Cal. Sept. 16, 2020)","354 F.3d 624 (7th Cir. 2003), cert. denied, 543 U.S. 816 (2004)","18 Civ. 9985 (VM) (S.D.N.Y. Mar. 18, 2019)","433 F. Supp. 2d 1236 (D. Colo. 2006)","No. 1:15-cv-02594-RWS (N.D. Ga. Mar. 23, 2017)","11 F. Supp. 2d 1179 (C.D. Cal. 1998)","No. 17-12418-LTS, 2020 U.S. Dist. LEXIS 1343 (D. Mass. Jan. 6, 2020)","387 F.3d 403 (5th Cir. 2004)","724 F.2d 1044 (2d Cir. 1983)","No. 2:08-cv-00867-RCJ-PAL (D. Nev. June 14, 2017)","696 F.2d 24 (2d Cir. 1982)","No. 79 Civ. 3786-PNL (S.D.N.Y. Aug. 3, 1979)","600 F.2d 1184 (5th Cir. 1979)","No. 13-942C (Fed. Cl. June 29, 2018)","246 F.3d 152 (2d Cir. 2001)","39 F.4th 1214 (9th Cir. 2022)","64 F. Supp. 3d (N.D. Ill. 2014)","745 F.2d 142 (2d Cir. 1984)","No. 2:16-CV-04109 (9th Cir. Aug. 24, 2017)","No. 2:16-cv-04109-AB (C.D. Cal. Dec. 12, 2016)","738 F.3d 1196 (10th Cir. 2013)","CV 18-3905-GW (GJSx), 2019 U.S. Dist. LEXIS 149404 (C.D. Cal. Aug. 22, 2019)","No. 1.11-cv-1013-GTS-CFH (N.D.N.Y. Feb. 22, 2016)","No. 15-CV-10160 (S.D.N.Y. July 18, 2017)","546 F. Supp. 113 (S.D.N.Y. 1982)","983 F.3d 443 (9th Cir. 2020)","109 F.3d 1394 (9th Cir. 1997)","4 F. Supp. 2d 268 (S.D.N.Y. 1998)","No. 18-cv-06637, 2021 U.S. Dist. LEXIS 184636 (E.D.N.Y. Sep. 17, 2021)","793 F.2d 533 (3d Cir. 1986), abrogated on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","246 F.2d 598 (7th Cir. 1957)","482 F. Supp. 741 (S.D.N.Y. 1980), aff’d, 623 F.2d 252 (2d. Cir. 1980) (per curiam)","349 F.3d 622 (9th Cir. 2003), overruled on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","542 F. Supp. 1156 (S.D.N.Y. 1982)","No. 17-66-M-DLC (D. Mont. March 19, 2018)","No. 17-1057 (E.D. Lou. July 25, 2017)","No. 1:14-cv-02703 (S.D.N.Y. May 30, 2017)","953 F. Supp. 2d 701 (N.D. Miss. 2013)","No. 17 Civ. 1317 (PGG) (S.D.N.Y. Sept. 24, 2018)","751 F.2d 501 (2d Cir. 1984)","794 F.2d 432 (9th Cir. 1986)","491 F. Supp. 2d 177 (D. Mass. 2007)","9 F. Cas. 342 (C.C.D. Mass. 1841)","723 F.3d 1067 (9th Cir. 2013) amended and reh’g en banc denied, 747 F.3d 1060 (9th Cir. 2014)","No. 2:12-cv-04529-DMG-SH (C.D. Cal. Jan. 12, 2015)","Nos. 15-3885, 15-3886 (2d Cir. Feb. 27, 2018)","No. CV 10-00014 DDP (JCx) (C.D. Cal. May 27, 2011)","Case No. CV 18-1830-MWF (JPRx) (C.D. Cal. May 16, 2019)","No. 1:14-cv-00490 (N.D. Ill. Sept. 9, 2015)","595 F.3d 1364 (Fed. Cir. 2010)","No. 19-CV-3156 (NGG) (RER), 2021 U.S. Dist. LEXIS 43701 (E.D.N.Y. Mar. 9, 2021)","141 S. Ct. 1183 (2021)","418 F. Supp. 620 (S.D.N.Y. 1976), aff’d 558 F.2d 91 (2d Cir. 1977), cert. denied, 434 U.S. 1014 (1978)","626 F. Supp. 201 (D. Mass. 1986)","471 U.S. 539 (1985)","733 F. Supp. 2d 1144 (C.D. Cal. 2010)","No. 00 CIV. 3802 (HB) (S.D.N.Y. Sep. 20, 2001)","No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","796 F.2d 1148 (9th Cir. 1986)","No. 19-mc-80005-SK (JD), 2020 U.S. Dist. LEXIS 37033 (N.D. Cal. Mar. 2, 2020)","150 F.3d 104 (2d Cir. 1998)","17 Civ. 6261 (VM), 2020 U.S. Dist. LEXIS 92324 (S.D.N.Y. May 27, 2020)","621 F.2d 57 (2d Cir. 1980)","No. 1:17-CV-00437-BLW (D. Idaho Oct. 30, 2017)","666 F.2d 403 (9th Cir. 1982)","No. 14-14525 (11th Cir. Sept. 17, 2015)","336 F.3d 811 (9th Cir. 2003)","No. 4:13-cv-02236-JAR (E.D. Mo. Nov. 5, 2015)","766 F.3d 756 (7th Cir. 2014) cert. denied 135 S. Ct. 1555 (2015)","305 F.3d 924 (9th Cir. 2002)","108 F.3d 1119 (9th Cir. 1997), cert. denied 522 U.S. 823 (1997)","149 F.3d 987 (9th Cir. 1998)","973 F.2d 791 (9th Cir. 1992)","512 F.3d 522 (9th Cir. 2008)","137 F.3d 109 (2d Cir. 1998)","556 F. Supp. 2d 310 (S.D.N.Y. 2008)","807 F. Supp. 1090 (S.D.N.Y. 1992)","No. 17-cv-07249-RS (N.D. Cal. June 29, 2018)","5 F. Supp. 2d 238 (D. Del. 1998)","677 F.2d 180 (2d Cir. 1981)","844 F. App’x 436 (2d Cir. 2021)","695 F.2d 1171 (9th Cir. 1983)","No. 00 CIV. 6068 (GBD) (S.D.N.Y. Mar. 8, 2004)","353 F.3d 792 (9th Cir. 2003)","21 Civ. 2333 (VM), 2021 U.S. Dist. LEXIS 106188 (S.D.N.Y. June 4, 2021)","No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017) aff’d, No. 17-2952-cv, 2018 WL 3323476 (2d Cir. July 6, 2018)","803 F.2d 1253 (2d Cir. 1986)","991 F.2d 790, Nos. 92-1480, 92-1584 (4th Cir. Apr. 22, 1993)","19 Civ. 9617 (KPF), 2022 U.S. Dist. LEXIS 50231 (S.D.N.Y. Mar. 21, 2022)","2:20-cv-01923-RGK-AS, 2021 U.S. Dist. LEXIS 153361 (C.D. Cal. July 27, 2021)","560 F.2d 1061 (2d Cir. 1977)","312 F.3d 94 (2d Cir. 2002)","900 F. Supp. 1287 (C.D. Cal. 1995)","989 F.3d 1205 (11th Cir. 2021)","688 F.3d 1164 (9th Cir. 2012)","28 F.4th 314 (1st Cir. 2022)","935 F. Supp. 490 (S.D.N.Y. 1996)","No. LA CV12-00684 JAK (RZX) (C.D. Cal. Feb. 4, 2013)","650 F.3d 295 (3d Cir. 2011)","74 F. Supp. 3d 605 (S.D.N.Y. 2015)","434 F. Supp. 217 (D.N.J. 1977)","872 F.2d 907 (9th Cir. 1989)","No. 20-CV-7269 (VEC), 2021 U.S. Dist. LEXIS 142733 (S.D.N.Y. July 30, 2021)","No. 5:12-cv-00044-ODW (DTB) (C.D. Cal. Sept. 14, 2012)","15 F.3d 559 (6th Cir. 1994)","No. 11-cv-429-slc (W.D. Wis. Feb. 26, 2014)","904 F.2d 152 (2d Cir. 1990)","873 F.2d 576 (2d Cir. 1989)","693 F. Supp. 1517 (S.D.N.Y. 1988)","166 F.3d 65 (2d Cir. 1999)","No. 17-CV-5452, 2020 U.S. Dist. LEXIS 95454 (S.D.N.Y. June 1, 2020)","847 F. Supp. 142 (N.D. Cal. 1994)","868 F. Supp. 2d 962 (C.D. Cal. 2012)","235 F.3d 18 (1st Cir. 2000)","No. 1:17-cv-4712-GHW (S.D.N.Y. Dec. 10, 2018)","291 F. Supp. 3d 422 (S.D.N.Y. Mar. 8, 2018)","No. 19 CIV. 9769 (AT), 2021 WL 4443259 (S.D.N.Y. Sept. 28, 2021)","744 F.2d 1490 (11th Cir. 1984)","No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","508 F.3d 1146 (9th Cir. 2007)","533 F.3d 1287 (11th Cir. 2008)","No. CV 17-66-M-DLC (D. Mont. Feb. 22, 2019)","No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","No. 1:17-cv-822 (E.D. Va. Jan. 8, 2018)","No. 1:18-CV-339-RP (W.D. Tex. Apr. 22, 2019)","99 F.3d 1381 (6th Cir. 1996)","607 F. Supp. 1296 (D.D.C. 1985)","18 C 7252, 2019 U.S. Dist. LEXIS 90159 (N.D. Ill. May 30, 2019)","No. 3:15-cv-00241 (M.D. Tenn. Apr. 28, 2017)","603 F. Supp. 2d 289 (D.P.R. 2009)","55 F. Supp. 205 (D. Mass. 2014)","No. 2:10-CV-1322 JCM (LRL) (D. Nev. Apr. 22, 2011)","No. 2:10-cv-1036-LRH-PAL. (D. Nev. Oct. 19, 2010)","473 F. Supp. 3d 1158 (D. Nev. 2020)","126 F.3d 70 (2d Cir. 1997)","877 F. Supp. 830 (S.D.N.Y. 1995)","960 F.2d 301 (2d Cir. 1992)","366 F.2d 303 (2d Cir. 1966)","No. 2:13-cv-06801-MWF-E (C.D. Cal. Jan. 16, 2015)","No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","672 F.2d 1095 (2d Cir. 1982)","645 F.2d 80 (1st Cir. 1981)","No. 1-17-cv-01009 (E.D. Va. June 11, 2018)","709 F.3d 1273 (9th Cir. 2013)","607 F.3d 68 (2d Cir. 2010)","811 F.2d 90 (2d Cir. 1987)","No. 19-CV-9938 (RA), 2020 U.S. Dist. LEXIS 165641 (S.D.N.Y. Sept. 10, 2020)","No. CV 21-1102, 2022 WL 2784818 (C.D. Cal. May 31, 2022)","977 F.2d 1510 (9th Cir. 1992)","948 F. Supp. 923 (N.D. Cal. 1996)","725 F.3d 1170 (9th Cir. 2013)","18-CV-6508-FPG, 2019 U.S. Dist. LEXIS 83767 (W.D.N.Y. May 17, 2019)","No. 19-CV-7470-LTS-VF, 2022 U.S. Dist. LEXIS 86331 (S.D.N.Y. May 12, 2022)","689 F.3d 29 (1st Cir. 2012)","No. 16-CV-724-LTS-SDA, 2020 U.S. Dist. LEXIS 53287 (S.D.N.Y. Mar. 26, 2020)","203 F.3d 596 (9th Cir. 2000)","214 F.3d 1022 (9th Cir. 2000)","464 U.S. 417 (1984)","495 U.S. 207 (1990)","142 F.3d 194 (4th Cir. 1998)","268 F.3d 1257 (11th Cir. 2001)","786 F.2d 1400 (9th Cir. 1986)","742 F.3d 17 (2d Cir. 2014)","No. 1:16-cv-0134 (2d Cir. Oct. 11, 2016)","No. 1.12-cv-07188-RBK-JS (D. N.J. July 27, 2015)","495 F. Supp. 2d 531 (E.D. Va. 2007)","841 F. Supp. 5 (D.D.C. 1993)","55 F. Supp. 2d 1113 (D. Nev. 1999)","181 F.2d 664 (7th Cir. 1950)","Nos. 17-56006, 17-56417, 17-56419, 2020 U.S. App. LEXIS 9128 (9th Cir. Mar. 24, 2020)","626 F.2d 1171 (5th Cir. 1980)","996 F.2d 1366 (2d Cir. 1993)","333 F. Supp. 2d 705 (N.D. Ill. 2004)","599 F. Supp. 2d 415 (S.D.N.Y. 2009), vacated, 627 F.3d 64 (2d Cir. 2010)","348 F.3d 666 (7th Cir. 2003)","Nos. 17-35587, 17-35588 (9th Cir. Mar. 15, 2019)","241 F.3d 398 (5th Cir. 2001)","Civ. Action No H-21-2612, 2022 U.S. Dist. LEXIS 57400 (S.D. Tex. Mar. 25, 2022)","342 F.3d 191 (3d Cir. 2003)","447 F.3d 769 (9th Cir. 2006)","No. 19-CV-4958 (VSB), 2020 U.S. Dist. LEXIS 96090 (S.D.N.Y. June 1, 2020)","581 F.2d 751 (9th Cir. 1978), cert. denied, 439 U.S. 1132 (1979)","575 F. Supp. 2d 513 (S.D.N.Y. 2008)","654 F.2d 204 (2d Cir. 1981)","720 F.2d 231 (2d Cir. 1983)","645 F. Supp. 2d 402 (E.D. Pa. 2009)","868 F.2d 1313 (2d Cir. 1989)","No. 12-cv-1340-JSR (S.D.N.Y. Jul. 3, 2014)","309 F.2d 777 (8th Cir. 1962)","No. 03CIV2524 (RMB) (JCF) (S.D.N.Y. Jan. 26, 2005)","487 F.2d 1345 (Ct. Cl. 1973)","745 F. Supp. 130 (S.D.N.Y. 1990)","142 F. Supp. 2d 514 (S.D.N.Y. 2001)","227 F.3d 1110 (9th Cir. 2000)","953 F.2d 731 (2d Cir. 1991)","Nos. 20-4097-cv(L), 20-4201-cv (XAP), 2022 U.S. App. LEXIS 8195 (2d Cir. Mar. 29, 2022)","491 F.3d 574 (6th Cir. 2007)"]},"columns":[{"id":"case","name":"case","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["A&amp;M Records, Inc. v. Napster, Inc., 239 F.3d 1004 (9th Cir. 2001)","A.V. ex rel. Vanderhye v. iParadigms, L.L.C., 562 F.3d 630 (4th Cir. 2009)","Adjmi v. DLT Entm’t, Ltd., No. 1:14-cv-00568-LAP (S.D.N.Y. Mar. 31, 2015)","Am. Geophysical Union v. Texaco, Inc., 60 F.3d 913 (2d Cir. 1994)","Am. Inst. of Physics v. Schwegman, Lundberg &amp; Woessner, P.A., Civ. No. 12-528 (RHK/JJK) (D. Minn. July. 30, 2013)","Am. Soc'y for Testing &amp; Materials v. Public.Resource.Org, Inc., No. 13-cv-1215 (D.D.C. Mar. 31, 2022)","Andy Warhol Found. for the Visual Arts, Inc. v. Goldsmith, 19-2420-cv (2d Cir. Aug. 24, 2021)","Apple Inc. v. Corellium, LLC, Case No. 9:19-cv-81160-RS (S.D. Fla. Dec. 29, 2020)","Arica Inst., Inc. v. Palmer, 970 F.2d 1067 (2d Cir. 1992)","Arrow Prods., Ltd. v. The Weinstein Co., LLC,44 F. Supp. 3d 359 (S.D.N.Y. Aug. 25, 2014)","Associated Press v. Meltwater U.S. Holdings, Inc., 931 F. Supp. 2d 537 (S.D.N.Y. 2013)","Ass’n of Am. Med. Colls. v. Cuomo, 928 F.2d 519 (2d Cir. 1991)","Ass’n of Am. Med. Colls. v. Mikaelian, 571 F. Supp. 144 (E.D. Pa. 1983)","Atari Games Corp. v. Nintendo of Am. Inc., 975 F. 2d 832 (Fed. Cir. 1992)","Authors Guild, Inc. v. Google Inc., No. 13-04829 (2d Cir. Oct. 16, 2015)","Authors Guild, Inc. v. HathiTrust, 755 F.3d 87 (2d Cir. 2014)","BMG Music v. Gonzalez, 430 F.3d 888 (7th Cir. 2005)","BWP Media USA, Inc. v. Gossip Cop Media, Inc. No. 13-cv-7574-KPF (S.D.N.Y. Jul. 20, 2016)","Bain v. Film Indep., Inc. No. CV 18-4126 PA (JEMx) (C.D. Cal. Aug. 6, 2020)","Balsley v. LFP, Inc., 691 F.3d 747 (6th Cir. 2012)","Baraban v. Time Warner, Inc., No. 99 Civ. 1569 (JSM) (S.D.N.Y. Apr. 6, 2000)","Barcroft Media, Ltd. v. Coed Media Group, LLC, No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","Basic Books, Inc. v. Kinko’s Graphics Corp., 758 F. Supp. 1522 (S.D.N.Y. 1991)","Bell v. Eagle Mt. Saginaw Indep. Sch. Distr., 27 F.4th 313 (5th Cir. 2022)","Bell v. Worthington City Sch. Dist., No. 2:18-cv-961 (S.D. Ohio June 2, 2020)","Benny v. Loew's, Inc., 239 F.2d 532 (9th Cir. 1956)","Berlin v. E.C. Publ’ns, Inc., 329 F.2d 541 (2d Cir. 1964)","Bill Graham Archives v. Dorling Kindersley Ltd., 448 F.3d 605 (2d Cir. 2006)","Blackwell Publ’g, Inc. v. Excel Research Grp., LLC, 661 F. Supp. 2d 786 (E.D. Mich. 2009)","Blanch v. Koons, 467 F.3d 244 (2d Cir. 2006)","Boesen v. United Sports Publs., Ltd., No. 20-CV-1552 (ARR) (SIL) (E.D.N.Y. Nov. 2, 2020), reconsideration denied (Dec. 22, 2020)","Bond v. Blum, 317 F.3d 385 (4th Cir. 2003)","Bouchat v. Balt. Ravens Ltd. P'ship, 619 F.3d 301 (4th Cir. 2010)","Bouchat v. Balt. Ravens Ltd. P'ship, 737 F.3d 932 (4th Cir. 2013)","Brammer v. Violent Hues Productions, LLC, No. 18-1763 (4th Cir. Apr. 26, 2019)","Brewer v. Hustler Magazine, Inc., 749 F.2d 527 (9th Cir. 1984)","Brown v. Netflix, Inc., 855 F. App’x 61 (2d Cir. 2021)","Brownmark Films, L.L.C. v. Comedy Partners, 682 F.3d 687 (7th Cir. 2012)","Byrne v. BBC, 132 F. Supp. 2d 229 (S.D.N.Y. 2001)","CCA and B, LLC v. F + W Media, Inc., 819 F. Supp. 2d 1310 (Ν.D. Ga. 2011)","Cable/Home Commc’n Corp. v. Network Prods., Inc., 902 F.2d 829 (11th Cir. 1990)","Cambridge Univ. Press v. Becker, No. No. 1:08-cv-1425-ODE (N.D. Ga. Mar. 2, 2020)","Cambridge Univ. Press v. Patton, 769 F.3d 1232 (11th Cir. 2014)","Cambridge University Press v. Albert","Cambridge University Press v. Becker, 1:08-cv-01425-ODE (N.D. Ga. March 31, 2016)","Campbell v. Acuff-Rose Music, Inc., 510 U.S. 569 (1994)","Caner v. Autry, 16 F. Supp. 3d 689 (W.D. Va. 2014)","Capitol Records, LLC v. ReDigi Inc.","Cariou v. Prince, 714 F.3d 694 (2d Cir. 2013)","Castle Rock Entm’t, Inc. v. Carol Publ’g Grp., Inc., 150 F.3d 132 (2d Cir. 1998)","Castle v. Kingsport Publ’g Corp. 2:19-CV-00092-DCLC (E.D. Tenn. Dec. 14, 2020)","Chapman v. Maraj, No. 2:18-cv 09088-VAP-SS (C.D. Cal. Sept. 16, 2020)","Chi. Bd. of Educ. v. Substance, Inc., 354 F.3d 624 (7th Cir. 2003)","Clark v. Transportation Alternatives, Inc., 18 Civ. 9985 (VM) (S.D.N.Y. Mar. 18, 2019)","Clean Flicks of Colo., LLC v. Soderbergh, 433 F. Supp. 2d 1236 (D. Colo. 2006)","Code Revision Comm. v. Public.Resource.Org, Inc., No. 1:15-cv-02594-RWS (N.D. Ga. Mar. 23, 2017)","Columbia Pictures Indus., Inc. v. Miramax Films Corp., 11 F. Supp. 2d 1179 (C.D. Cal. 1998)","Comerica Bank &amp; Trust, N.A. v. Habib, No. 17-12418-LTS (D. Mass. Jan. 6, 2020)","Compaq Computer Corp. v. Ergonome, Inc., 387 F.3d 403 (5th Cir. 2004)","Consumers Union, Inc. v. Gen. Signal Corp., 724 F.2d 1044 (2d Cir. 1983)","Corbello v. DeVito, No. 2:08-cv-00867-RCJ-PAL (D. Nev. June 14, 2017)","DC Comics Inc. v. Reel Fantasy, Inc., 696 F.2d 24 (2d Cir. 1982)","DC Comics, Inc. v. Crazy Eddie, Inc., No. 79 Civ. 3786 (PNL) (S.D.N.Y. Aug. 3, 1979)","Dall. Cowboys Cheerleaders, Inc. v. Scoreboard Posters, Inc., 600 F.2d 1184 (5th Cir. 1979)","Davidson v. United States, No. 13-942C (Fed. Cl. June 29, 2018)","Davis v. Gap, Inc., 246 F.3d 152 (2d Cir. 2001)","De Fontbrune v. Wofsy, 39 F.4th 1214 (9th Cir. 2022)","Denison v. Larkin, 64 F. Supp. 3d 1127 (N.D. Ill. 2014)","Diamond v. Am-Law Publ’g Corp., 745 F.2d 142 (2d Cir. 1984)","Disney Enterprises, Inc. v. VidAngel, Inc., No. 2:16-CV-04109 (9th Cir. Aug. 24, 2017)","Disney Enters., Inc. v. VidAngel, Inc., No. 2:16-cv-004109-AB (C.D. Cal. Dec. 12, 2016)","Diversey v. Schmidly, 738 F.3d 1196 (10th Cir. 2013)","Dlugolecki v. Poppel, CV 18 3905 GW (GJSx) (C.D. Cal. Aug. 22, 2019)","Dominick Ranieri v. Adirondack Dev. Group LLC, No. 1.11-cv-1013-GTS-CFH (N.D.N.Y. Feb. 22, 2016)","Donald Graham v. Richard Prince, et al., No. 15-CV-10160 (S.D.N.Y. July 18, 2017)","Dow Jones &amp; Co. v. Brd. of Trade of Chi., 546 F. Supp. 113 (S.D.N.Y. 1982)","Dr. Seuss Enters., L.P. v. ComicMix LLC, 983 F.3d 443 (9th Cir. 2020)","Dr. Seuss Enters., L.P. v. Penguin Books USA, Inc., 109 F.3d 1394 (9th Cir. 1997)","Duffy v. Penguin Books USA, Inc., 4 F. Supp. 2d 268 (S.D.N.Y. 1998)","Easter Unlimited, Inc. v. Rozier, No. 18-cv-06637 (E.D.N.Y. Sep. 17, 2021)","Educ. Testing Servs. v. Katzman, 793 F.2d 533 (3d Cir. 1986)","Eisenschiml v. Fawcett Publ’ns, Inc., 246 F.2d 598 (7th Cir. 1957)","Elsmere Music, Inc. v. NBC, 482 F. Supp. 741 (S.D.N.Y. 1980)","Elvis Presley Enters., Inc. v. Passport Video, 349 F.3d 622 (9th Cir. 2003)","Encyclopedia Brittanica Educ. Corp. v. Crooks, 542 F. Supp. 1156 (W.D.N.Y. 1982)","Erika Peterman v. Republican National Committee, No. 17-66-M-DLC (D. Mont. March 19, 2018)","Estate of Anthony Barré and Angel Barré v. Carter, et al. No. 17-1057 (E.D. Lou. July 25, 2017)","Estate of James Oscar Smith v. Cash Money Records, Inc., et al., No. 1:14-cv-02703 (S.D.N.Y. May 30, 2017)","Faulkner Literary Rights, L.L.C. v. Sony Pictures Classics, Inc., 953 F. Supp. 2d 701 (N.D. Miss. 2013)","Ferdman v. CBS Interactive Inc.","Fin. Info., Inc. v. Moody’s Investor Serv., Inc., 751 F.2d 501 (2d Cir. 1984)","Fisher v. Dees, 794 F.2d 432 (9th Cir. 1986)","Fitzgerald v. CBS Broad., Inc., 491 F. Supp. 2d 177 (D. Mass. 2007)","Folsom v. Marsh, 9 F. Cas. 342 (C.C.D. Mass. 1841)","Fox Broad. Co. v. Dish Network, L.L.C., 723 F.3d 1067 (9th Cir. 2013)","Fox Broad. Co. v. Dish Network, LLC, No. 2:12-cv-04529-DMG-SH (C.D. Cal. Jan. 12, 2015)","Fox News Network, LLC v. TVEyes, Inc., Nos. 15-3885, 15-3886 (2d Cir. Feb. 27, 2018)","Friedman v. Guetta, No. CV 10-00014 DDP (JCx) (C.D. Cal. May 27, 2011)","Furie v. Infowars, LLC, Case No. 18-1830-MWF (JPRx) (C.D. Cal. May 16, 2019)","Galvin v. Ill. Republican Party, No. 1:14-cv-00490 (N.D. Ill. Sept. 9, 2015)","Gaylord v. United States, 595 F.3d 1364 (Fed. Cir. 2010)","Golden v. Michael Grecco Prods., No. 19-CV-3156 (NGG) (RER) (E.D.N.Y. Mar. 9, 2021)","Google LLC v. Oracle Am., Inc., 141 S. Ct. 1183 (2021)","H.C. Wainwright &amp; Co. v. Wall St. Transcript Corp., 418 F. Supp. 620 (S.D.N.Y. 1976), aff’d, 558 F.2d 91 (2d Cir. 1977), cert. denied, 434 U.S. 1014 (1978)","Haberman v. Hustler Magazine, Inc., 626 F. Supp. 201 (D. Mass. 1986)","Harper &amp; Row Publishers, Inc. v. Nation Enters., 471 U.S. 539 (1985)","Henley v. DeVore, 733 F. Supp. 2d 1144 (C.D. Cal. 2010)","Hofheinz v. Discovery Commc’ns, Inc., No. 00 CIV. 3802 (HB) (S.D.N.Y. Sep. 20, 2001)","Hosseinzadeh v. Klein, No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","House of Bryant Publ’ns, L.L.C. v. A&amp;E Television Networks, No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","Hustler Magazine, Inc. v. Moral Majority, Inc., 796 F.2d 1148 (9th Cir. 1986)","In re DMCA Subpoena to Reddit, Inc., No. 19-mc-80005-SK (JD) (N.D. Cal. Mar. 2, 2020)","Infinity Broad. Corp. v. Kirkwood, 150 F.3d 104 (2d Cir. 1998)","Int’l Code Council, Inc. v. UpCodes, Inc., 17 Civ. 6261 (VM) (S.D.N.Y. May 27, 2020)","Iowa State Univ. Research Found., Inc., v. Am. Broad. Cos., Inc., 621 F.2d 57 (2d Cir. 1980)","James Castle Collection and Archive, LP v. Scholastic, Inc. and Allen Say","Jartech, Inc. v. Clancy, 666 F.2d 403 (9th Cir. 1982)","Katz v. Google Inc., No. 14-14525 (11th Cir. Sept. 17, 2015)","Kelly v. Arriba Soft Corp., 336 F.3d 811 (9th Cir. 2003)","Kennedy v. Gish, Sherwood &amp; Friends, Inc., No. 4:13-cv-02236-JAR (E.D. Mo. Nov. 5, 2015)","Kienitz v. Sconnie Nation, LLC, 766 F.3d 756 (7th Cir. 2014)","L.A. News Serv. v. CBS Broad., Inc., 305 F.3d 924 (9th Cir. 2002)","L.A. News Serv. v. KCAL-TV Channel 9, 108 F.3d 1119 (9th Cir. 1997)","L.A. News Serv. v. Reuters Television Int'l, Ltd., 149 F.3d 987 (9th Cir. 1998)","L.A. News Serv. v. Tullo, 973 F.2d 791 (9th Cir. 1992)","Leadsinger, Inc. v. BMG Music Publ’g, 512 F.3d 522 (9th Cir. 2008)","Leibovitz v. Paramount Pictures Corp., 137 F.3d 109 (2d Cir. 1998)","Lennon v. Premise Media Corp., 556 F. Supp. 2d 310 (S.D.N.Y. 2008)","Lish v. Harper’s Magazine Found., 807 F. Supp. 1090 (S.D.N.Y. 1992)","Lucasfilm Ltd. LLC, et al. v. Ren Ventures Ltd., et al.","Lucent Info. Mgmt. v. Lucent Techs., Inc., 5 F. Supp. 2d 238 (D. Del. 1998)","MCA, Inc. v. Wilson, 677 F.2d 180 (2d Cir. 1981)","Marano v. Metro. Museum of Art, 844 F. App’x 436 (2d Cir. 2021)","Marcus v. Rowley, 695 F.2d 1171 (9th Cir. 1983)","MasterCard Int’l, Inc. v. Nader 2000 Primary Comm., Inc., No. 00 CIV. 3802 (HB) (S.D.N.Y. Mar. 8, 2004)","Mattel Inc. v. Walking Mountain Prods., 353 F.3d 792 (9th Cir. 2003)","Mattel, Inc. v. Entities Doing Bus. as Unicorn Element, 21 Civ. 2333 (VM) (S.D.N.Y. June 4, 2021)","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P., No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017)","Maxtone-Graham v. Burtchaell, 803 F.2d 1253 (2d Cir. 1986)","McGowan v. Cross, 991 F.2d 790, Nos. 92-1480, 92-1584 (4th Cir. Apr. 22, 1993)","McGucken v. Newsweek LLC, 19 Civ. 9617 (KPF) (S.D.N.Y. Mar. 21, 2020)","McGucken v. Pub Ocean Ltd., 2:20-cv-01923-RGK-AS (C.D. Cal. July 27, 2021)","Meeropol v. Nizer, 560 F.2d 1061 (2d Cir. 1977)","Merkos L’Inyonei Chinuch, Inc. v. Otsar Sifrei Lubavitch, Inc., 312 F.3d 94 (2d Cir. 2002)","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., 900 F. Supp. 1287 (C.D. Cal. 1995)","MidlevelU, Inc. v. ACI Info. Grp., 989 F.3d 1205 (11th Cir. 2021)","Monge v. Maya Magazines, Inc., 688 F.3d 1164 (9th Cir. 2012)","Monsarrat v. Newman, 28 F.4th 314 (1st Cir. 2022)","Monster Commc’ns, Inc. v. Turner Broad. Sys., Inc., 935 F. Supp. 490 (S.D.N.Y. 1996)","Morris v. Guetta, No. LA CV12-00684 JAK (RZX) (C.D. Cal. Feb. 4, 2013)","Murphy v. Millennium Radio Grp. L.L.C., 650 F.3d 295 (3d Cir. 2011)","N. Jersey Media Grp., Inc. v. Pirro, 74 F. Supp. 3d. 605 (S.D.N.Y. 2015)","N.Y. Times Co. v. Roxbury Data Interface, Inc., 434 F. Supp. 217 (D.N.J. 1977)","Narell v. Freeman, 872 F.2d 907 (9th Cir. 1989)","Nat'l Acad. of TV Arts &amp; Scis., Inc., v. Multimedia Sys. Design, Inc. No. 20-CV-7269 (VEC) (S.D.N.Y. July 30, 2021)","Nat’l Ctr. for Jewish Film v. Riverside Films, L.L.C., No. 5:12-cv-00044-ODW (DTB) (C.D. Cal. Sept. 14, 2012)","Nat’l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio, 15 F.3d 559 (6th Cir. 1994)","Neri v. Monroe, No. 11-cv-429-slc (W.D. Wis. Feb. 26, 2014)","New Era Publ’ns Int’l, ApS v. Carol Publ’g Grp., 904 F.2d 152 (2d Cir. 1990)","New Era Publ’ns Int’l, ApS v. Henry Holt &amp; Co., 873 F.2d 576 (2d Cir. 1989)","New Line Cinema Corp. v. Bertlesman Music Grp., Inc., 693 F. Supp. 1517 (S.D.N.Y. 1988)","Nihon Keizai Shimbun, Inc. v. Comline Bus. Data, Inc., 166 F.3d 65 (2d Cir. 1999)","Noland v. Janssen, No. 17-CV-5452 (S.D.N.Y. June 1, 2020)","Norse v. Henry Holt &amp; Co., 847 F. Supp. 142 (N.D. Cal. 1994)","Northland Family Planning Clinic, Inc. v. Crt. for Bio-Ethical Reform, 868 F. Supp. 2d 962 (C.D. Cal. 2012)","Nunez v. Caribbean Int’l News Corp., 235 F.3d 18 (1st Cir. 2000)","Otto v. Hearst Communications, Inc.","Oyewole v. Ora, 291 F. Supp. 3d 422 (S.D.N.Y. Mar. 8, 2018)","O’Neil v. Ratajkowski, No. 19 CIV. 9769 (AT) (S.D.N.Y. Sept. 28, 2021)","Pac. &amp; S. Co. v. Duncan, 744 F.2d 1490 (11th Cir. 1984)","Paramount Pictures, Corp. v. Axanar Prods., Inc., No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","Penguin Grp. (USA), Inc. v. Am. Buddha, No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","Penguin Random House v. Colting, No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","Perfect 10, Inc. v. Amazon.com, Inc., 508 F.3d 1146 (9th Cir. 2007)","Peter Letterese &amp; Assocs. v. World Inst. of Scientology Enters., 533 F.3d 1287 (11th Cir. 2008)","Peterman v. Republican National Committee, No. CV 17-66-M-DLC (D. Mont. Feb. 22, 2019)","Peteski Productions, Inc. v. Rothman, No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","Philpot v. Media Research Center Inc. No. 1:17-cv-822 (E.D. Va. Jan. 8, 2018)","Philpot v. WOS, Inc., No. 1:18-CV-339-RP (W.D. Tex. Apr. 22, 2019)","Princeton Univ. Press v. Mich. Document Servs., Inc., 99 F.3d 1381 (6th Cir. 1996)","Radji v. Khakbaz, 607 F. Supp. 1296 (D.D.C. 1985)","Red Label Music Publ’g v. Chila Prods., 18 C 7252 (N.D. Ill. May 30, 2019)","Reiner v. Nishimori, No. 3:15-cv-00241 (M.D. Tenn. Apr. 28, 2017)","Reyes v. Wyeth Pharm., Inc., 603 F. Supp. 2d 289 (D.P.R. 2009)","Richards v. Merriam Webster, Inc., 55 F. Supp. 205 (D. Mass. 2014)","Righthaven, L.L.C. v. Jama, No. 2:10-CV-1322 JCM (LRL) (D. Nev. Apr. 22, 2011)","Righthaven, L.L.C. v. Realty One Grp., Inc., No. 2:10-cv-1036-LRH-PAL. (D. Nev. Oct. 19, 2010)","Rimini St. v. Oracle Int’l Corp., 473 F. Supp. 3d 1158 (D. Nev. 2020)","Ringgold v. Black Entm’t Television, Inc., 126 F.3d 70 (2d Cir. 1997)","Robinson v. Random House, Inc., 877 F. Supp. 830 (S.D.N.Y. 1995)","Rogers v. Koons, 960 F.2d 301 (2d Cir. 1992)","Rosemont Enters., Inc. v. Random House, Inc., 366 F.2d 303 (2d Cir. 1966)","Rosen v. eBay, Inc., No. 2:13-cv-06801-MWF-E (C.D. Cal. Jan. 16, 2015)","Rotbart v. J.R. O’Dwyer Co., No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","Roy Exp. Co. Establishment of Vaduz, Liech. v. CBS, Inc., 672 F.2d 1095 (2d Cir. 1982)","Rubin v. Bos. Magazine Co., 645 F.2d 80 (1st Cir. 1981)","Russell Brammer v. Violent Hues Productions, LLC, No. 1-17-cv-01009 (E.D. Va. June 11, 2018)","SOFA Entm’t, Inc. v. Dodger Prods., Inc., 709 F.3d 1273 (9th Cir. 2013)","Salinger v. Colting, 607 F.3d 68 (2d Cir. 2010)","Salinger v. Random House, Inc., 811 F.2d 90 (2d Cir. 1987)","Schwartzwald v. Oath Inc. No. 19-CV-9938 (RA) (S.D.N.Y. Sept. 10, 2020)","Sedlik v. Von Drachenberg, No. CV 21-1102 (C.D. Cal. May 31, 2022)","Sega Enters. Ltd. v. Accolade, Inc., 977 F.2d 1510 (9th Cir. 1992)","Sega Enters. Ltd. v. MAPHIA, 948 F. Supp. 923 (N.D. Cal. 1996)","Seltzer v. Green Day, Inc., 725 F.3d 1170 (9th Cir. 2013)","Shirman v. WHEC-TV, LLC, 18-CV-6508-FPG, 2019 U.S. Dist. LEXIS 83767 (W.D.N.Y. May 17, 2019)","Sketchworks Indus. Strength Comedy, Inc. v. Jacobs, No. 19-CV-7470-LTS-VF (S.D.N.Y. May 12, 2022)","Soc’y of the Holy Transfiguration Monestary, Inc. v. Gregory, 689 F.3d 29 (1st Cir. 2012)","Solid Oak Sketches, LLC v. 2K Games, Inc., No. 16-cv-724-LTS-SDA (S.D.N.Y. Mar. 26, 2020)","Sony Computer Entm't. Inc. v. Connectix Corp., 203 F. 3d 596 (9th Cir. 2000)","Sony Computer Entm’t Am., Inc. v. Bleem, L.L.C., 214 F.3d 1022 (9th Cir. 2000)","Sony Corp. of Am. v. Universal City Studios, Inc., 464 U.S. 417 (1984)","Stewart v. Abend, 495 U.S. 207 (1990)","Sundeman v. Seajay Soc’y, Inc., 142 F.3d 194 (4th Cir. 1998)","Suntrust Bank v. Houghton Mifflin Co., 268 F.3d 1257 (11th Cir. 2001)","Supermarket of Homes, Inc. v. San Fernando Valley Bd. of Realtors, 786 F.2d 1400 (9th Cir. 1986)","Swatch Grp. Mgmt. Servs. Ltd. v. Bloomberg L.P., 742 F.3d 17 (2d Cir. 2014)","TCA Television Corp. v. McCollum, No. 1:16-cv-0134 (2d Cir. Oct. 11, 2016)","TD Bank, N.A. v. Hill, No. 12-7188 (RDK/JS), 2015 WL 4523570 (D. NJ July 27, 2015)","Tavory v. NTP, Inc., 495 F. Supp. 2d 531 (E.D. Va. 2007)","Television Digest, Inc. v. U.S. Tel. Ass’n, 841 F. Supp. 5 (D.D.C. 1993)","Tiffany Design, Inc. v. Reno-Tahoe Specialty, Inc., 55 F. Supp. 2d 1113 (D. Nev. 1999)","Toksvig v. Bruce Pub. Co., 181 F.2d 664 (7th Cir. 1950)","Tresóna Multimedia v. Burbank High School Vocal Music Ass’n, Nos. 17-56006, 17-56417, 17-56419 (9th Cir. Mar. 24, 2020)","Triangle Publ’ns, Inc. v. Knight-Ridder Newspapers, Inc., 626 F.2d 1171 (5th Cir. 1980)","Twin Peaks Prods., Inc. v. Publ’ns Int’l, Ltd., 996 F.2d 1366 (2d Cir. 1993)","Ty, Inc. v. Publ'ns Int'l, Ltd., 333 F. Supp. 2d 705 (N.D. Ill. 2004)","United States v. Am. Soc’y of Composers, Authors and Publishers, 599 F. Supp. 2d 415 (S.D.N.Y. 2009), vacated, 627 F.3d 64 (2d Cir. 2010)","United States v. Slater, 348 F.3d 666 (7th Cir. 2003)","VHT, Inc. v. Zillow Group, Nos. 17-35587, 17-35588 (9th Cir. Mar. 15, 2019)","Veeck v. S. Bldg. Code Cong. Int’l, 241 F.3d 398 (5th Cir. 2001)","Viacom Int’l v. Pixi Universal, Civ. Action No H-21-2612 (S.D. Tex. Mar. 25, 2022)","Video Pipeline, Inc. v. Buena Vista Home Entm’t, Inc., 342 F.3d 191 (3d Cir. 2003)","Wall Data, Inc. v. L.A. Cnty. Sheriff’s Dep’t, 447 F.3d 769 (9th Cir. 2006)","Walsh v. Townsquare Media, Inc., No. 19-CV-4958 (VSB) (S.D.N.Y. June 1, 2020)","Walt Disney Prods. v. Air Pirates, 581 F.2d 751 (9th Cir. 1978), cert. denied, 439 U.S. 1132 (1979)","Warner Bros. Entm’t, Inc. v. RDR Books, 575 F. Supp. 2d 513 (S.D.N.Y. 2008)","Warner Bros., Inc. v. Am. Broad. Cos., Inc., 654 F.2d 204 (2d Cir. 1981)","Warner Bros., Inc. v. Am. Broad. Cos., Inc., 720 F.2d 231 (2d Cir. 1983)","Warren Publ’g Co. v. Spurlock, 645 F. Supp. 2d 402 (E.D. Pa. 2009)","Weissmann v. Freeman, 868 F.2d 1313 (2d Cir. 1989)","White v. West Pub. Corp., No. 12-cv-1340-JSR (S.D.N.Y. Jul. 3, 2014)","Wihtol v. Crow, 309 F.2d 777 (8th Cir. 1962)","Wilen v. Alt. Media Net, Inc., No. 03CIV2524 (RMB) (JCF) (S.D.N.Y. Jan. 26, 2005)","Williams &amp; Wilkins Co. v. United States, 487 F.2d 1345 (Ct. Cl. 1973)","Wojnarowicz v. Am. Family Ass’n, 745 F. Supp. 130 (S.D.N.Y. 1990)","World Wrestling Fed’n Entm’t, Inc. v. Bozell, 142 F. Supp. 2d 514 (S.D.N.Y. 2001)","Worldwide Church of God v. Phila. Church of God, Inc., 227 F.3d 1110 (9th Cir. 2000)","Wright v. Warner Books, Inc., 953 F.2d 731 (2d Cir. 1991)","Yang v. Mic Network Inc., Nos. 20-4097-cv, 20-4201-cv (2d Cir. Mar. 29, 2022)","Zomba Enters., Inc. v. Panorama Records, Inc., 491 F.3d 574 (6th Cir. 2007)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"title","name":"title","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["A&amp;M Records, Inc. v. Napster, Inc.,","A.V. ex rel. Vanderhye v. iParadigms, L.L.C.,","Adjmi v. DLT Entm’t, Ltd.,","Am. Geophysical Union v. Texaco, Inc.,","Am. Inst. of Physics v. Schwegman, Lundberg &amp; Woessner, P.A.,","Am. Soc'y for Testing &amp; Materials v. Public.Resource.Org, Inc.","Andy Warhol Found. for the Visual Arts, Inc. v. Goldsmith","Apple Inc. v. Corellium, LLC","Arica Inst., Inc. v. Palmer,","Arrow Prods., Ltd. v. The Weinstein Co., LLC,","Associated Press v. Meltwater U.S. Holdings, Inc.,","Ass’n of Am. Med. Colls. v. Cuomo,","Ass’n of Am. Med. Colls. v. Mikaelian,","Atari Games Corp. v. Nintendo of Am. Inc.,","Authors Guild, Inc. v. Google Inc.,","Authors Guild, Inc. v. HathiTrust,","BMG Music v. Gonzalez,","BWP Media USA, Inc. v. Gossip Cop Media, Inc.","Bain v. Film Indep., Inc.","Balsley v. LFP, Inc.,","Baraban v. Time Warner, Inc.,","Barcroft Media, Ltd. V. Coed Media Group, LLC","Basic Books, Inc. v. Kinko’s Graphics Corp.,","Bell v. Eagle Mt. Saginaw Indep. Sch. Distr.","Bell v. Worthington City Sch. Dist.","Benny v. Loew's, Inc.,","Berlin v. E.C. Publ’ns, Inc.,","Bill Graham Archives v. Dorling Kindersley Ltd.,","Blackwell Publ’g, Inc. v. Excel Research Grp., LLC,","Blanch v. Koons,","Boesen v. United Sports Publs., Ltd.","Bond v. Blum,","Bouchat v. Balt. Ravens Ltd. P’ship,","Bouchat v. Balt. Ravens Ltd. P’ship,","Brammer v. Violent Hues Productions, LLC","Brewer v. Hustler Magazine, Inc.,","Brown v. Netflix, Inc.","Brownmark Films, LLC v. Comedy Partners,","Byrne v. BBC,","CCA and B, LLC v. F + W Media, Inc.,","Cable/Home Commc’n Corp. v. Network Prods., Inc.,","Cambridge University Press v. Becker","Cambridge Univ. Press v. Patton,","Cambridge University Press v. Albert","Cambridge University Press v. Mark P. Becker","Campbell v. Acuff-Rose Music, Inc.,","Caner v. Autry,","Capitol Records, LLC v. ReDigi Inc.","Cariou v. Prince,","Castle Rock Entm’t, Inc. v. Carol Publ. Group, Inc.,","Castle v. Kingsport Publ’g Corp.","Chapman v. Maraj","Chi. Bd. of Educ. v. Substance, Inc.,","Clark v. Transportation Alternatives, Inc.","Clean Flicks of Colo., LLC v. Soderbergh,","Code Revision Comm. v. Public.Resource.Org, Inc.","Columbia Pictures Indus., Inc. v. Miramax Films Corp.,","Comerica Bank &amp; Trust, N.A. v. Habib","Compaq Computer Corp. v. Ergonome, Inc.,","Consumers Union of U.S., Inc. v. Gen. Signal Corp.,","Corbello v. DeVito","DC Comics Inc. v. Reel Fantasy, Inc.,","DC Comics Inc. v. Crazy Eddie, Inc.,","Dall. Cowboys Cheerleaders, Inc. v. Scoreboard Posters, Inc.,","Davidson v. United States","Davis v. Gap, Inc.,","De Fontbrune v. Wofsy","Denison v. Larkin,","Diamond v. Am-Law Publ’g Corp.,","Disney Enterprises, Inc. v. VidAngel, Inc.","Disney Enters., Inc. v. VidAngel, Inc.","Diversey v. Schmidly,","Dlugolecki v. Poppel","Dominick Ranieri v. Adirondack Dev. Group LLC,","Donald Graham v. Richard Prince, et al.","Dow Jones &amp; Co., Inc. v. Bd. of Trade of the City of Chi.,","Dr. Seuss Enters., L.P. v. ComicMix LLC","Dr. Seuss Enters., LP v. Penguin Books USA, Inc.,","Duffy v. Penguin Books USA, Inc.,","Easter Unlimited, Inc. v. Rozier","Educ. Testing Serv. v. Katzman,","Eisenschiml v. Fawcett Publ’n, Inc.,","Elsmere Music, Inc. v. NBC,","Elvis Presley Enters., Inc. v. Passport Video,","Encyclopedia Brittanica Educ. Corp. v. Crooks,","Erika Peterman v. Republican National Committee","Estate of Anthony Barré and Angel Barré v. Carter, et al.","Estate of James Oscar Smith v. Cash Money Records, Inc., et al.","Faulkner Literary Rights, LLC v. Sony Pictures Classics, Inc.,","Ferdman v. CBS Interactive Inc.","Fin. Info., Inc. v. Moody’s Investor Serv., Inc.,","Fisher v. Dees,","Fitzgerald v. CBS Broad., Inc.,","Folsom v. Marsh,","Fox Broad. Co. v. Dish Network, LLC,","Fox Broad. Co. v. Dish Network, LLC,","Fox News Network, LLC v. TVEyes, Inc.","Friedman v. Guetta,","Furie v. Infowars, LLC","Galvin v. Ill. Republican Party","Gaylord v. United States,","Golden v. Michael Grecco Prods.","Google LLC v. Oracle Am., Inc.","H.C. Wainwright &amp; Co. v. Wall St. Transcript Corp.,","Haberman v. Hustler Magazine, Inc.,","Harper &amp; Row Publishers, Inc. v. Nation Enterprises,","Henley v. DeVore,","Hofheinz v. Discovery Commc’ns, Inc.,","Matt Hosseinzadeh v. Ethan Klein and Hila Klein","House of Bryant Publ’ns, L.L.C. v. A&amp;E Television Networks,","Hustler Magazine, Inc. v. Moral Majority, Inc.,","In re DMCA Subpoena to Reddit, Inc.","Infinity Broad. Corp. v. Kirkwood,","Int’l Code Council, Inc. v. UpCodes, Inc.","Iowa State Univ. Research Found., Inc., v. Am. Broad. Cos., Inc.,","James Castle Collection and Archive, LP v. Scholastic, Inc. and Allen Say","Jartech, Inc. v. Clancy,","Katz v. Google, Inc.","Kelly v. Arriba Soft Corp.,","Kennedy v. Gish, Sherwood &amp; Friends, Inc.,","Kienitz v. Sconnie Nation, LLC,","L.A. News Serv. v. CBS Broad., Inc.,","L.A. News Serv. v. KCAL-TV Channel 9,","L.A. News Serv. v. Reuters Television Int’l, Ltd.,","L.A. News Serv. v. Tullo,","Leadsinger, Inc. v. BMG Music Publ’g,","Leibovitz v. Paramount Pictures Corp.,","Lennon v. Premise Media Corp.,","Lish v. Harper’s Magazine Found.,","Lucasfilm Ltd. LLC, et al. v. Ren Ventures Ltd., et al.","Lucent Info. Mgmt. v. Lucent Techs., Inc.,","MCA, Inc. v. Wilson,","Marano v. Metro. Museum of Art","Marcus v. Rowley,","MasterCard Int’l, Inc. v. Nader 2000 Primary Comm., Inc.,","Mattel Inc. v. Walking Mountain Prods.,","Mattel, Inc. v. Entities Doing Bus. as Unicorn Element","Matthew Lombardo and Who’s Holiday LLC v. Dr. Seuss Enterprises, L.P.","Maxtone-Graham v. Burtchaell,","McGowan v. Cross,","McGucken v. Newsweek LLC","McGucken v. Pub Ocean Ltd.","Meeropol v. Nizer,","Merkos L’Inyonei Chinuch, Inc. v. Otsar Sifrei Lubavitch, Inc.,","Metro-Goldwyn-Mayer, Inc. v. Am. Honda Motor Co., Inc.,","MidlevelU, Inc. v. ACI Info. Grp.","Monge v. Maya Magazines, Inc.,","Monsarrat v. Newman","Monster Commc’ns, Inc. v. Turner Broad. Sys., Inc.,","Morris v. Guetta,","Murphy v. Millennium Radio Grp. L.L.C.,","N. Jersey Media Grp., Inc. v. Pirro","N.Y. Times Co. v. Roxbury Data Interface, Inc.,","Narell v. Freeman,","Nat'l Acad. of TV Arts &amp; Scis., Inc. v. Multimedia Sys. Design, Inc.","Nat’l Ctr. for Jewish Film v. Riverside Films, L.L.C.,","Nat'l Rifle Ass’n of Am. v. Handgun Control Fed’n of Ohio,","Neri v. Monroe,","New Era Publ’ns Int’l, ApS v. Carol Publ’g Grp.,","New Era Publ’ns Int’l, ApS v. Henry Holt &amp; Co.,","New Line Cinema Corp. v. Bertlesman Music Grp., Inc.,","Nihon Keizai Shimbun, Inc. v. Comline Bus. Data, Inc.,","Noland v. Janssen","Norse v. Henry Holt &amp; Co.,","Northland Family Planning Clinic, Inc. v. Ctr. for Bio-Ethical Reform,","Nunez v. Caribbean Int’l News Corp.,","Otto v. Hearst Communications, Inc.","Oyewole v. Ora","O’Neil v. Ratajkowski","Pac. &amp; S. Co. v. Duncan,","Paramount Pictures Corp. v. Axanar Prods., Inc.","Penguin Grp. (USA), Inc. v. Am. Buddha,","Penguin Random House LLC, et al. v. Frederik Colting and Melissa Medina, d/b/a Moppet Books","Perfect 10, Inc. v. Amazon.com, Inc.,","Peter Letterese &amp; Assocs. v. World Inst. of Scientology Enters.,","Peterman v. Republican National Committee","Peteski Productions, Inc. v. Leah Rothman","Philpot v. Media Research Center Inc.","Philpot v. WOS, Inc.","Princeton Univ. Press v. Mich. Document Servs., Inc.,","Radji v. Khakbaz,","Red Label Music Publ’g v. Chila Prods.","Reiner v. Nishimori","Reyes v. Wyeth Pharm., Inc.,","Richards v. Merriam Webster, Inc.,","Righthaven, L.L.C. v. Jama,","Righthaven, L.L.C. v. Realty One Grp., Inc.,","Rimini St. v. Oracle Int’l Corp.","Ringgold v. Black Entm’t Television, Inc.,","Robinson v. Random House, Inc.,","Rogers v. Koons,","Rosemont Enters., Inc. v. Random House, Inc.,","Rosen v. eBay, Inc.,","Rotbart v. J.R. O’Dwyer Co., Inc.,","Roy Exp. Co. Establishment of Vaduz, Liech. v. CBS, Inc.,","Rubin v. Bos. Magazine Co.,","Russell Brammer v. Violent Hues Productions, LLC","SOFA Entm’t, Inc. v. Dodger Prods., Inc.,","Salinger v. Colting,","Salinger v. Random House, Inc.,","Schwartzwald v. Oath Inc.","Sedlik v. Von Drachenberg","Sega Enters. Ltd. v. Accolade, Inc.,","Sega Enters. Ltd. v. MAPHIA,","Seltzer v. Green Day, Inc.,","Shirman v. WHEC-TV, LLC","Sketchworks Indus. Strength Comedy, Inc. v. Jacobs","Soc’y of the Holy Transfiguration Monestary, Inc. v. Gregory,","Solid Oak Sketches, LLC v. 2K Games, Inc.,","Sony Computer Entm’t, Inc. v. Connectix Corp.,","Sony Computer Entm’t Am., Inc. v. Bleem, L.L.C.,","Sony Corp. of Am. v. Universal City Studios, Inc.,","Stewart v. Abend,","Sundeman v. The Seajay Soc’y, Inc.,","Suntrust Bank v. Houghton Mifflin Co.,","Supermarket of Homes, Inc. v. San Fernando Valley Bd. of Realtors,","Swatch Grp. Mgmt. Servs. Ltd. v. Bloomberg L.P.,","TCA Television Corp. v. McCollum,","TD Bank, N.A. v. Hill","Tavory v. NTP, Inc.,","Television Digest, Inc. v. U.S. Tel. Ass’n,","Tiffany Design, Inc. v. Reno-Tahoe Specialty, Inc.,","Toksvig v. Bruce Pub. Co.,","Tresóna Multimedia, LLC v. Burbank High School Vocal Music Ass’n","Triangle Publ’ns, Inc. v. Knight-Ridder Newspapers, Inc.,","Twin Peaks Prods., Inc. v. Publ’ns Int’l, Ltd.,","Ty, Inc. v. Publ'ns Int'l, Ltd.,","United States v. Am. Soc’y of Composers, Authors and Publishers","United States v. Slater,","VHT, Inc. v. Zillow Group","Veeck v. S. Bldg. Code Congress Int’l,","Viacom Int’l v. Pixi Universal","Video Pipeline, Inc. v. Buena Vista Home Entm’t, Inc.,","Wall Data, Inc. v. L.A. Cnty. Sheriff’s Dep’t,","Walsh v. Townsquare Media, Inc.","Walt Disney Prods. v. Air Pirates,","Warner Bros. Entm’t, Inc. v. RDR Books,","Warner Bros., Inc. v. Am. Broad. Cos., Inc.,","Warner Bros., Inc. v. Am. Broad. Cos., Inc.,","Warren Publ’g Co. v. Spurlock,","Weissmann v. Freeman,","White v. West Pub. Corp.","Wihtol v. Crow,","Wilen v. Alt. Media Net, Inc.,","Williams &amp; Wilkins Co. v. United States,","Wojnarowicz v. Am. Family Ass’n,","World Wrestling Fed’n Entm’t, Inc. v. Bozell,","Worldwide Church of God v. Phila. Church of God, Inc.,","Wright v. Warner Books, Inc.,","Yang v. Mic Network Inc.","Zomba Enters., Inc. v. Panorama Records, Inc.,"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}},{"id":"case_number","name":"case_number","type":"character","style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","cell":["239 F.3d 1004 (9th Cir. 2001)","562 F.3d 630 (4th Cir. 2009)","No. 1:14-cv-00568-LAP (S.D.N.Y. Mar. 31, 2015)","60 F.3d 913 (2d Cir. 1995)","No. 0:12-cv-00528-RHK-JJK (D. Minn. July. 30, 2013)","No. 13-cv-1215 (TSC), 2022 U.S. Dist. LEXIS 60922 (D.D.C. Mar. 31, 2022)","19-2420-cv (2d Cir. Aug. 24, 2021)","Case No. 9:19-cv-81160-RS, 2020 U.S. Dist. LEXIS 249945 (S.D. Fla. Dec. 29, 2020)","970 F.2d 1067 (2d Cir. 1992)","44 F. Supp. 3d 359 (S.D.N.Y. 2014)","931 F. Supp. 2d 537 (S.D.N.Y. 2013)","928 F.2d 519 (2d Cir. 1991)","571 F. Supp. 144 (E.D. Pa. 1983)","975 F. 2d 832 (Fed. Cir. 1992)","No. 13-4829-cv (2d Cir. Oct. 16, 2015)","755 F.3d 87 (2d Cir. 2014)","430 F.3d 888 (7th Cir. 2005)","No. 13-cv-7574-KPF (S.D.N.Y. Jul. 20, 2016)","No. CV 18-4126 PA (JEMx), 2020 U.S. Dist. LEXIS 141859 (C.D. Cal. Aug. 6, 2020)","691 F.3d 747 (6th Cir. 2012)","No. 99 Civ. 1569-JSM (S.D.N.Y. April 6, 2000)","No. 16-CV-7634 (JMF) (S.D.N.Y. Nov. 2, 2017)","758 F. Supp. 1522 (S.D.N.Y. 1991)","27 F.4th 313 (5th Cir. 2022)","No. 2:18-cv-961, 2020 U.S. Dist. LEXIS 96464 (S.D. Ohio June 2, 2020)","239 F.2d 532 (9th Cir. 1956), aff’d by an equally divided court, 356 U.S. 43 (1958)","329 F.2d 541 (2d Cir. 1964)","448 F.3d 605 (2d Cir. 2006)","661 F. Supp. 2d 786 (E.D. Mich. 2009)","467 F.3d 244 (2d Cir. 2006)","No. 20-CV-1552 (ARR) (SIL), 2020 U.S. Dist. LEXIS 240935 (E.D.N.Y. Nov. 2, 2020), reconsideration denied by 2020 U.S. Dist. LEXIS 240935 (Dec. 22, 2020)","317 F.3d 385 (4th Cir. 2003), cert. denied 540 U.S. 820","619 F.3d 301 (4th Cir. 2010)","737 F.3d 932 (4th Cir. 2013)","No. 18-1763 (4th Cir. Apr. 26, 2019)","749 F.2d 527 (9th Cir. 1984)","855 F. App’x 61 (2d Cir. 2021)","682 F.3d 687 (7th Cir. 2012)","132 F. Supp. 2d 229 (S.D.N.Y. 2001)","819 F. Supp. 2d 1310 (N.D. Ga. 2011)","902 F.2d 829 (11th Cir. 1990)","No. 1:08-cv-1425-ODE, 2020 U.S. Dist. LEXIS 35134 (N.D. Ga. Mar. 2, 2020)","769 F.3d 1232 (11th Cir. 2014)","No. 16-15726 (11th Cir. Oct. 19, 2018)","No. 1:08-cv-01425-ODE (N.D. Ga. Mar. 31, 2016) appeal docketed, Aug. 26, 2016","510 U.S. 569 (1994)","16 F. Supp. 3d 689 (W.D. Va. 2014)","No. 16-2321 (2nd Cir. Dec. 12, 2018)","714 F.3d 694 (2d Cir. 2013) cert. denied 134 S. Ct. 618 (2013)","150 F.3d 132 (2d Cir. 1998)","2:19-CV-00092-DCLC, 2020 U.S. Dist. LEXIS 233919 (E.D. Tenn. Dec. 14, 2020)","No. 2:18-cv-09088-VAP-SS (C.D. Cal. Sept. 16, 2020)","354 F.3d 624 (7th Cir. 2003), cert. denied, 543 U.S. 816 (2004)","18 Civ. 9985 (VM) (S.D.N.Y. Mar. 18, 2019)","433 F. Supp. 2d 1236 (D. Colo. 2006)","No. 1:15-cv-02594-RWS (N.D. Ga. Mar. 23, 2017)","11 F. Supp. 2d 1179 (C.D. Cal. 1998)","No. 17-12418-LTS, 2020 U.S. Dist. LEXIS 1343 (D. Mass. Jan. 6, 2020)","387 F.3d 403 (5th Cir. 2004)","724 F.2d 1044 (2d Cir. 1983)","No. 2:08-cv-00867-RCJ-PAL (D. Nev. June 14, 2017)","696 F.2d 24 (2d Cir. 1982)","No. 79 Civ. 3786-PNL (S.D.N.Y. Aug. 3, 1979)","600 F.2d 1184 (5th Cir. 1979)","No. 13-942C (Fed. Cl. June 29, 2018)","246 F.3d 152 (2d Cir. 2001)","39 F.4th 1214 (9th Cir. 2022)","64 F. Supp. 3d (N.D. Ill. 2014)","745 F.2d 142 (2d Cir. 1984)","No. 2:16-CV-04109 (9th Cir. Aug. 24, 2017)","No. 2:16-cv-04109-AB (C.D. Cal. Dec. 12, 2016)","738 F.3d 1196 (10th Cir. 2013)","CV 18-3905-GW (GJSx), 2019 U.S. Dist. LEXIS 149404 (C.D. Cal. Aug. 22, 2019)","No. 1.11-cv-1013-GTS-CFH (N.D.N.Y. Feb. 22, 2016)","No. 15-CV-10160 (S.D.N.Y. July 18, 2017)","546 F. Supp. 113 (S.D.N.Y. 1982)","983 F.3d 443 (9th Cir. 2020)","109 F.3d 1394 (9th Cir. 1997)","4 F. Supp. 2d 268 (S.D.N.Y. 1998)","No. 18-cv-06637, 2021 U.S. Dist. LEXIS 184636 (E.D.N.Y. Sep. 17, 2021)","793 F.2d 533 (3d Cir. 1986), abrogated on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","246 F.2d 598 (7th Cir. 1957)","482 F. Supp. 741 (S.D.N.Y. 1980), aff’d, 623 F.2d 252 (2d. Cir. 1980) (per curiam)","349 F.3d 622 (9th Cir. 2003), overruled on other grounds by eBay, Inc. v. MercExchange, LLC, 547 U.S. 388 (2006)","542 F. Supp. 1156 (S.D.N.Y. 1982)","No. 17-66-M-DLC (D. Mont. March 19, 2018)","No. 17-1057 (E.D. Lou. July 25, 2017)","No. 1:14-cv-02703 (S.D.N.Y. May 30, 2017)","953 F. Supp. 2d 701 (N.D. Miss. 2013)","No. 17 Civ. 1317 (PGG) (S.D.N.Y. Sept. 24, 2018)","751 F.2d 501 (2d Cir. 1984)","794 F.2d 432 (9th Cir. 1986)","491 F. Supp. 2d 177 (D. Mass. 2007)","9 F. Cas. 342 (C.C.D. Mass. 1841)","723 F.3d 1067 (9th Cir. 2013) amended and reh’g en banc denied, 747 F.3d 1060 (9th Cir. 2014)","No. 2:12-cv-04529-DMG-SH (C.D. Cal. Jan. 12, 2015)","Nos. 15-3885, 15-3886 (2d Cir. Feb. 27, 2018)","No. CV 10-00014 DDP (JCx) (C.D. Cal. May 27, 2011)","Case No. CV 18-1830-MWF (JPRx) (C.D. Cal. May 16, 2019)","No. 1:14-cv-00490 (N.D. Ill. Sept. 9, 2015)","595 F.3d 1364 (Fed. Cir. 2010)","No. 19-CV-3156 (NGG) (RER), 2021 U.S. Dist. LEXIS 43701 (E.D.N.Y. Mar. 9, 2021)","141 S. Ct. 1183 (2021)","418 F. Supp. 620 (S.D.N.Y. 1976), aff’d 558 F.2d 91 (2d Cir. 1977), cert. denied, 434 U.S. 1014 (1978)","626 F. Supp. 201 (D. Mass. 1986)","471 U.S. 539 (1985)","733 F. Supp. 2d 1144 (C.D. Cal. 2010)","No. 00 CIV. 3802 (HB) (S.D.N.Y. Sep. 20, 2001)","No. 16-CV-3081 (S.D.N.Y. Aug. 23, 2017)","No. 3:09-0502 (M.D. Tenn. Oct. 30, 2009)","796 F.2d 1148 (9th Cir. 1986)","No. 19-mc-80005-SK (JD), 2020 U.S. Dist. LEXIS 37033 (N.D. Cal. Mar. 2, 2020)","150 F.3d 104 (2d Cir. 1998)","17 Civ. 6261 (VM), 2020 U.S. Dist. LEXIS 92324 (S.D.N.Y. May 27, 2020)","621 F.2d 57 (2d Cir. 1980)","No. 1:17-CV-00437-BLW (D. Idaho Oct. 30, 2017)","666 F.2d 403 (9th Cir. 1982)","No. 14-14525 (11th Cir. Sept. 17, 2015)","336 F.3d 811 (9th Cir. 2003)","No. 4:13-cv-02236-JAR (E.D. Mo. Nov. 5, 2015)","766 F.3d 756 (7th Cir. 2014) cert. denied 135 S. Ct. 1555 (2015)","305 F.3d 924 (9th Cir. 2002)","108 F.3d 1119 (9th Cir. 1997), cert. denied 522 U.S. 823 (1997)","149 F.3d 987 (9th Cir. 1998)","973 F.2d 791 (9th Cir. 1992)","512 F.3d 522 (9th Cir. 2008)","137 F.3d 109 (2d Cir. 1998)","556 F. Supp. 2d 310 (S.D.N.Y. 2008)","807 F. Supp. 1090 (S.D.N.Y. 1992)","No. 17-cv-07249-RS (N.D. Cal. June 29, 2018)","5 F. Supp. 2d 238 (D. Del. 1998)","677 F.2d 180 (2d Cir. 1981)","844 F. App’x 436 (2d Cir. 2021)","695 F.2d 1171 (9th Cir. 1983)","No. 00 CIV. 6068 (GBD) (S.D.N.Y. Mar. 8, 2004)","353 F.3d 792 (9th Cir. 2003)","21 Civ. 2333 (VM), 2021 U.S. Dist. LEXIS 106188 (S.D.N.Y. June 4, 2021)","No. 1:16-cv-09974-AKH (S.D.N.Y. Sept. 15, 2017) aff’d, No. 17-2952-cv, 2018 WL 3323476 (2d Cir. July 6, 2018)","803 F.2d 1253 (2d Cir. 1986)","991 F.2d 790, Nos. 92-1480, 92-1584 (4th Cir. Apr. 22, 1993)","19 Civ. 9617 (KPF), 2022 U.S. Dist. LEXIS 50231 (S.D.N.Y. Mar. 21, 2022)","2:20-cv-01923-RGK-AS, 2021 U.S. Dist. LEXIS 153361 (C.D. Cal. July 27, 2021)","560 F.2d 1061 (2d Cir. 1977)","312 F.3d 94 (2d Cir. 2002)","900 F. Supp. 1287 (C.D. Cal. 1995)","989 F.3d 1205 (11th Cir. 2021)","688 F.3d 1164 (9th Cir. 2012)","28 F.4th 314 (1st Cir. 2022)","935 F. Supp. 490 (S.D.N.Y. 1996)","No. LA CV12-00684 JAK (RZX) (C.D. Cal. Feb. 4, 2013)","650 F.3d 295 (3d Cir. 2011)","74 F. Supp. 3d 605 (S.D.N.Y. 2015)","434 F. Supp. 217 (D.N.J. 1977)","872 F.2d 907 (9th Cir. 1989)","No. 20-CV-7269 (VEC), 2021 U.S. Dist. LEXIS 142733 (S.D.N.Y. July 30, 2021)","No. 5:12-cv-00044-ODW (DTB) (C.D. Cal. Sept. 14, 2012)","15 F.3d 559 (6th Cir. 1994)","No. 11-cv-429-slc (W.D. Wis. Feb. 26, 2014)","904 F.2d 152 (2d Cir. 1990)","873 F.2d 576 (2d Cir. 1989)","693 F. Supp. 1517 (S.D.N.Y. 1988)","166 F.3d 65 (2d Cir. 1999)","No. 17-CV-5452, 2020 U.S. Dist. LEXIS 95454 (S.D.N.Y. June 1, 2020)","847 F. Supp. 142 (N.D. Cal. 1994)","868 F. Supp. 2d 962 (C.D. Cal. 2012)","235 F.3d 18 (1st Cir. 2000)","No. 1:17-cv-4712-GHW (S.D.N.Y. Dec. 10, 2018)","291 F. Supp. 3d 422 (S.D.N.Y. Mar. 8, 2018)","No. 19 CIV. 9769 (AT), 2021 WL 4443259 (S.D.N.Y. Sept. 28, 2021)","744 F.2d 1490 (11th Cir. 1984)","No. 2:15-cv-09938-RGK-E (C.D. Cal. Jan. 3, 2017)","No. 4:13-cv-02075-JGZ (D. Ariz. May 11, 2015)","No. 17-cv-386 (S.D.N.Y. Sept. 8, 2017)","508 F.3d 1146 (9th Cir. 2007)","533 F.3d 1287 (11th Cir. 2008)","No. CV 17-66-M-DLC (D. Mont. Feb. 22, 2019)","No. 5:17-CV-00122 (E.D. Tex. Aug. 30, 2017)","No. 1:17-cv-822 (E.D. Va. Jan. 8, 2018)","No. 1:18-CV-339-RP (W.D. Tex. Apr. 22, 2019)","99 F.3d 1381 (6th Cir. 1996)","607 F. Supp. 1296 (D.D.C. 1985)","18 C 7252, 2019 U.S. Dist. LEXIS 90159 (N.D. Ill. May 30, 2019)","No. 3:15-cv-00241 (M.D. Tenn. Apr. 28, 2017)","603 F. Supp. 2d 289 (D.P.R. 2009)","55 F. Supp. 205 (D. Mass. 2014)","No. 2:10-CV-1322 JCM (LRL) (D. Nev. Apr. 22, 2011)","No. 2:10-cv-1036-LRH-PAL. (D. Nev. Oct. 19, 2010)","473 F. Supp. 3d 1158 (D. Nev. 2020)","126 F.3d 70 (2d Cir. 1997)","877 F. Supp. 830 (S.D.N.Y. 1995)","960 F.2d 301 (2d Cir. 1992)","366 F.2d 303 (2d Cir. 1966)","No. 2:13-cv-06801-MWF-E (C.D. Cal. Jan. 16, 2015)","No. 94 Civ. 2091 (JSM) (S.D.N.Y. Feb. 7, 1995)","672 F.2d 1095 (2d Cir. 1982)","645 F.2d 80 (1st Cir. 1981)","No. 1-17-cv-01009 (E.D. Va. June 11, 2018)","709 F.3d 1273 (9th Cir. 2013)","607 F.3d 68 (2d Cir. 2010)","811 F.2d 90 (2d Cir. 1987)","No. 19-CV-9938 (RA), 2020 U.S. Dist. LEXIS 165641 (S.D.N.Y. Sept. 10, 2020)","No. CV 21-1102, 2022 WL 2784818 (C.D. Cal. May 31, 2022)","977 F.2d 1510 (9th Cir. 1992)","948 F. Supp. 923 (N.D. Cal. 1996)","725 F.3d 1170 (9th Cir. 2013)","18-CV-6508-FPG, 2019 U.S. Dist. LEXIS 83767 (W.D.N.Y. May 17, 2019)","No. 19-CV-7470-LTS-VF, 2022 U.S. Dist. LEXIS 86331 (S.D.N.Y. May 12, 2022)","689 F.3d 29 (1st Cir. 2012)","No. 16-CV-724-LTS-SDA, 2020 U.S. Dist. LEXIS 53287 (S.D.N.Y. Mar. 26, 2020)","203 F.3d 596 (9th Cir. 2000)","214 F.3d 1022 (9th Cir. 2000)","464 U.S. 417 (1984)","495 U.S. 207 (1990)","142 F.3d 194 (4th Cir. 1998)","268 F.3d 1257 (11th Cir. 2001)","786 F.2d 1400 (9th Cir. 1986)","742 F.3d 17 (2d Cir. 2014)","No. 1:16-cv-0134 (2d Cir. Oct. 11, 2016)","No. 1.12-cv-07188-RBK-JS (D. N.J. July 27, 2015)","495 F. Supp. 2d 531 (E.D. Va. 2007)","841 F. Supp. 5 (D.D.C. 1993)","55 F. Supp. 2d 1113 (D. Nev. 1999)","181 F.2d 664 (7th Cir. 1950)","Nos. 17-56006, 17-56417, 17-56419, 2020 U.S. App. LEXIS 9128 (9th Cir. Mar. 24, 2020)","626 F.2d 1171 (5th Cir. 1980)","996 F.2d 1366 (2d Cir. 1993)","333 F. Supp. 2d 705 (N.D. Ill. 2004)","599 F. Supp. 2d 415 (S.D.N.Y. 2009), vacated, 627 F.3d 64 (2d Cir. 2010)","348 F.3d 666 (7th Cir. 2003)","Nos. 17-35587, 17-35588 (9th Cir. Mar. 15, 2019)","241 F.3d 398 (5th Cir. 2001)","Civ. Action No H-21-2612, 2022 U.S. Dist. LEXIS 57400 (S.D. Tex. Mar. 25, 2022)","342 F.3d 191 (3d Cir. 2003)","447 F.3d 769 (9th Cir. 2006)","No. 19-CV-4958 (VSB), 2020 U.S. Dist. LEXIS 96090 (S.D.N.Y. June 1, 2020)","581 F.2d 751 (9th Cir. 1978), cert. denied, 439 U.S. 1132 (1979)","575 F. Supp. 2d 513 (S.D.N.Y. 2008)","654 F.2d 204 (2d Cir. 1981)","720 F.2d 231 (2d Cir. 1983)","645 F. Supp. 2d 402 (E.D. Pa. 2009)","868 F.2d 1313 (2d Cir. 1989)","No. 12-cv-1340-JSR (S.D.N.Y. Jul. 3, 2014)","309 F.2d 777 (8th Cir. 1962)","No. 03CIV2524 (RMB) (JCF) (S.D.N.Y. Jan. 26, 2005)","487 F.2d 1345 (Ct. Cl. 1973)","745 F. Supp. 130 (S.D.N.Y. 1990)","142 F. Supp. 2d 514 (S.D.N.Y. 2001)","227 F.3d 1110 (9th Cir. 2000)","953 F.2d 731 (2d Cir. 1991)","Nos. 20-4097-cv(L), 20-4201-cv (XAP), 2022 U.S. App. LEXIS 8195 (2d Cir. Mar. 29, 2022)","491 F.3d 574 (6th Cir. 2007)"],"html":true,"align":"left","headerStyle":{"font-weight":"normal"}}],"defaultPageSize":3,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"showSortable":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#f1f3f5","stripedColor":"rgba(128,128,128,0.05)","style":{"fontFamily":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"},"headerStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"}},"elementId":"ccqdsrgqzz","dataKey":"e2ca5e1827913a7fd0bcdc2865cb4f4b"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style","tag.attribs.columns.2.style"],"jsHooks":[]}</script>
</div>
</div>
</div>
<p>It looks like the matches are now correct.</p>
</section></section><section id="data-visualization" class="level1"><h1>Data visualization</h1>
<p>And now for a quick data viz showing the journey towards achieving 100% matches between the two data frames.</p>
<div class="cell">
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"method"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fuzzy joining"</span>, </span>
<span>                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fuzzy joining + \nstring cleaning"</span>, </span>
<span>                        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fuzzy joining + \nstring cleaning + \ncolumn binding"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"match_rate"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">37</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">251</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"class"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">method</span>, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">match_rate</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"identity"</span>, colour<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">match_rate</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, colour<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, vjust<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Method"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Match Rate"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Percentage of matches found between&lt;br&gt;&lt;span style='font-family:monospace;color:red'&gt;fair_use_cases&lt;/span&gt; and &lt;span style='font-family:monospace;color:red'&gt;fair_use_findings&lt;/span&gt;&lt;br&gt;by method(s) used"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggthemes</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/ggthemes/man/theme_fivethirtyeight.html">theme_fivethirtyeight</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gghighlight</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://yutannihilation.github.io/gghighlight/reference/gghighlight.html">gghighlight</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">class</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, unhighlighted_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey"</span>, colour<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>plot.title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtext</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>          plot.caption <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtext</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>label_key: method</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/31/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'social-image.png'</span>, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>


<!-- -->

</section> ]]></description>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/08/31/</guid>
  <pubDate>Thu, 31 Aug 2023 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/08/31/social-image.png" medium="image" type="image/png" height="72" width="144"/>
</item>
<item>
  <title>Using data normalization to better compare change over time in regions with different population sizes</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/08/25/</link>
  <description><![CDATA[ <p>For this post, I’ll be using the Week 34 <a href="https://github.com/rfordatascience/tidytuesday">Tidy Tuesday</a> dataset, which contains data on refugee movement around the world. I want to look at the change in refugee outflows over time in different nations, and see if I can identify countries with meaningfully large increases in refugee outflows.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/nset-ornl/wbstats">wbstats</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://yutannihilation.github.io/gghighlight/">gghighlight</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-08-22/population.csv'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<section id="data-cleaning" class="level1"><h1>Data cleaning</h1>
<p>First, some data cleaning.</p>
<p>To keep things simple, I’m only going to keep nations that had refugee data for all of the 13 years spanning 2010-2022.</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n_years <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_years</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_to_keep</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_to_keep</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span>,</span>
<span>         <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_iso</span>,</span>
<span>         <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>,</span>
<span>         <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">refugees</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_clean</span></span></code></pre></div>
</div>
</section><section id="normalization" class="level1"><h1>Normalization</h1>
<p>Next, to make comparisons between nations more apples-apples, I’m going to do some normalization.</p>
<p>I want to normalize in terms of population size and change over baseline.</p>
<p>First, I’ll fetch population data from World Bank using <code>wbstats</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/wbstats/man/wb_search.html">wb_search</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SP.POP.TOTL"</span>, fields<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'indicator_id'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  indicator_id indicator         indicator_desc                                 
  &lt;chr&gt;        &lt;chr&gt;             &lt;chr&gt;                                          
1 SP.POP.TOTL  Population, total Total population is based on the de facto defi…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pops</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/wbstats/man/wb_data.html">wb_data</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SP.POP.TOTL"</span>, start_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2010</span>, end_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iso3c</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">date</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SP.POP.TOTL"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SP.POP.TOTL"</span>,</span>
<span>         iso <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">iso3c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pops</span>, by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coo_iso'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'iso'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'year'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  coo_name               coo_iso  year refugees        pop
  &lt;chr&gt;                  &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
1 Afghanistan            AFG      2010        0   28189672
2 Iran (Islamic Rep. of) IRN      2010       30   75373855
3 Iraq                   IRQ      2010        6   31264875
4 Pakistan               PAK      2010     6398  194454498
5 Egypt                  EGY      2010        5   87252413
6 China                  CHN      2010        6 1337705000</code></pre>
</div>
</div>
<p>Next, I’ll compute a new variable: <code>refugees_per_1k_pop</code> that represents refugees leaving per 1000 persons in the original population. This is a good way to normalize, because we’d expect a larger count of refugees leaving from countries that had more people to begin with.</p>
<div class="cell">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_iso</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>refugees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">refugees</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>            pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pop</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>refugees_per_1k_pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">refugees</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pop</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
# Groups:   year, coo_name [6]
   year coo_name            coo_iso refugees      pop refugees_per_1k_pop
  &lt;dbl&gt; &lt;chr&gt;               &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;               &lt;dbl&gt;
1  2010 Afghanistan         AFG      3054699 28189672            108.    
2  2010 Albania             ALB        14771  2913021              5.07  
3  2010 Algeria             DZA         6665 35856344              0.186 
4  2010 Angola              AGO       134851 23364185              5.77  
5  2010 Antigua and Barbuda ATG           28    85695              0.327 
6  2010 Argentina           ARG          553 40788453              0.0136</code></pre>
</div>
</div>
<p>I’ll do a bit of cleaning again, to remove those nations for whom I didn’t have a complete record of population data, and so couldn’t calculate <code>refugees_per_1k_pop</code> for every year.</p>
<div class="cell">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n_years <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">refugees_per_1k_pop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, na.rm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n_years</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_to_keep_2</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_to_keep_2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span></span></code></pre></div>
</div>
<p>Next, I’ll use 2010 as a baseline year, and subtract each year’s value from that. This will allow me to measure change over time from this common baseline, and compare nations in terms of a normalized change.</p>
<div class="cell">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2010</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>baseline_refugees_per_1k_pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">refugees</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">pop</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_year</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_year</span>, by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coo_name'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>change_from_baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">refugees_per_1k_pop</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">baseline_refugees_per_1k_pop</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
# Groups:   year, coo_name [6]
   year coo_name            coo_iso refugees      pop refugees_per_1k_pop
  &lt;dbl&gt; &lt;chr&gt;               &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;               &lt;dbl&gt;
1  2010 Afghanistan         AFG      3054699 28189672            108.    
2  2010 Albania             ALB        14771  2913021              5.07  
3  2010 Algeria             DZA         6665 35856344              0.186 
4  2010 Angola              AGO       134851 23364185              5.77  
5  2010 Antigua and Barbuda ATG           28    85695              0.327 
6  2010 Argentina           ARG          553 40788453              0.0136
# ℹ 2 more variables: baseline_refugees_per_1k_pop &lt;dbl&gt;,
#   change_from_baseline &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="identifying-regions-of-interest" class="level1"><h1>Identifying regions of interest</h1>
<p>Next, I want to identify a smaller set of “interesting” COOs that have experienced large increases over the baseline. I’ll identify an upper bound percentile of max change over baseline, and then I’ll use a value that approximates that as a filter. This gives me 4 “interesting” nations.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>max_change_from_baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">change_from_baseline</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>p90_change <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">max_change_from_baseline</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.975</span>, na.rm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">T</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  p90_change
       &lt;dbl&gt;
1       30.0</code></pre>
</div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_iso</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>max_change_from_baseline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">change_from_baseline</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>            last_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/nth.html">last</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">change_from_baseline</span>, order_by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">max_change_from_baseline</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coos_with_large_changes_over_baseline</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'coo_name'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coos_with_large_changes_over_baseline</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   coo_name [4]
  coo_name             coo_iso max_change_from_baseline last_value
  &lt;chr&gt;                &lt;chr&gt;                      &lt;dbl&gt;      &lt;dbl&gt;
1 Central African Rep. CAF                         99.8       98.7
2 Eritrea              ERI                         76.9       67.3
3 Syrian Arab Rep.     SYR                        343.       295. 
4 Ukraine              UKR                        149.       149. </code></pre>
</div>
</div>
</section><section id="data-visualization" class="level1"><h1>Data visualization</h1>
<p>Finally, I’ll plot change over the 2010 baseline (in refugees per 1k population), and highlight the 4 interesting nations identified above.</p>
<p>I’ll use this to help me pick colors for the <code>ggtitle</code> text.</p>
<div class="cell">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scales</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://scales.r-lib.org/reference/show_col.html">show_col</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scales</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://scales.r-lib.org/reference/hue_pal.html">hue_pal</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/25/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_enriched_clean</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>class <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coos_with_large_changes_over_baseline</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_name</span>,</span>
<span>         year <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-01-01'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">class</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>coo_iso <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_inorder</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_iso</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">year</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">change_from_baseline</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">coo_iso</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>date_labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%Y"</span>, date_breaks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1 year"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggthemes</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/ggthemes/man/theme_solarized.html">theme_solarized</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gghighlight</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://yutannihilation.github.io/gghighlight/reference/gghighlight.html">gghighlight</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">class</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;strong&gt;&lt;span style='color:#00BFC4'&gt;SYR&lt;/span&gt;&lt;/strong&gt;, &lt;strong&gt;&lt;span style='color:#C77CFF'&gt;UKR&lt;/span&gt;&lt;/strong&gt;, &lt;strong&gt;&lt;span style='color:#F8766D'&gt;CAF&lt;/span&gt;&lt;/strong&gt;, and &lt;strong&gt;&lt;span style='color:#7CAE00'&gt;ERI&lt;/span&gt;&lt;/strong&gt; experienced large increases in&lt;br&gt;normalized refugee outflow (i.e., refugees per 1k population),&lt;br&gt; compared to their 2010 baseline."</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Year'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Change in Normalized Refugee Outflow*'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>caption <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;span style='font-size:7pt'&gt;*Change in refugees per 1k population from the baseline value observed in 2010.&lt;/span&gt;"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>plot.title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtext</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>          plot.caption <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtext</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">plot</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Tried to calculate with group_by(), but the calculation failed.
Falling back to ungrouped filter operation...</code></pre>
</div>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">plot</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/25/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


<!-- -->

</section> ]]></description>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/08/25/</guid>
  <pubDate>Fri, 25 Aug 2023 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/08/25/social-image.png" medium="image" type="image/png" height="75" width="144"/>
</item>
<item>
  <title>Building a prediction model to detect spam email</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2023/08/19/</link>
  <description><![CDATA[ <p>Getting back into the swing of things. This is my first blog post in more than 3 years!</p>
<p>For this post, I’ll be using the Week 33 <a href="https://github.com/rfordatascience/tidytuesday">Tidy Tuesday</a> dataset. This one is all about spam email.</p>
<p>From the <a href="https://vincentarelbundock.github.io/Rdatasets/doc/DAAG/spam7.html">dataset description</a>:</p>
<blockquote class="blockquote">
<p>The data consist of 4601 email items, of which 1813 items were identified as spam. This is a subset of the full dataset, with six only of the 57 explanatory variables in the complete dataset.</p>
</blockquote>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/taiyun/corrplot">corrplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://usemodels.tidymodels.org/">usemodels</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://future.futureverse.org">future</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://github.com/bethatkinson/rpart">rpart</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="http://www.milbo.org/rpart-plot/index.html">rpart.plot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">knitr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html">opts_chunk</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>echo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, fig.width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>, fig.height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<section id="load-data" class="level1"><h1>Load data</h1>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readr</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2023/2023-08-15/spam.csv'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>yesno <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
</section><section id="data-dictionary" class="level1"><h1>Data dictionary</h1>
<pre><code>variable    class         description
crl.tot     double        Total length of uninterrupted sequences of capitals
dollar      double        Occurrences of the dollar sign, as percent of total number of characters
bang        double        Occurrences of ‘!’, as percent of total number of characters
money       double        Occurrences of ‘money’, as percent of total number of characters
n000        double        Occurrences of the string ‘000’, as percent of total number of words
make        double        Occurrences of ‘make’, as a percent of total number of words
yesno       character     Outcome variable, a factor with levels 'n' not spam, 'y' spam</code></pre>
<p>The outcome variable is <code>yesno</code>, a character type, and all of the other variables are of a numeric type.</p>
<p>We can see that a lot of the feature engineering has already been done. It seems that whoever prepared this dataset has determined that spam emails can be meaningfully identified by:</p>
<ul>
<li>SHOUTING! (<code>crl.tot</code>, <code>bang</code>)</li>
<li>and talk of making money (<code>make</code>, <code>money</code>, <code>dollar</code>) at values of 1,000 or greater (<code>n000</code>)</li>
</ul>
<p>That definitely matches my experience reading spam!</p>
</section><section id="what-can-we-do-with-this-data" class="level1"><h1>What can we do with this data?</h1>
<p>What can we do with this data? Because this data has “ground truth” labels that tell us which emails were spam or not (<code>yesno</code>), and a list of features associated with each email, we can approach this as a supervised ML problem. We can use supervised ML to predict spam, to create a spam filter, for example.</p>
</section><section id="supervised-ml-predicting-spam-spam-filter" class="level1"><h1>Supervised ML: Predicting spam / spam filter</h1>
<section id="average-values-by-spam" class="level2"><h2 class="anchored" data-anchor-id="average-values-by-spam">Average values, by spam</h2>
<p>Let’s start by looking at some averages (mean and median), split by the outcome variable.</p>
<div class="cell">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">mean</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  yesno crl.tot dollar  bang  money    n000   make
  &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 TRUE     471. 0.174  0.514 0.213  0.247   0.152 
2 FALSE    161. 0.0116 0.110 0.0171 0.00709 0.0735</code></pre>
</div>
</div>
<p>We can see that on average, spam emails have higher mean values for each of the predictors. No surprise there.</p>
<p>However, the medians of some variables are zero, which suggests those variables have heavily positively skewed distributions with many zero values (sometimes called “zero-inflation”).</p>
<div class="cell">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">median</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  yesno crl.tot dollar  bang money  n000  make
  &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 TRUE      194   0.08 0.331     0     0     0
2 FALSE      54   0    0         0     0     0</code></pre>
</div>
</div>
<p>We can confirm this by looking at the counts of zero values, in relation to the total counts.</p>
<p>As we see, the vast majority of the spam emails had non-zero values on these variables, and non-spam emails had significantly fewer non-zero values, with the exception of <code>crl.tot</code>. In particular, spam emails were MUCH more likely to contain “!”, “$”, “000”, and “money”.</p>
<div class="cell">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">no</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yes</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">no</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">no</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>crl.tot  dollar    bang   money    n000    make 
    100      10      27       2       3      15 </code></pre>
</div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yes</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yes</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>crl.tot  dollar    bang   money    n000    make 
    100      61      83      38      33      35 </code></pre>
</div>
</div>
</section><section id="distributions-by-spam" class="level2"><h2 class="anchored" data-anchor-id="distributions-by-spam">Distributions, by spam</h2>
<p>Next, let’s look at the distributions.</p>
<p>For these plots, since they all have extreme skew, I’m going to truncate them at the 90th percentile and look at the left side where most of the mass is.</p>
<div class="cell">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'crl.tot'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dollar'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bang'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'money'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n000'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'make'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">qtile_90</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[[</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.90</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">qtile_90</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.7</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span>      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">c</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">plot</span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">plot</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>  </span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-6-3.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-6-4.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-6-5.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-6-6.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
</section><section id="feature-correlations" class="level2"><h2 class="anchored" data-anchor-id="feature-correlations">Feature correlations</h2>
<p>It doesn’t look like the features are very strongly correlated. The strongest correlation is between <code>n000</code> and <code>dollar</code>, which is not particularly surprising since I would expect that “000” would tend to appear in the context of a dollar value like “$1000”.</p>
<div class="cell">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>use <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete.obs"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           crl.tot    dollar       bang      money       n000       make
crl.tot 1.00000000 0.2019477 0.03632120 0.08099318 0.16597657 0.08916478
dollar  0.20194768 1.0000000 0.14291296 0.10469131 0.31097072 0.11741853
bang    0.03632120 0.1429130 1.00000000 0.05107591 0.07010334 0.05829200
money   0.08099318 0.1046913 0.05107591 1.00000000 0.05258693 0.18815518
n000    0.16597657 0.3109707 0.07010334 0.05258693 1.00000000 0.13407211
make    0.08916478 0.1174185 0.05829200 0.18815518 0.13407211 1.00000000</code></pre>
</div>
</div>
<p>If we convert the features to boolean, we can see that the presence of features have stronger correlations. The strongest correlation is again between <code>dollar</code> and <code>n000</code>, but <code>money</code> and <code>dollar</code> also occur together more often than not.</p>
<div class="cell">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">crl.tot</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>dollar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">dollar</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span>         bang <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">bang</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span>         money <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">money</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span>         n000 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span>         make <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">make</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>use <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"complete.obs"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          dollar      bang     money      n000      make
dollar 1.0000000 0.3779057 0.5058803 0.5372603 0.4133374
bang   0.3779057 1.0000000 0.3290505 0.3404896 0.2641339
money  0.5058803 0.3290505 1.0000000 0.4140177 0.4092119
n000   0.5372603 0.3404896 0.4140177 1.0000000 0.3757565
make   0.4133374 0.2641339 0.4092119 0.3757565 1.0000000</code></pre>
</div>
</div>
</section><section id="simple-classification-algorithm" class="level2"><h2 class="anchored" data-anchor-id="simple-classification-algorithm">Simple classification algorithm</h2>
<p>Just for fun, let’s see how well we can distinguish spam vs.&nbsp;not spam using a simple heuristic.</p>
<p>I’ll label anything as spam if it contained at least 1 “money”, “$”, “000”, and “!” OR if it contained more than 100 uninterrupted sequences of capital letters and at least 1 “!”. This is just what comes to mind after looking at the frequency plots above.</p>
<div class="cell">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>simple_spam_flag <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">money</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">dollar</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">bang</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">n000</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> </span>
<span>                                     <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">crl.tot</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">bang</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, </span>
<span>                                   levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span>         <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_flag</span></span></code></pre></div>
</div>
<p>This simple classification algorithm achieved an accuracy of 79%, with 64% sensitivity and 89% specificity. This doesn’t seem too bad. But what is a good baseline of performance?</p>
<div class="cell">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_flag</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">simple_spam_flag</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_flag</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span>, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'everything'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction TRUE FALSE
     TRUE  1172   309
     FALSE  641  2479
                                          
               Accuracy : 0.7935          
                 95% CI : (0.7815, 0.8051)
    No Information Rate : 0.606           
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.5533          
                                          
 Mcnemar's Test P-Value : &lt; 2.2e-16       
                                          
            Sensitivity : 0.6464          
            Specificity : 0.8892          
         Pos Pred Value : 0.7914          
         Neg Pred Value : 0.7946          
              Precision : 0.7914          
                 Recall : 0.6464          
                     F1 : 0.7116          
             Prevalence : 0.3940          
         Detection Rate : 0.2547          
   Detection Prevalence : 0.3219          
      Balanced Accuracy : 0.7678          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
</div>
</div>
<p>We can see that the base rate of spam is 39%.</p>
<div class="cell">
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3940448</code></pre>
</div>
</div>
<p>A good baseline model might be to predict the majority class, which in this case is not-spam.</p>
<p>This “always predict FALSE” baseline model can be expected to achieve 1 minus the base rate of spam (i.e., 61%), and we can see that this is the case if we construct just such a model. This tells us that the heuristic model above is quite a bit better than a completely naive model.</p>
<div class="cell">
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'FALSE'</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_flag</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df_flag</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span>, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'everything'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in confusionMatrix.default(factor(rep("FALSE", nrow(df_flag))), :
Levels are not in the same order for reference and data. Refactoring data to
match.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction TRUE FALSE
     TRUE     0     0
     FALSE 1813  2788
                                          
               Accuracy : 0.606           
                 95% CI : (0.5917, 0.6201)
    No Information Rate : 0.606           
    P-Value [Acc &gt; NIR] : 0.5064          
                                          
                  Kappa : 0               
                                          
 Mcnemar's Test P-Value : &lt;2e-16          
                                          
            Sensitivity : 0.000           
            Specificity : 1.000           
         Pos Pred Value :   NaN           
         Neg Pred Value : 0.606           
              Precision :    NA           
                 Recall : 0.000           
                     F1 :    NA           
             Prevalence : 0.394           
         Detection Rate : 0.000           
   Detection Prevalence : 0.000           
      Balanced Accuracy : 0.500           
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
</div>
</div>
</section><section id="decision-tree" class="level2"><h2 class="anchored" data-anchor-id="decision-tree">Decision Tree</h2>
<p>Proceeding from simpler to more complex, we can go a step further and try fitting a decision tree model. The decision tree will help us to identify a more sophisticated rule set for classifying spam mail. Decision trees also have the advantage of being highly interpretable.</p>
<p>We’ll start by splitting our data into training and test – that way, we won’t be testing performance on the same data that our model was trained on, and we can minimize the risk of overfitting.</p>
<div class="cell">
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial_split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">training</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">testing</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<p>Next, we’ll fit the model and then visualize its logic.</p>
<p>We can read this chart by starting at the root node and following the branches until we reach a terminal node. The predicted value at this terminal node will give us the prediction that the model has made, and the path that we followed to get there provides its reasoning for the prediction.</p>
<p>So for example, if we follow the tree to the left-most terminal node, we can see that it would predict that an email was spam if it contained <code>dollar &gt;= 0.056</code>. If we follow the tree to the right-most terminal, we can see that it would predict that an email was not spam if it contained <code>dollar &lt; 0.056</code> and <code>bang &gt;= 0.12</code>. The percentage value in the node tells us what percentage of emails met these criteria. So 24% of emails met the former criteria, and 54% the latter.</p>
<div class="cell">
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">decision_tree</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/rpart/man/rpart.html">rpart</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'class'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">decision_tree</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 3450 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

 1) root 3450 1358 FALSE (0.3936232 0.6063768)  
   2) dollar&gt;=0.0555 839   94 TRUE (0.8879619 0.1120381) *
   3) dollar&lt; 0.0555 2611  613 FALSE (0.2347759 0.7652241)  
     6) bang&gt;=0.1205 739  330 TRUE (0.5534506 0.4465494)  
      12) crl.tot&gt;=80.5 361   75 TRUE (0.7922438 0.2077562) *
      13) crl.tot&lt; 80.5 378  123 FALSE (0.3253968 0.6746032)  
        26) bang&gt;=0.802 85   34 TRUE (0.6000000 0.4000000) *
        27) bang&lt; 0.802 293   72 FALSE (0.2457338 0.7542662) *
     7) bang&lt; 0.1205 1872  204 FALSE (0.1089744 0.8910256) *</code></pre>
</div>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">decision_tree</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="https://tylerburleigh.com/blog/2023/08/19/index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="432"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can test the model on the out-of-sample test dataset and see how it performs.</p>
<p>Overall it achieved an accuracy of 85%, with 78% sensitivity and 89% specificity. This model has similar specificity as the heuristic model, but better sensitivity, and therefore better overall accuracy.</p>
<div class="cell">
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_pred</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">decision_tree</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span>, type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'class'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test_pred</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span>, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'everything'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction TRUE FALSE
     TRUE   355    77
     FALSE  100   619
                                          
               Accuracy : 0.8462          
                 95% CI : (0.8241, 0.8666)
    No Information Rate : 0.6047          
    P-Value [Acc &gt; NIR] : &lt;2e-16          
                                          
                  Kappa : 0.6755          
                                          
 Mcnemar's Test P-Value : 0.0982          
                                          
            Sensitivity : 0.7802          
            Specificity : 0.8894          
         Pos Pred Value : 0.8218          
         Neg Pred Value : 0.8609          
              Precision : 0.8218          
                 Recall : 0.7802          
                     F1 : 0.8005          
             Prevalence : 0.3953          
         Detection Rate : 0.3084          
   Detection Prevalence : 0.3753          
      Balanced Accuracy : 0.8348          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
</div>
</div>
</section><section id="random-forest" class="level2"><h2 class="anchored" data-anchor-id="random-forest">Random forest</h2>
<p>Next, we’ll try a random forest model. Random forest models tend to perform better than decision trees, due to the fact that they are ensemble decision trees, meaning they group together the decisions of lots of decision trees. But as a result, they tend to be less interpretable. So if our goal was only to create the most accurate prediction model possible, then a random forest would be better suited to the task.</p>
<div class="cell">
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cv</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vfold_cv</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<p>I’ll use <code><a href="https://usemodels.tidymodels.org/reference/templates.html">usemodels::use_ranger</a></code> to give me a starting template.</p>
<div class="cell">
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://usemodels.tidymodels.org/reference/templates.html">use_ranger</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">train</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ranger_recipe &lt;- 
  recipe(formula = yesno ~ ., data = train) 

ranger_spec &lt;- 
  rand_forest(mtry = tune(), min_n = tune(), trees = 1000) %&gt;% 
  set_mode("classification") %&gt;% 
  set_engine("ranger") 

ranger_workflow &lt;- 
  workflow() %&gt;% 
  add_recipe(ranger_recipe) %&gt;% 
  add_model(ranger_spec) 

set.seed(17214)
ranger_tune &lt;-
  tune_grid(ranger_workflow, resamples = stop("add your rsample object"), grid = stop("add number of candidate points"))</code></pre>
</div>
</div>
<p>I’ll remove the parameter tuning to keep things simple.</p>
<div class="cell">
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_recipe</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>formula <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.</span>, data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">df</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_spec</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand_forest</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>trees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_mode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"classification"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_engine</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ranger"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_workflow</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_recipe</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_model</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_spec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> </span></code></pre></div>
</div>
<p>Next, I’ll fit the model using a resampling approach.</p>
<div class="cell">
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">multisession</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_rf</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fit_resamples</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span></span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_workflow</span>,</span>
<span>  <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">cv</span>,</span>
<span>  metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metric_set</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">accuracy</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">sens</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">spec</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>,</span>
<span>  control <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">control_resamples</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>verbose <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span>                              save_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span>                              extract <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
</div>
<p>Overall, accuracy is pretty good: 89% accuracy, 79% sensitivity, and 95% specificity.</p>
<div class="cell">
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">fit_rf</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  .metric  .estimator  mean     n std_err .config             
  &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 accuracy binary     0.886    10 0.00497 Preprocessor1_Model1
2 sens     binary     0.793    10 0.00797 Preprocessor1_Model1
3 spec     binary     0.946    10 0.00523 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Next, we can check the performance on the test set.</p>
<p>We can use <code>collect_metrics()</code> function on the last fit.</p>
<div class="cell">
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_workflow</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">last_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect_metrics</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric  .estimator .estimate .config             
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy binary         0.888 Preprocessor1_Model1
2 roc_auc  binary         0.930 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Or we can use <code><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix()</a></code> to get a bit more information.</p>
<p>Performance on the test set is similar to the training performance. Overall, accuracy is pretty good – and better than the decision tree. For a spam detection filter, we’d want to bias towards minimizing false positives (it would arguably be worse for people to lose legitimate mail to the filter, than to have spam mail slip through), and here we see that the specificity was quite good at ~95%.</p>
<div class="cell">
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">ranger_workflow</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">last_fit</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">split</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract_workflow</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">final_model</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">confusionMatrix</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">final_model</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">.pred_class</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">test</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">yesno</span>, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'everything'</span>, positive<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TRUE'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction TRUE FALSE
     TRUE   362    34
     FALSE   93   662
                                          
               Accuracy : 0.8897          
                 95% CI : (0.8701, 0.9072)
    No Information Rate : 0.6047          
    P-Value [Acc &gt; NIR] : &lt; 2.2e-16       
                                          
                  Kappa : 0.7639          
                                          
 Mcnemar's Test P-Value : 2.652e-07       
                                          
            Sensitivity : 0.7956          
            Specificity : 0.9511          
         Pos Pred Value : 0.9141          
         Neg Pred Value : 0.8768          
              Precision : 0.9141          
                 Recall : 0.7956          
                     F1 : 0.8508          
             Prevalence : 0.3953          
         Detection Rate : 0.3145          
   Detection Prevalence : 0.3440          
      Balanced Accuracy : 0.8734          
                                          
       'Positive' Class : TRUE            
                                          </code></pre>
</div>
</div>


<!-- -->

</section></section> ]]></description>
  <category>machine-learning</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2023/08/19/</guid>
  <pubDate>Sat, 19 Aug 2023 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2023/08/19/social-image.png" medium="image" type="image/png" height="80" width="144"/>
</item>
<item>
  <title>Modeling cognitive impairment using NHANES data</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2020/05/12/</link>
  <description><![CDATA[ 





<p>In this blog post, I build a machine learning model to predict possible cases of cognitive impairment / dementia in a population of individuals over the age of 60. My data for this model comes from the 2013-2014 NHANES (National Health and Nutrition Examination Survey) study cohort, which is a nationally representative, longitudinal study of health in the US.</p>
<p>As an outcome measure, I’ll create a composite index of cognition by combining data from the Animal Fluency and Digit Symbol Substitution tasks. As predictors of this outcome, I’ll pull together variables that seem relevant to predicting dementia at a population level. For example, variables like age, race, gender, BMI, depression symptoms, alcohol use, blood lead levels, etc.</p>
<p>I’ll use xgboost to train the model, and I’ll walk through a hypothetical use-case for the model, discussing what might be the appropriate model bias (e.g., specificity/recall).</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> wget</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span></code></pre></div>
<p>The data is obtained from the <a href="https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Questionnaire&amp;CycleBeginYear=2013">NHANES website</a>, for the 2013-2014 study cohort.</p>
<p>Data files are converted from XPT to CSV.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Base path for downloading</span></span>
<span id="cb2-2">base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/'</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Files to download</span></span>
<span id="cb2-5">files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DEMO_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFQ_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COT_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BPX_H.XPT'</span>,</span>
<span id="cb2-6">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BMX_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MGX_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSX_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'HSQ_H.XPT'</span>,</span>
<span id="cb2-7">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DIQ_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ALQ_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SLQ_H.XPT'</span>,</span>
<span id="cb2-8">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'VID_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'VITB12_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DBQ_H.XPT'</span>,</span>
<span id="cb2-9">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PBCD_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BIOPRO_H.XPT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'INQ_H.XPT'</span>]</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> files:</span>
<span id="cb2-12">    xpt_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span></span>
<span id="cb2-13">    csv_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xpt_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.csv'</span></span>
<span id="cb2-14">    wget.download(base <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>, xpt_file)</span>
<span id="cb2-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>xport $xpt_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> $csv_file</span></code></pre></div>
<pre><code>100% [..........................................................................] 1223920 / 1223920</code></pre>
<p>Read the files into a single dataframe by joining on participant ID (<code>SEQN</code>).</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read first file</span></span>
<span id="cb4-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/DEMO_H.XPT.csv'</span>)</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop through remaining files and join together</span></span>
<span id="cb4-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> files[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]:</span>
<span id="cb4-6">    tmp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.csv'</span>)</span>
<span id="cb4-7">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.join(tmp.set_index(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SEQN'</span>), on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SEQN'</span>)</span>
<span id="cb4-8">    </span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drop duplicates by SEQN</span></span>
<span id="cb4-10">df.drop_duplicates(subset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SEQN'</span>, keep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'first'</span>, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">df.shape</span></code></pre></div>
<pre><code>(10175, 393)</code></pre>
<section id="cognitive-functioning-data" class="level2">
<h2 class="anchored" data-anchor-id="cognitive-functioning-data">Cognitive functioning data</h2>
<p>This dataset contains multiple tests on which cognitive functioning was assessed. For this analysis, I will be considering the Animal Fluency Task (AFT) and the Digit Symbol Substitution Task (DSST). These tasks measure different aspects of cognition.</p>
<p>In past research, these tasks have each been shown to discriminate between populations with and without dementia. For example, see <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2880929">Howe (2007)</a> or <a href="https://academic.oup.com/ageing/article/45/5/688/2236919">Rosano et al.&nbsp;[2016]</a>.</p>
<p>I will take these measures and combine them to create a composite measure of cognition. By creating a composite, I will be able to reduce measurement noise or bias.</p>
<p>To create a composite, I will first “standardize” each score using z-score normalization so that each score represents a standardized difference from the the mean of its distribution. I will then take the average of the standardized scores.</p>
</section>
<section id="number-of-observations" class="level2">
<h2 class="anchored" data-anchor-id="number-of-observations">Number of observations</h2>
<p>According to the <a href="https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/CFQ_H.htm#CFDAST">documentation on NHANES</a>, there should be 1661 individuals with scores on the Animal Fluency Task (AFT), and 1592 participants with scores on the Digit Symbol Substitution Task (DSST). Here we can see that the intersection of individuals who completed AFT and DSST tasks is 1575.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All participants in the dataset</span></span>
<span id="cb7-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df[df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RIDAGEYR'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>])) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># All participants over 60</span></span>
<span id="cb7-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDAST'</span>].notnull().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Participants with AFT scores</span></span>
<span id="cb7-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDDS'</span>].notnull().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Participants with DSST scores</span></span>
<span id="cb7-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df[df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDAST'</span>].notnull() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDDS'</span>].notnull()]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Individuals with both AFT and DSST</span></span>
<span id="cb7-6"></span>
<span id="cb7-7">df2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDAST'</span>].notnull() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDDS'</span>].notnull()].reset_index()</span></code></pre></div>
<pre><code>10175
1729
1661
1592</code></pre>
</section>
<section id="score-distributions" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="score-distributions">Score distributions</h2>
<p>Below we can see that the distribution of scores on each task are approximately normal.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">plt.hist(df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDAST'</span>], bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>)</span>
<span id="cb9-2">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Animal Fluency Scores"</span>)</span>
<span id="cb9-3">plt.show()</span>
<span id="cb9-4">plt.hist(df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDDS'</span>], bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>)</span>
<span id="cb9-5">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Digit Symbol Substitution Scores"</span>)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_13_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<pre><code>Text(0.5, 1.0, 'Digit Symbol Substitution Scores')</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_13_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
</section>
<section id="composite-scoring" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="composite-scoring">Composite scoring</h2>
<p>First I’ll standardize each of the test columns.</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zscore</span>
<span id="cb11-2">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DSST_z'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDDS'</span>].pipe(zscore)</span>
<span id="cb11-3">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AFT_z'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CFDAST'</span>].pipe(zscore)</span></code></pre></div>
<p>Next, I’ll create a composite by taking the average of the two standardized scores.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DSST_z'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AFT_z'</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
<p>Finally, I’ll check to make sure that the distribution of composite scores is still normal.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">plt.hist(df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG'</span>], bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>)</span>
<span id="cb13-2">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Composite Cognition"</span>)</span></code></pre></div>
<pre><code>Text(0.5, 1.0, 'Composite Cognition')</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_20_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
</section>
<section id="what-is-low-cognition" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="what-is-low-cognition">What is “low” cognition?</h2>
<p>Since these are standardized scores, we can say that low cognition represents 1 standardized unit below the mean.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">plt.hist(df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG'</span>], bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>)</span>
<span id="cb15-2">plt.axvline(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb15-3">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Composite Cognition with Threshold"</span>)</span></code></pre></div>
<pre><code>Text(0.5, 1.0, 'Composite Cognition with Threshold')</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_22_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<p>I’ll create a variable to track this classification.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG_low'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
</section>
<section id="model-features" class="level2">
<h2 class="anchored" data-anchor-id="model-features">Model features</h2>
<p>I’ll collect all the features that I think might be interesting.</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">features <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Composite cognition score</span></span>
<span id="cb18-2">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition'</span>,</span>
<span id="cb18-3">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COG_low'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition_impaired'</span>,</span>
<span id="cb18-4">    </span>
<span id="cb18-5">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demographics</span></span>
<span id="cb18-6">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RIAGENDR'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gender'</span>, </span>
<span id="cb18-7">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RIDAGEYR'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'age'</span>,</span>
<span id="cb18-8">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RIDRETH1'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'race'</span>,</span>
<span id="cb18-9">            </span>
<span id="cb18-10">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Poverty level</span></span>
<span id="cb18-11">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'INDFMMPI'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'poverty'</span>,</span>
<span id="cb18-12">            </span>
<span id="cb18-13">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Body mass index</span></span>
<span id="cb18-14">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BMXBMI'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bmi'</span>,</span>
<span id="cb18-15">            </span>
<span id="cb18-16">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Alcohol use</span></span>
<span id="cb18-17">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ALQ120Q'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol_days'</span>,</span>
<span id="cb18-18">            </span>
<span id="cb18-19">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Blood vitamin levels</span></span>
<span id="cb18-20">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LBXVIDMS'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vit_d'</span>,</span>
<span id="cb18-21">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LBDB12'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vit_b12'</span>,</span>
<span id="cb18-22">            </span>
<span id="cb18-23">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Diet</span></span>
<span id="cb18-24">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DBQ700'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diet_healthy'</span>,</span>
<span id="cb18-25">            </span>
<span id="cb18-26">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Lead</span></span>
<span id="cb18-27">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LBXBPB'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blood_lead'</span>,</span>
<span id="cb18-28">            </span>
<span id="cb18-29">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Blood nicotine metabolite</span></span>
<span id="cb18-30">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LBXCOT'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cotinine'</span>,</span>
<span id="cb18-31">            </span>
<span id="cb18-32">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Grip strength</span></span>
<span id="cb18-33">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/MGX_H.htm#MGDCGSZ</span></span>
<span id="cb18-34">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MGDCGSZ'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'grip_strength'</span>,</span>
<span id="cb18-35">            </span>
<span id="cb18-36">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Smell test</span></span>
<span id="cb18-37">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXCHOOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_choco'</span>,</span>
<span id="cb18-38">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXSBOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_strawberry'</span>,</span>
<span id="cb18-39">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXSMKOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_smoke'</span>,</span>
<span id="cb18-40">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXLEAOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_leather'</span>,</span>
<span id="cb18-41">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXSOAOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_soap'</span>,</span>
<span id="cb18-42">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXGRAOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_grape'</span>,</span>
<span id="cb18-43">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXONOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_onion'</span>,</span>
<span id="cb18-44">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSXNGSOD'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_gas'</span>,</span>
<span id="cb18-45">            </span>
<span id="cb18-46">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Health in general</span></span>
<span id="cb18-47">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'HSD010'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'health_general'</span>,</span>
<span id="cb18-48">            </span>
<span id="cb18-49">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Depression screener</span></span>
<span id="cb18-50">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ010'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_1'</span>,</span>
<span id="cb18-51">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ020'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_2'</span>,</span>
<span id="cb18-52">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ030'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_3'</span>,</span>
<span id="cb18-53">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ040'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_4'</span>,</span>
<span id="cb18-54">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ050'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_5'</span>,</span>
<span id="cb18-55">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ060'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_6'</span>,</span>
<span id="cb18-56">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ070'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_7'</span>,</span>
<span id="cb18-57">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ080'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_8'</span>,</span>
<span id="cb18-58">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'DPQ090'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_9'</span>,</span>
<span id="cb18-59">            </span>
<span id="cb18-60">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sleep</span></span>
<span id="cb18-61">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SLD010H'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sleep'</span>,</span>
<span id="cb18-62">            </span>
<span id="cb18-63">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Heart rate</span></span>
<span id="cb18-64">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'BPXPLS'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'heart_rate'</span></span>
<span id="cb18-65">            }</span>
<span id="cb18-66"></span>
<span id="cb18-67">df2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2.loc[:, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(features)]</span>
<span id="cb18-68">df2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2.rename(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>features)</span></code></pre></div>
<section id="recoding-variables" class="level3">
<h3 class="anchored" data-anchor-id="recoding-variables">Recoding variables</h3>
<p>Some of the features need to be combined. For example, the smell tests can all be combined into a single “smell test” score; the depression scale can be converted into a single depression score.</p>
<p>On some features the values are numeric but not ordinal. For example, on the depression scale scores 0-3 represent increasing levels of depression symptom severity, but a score of “9” means “don’t know” and a score of “7” means “refused”. This will be important to catch in the variable coding.</p>
<section id="depression-items" class="level4">
<h4 class="anchored" data-anchor-id="depression-items">Depression items</h4>
<p>First I’ll score the depression items. I’ll take the mean of all the items responded to.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_4'</span>,</span>
<span id="cb19-2">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_5'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_6'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_7'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_8'</span>,</span>
<span id="cb19-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_9'</span>]</span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> score_depression(x):</span>
<span id="cb19-6">    </span>
<span id="cb19-7">    scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb19-8">    </span>
<span id="cb19-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> items:</span>
<span id="cb19-10">        value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[item]</span>
<span id="cb19-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:</span>
<span id="cb19-12">            scores.append(value)</span>
<span id="cb19-13">    </span>
<span id="cb19-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(scores) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb19-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb19-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb19-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.mean(scores)</span>
<span id="cb19-18">    </span>
<span id="cb19-19"></span>
<span id="cb19-20">df2.loc[:, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dep_tot'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(score_depression, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-21">df2.drop(items, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</section>
<section id="smell-test" class="level4">
<h4 class="anchored" data-anchor-id="smell-test">Smell test</h4>
<p>Next, I’ll score the smell test items. Each item has one correct response and several incorrect responses. I’ll take the mean number of correct responses.</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_choco'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_strawberry'</span>,</span>
<span id="cb20-2">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_smoke'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_leather'</span>,</span>
<span id="cb20-3">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_soap'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_grape'</span>,</span>
<span id="cb20-4">         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_onion'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_gas'</span>]</span>
<span id="cb20-5"></span>
<span id="cb20-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> score_smell(x):</span>
<span id="cb20-7">    </span>
<span id="cb20-8">    scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb20-9">    </span>
<span id="cb20-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_choco'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb20-11">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_choco'</span>]):</span>
<span id="cb20-13">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-14">        </span>
<span id="cb20-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_strawberry'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb20-16">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_strawberry'</span>]):</span>
<span id="cb20-18">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-19">        </span>
<span id="cb20-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_smoke'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb20-21">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_smoke'</span>]):</span>
<span id="cb20-23">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-24">        </span>
<span id="cb20-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_leather'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb20-26">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_leather'</span>]):</span>
<span id="cb20-28">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-29">        </span>
<span id="cb20-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_soap'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb20-31">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_soap'</span>]):</span>
<span id="cb20-33">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-34">        </span>
<span id="cb20-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_grape'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:</span>
<span id="cb20-36">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_grape'</span>]):</span>
<span id="cb20-38">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-39">        </span>
<span id="cb20-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_onion'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb20-41">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_onion'</span>]):</span>
<span id="cb20-43">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-44">        </span>
<span id="cb20-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_gas'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:</span>
<span id="cb20-46">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>np.isnan(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_gas'</span>]):</span>
<span id="cb20-48">        scores.append(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-49">    </span>
<span id="cb20-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(scores) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb20-51">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb20-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb20-53">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.nanmean(scores)</span>
<span id="cb20-54"></span>
<span id="cb20-55">df2.loc[:, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smell_tot'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(score_smell, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-56">df2.drop(items, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</section>
<section id="others" class="level4">
<h4 class="anchored" data-anchor-id="others">Others</h4>
<p>Replace “Don’t know” and “Refused” with missing.</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'health_general'</span>].replace([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.0</span>], [np.nan, np.nan], inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb21-2">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sleep'</span>].replace([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">99.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77.0</span>], [np.nan, np.nan], inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb21-3">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alcohol_days'</span>].replace([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">999.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">777.0</span>], [np.nan, np.nan], inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb21-4">df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diet_healthy'</span>].replace([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.0</span>], [np.nan, np.nan], inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</section>
</section>
<section id="missing-values" class="level3">
<h3 class="anchored" data-anchor-id="missing-values">Missing values</h3>
<p>How many values are missing in each column?</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'% missing values'</span>)</span>
<span id="cb22-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(df2.isnull().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
<pre><code>% missing values





cognition              0.0
cognition_impaired     0.0
gender                 0.0
age                    0.0
race                   0.0
poverty               11.0
bmi                    1.0
alcohol_days          18.0
vit_d                  3.0
vit_b12                4.0
diet_healthy           0.0
blood_lead            51.0
cotinine               4.0
grip_strength         11.0
health_general         2.0
sleep                  0.0
heart_rate             3.0
dep_tot                2.0
smell_tot              3.0
dtype: float64</code></pre>
</section>
</section>
<section id="preprocessing" class="level1">
<h1>Preprocessing</h1>
<p>I will use median imputation for missing numeric values.</p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.compose <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ColumnTransformer</span>
<span id="cb24-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LabelEncoder, OneHotEncoder</span>
<span id="cb24-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.impute <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SimpleImputer</span>
<span id="cb24-4"></span>
<span id="cb24-5">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2.drop([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition_impaired'</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Features</span></span>
<span id="cb24-6">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outcome raw</span></span>
<span id="cb24-7">y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition_impaired'</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Outcome binary</span></span>
<span id="cb24-8"></span>
<span id="cb24-9">ct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ColumnTransformer(</span>
<span id="cb24-10">    [</span>
<span id="cb24-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#('ohe', OneHotEncoder(sparse=False, handle_unknown='ignore'), [1, 3]),</span></span>
<span id="cb24-12">        (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'impute'</span>, SimpleImputer(strategy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'median'</span>), [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]),</span>
<span id="cb24-13">    ],</span>
<span id="cb24-14">    remainder<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'passthrough'</span></span>
<span id="cb24-15">)</span>
<span id="cb24-16">X_arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ct.fit_transform(X)</span></code></pre></div>
</section>
<section id="xgboost-model" class="level1 page-columns page-full">
<h1>XGBoost model</h1>
<p>Next I’ll train a model to predict the composite cognition score using xgboost.</p>
<p>I’ll stratify the train-test split on the classification of healthy/impaired cognition.</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> xgboost <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> XGBRegressor, XGBClassifier</span>
<span id="cb25-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> xgboost <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> plot_importance</span>
<span id="cb25-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split, RandomizedSearchCV</span>
<span id="cb25-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> accuracy_score, precision_score, recall_score, roc_curve, roc_auc_score, plot_roc_curve, confusion_matrix</span>
<span id="cb25-5"></span>
<span id="cb25-6">X_train, X_test, y_train, y_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(X_arr, y2, </span>
<span id="cb25-7">                                                    test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, </span>
<span id="cb25-8">                                                    random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb25-9">                                                    stratify<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>y2)</span></code></pre></div>
<section id="baseline-model" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="baseline-model">Baseline model</h2>
<p>I’ll train a baseline xgboost model, without any parameter tuning. This will give me a general sense of the model’s performance.</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> XGBClassifier()</span>
<span id="cb26-2">model.fit(X_train, y_train)</span></code></pre></div>
<pre><code>XGBClassifier(base_score=0.5, booster=None, colsample_bylevel=1,
              colsample_bynode=1, colsample_bytree=1, gamma=0, gpu_id=-1,
              importance_type='gain', interaction_constraints=None,
              learning_rate=0.300000012, max_delta_step=0, max_depth=6,
              min_child_weight=1, missing=nan, monotone_constraints=None,
              n_estimators=100, n_jobs=0, num_parallel_tree=1,
              objective='binary:logistic', random_state=0, reg_alpha=0,
              reg_lambda=1, scale_pos_weight=1, subsample=1, tree_method=None,
              validate_parameters=False, verbosity=None)</code></pre>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">model.score(X_test, y_test)</span></code></pre></div>
<pre><code>0.8571428571428571</code></pre>
<section id="test-performance" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="test-performance">Test performance</h3>
<p>How did the model perform on the test set?</p>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(X_test)</span>
<span id="cb30-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (accuracy_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb30-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Precision: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (precision_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb30-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Recall: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (recall_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb30-5">plot_roc_curve(model, X_test, y_test)</span></code></pre></div>
<pre><code>Accuracy: 85.71%
Precision: 40.91%
Recall: 21.95%





&lt;sklearn.metrics._plot.roc_curve.RocCurveDisplay at 0x25115f7c7c8&gt;</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_45_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1">tn, fp, fn, tp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> confusion_matrix(y_test, preds).ravel()</span>
<span id="cb32-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"True Pos: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> , <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">False Neg: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fn<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">False Pos: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre><code>True Pos: 9 
False Neg: 32 
False Pos: 13</code></pre>
</section>
</section>
<section id="biasing-the-model-towards-specificity" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="biasing-the-model-towards-specificity">Biasing the model towards specificity</h2>
<p>The model didn’t perform very well on specificity (a.k.a. recall), meaning that among the 41 individuals with cognitive impairment, the model was only able to correctly identify 22% of them.</p>
<p>Let’s imagine a scenario in which we might want to bias the model towards high specificity:</p>
<p>Imagine the model is will be used to identify possible cases of dementia and when the model identifies a case of dementia they will be invited back for further testing to make a diagnosis with much higher precision. In this case, false positives would arguably carry a low risk because (let’s say for the sake of argument) further testing will be harmless and individuals who are healthy will be discovered as healthy. On the other side of the equation, let’s say that there is a high risk of negative consequences for anyone cases of dementia that go missed (and therefore untreated).</p>
<p>This is a case where we would want to optimize for detecting cases of dementia at risk of having an inflated false-positive rate.</p>
<p>Now, one of the reasons for poor recall performance was the imbalanced classes used to train the data. That is to say, the impaired class had many fewer examples than the healthy class. I can correct for this using a weighting parameter when I instantiate the model, setting it to the ratio of healthy-to-impaired examples.</p>
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">impaired <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df2[df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition_impaired'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>])</span>
<span id="cb34-2">healthy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df2[df2[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cognition_impaired'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>])</span>
<span id="cb34-3">imbalance_ratio <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> healthy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> impaired</span>
<span id="cb34-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(imbalance_ratio)</span></code></pre></div>
<pre><code>6.720588235294118</code></pre>
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> XGBClassifier(scale_pos_weight <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> imbalance_ratio)</span>
<span id="cb36-2">model.fit(X_train, y_train)</span>
<span id="cb36-3">model.score(X_test, y_test)</span></code></pre></div>
<pre><code>0.8444444444444444</code></pre>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(X_test)</span>
<span id="cb38-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (accuracy_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb38-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Precision: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (precision_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb38-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Recall: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (recall_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb38-5">plot_roc_curve(model, X_test, y_test)</span></code></pre></div>
<pre><code>Accuracy: 84.44%
Precision: 39.47%
Recall: 36.59%





&lt;sklearn.metrics._plot.roc_curve.RocCurveDisplay at 0x25116152d08&gt;</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_50_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1">tn, fp, fn, tp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> confusion_matrix(y_test, preds).ravel()</span>
<span id="cb40-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"True Pos: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> , <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">False Neg: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fn<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">False Pos: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre><code>True Pos: 15 
False Neg: 26 
False Pos: 23</code></pre>
</section>
<section id="model-with-hyperparameter-tuning" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="model-with-hyperparameter-tuning">Model with hyperparameter tuning</h2>
<p>I’ve managed to bias the model to improve its specificity. This has resulted in more true positives at the cost of more false positives. But I think I can improve this metric even further by searching through the “hyperparameter space” and considering alternative models that optimize for this metric. This is what I’ll do next using random search.</p>
<div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter grid</span></span>
<span id="cb42-2">gbm_param_grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb42-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n_estimators'</span>: np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb42-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_depth'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>),</span>
<span id="cb42-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'colsample_bytree'</span>: np.arange(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>),</span>
<span id="cb42-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'eta'</span>: np.arange(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>),</span>
<span id="cb42-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'scale_pos_weight'</span>: [imbalance_ratio]</span>
<span id="cb42-8">}</span>
<span id="cb42-9"></span>
<span id="cb42-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize regressor</span></span>
<span id="cb42-11">gbm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> XGBClassifier()</span>
<span id="cb42-12"></span>
<span id="cb42-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Random search</span></span>
<span id="cb42-14">randomized_mse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomizedSearchCV(param_distributions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gbm_param_grid, </span>
<span id="cb42-15">                                    estimator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gbm, </span>
<span id="cb42-16">                                    scoring<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'recall'</span>, </span>
<span id="cb42-17">                                    n_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>, </span>
<span id="cb42-18">                                    cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, </span>
<span id="cb42-19">                                    random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb42-20">                                    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb42-21"></span>
<span id="cb42-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit to data</span></span>
<span id="cb42-23">randomized_mse.fit(X_train, y_train)</span>
<span id="cb42-24"></span>
<span id="cb42-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the best parameters and lowest RMSE</span></span>
<span id="cb42-26"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Best parameters found: "</span>, randomized_mse.best_params_)</span></code></pre></div>
<pre><code>Fitting 4 folds for each of 500 candidates, totalling 2000 fits


[Parallel(n_jobs=1)]: Using backend SequentialBackend with 1 concurrent workers.


Best parameters found:  {'scale_pos_weight': 6.720588235294118, 'n_estimators': 20, 'max_depth': 2, 'eta': 0.21999999999999995, 'colsample_bytree': 0.49500000000000033}


[Parallel(n_jobs=1)]: Done 2000 out of 2000 | elapsed:  2.1min finished</code></pre>
<section id="test-performance-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="test-performance-1">Test performance</h3>
<div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> randomized_mse.predict(X_test)</span>
<span id="cb44-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (accuracy_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb44-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Precision: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (precision_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb44-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Recall: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%.2f%%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (recall_score(y_test, preds) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>))</span>
<span id="cb44-5">plot_roc_curve(randomized_mse, X_test, y_test)</span></code></pre></div>
<pre><code>Accuracy: 72.38%
Precision: 27.00%
Recall: 65.85%





&lt;sklearn.metrics._plot.roc_curve.RocCurveDisplay at 0x251159b4a88&gt;</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/05/12/output_55_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">tn, fp, fn, tp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> confusion_matrix(y_test, preds).ravel()</span>
<span id="cb46-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"True Pos: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> , <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">False Neg: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fn<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">False Pos: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre><code>True Pos: 27 
False Neg: 14 
False Pos: 73</code></pre>


<!-- -->

</section>
</section>
</section>

 ]]></description>
  <category>python</category>
  <guid>https://tylerburleigh.com/blog/2020/05/12/</guid>
  <pubDate>Tue, 12 May 2020 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2020/05/12/social-image.png" medium="image" type="image/png" height="98" width="144"/>
</item>
<item>
  <title>Estimating how many people live near a landmark / point-of-interest</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2020/04/11/</link>
  <description><![CDATA[ 





<p>It can be useful to know how many people live near a landmark / point-of-interest (POI). For example, a location is often considered “walkable” if you can walk to it in 10 minutes or less. Understanding how many people live near a POI is one way of estimating how many people are within walking distance of a POI, if they were to walk from their home to the POI.</p>
<p>In this post, I start with a point-of-interest, “Times Square, NYC”, and using the Census API I find out how many people live within the census tract that contains this POI (a tract is one of the smallest sub-divisions for which the Census provides population estimates).</p>
<p>If we wanted to go a bit further down this path of estimating “population within walking distance” we could take this approach and expand it to include all census tracts within a certain distance of our POI census tract. I used this approach one time to understand the potential “reach” of outdoor neighborhood advertising.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> census <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Census</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> us <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> states</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> censusgeocode <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> cg</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> folium</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> geocoder</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pprint</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> wget</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> shapefile <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> shp</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> shapely.geometry <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Polygon</span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-13"></span>
<span id="cb1-14">c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Census(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MY_API_KEY"</span>)</span></code></pre></div>
<section id="geocoding-the-point-of-interest" class="level1">
<h1>Geocoding the point-of-interest</h1>
<p>First we’ll geocode our point-of-interest (POI) using <code>geocoder</code>. This will give us the latitude and longitude coordinates, among other things.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">poi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> geocoder.osm(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Times Square'</span>).json</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print keys</span></span>
<span id="cb2-4">pprint.pprint(poi.keys())</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'address'</span>])</span></code></pre></div>
<pre><code>dict_keys(['accuracy', 'address', 'bbox', 'city', 'confidence', 'country', 'country_code', 'county', 'icon', 'importance', 'lat', 'lng', 'ok', 'osm_id', 'osm_type', 'place_id', 'place_rank', 'postal', 'quality', 'raw', 'region', 'state', 'status', 'street', 'suburb', 'type'])

Times Square, West 45th Street, Times Square, Theater District, Manhattan Community Board 5, Manhattan, New York County, New York, 10036, United States of America</code></pre>
<p>Next, we’ll use <code>censusgeocode</code> to get the geo IDs used by the census. As input, we’ll use the latitude and longitude from the previous geocoding.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">poi_cg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cg.coordinates(y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lat'</span>], x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lng'</span>])</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print top-level keys</span></span>
<span id="cb4-4">pprint.pprint(poi_cg.keys())</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print Census Tract keys</span></span>
<span id="cb4-7">pprint.pprint(poi_cg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Census Tracts'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].keys())</span></code></pre></div>
<pre><code>dict_keys(['2010 Census Blocks', 'States', 'Counties', 'Census Tracts'])
dict_keys(['GEOID', 'CENTLAT', 'AREAWATER', 'STATE', 'BASENAME', 'OID', 'LSADC', 'FUNCSTAT', 'INTPTLAT', 'NAME', 'OBJECTID', 'TRACT', 'CENTLON', 'AREALAND', 'INTPTLON', 'MTFCC', 'COUNTY', 'CENT', 'INTPT'])</code></pre>
</section>
<section id="mapping-the-tract" class="level1">
<h1>Mapping the tract</h1>
<p>First we’ll find the shapefiles for NY state tracts using the <code>us</code> library.</p>
<section id="getting-shapefiles" class="level2">
<h2 class="anchored" data-anchor-id="getting-shapefiles">Getting shapefiles</h2>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">shpurls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> states.NY.shapefile_urls()</span>
<span id="cb6-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> region, url <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> shpurls.items():</span>
<span id="cb6-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(region, url)</span></code></pre></div>
<pre><code>tract https://www2.census.gov/geo/tiger/TIGER2010/TRACT/2010/tl_2010_36_tract10.zip
cd https://www2.census.gov/geo/tiger/TIGER2010/CD/111/tl_2010_36_cd111.zip
county https://www2.census.gov/geo/tiger/TIGER2010/COUNTY/2010/tl_2010_36_county10.zip
state https://www2.census.gov/geo/tiger/TIGER2010/STATE/2010/tl_2010_36_state10.zip
zcta https://www2.census.gov/geo/tiger/TIGER2010/ZCTA5/2010/tl_2010_36_zcta510.zip
block https://www2.census.gov/geo/tiger/TIGER2010/TABBLOCK/2010/tl_2010_36_tabblock10.zip
blockgroup https://www2.census.gov/geo/tiger/TIGER2010/BG/2010/tl_2010_36_bg10.zip</code></pre>
<p>Now we’ll download and unzip the shapefiles for the tract zip.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">wget.download(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://www2.census.gov/geo/tiger/TIGER2010/TRACT/2010/tl_2010_36_tract10.zip'</span>)</span>
<span id="cb8-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> zipfile.ZipFile(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tl_2010_36_tract10.zip'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> zip_ref:</span>
<span id="cb8-3">    zip_ref.extractall()</span></code></pre></div>
<pre><code>-1 / unknown</code></pre>
</section>
<section id="converting-shapefile-to-lnglat-coords" class="level2">
<h2 class="anchored" data-anchor-id="converting-shapefile-to-lnglat-coords">Converting shapefile to LNG/LAT coords</h2>
<p>Next, we’ll read the shape files into a dataframe, giving us a “coords” column, using the <code>shapefile</code> library. Note that these will be in LNG, LAT (not LAT, LNG).</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> read_shapefile(sf):</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Read a shapefile into a Pandas dataframe with a 'coords' </span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    column holding the geometry information. This uses the pyshp</span></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    package</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-7">    fields <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sf.fields][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]</span>
<span id="cb10-8">    records <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sf.records()</span>
<span id="cb10-9">    shps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [s.points <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> sf.shapes()]    </span>
<span id="cb10-10">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fields, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>records)</span>
<span id="cb10-11">    df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.assign(coords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>shps)</span>
<span id="cb10-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> df</span>
<span id="cb10-13"></span>
<span id="cb10-14">shp_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tl_2010_36_tract10.shp'</span></span>
<span id="cb10-15">sf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shp.Reader(shp_path)</span>
<span id="cb10-16">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> read_shapefile(sf)</span></code></pre></div>
<p>This is the tract we’re interested in:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">poi_tract <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GEOID10'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> poi_cg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Census Tracts'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GEOID'</span>]].reset_index()</span>
<span id="cb11-2">poi_tract[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coords'</span>]</span></code></pre></div>
<pre><code>0    [(-73.985085, 40.758589), (-73.98225599999999,...
Name: coords, dtype: object</code></pre>
</section>
<section id="map-the-poi-marker-and-tract-polygon" class="level2">
<h2 class="anchored" data-anchor-id="map-the-poi-marker-and-tract-polygon">Map the POI marker and tract polygon</h2>
<p>Finally, we’re ready to map the POI and the tract polygon in which it is located. We’ll use <code>shapely</code> to get the polygon and <code>folium</code> to do the mapping.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to Polygon</span></span>
<span id="cb13-2">poi_poly <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Polygon(poi_tract[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coords'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize map with zoom and custom tileset, centered on POI</span></span>
<span id="cb13-5">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> folium.Map(location<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lat'</span>], poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lng'</span>]],</span>
<span id="cb13-6">               zoom_start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb13-7">               tiles<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cartodbpositron'</span>)</span>
<span id="cb13-8"></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a map pin</span></span>
<span id="cb13-10">folium.Marker([poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lat'</span>], poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lng'</span>]]).add_to(m)</span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the polygon</span></span>
<span id="cb13-13">folium.GeoJson(poi_poly).add_to(m)</span>
<span id="cb13-14"></span>
<span id="cb13-15">m</span></code></pre></div>
<div style="width:100%;">
<div style="position:relative;width:100%;height:0;padding-bottom:60%;">
<iframe src="about:blank" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" data-html="PCFET0NUWVBFIGh0bWw+CjxoZWFkPiAgICAKICAgIDxtZXRhIGh0dHAtZXF1aXY9ImNvbnRlbnQtdHlwZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PVVURi04IiAvPgogICAgCiAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgTF9OT19UT1VDSCA9IGZhbHNlOwogICAgICAgICAgICBMX0RJU0FCTEVfM0QgPSBmYWxzZTsKICAgICAgICA8L3NjcmlwdD4KICAgIAogICAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbGVhZmxldEAxLjUuMS9kaXN0L2xlYWZsZXQuanMiPjwvc2NyaXB0PgogICAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY29kZS5qcXVlcnkuY29tL2pxdWVyeS0xLjEyLjQubWluLmpzIj48L3NjcmlwdD4KICAgIDxzY3JpcHQgc3JjPSJodHRwczovL21heGNkbi5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjIuMC9qcy9ib290c3RyYXAubWluLmpzIj48L3NjcmlwdD4KICAgIDxzY3JpcHQgc3JjPSJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9MZWFmbGV0LmF3ZXNvbWUtbWFya2Vycy8yLjAuMi9sZWFmbGV0LmF3ZXNvbWUtbWFya2Vycy5qcyI+PC9zY3JpcHQ+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbGVhZmxldEAxLjUuMS9kaXN0L2xlYWZsZXQuY3NzIi8+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vbWF4Y2RuLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMi4wL2Nzcy9ib290c3RyYXAubWluLmNzcyIvPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL21heGNkbi5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjIuMC9jc3MvYm9vdHN0cmFwLXRoZW1lLm1pbi5jc3MiLz4KICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iaHR0cHM6Ly9tYXhjZG4uYm9vdHN0cmFwY2RuLmNvbS9mb250LWF3ZXNvbWUvNC42LjMvY3NzL2ZvbnQtYXdlc29tZS5taW4uY3NzIi8+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL0xlYWZsZXQuYXdlc29tZS1tYXJrZXJzLzIuMC4yL2xlYWZsZXQuYXdlc29tZS1tYXJrZXJzLmNzcyIvPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL3Jhd2Nkbi5naXRoYWNrLmNvbS9weXRob24tdmlzdWFsaXphdGlvbi9mb2xpdW0vbWFzdGVyL2ZvbGl1bS90ZW1wbGF0ZXMvbGVhZmxldC5hd2Vzb21lLnJvdGF0ZS5jc3MiLz4KICAgIDxzdHlsZT5odG1sLCBib2R5IHt3aWR0aDogMTAwJTtoZWlnaHQ6IDEwMCU7bWFyZ2luOiAwO3BhZGRpbmc6IDA7fTwvc3R5bGU+CiAgICA8c3R5bGU+I21hcCB7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7Ym90dG9tOjA7cmlnaHQ6MDtsZWZ0OjA7fTwvc3R5bGU+CiAgICAKICAgICAgICAgICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwKICAgICAgICAgICAgICAgIGluaXRpYWwtc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT1ubyIgLz4KICAgICAgICAgICAgPHN0eWxlPgogICAgICAgICAgICAgICAgI21hcF9kMjlmZWY4ZWIxOTc0YzRlOGJlMzRmMDNhNWNlY2Q4MyB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAuMCU7CiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAxMDAuMCU7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogMC4wJTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDAuMCU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIDwvc3R5bGU+CiAgICAgICAgCjwvaGVhZD4KPGJvZHk+ICAgIAogICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvbGl1bS1tYXAiIGlkPSJtYXBfZDI5ZmVmOGViMTk3NGM0ZThiZTM0ZjAzYTVjZWNkODMiID48L2Rpdj4KICAgICAgICAKPC9ib2R5Pgo8c2NyaXB0PiAgICAKICAgIAogICAgICAgICAgICB2YXIgbWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzID0gTC5tYXAoCiAgICAgICAgICAgICAgICAibWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzIiwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjZW50ZXI6IFs0MC43NTcyODA1NTAwMDAwMDQsIC03My45ODU4NTUwMzU0NTkxN10sCiAgICAgICAgICAgICAgICAgICAgY3JzOiBMLkNSUy5FUFNHMzg1NywKICAgICAgICAgICAgICAgICAgICB6b29tOiAxNiwKICAgICAgICAgICAgICAgICAgICB6b29tQ29udHJvbDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBwcmVmZXJDYW52YXM6IGZhbHNlLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwoKICAgICAgICAgICAgCgogICAgICAgIAogICAgCiAgICAgICAgICAgIHZhciB0aWxlX2xheWVyX2I5MTc0ZWE0MTBkNjRhMzQ4NWU0MzkxY2U3YzA3MTVjID0gTC50aWxlTGF5ZXIoCiAgICAgICAgICAgICAgICAiaHR0cHM6Ly9jYXJ0b2RiLWJhc2VtYXBzLXtzfS5nbG9iYWwuc3NsLmZhc3RseS5uZXQvbGlnaHRfYWxsL3t6fS97eH0ve3l9LnBuZyIsCiAgICAgICAgICAgICAgICB7ImF0dHJpYnV0aW9uIjogIlx1MDAyNmNvcHk7IFx1MDAzY2EgaHJlZj1cImh0dHA6Ly93d3cub3BlbnN0cmVldG1hcC5vcmcvY29weXJpZ2h0XCJcdTAwM2VPcGVuU3RyZWV0TWFwXHUwMDNjL2FcdTAwM2UgY29udHJpYnV0b3JzIFx1MDAyNmNvcHk7IFx1MDAzY2EgaHJlZj1cImh0dHA6Ly9jYXJ0b2RiLmNvbS9hdHRyaWJ1dGlvbnNcIlx1MDAzZUNhcnRvREJcdTAwM2MvYVx1MDAzZSwgQ2FydG9EQiBcdTAwM2NhIGhyZWYgPVwiaHR0cDovL2NhcnRvZGIuY29tL2F0dHJpYnV0aW9uc1wiXHUwMDNlYXR0cmlidXRpb25zXHUwMDNjL2FcdTAwM2UiLCAiZGV0ZWN0UmV0aW5hIjogZmFsc2UsICJtYXhOYXRpdmVab29tIjogMTgsICJtYXhab29tIjogMTgsICJtaW5ab29tIjogMCwgIm5vV3JhcCI6IGZhbHNlLCAib3BhY2l0eSI6IDEsICJzdWJkb21haW5zIjogImFiYyIsICJ0bXMiOiBmYWxzZX0KICAgICAgICAgICAgKS5hZGRUbyhtYXBfZDI5ZmVmOGViMTk3NGM0ZThiZTM0ZjAzYTVjZWNkODMpOwogICAgICAgIAogICAgCiAgICAgICAgICAgIHZhciBtYXJrZXJfZDI4YzFkZDMwYmM2NDc0YjljOTFiYTc0ZGY3NDgzOTcgPSBMLm1hcmtlcigKICAgICAgICAgICAgICAgIFs0MC43NTcyODA1NTAwMDAwMDQsIC03My45ODU4NTUwMzU0NTkxN10sCiAgICAgICAgICAgICAgICB7fQogICAgICAgICAgICApLmFkZFRvKG1hcF9kMjlmZWY4ZWIxOTc0YzRlOGJlMzRmMDNhNWNlY2Q4Myk7CiAgICAgICAgCiAgICAKICAgICAgICBmdW5jdGlvbiBnZW9fanNvbl9hOTcyNzZjOTdkYTk0YmM3YTBjYTQ1YWM1ODY0N2JiZF9vbkVhY2hGZWF0dXJlKGZlYXR1cmUsIGxheWVyKSB7CiAgICAgICAgICAgIGxheWVyLm9uKHsKICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgbWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzLmZpdEJvdW5kcyhlLnRhcmdldC5nZXRCb3VuZHMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkID0gTC5nZW9Kc29uKG51bGwsIHsKICAgICAgICAgICAgICAgIG9uRWFjaEZlYXR1cmU6IGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkX29uRWFjaEZlYXR1cmUsCiAgICAgICAgICAgIAogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkX2FkZCAoZGF0YSkgewogICAgICAgICAgICBnZW9fanNvbl9hOTcyNzZjOTdkYTk0YmM3YTBjYTQ1YWM1ODY0N2JiZC5hZGREYXRhKGRhdGEpCiAgICAgICAgICAgICAgICAuYWRkVG8obWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzKTsKICAgICAgICB9CiAgICAgICAgICAgIGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkX2FkZCh7ImNvb3JkaW5hdGVzIjogW1tbLTczLjk4NTA4NSwgNDAuNzU4NTg5XSwgWy03My45ODIyNTU5OTk5OTk5OSwgNDAuNzU3Mzg3XSwgWy03My45ODI3MTE5OTk5OTk5OSwgNDAuNzU2NzcxXSwgWy03My45ODMxNjc5OTk5OTk5OSwgNDAuNzU2MTM5OTk5OTk5OTk1XSwgWy03My45ODM2MjM5OTk5OTk5OSwgNDAuNzU1NTE2XSwgWy03My45ODQxMTgsIDQwLjc1NDg0Ml0sIFstNzMuOTg2Mzk4LCA0MC43NTU4MDRdLCBbLTczLjk4Njk0OSwgNDAuNzU2MDM2XSwgWy03My45ODk3OTEsIDQwLjc1NzIzNF0sIFstNzMuOTg5Mjk3LCA0MC43NTc5MDY5OTk5OTk5OTZdLCBbLTczLjk4ODg0MTk5OTk5OTk5LCA0MC43NTg1MzNdLCBbLTczLjk4ODM5MSwgNDAuNzU5MTY0XSwgWy03My45ODc5MjcsIDQwLjc1OTc5MV0sIFstNzMuOTg1MzIyLCA0MC43NTg2ODY5OTk5OTk5OTVdLCBbLTczLjk4NTA4NSwgNDAuNzU4NTg5XV1dLCAidHlwZSI6ICJQb2x5Z29uIn0pOwogICAgICAgIAo8L3NjcmlwdD4=" onload="this.contentDocument.open();this.contentDocument.write(atob(this.getAttribute('data-html')));this.contentDocument.close();" allowfullscreen="" webkitallowfullscreen="" mozallowfullscreen="">
</iframe>
</div>
</div>
</section>
</section>
<section id="population-for-census-tract" class="level1">
<h1>Population for census tract</h1>
<p>Now, the last step is finding the population for this census tract.</p>
<p>The variable we are interested in is <code>B01003_001E</code>, an estimate of the total population. A full list of the variable codes and definitions can be found at the <a href="https://www.census.gov/data/developers/data-sets/acs-5year.html">ACS developer page</a> (see the “2018 ACS Detailed Tables Variables”).</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">poi_pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> c.acs5.state_county_tract((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NAME'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B01003_001E'</span>),</span>
<span id="cb14-2">                                     poi_cg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Census Tracts'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'STATE'</span>], </span>
<span id="cb14-3">                                     poi_cg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Census Tracts'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'COUNTY'</span>], </span>
<span id="cb14-4">                                     poi_cg[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Census Tracts'</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TRACT'</span>])</span>
<span id="cb14-5"></span>
<span id="cb14-6">poi_pop_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(poi_pop[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'B01003_001E'</span>]))</span>
<span id="cb14-7"></span>
<span id="cb14-8">poi_pop_str</span></code></pre></div>
<pre><code>'1027'</code></pre>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">folium.Marker(</span>
<span id="cb16-2">    [poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lat'</span>], poi[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lng'</span>]],</span>
<span id="cb16-3">    icon<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>folium.DivIcon(</span>
<span id="cb16-4">        icon_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>),</span>
<span id="cb16-5">        icon_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb16-6">        html<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'&lt;div style="font-size: 10pt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb16-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                          background:white;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb16-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                          padding:5px;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb16-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                          border:1px solid red"&gt;</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb16-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                          The population in the census tract</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb16-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                          containing Times Square is '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> poi_pop_str <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb16-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">              &lt;/div&gt;'</span>,</span>
<span id="cb16-13">        )</span>
<span id="cb16-14">    ).add_to(m)</span>
<span id="cb16-15"></span>
<span id="cb16-16">m</span></code></pre></div>
<div style="width:100%;">
<div style="position:relative;width:100%;height:0;padding-bottom:60%;">
<iframe src="about:blank" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" data-html="PCFET0NUWVBFIGh0bWw+CjxoZWFkPiAgICAKICAgIDxtZXRhIGh0dHAtZXF1aXY9ImNvbnRlbnQtdHlwZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PVVURi04IiAvPgogICAgCiAgICAgICAgPHNjcmlwdD4KICAgICAgICAgICAgTF9OT19UT1VDSCA9IGZhbHNlOwogICAgICAgICAgICBMX0RJU0FCTEVfM0QgPSBmYWxzZTsKICAgICAgICA8L3NjcmlwdD4KICAgIAogICAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbGVhZmxldEAxLjUuMS9kaXN0L2xlYWZsZXQuanMiPjwvc2NyaXB0PgogICAgPHNjcmlwdCBzcmM9Imh0dHBzOi8vY29kZS5qcXVlcnkuY29tL2pxdWVyeS0xLjEyLjQubWluLmpzIj48L3NjcmlwdD4KICAgIDxzY3JpcHQgc3JjPSJodHRwczovL21heGNkbi5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjIuMC9qcy9ib290c3RyYXAubWluLmpzIj48L3NjcmlwdD4KICAgIDxzY3JpcHQgc3JjPSJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9MZWFmbGV0LmF3ZXNvbWUtbWFya2Vycy8yLjAuMi9sZWFmbGV0LmF3ZXNvbWUtbWFya2Vycy5qcyI+PC9zY3JpcHQ+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vY2RuLmpzZGVsaXZyLm5ldC9ucG0vbGVhZmxldEAxLjUuMS9kaXN0L2xlYWZsZXQuY3NzIi8+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vbWF4Y2RuLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMi4wL2Nzcy9ib290c3RyYXAubWluLmNzcyIvPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL21heGNkbi5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjIuMC9jc3MvYm9vdHN0cmFwLXRoZW1lLm1pbi5jc3MiLz4KICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iaHR0cHM6Ly9tYXhjZG4uYm9vdHN0cmFwY2RuLmNvbS9mb250LWF3ZXNvbWUvNC42LjMvY3NzL2ZvbnQtYXdlc29tZS5taW4uY3NzIi8+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL0xlYWZsZXQuYXdlc29tZS1tYXJrZXJzLzIuMC4yL2xlYWZsZXQuYXdlc29tZS1tYXJrZXJzLmNzcyIvPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL3Jhd2Nkbi5naXRoYWNrLmNvbS9weXRob24tdmlzdWFsaXphdGlvbi9mb2xpdW0vbWFzdGVyL2ZvbGl1bS90ZW1wbGF0ZXMvbGVhZmxldC5hd2Vzb21lLnJvdGF0ZS5jc3MiLz4KICAgIDxzdHlsZT5odG1sLCBib2R5IHt3aWR0aDogMTAwJTtoZWlnaHQ6IDEwMCU7bWFyZ2luOiAwO3BhZGRpbmc6IDA7fTwvc3R5bGU+CiAgICA8c3R5bGU+I21hcCB7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7Ym90dG9tOjA7cmlnaHQ6MDtsZWZ0OjA7fTwvc3R5bGU+CiAgICAKICAgICAgICAgICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwKICAgICAgICAgICAgICAgIGluaXRpYWwtc2NhbGU9MS4wLCBtYXhpbXVtLXNjYWxlPTEuMCwgdXNlci1zY2FsYWJsZT1ubyIgLz4KICAgICAgICAgICAgPHN0eWxlPgogICAgICAgICAgICAgICAgI21hcF9kMjlmZWY4ZWIxOTc0YzRlOGJlMzRmMDNhNWNlY2Q4MyB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMDAuMCU7CiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAxMDAuMCU7CiAgICAgICAgICAgICAgICAgICAgbGVmdDogMC4wJTsKICAgICAgICAgICAgICAgICAgICB0b3A6IDAuMCU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIDwvc3R5bGU+CiAgICAgICAgCjwvaGVhZD4KPGJvZHk+ICAgIAogICAgCiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImZvbGl1bS1tYXAiIGlkPSJtYXBfZDI5ZmVmOGViMTk3NGM0ZThiZTM0ZjAzYTVjZWNkODMiID48L2Rpdj4KICAgICAgICAKPC9ib2R5Pgo8c2NyaXB0PiAgICAKICAgIAogICAgICAgICAgICB2YXIgbWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzID0gTC5tYXAoCiAgICAgICAgICAgICAgICAibWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzIiwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjZW50ZXI6IFs0MC43NTcyODA1NTAwMDAwMDQsIC03My45ODU4NTUwMzU0NTkxN10sCiAgICAgICAgICAgICAgICAgICAgY3JzOiBMLkNSUy5FUFNHMzg1NywKICAgICAgICAgICAgICAgICAgICB6b29tOiAxNiwKICAgICAgICAgICAgICAgICAgICB6b29tQ29udHJvbDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBwcmVmZXJDYW52YXM6IGZhbHNlLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwoKICAgICAgICAgICAgCgogICAgICAgIAogICAgCiAgICAgICAgICAgIHZhciB0aWxlX2xheWVyX2I5MTc0ZWE0MTBkNjRhMzQ4NWU0MzkxY2U3YzA3MTVjID0gTC50aWxlTGF5ZXIoCiAgICAgICAgICAgICAgICAiaHR0cHM6Ly9jYXJ0b2RiLWJhc2VtYXBzLXtzfS5nbG9iYWwuc3NsLmZhc3RseS5uZXQvbGlnaHRfYWxsL3t6fS97eH0ve3l9LnBuZyIsCiAgICAgICAgICAgICAgICB7ImF0dHJpYnV0aW9uIjogIlx1MDAyNmNvcHk7IFx1MDAzY2EgaHJlZj1cImh0dHA6Ly93d3cub3BlbnN0cmVldG1hcC5vcmcvY29weXJpZ2h0XCJcdTAwM2VPcGVuU3RyZWV0TWFwXHUwMDNjL2FcdTAwM2UgY29udHJpYnV0b3JzIFx1MDAyNmNvcHk7IFx1MDAzY2EgaHJlZj1cImh0dHA6Ly9jYXJ0b2RiLmNvbS9hdHRyaWJ1dGlvbnNcIlx1MDAzZUNhcnRvREJcdTAwM2MvYVx1MDAzZSwgQ2FydG9EQiBcdTAwM2NhIGhyZWYgPVwiaHR0cDovL2NhcnRvZGIuY29tL2F0dHJpYnV0aW9uc1wiXHUwMDNlYXR0cmlidXRpb25zXHUwMDNjL2FcdTAwM2UiLCAiZGV0ZWN0UmV0aW5hIjogZmFsc2UsICJtYXhOYXRpdmVab29tIjogMTgsICJtYXhab29tIjogMTgsICJtaW5ab29tIjogMCwgIm5vV3JhcCI6IGZhbHNlLCAib3BhY2l0eSI6IDEsICJzdWJkb21haW5zIjogImFiYyIsICJ0bXMiOiBmYWxzZX0KICAgICAgICAgICAgKS5hZGRUbyhtYXBfZDI5ZmVmOGViMTk3NGM0ZThiZTM0ZjAzYTVjZWNkODMpOwogICAgICAgIAogICAgCiAgICAgICAgICAgIHZhciBtYXJrZXJfZDI4YzFkZDMwYmM2NDc0YjljOTFiYTc0ZGY3NDgzOTcgPSBMLm1hcmtlcigKICAgICAgICAgICAgICAgIFs0MC43NTcyODA1NTAwMDAwMDQsIC03My45ODU4NTUwMzU0NTkxN10sCiAgICAgICAgICAgICAgICB7fQogICAgICAgICAgICApLmFkZFRvKG1hcF9kMjlmZWY4ZWIxOTc0YzRlOGJlMzRmMDNhNWNlY2Q4Myk7CiAgICAgICAgCiAgICAKICAgICAgICBmdW5jdGlvbiBnZW9fanNvbl9hOTcyNzZjOTdkYTk0YmM3YTBjYTQ1YWM1ODY0N2JiZF9vbkVhY2hGZWF0dXJlKGZlYXR1cmUsIGxheWVyKSB7CiAgICAgICAgICAgIGxheWVyLm9uKHsKICAgICAgICAgICAgICAgIGNsaWNrOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgbWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzLmZpdEJvdW5kcyhlLnRhcmdldC5nZXRCb3VuZHMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgdmFyIGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkID0gTC5nZW9Kc29uKG51bGwsIHsKICAgICAgICAgICAgICAgIG9uRWFjaEZlYXR1cmU6IGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkX29uRWFjaEZlYXR1cmUsCiAgICAgICAgICAgIAogICAgICAgIH0pOwogICAgICAgIGZ1bmN0aW9uIGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkX2FkZCAoZGF0YSkgewogICAgICAgICAgICBnZW9fanNvbl9hOTcyNzZjOTdkYTk0YmM3YTBjYTQ1YWM1ODY0N2JiZC5hZGREYXRhKGRhdGEpCiAgICAgICAgICAgICAgICAuYWRkVG8obWFwX2QyOWZlZjhlYjE5NzRjNGU4YmUzNGYwM2E1Y2VjZDgzKTsKICAgICAgICB9CiAgICAgICAgICAgIGdlb19qc29uX2E5NzI3NmM5N2RhOTRiYzdhMGNhNDVhYzU4NjQ3YmJkX2FkZCh7ImNvb3JkaW5hdGVzIjogW1tbLTczLjk4NTA4NSwgNDAuNzU4NTg5XSwgWy03My45ODIyNTU5OTk5OTk5OSwgNDAuNzU3Mzg3XSwgWy03My45ODI3MTE5OTk5OTk5OSwgNDAuNzU2NzcxXSwgWy03My45ODMxNjc5OTk5OTk5OSwgNDAuNzU2MTM5OTk5OTk5OTk1XSwgWy03My45ODM2MjM5OTk5OTk5OSwgNDAuNzU1NTE2XSwgWy03My45ODQxMTgsIDQwLjc1NDg0Ml0sIFstNzMuOTg2Mzk4LCA0MC43NTU4MDRdLCBbLTczLjk4Njk0OSwgNDAuNzU2MDM2XSwgWy03My45ODk3OTEsIDQwLjc1NzIzNF0sIFstNzMuOTg5Mjk3LCA0MC43NTc5MDY5OTk5OTk5OTZdLCBbLTczLjk4ODg0MTk5OTk5OTk5LCA0MC43NTg1MzNdLCBbLTczLjk4ODM5MSwgNDAuNzU5MTY0XSwgWy03My45ODc5MjcsIDQwLjc1OTc5MV0sIFstNzMuOTg1MzIyLCA0MC43NTg2ODY5OTk5OTk5OTVdLCBbLTczLjk4NTA4NSwgNDAuNzU4NTg5XV1dLCAidHlwZSI6ICJQb2x5Z29uIn0pOwogICAgICAgIAogICAgCiAgICAgICAgICAgIHZhciBtYXJrZXJfZTI1NTgyYjE1ZDY2NDZkY2E1OGNlMWI3YTQ4N2Q4ZTEgPSBMLm1hcmtlcigKICAgICAgICAgICAgICAgIFs0MC43NTcyODA1NTAwMDAwMDQsIC03My45ODU4NTUwMzU0NTkxN10sCiAgICAgICAgICAgICAgICB7fQogICAgICAgICAgICApLmFkZFRvKG1hcF9kMjlmZWY4ZWIxOTc0YzRlOGJlMzRmMDNhNWNlY2Q4Myk7CiAgICAgICAgCiAgICAKICAgICAgICAgICAgdmFyIGRpdl9pY29uX2Y5MDY3OTYyN2VlYzRhYzg5ZmZmMTYyODhhNzAzYWQ1ID0gTC5kaXZJY29uKHsiY2xhc3NOYW1lIjogImVtcHR5IiwgImh0bWwiOiAiXHUwMDNjZGl2IHN0eWxlPVwiZm9udC1zaXplOiAxMHB0OyAgICAgICAgICAgICAgICAgICAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmc6NXB4OyAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyOjFweCBzb2xpZCByZWRcIlx1MDAzZSAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHBvcHVsYXRpb24gaW4gdGhlIGNlbnN1cyB0cmFjdCAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmluZyBUaW1lcyBTcXVhcmUgaXMgMTAyNyAgICAgICAgICAgICAgXHUwMDNjL2Rpdlx1MDAzZSIsICJpY29uQW5jaG9yIjogWzAsIDBdLCAiaWNvblNpemUiOiBbMTUwLCAzNl19KTsKICAgICAgICAgICAgbWFya2VyX2UyNTU4MmIxNWQ2NjQ2ZGNhNThjZTFiN2E0ODdkOGUxLnNldEljb24oZGl2X2ljb25fZjkwNjc5NjI3ZWVjNGFjODlmZmYxNjI4OGE3MDNhZDUpOwogICAgICAgIAo8L3NjcmlwdD4=" onload="this.contentDocument.open();this.contentDocument.write(atob(this.getAttribute('data-html')));this.contentDocument.close();" allowfullscreen="" webkitallowfullscreen="" mozallowfullscreen="">
</iframe>
</div>
</div>


<!-- -->

</section>

 ]]></description>
  <category>python</category>
  <guid>https://tylerburleigh.com/blog/2020/04/11/</guid>
  <pubDate>Sat, 11 Apr 2020 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2020/04/11/social-image.png" medium="image" type="image/png" height="88" width="144"/>
</item>
<item>
  <title>Identifying pneumonia from chest x-rays using EfficientNet</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2020/04/04/</link>
  <description><![CDATA[ 





<p>In my last post I used EfficientNet to <a href="https://tylerburleigh.com/blog/predicting-plant-diseases-using-efficientnet/">identify plant diseases</a>. I was surprised at how well this pre-trained model worked, with so few modifications, and I was curious how an approach like this might generalize to other visual image detection problems. In this post I use a similar approach to identify childhood pneumonia from chest x-ray images, using the <a href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia">Chest X-Ray Images (Pneumonia)</a> dataset on Kaggle. Using this approach, I was able to achieve 97% accuracy, 97% precision, and 97% recall.</p>
<p>The code below implements this model. See also <a href="https://www.kaggle.com/bluewizard/predict-pneumonia-keras-efficientnet-98-acc">my notebook on Kaggle</a>.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get data from Kaggle</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!kaggle datasets download paultimothymooney/chest-xray-pneumonia</span></span></code></pre></div>
<section id="addressing-some-issues-with-the-original-dataset" class="level1 page-columns page-full">
<h1>Addressing some issues with the original dataset</h1>
<p>We’ll start by addressing two major issues with the dataset.</p>
<p>I discovered these issues after exploring the data and after my first attempt at validating a trained model:</p>
<ol type="1">
<li>The original validation set was WAY too small (only 8 items in each class). This is insufficient, so we need to create our own train-validation split.</li>
<li>The test set appears to be incorrectly labeled. After my first attempt at training a model I was able to achieve ~99% accuracy on both the training and validation sets, but only ~87% accuracy on the test set. After reading through some of the comments on Kaggle, it seems others have come to a similar conclusion: Some of the test set data is not correctly labeled (e.g., <a href="https://www.kaggle.com/paultimothymooney/chest-xray-pneumonia/discussion/56672">see here</a>). To address this, we’ll create our own train-test split as well.</li>
</ol>
<p>The first thing I’ll do is remove the existing train/validation/test labels by combining the images into directories for each class, and then I’ll do my own train/test split. Later, I’ll use a parameter in the <code>flow_from_directory</code> function to split the training set into training and validation sets for model training.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> shutil <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> copyfile</span>
<span id="cb2-3">os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/NORMAL'</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-4">os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/PNEUMONIA'</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> dirname, _, filenames <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> os.walk(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chest_xray'</span>):</span>
<span id="cb2-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(filenames):</span>
<span id="cb2-8">        img_class <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dirname.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb2-9">        copyfile(os.path.join(dirname, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> img_class <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>)</span></code></pre></div>
<p>Let’s check how many images are in each class, now that we’ve combined them.</p>
<p>It appears we have imbalanced data – i.e., a disproportionate number of items belong to the <code>PNEUMONIA</code> class. When it comes time to evaluate the model it will be important to look at more than just accuracy.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> dirname, _, filenames <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> os.walk(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images'</span>):</span>
<span id="cb3-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dirname.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb3-3">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(dirname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" has "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(filenames)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" files"</span>)</span></code></pre></div>
<pre><code>images\NORMAL has 1583 files
images\PNEUMONIA has 4273 files</code></pre>
<p>Next, let’s split the new image set into training and test sets.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> shutil <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rmtree</span>
<span id="cb5-4"></span>
<span id="cb5-5">rmtree(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove existing, if re-run</span></span>
<span id="cb5-6">rmtree(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove existing, if re-run</span></span>
<span id="cb5-7"></span>
<span id="cb5-8">os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train/NORMAL'</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-9">os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train/PNEUMONIA'</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-10">os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test/NORMAL'</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-11">os.makedirs(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test/PNEUMONIA'</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split NORMAL</span></span>
<span id="cb5-14">train, test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(os.listdir(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/NORMAL'</span>), </span>
<span id="cb5-15">                               test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, </span>
<span id="cb5-16">                               random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb5-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> train:</span>
<span id="cb5-18">    copyfile(os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/NORMAL/'</span>, img), </span>
<span id="cb5-19">             os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train/NORMAL/'</span>, img))</span>
<span id="cb5-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test:</span>
<span id="cb5-21">    copyfile(os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/NORMAL/'</span>, img), </span>
<span id="cb5-22">             os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test/NORMAL/'</span>, img))</span>
<span id="cb5-23"></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split PNEUMONIA</span></span>
<span id="cb5-25">train, test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(os.listdir(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/PNEUMONIA'</span>), </span>
<span id="cb5-26">                               test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, </span>
<span id="cb5-27">                               random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb5-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> train:</span>
<span id="cb5-29">    copyfile(os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/PNEUMONIA/'</span>, img), </span>
<span id="cb5-30">             os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train/PNEUMONIA/'</span>, img))</span>
<span id="cb5-31"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> img <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> test:</span>
<span id="cb5-32">    copyfile(os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/PNEUMONIA/'</span>, img), </span>
<span id="cb5-33">             os.path.join(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test/PNEUMONIA/'</span>, img))</span></code></pre></div>
<p>Let’s look at some of the images, so we know what we’re dealing with.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> image <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mpimg</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> dirname, _, filenames <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> os.walk(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>):</span>
<span id="cb6-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(filenames):</span>
<span id="cb6-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb6-7">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb6-8">        plt.imshow(mpimg.imread(os.path.join(dirname, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>)), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span>
<span id="cb6-9">        plt.title(dirname.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb6-10">        plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/04/output_9_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/04/output_9_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/04/output_9_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/04/output_9_3.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<p>To the eye of a layman like myself, it’s hard to tell what distinguishes the classes. Maybe the chest area of the pneumonia images are “cloudier”?</p>
</section>
<section id="model" class="level1 page-columns page-full">
<h1>Model</h1>
<p>We’ll train a model using EfficientNet as a base.</p>
<p>When setting up the <code>flow_from_directory</code> we’ll define a <code>validation_split</code>.</p>
<p>We’ll also add precision and recall to the model metrics.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tensorflow.keras.preprocessing.image <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ImageDataGenerator</span>
<span id="cb7-2"></span>
<span id="cb7-3">SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb7-4">BATCH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># image augmentations</span></span>
<span id="cb7-7">image_gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataGenerator(rescale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>,</span>
<span id="cb7-8">                                rotation_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb7-9">                                width_shift_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb7-10">                                height_shift_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb7-11">                                validation_split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># flow_from_directory generators</span></span>
<span id="cb7-14">train_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image_gen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-15">    .flow_from_directory(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>,</span>
<span id="cb7-16">                        target_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(SIZE, SIZE),</span>
<span id="cb7-17">                        class_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binary"</span>,</span>
<span id="cb7-18">                        batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH,</span>
<span id="cb7-19">                        subset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'training'</span>)</span>
<span id="cb7-20"></span>
<span id="cb7-21">validation_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image_gen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-22">    .flow_from_directory(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>,</span>
<span id="cb7-23">                        target_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(SIZE, SIZE),</span>
<span id="cb7-24">                        class_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binary"</span>,</span>
<span id="cb7-25">                        batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH,</span>
<span id="cb7-26">                        subset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'validation'</span>)</span></code></pre></div>
<pre><code>Found 3748 images belonging to 2 classes.
Found 936 images belonging to 2 classes.</code></pre>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> efficientnet.keras <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> efn</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tensorflow.keras.callbacks <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Callback</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.models <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Model</span>
<span id="cb9-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.layers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Dense, GlobalAveragePooling2D</span>
<span id="cb9-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.callbacks <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ReduceLROnPlateau, ModelCheckpoint</span>
<span id="cb9-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tensorflow.keras.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Recall, Precision</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Callbacks</span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Keep the best model</span></span>
<span id="cb9-10">mc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ModelCheckpoint(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model.hdf5'</span>, </span>
<span id="cb9-11">                     save_best_only<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb9-12">                     verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb9-13">                     monitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_loss'</span>, </span>
<span id="cb9-14">                     mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min'</span>)</span>
<span id="cb9-15"></span>
<span id="cb9-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Reduce learning rate if it gets stuck in a plateau</span></span>
<span id="cb9-17">rlr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ReduceLROnPlateau(monitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_loss'</span>, </span>
<span id="cb9-18">                        factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, </span>
<span id="cb9-19">                        patience<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, </span>
<span id="cb9-20">                        min_lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.000001</span>, </span>
<span id="cb9-21">                        verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-22"></span>
<span id="cb9-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model</span></span>
<span id="cb9-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Define the base model with EfficientNet weights</span></span>
<span id="cb9-25">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> efn.EfficientNetB4(weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imagenet'</span>, </span>
<span id="cb9-26">                           include_top <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, </span>
<span id="cb9-27">                           input_shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (SIZE, SIZE, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb9-28"></span>
<span id="cb9-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Output layer</span></span>
<span id="cb9-30">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.output</span>
<span id="cb9-31">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GlobalAveragePooling2D()(x)</span>
<span id="cb9-32">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dense(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"relu"</span>)(x)</span>
<span id="cb9-33">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dense(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"relu"</span>)(x)</span>
<span id="cb9-34">predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dense(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigmoid"</span>)(x)</span>
<span id="cb9-35"></span>
<span id="cb9-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Compile and run</span></span>
<span id="cb9-37">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Model(inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>predictions)</span>
<span id="cb9-38"></span>
<span id="cb9-39">model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(optimizer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'adam'</span>,</span>
<span id="cb9-40">              loss<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'binary_crossentropy'</span>, </span>
<span id="cb9-41">              metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'accuracy'</span>, Recall(), Precision()])</span>
<span id="cb9-42"></span>
<span id="cb9-43">model_history <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.fit(train_generator,</span>
<span id="cb9-44">                            validation_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>validation_generator,</span>
<span id="cb9-45">                            steps_per_epoch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>train_generator.n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>BATCH,</span>
<span id="cb9-46">                            validation_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>validation_generator.n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>BATCH,</span>
<span id="cb9-47">                            epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb9-48">                            verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb9-49">                            callbacks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[mc, rlr])</span></code></pre></div>
<pre><code>Using TensorFlow backend.


Epoch 1/10
235/234 [==============================] - 177s 754ms/step - loss: 0.2632 - accuracy: 0.9015 - recall: 0.9207 - precision: 0.9174 - val_loss: 0.1176 - val_accuracy: 0.8686 - val_recall: 0.9424 - val_precision: 0.9198
Epoch 2/10
235/234 [==============================] - 142s 604ms/step - loss: 0.1449 - accuracy: 0.9472 - recall: 0.9519 - precision: 0.9236 - val_loss: 0.1220 - val_accuracy: 0.9402 - val_recall: 0.9589 - val_precision: 0.9328
Epoch 3/10
235/234 [==============================] - 142s 604ms/step - loss: 0.1388 - accuracy: 0.9493 - recall: 0.9614 - precision: 0.9368 - val_loss: 0.0892 - val_accuracy: 0.9733 - val_recall: 0.9636 - val_precision: 0.9421
Epoch 4/10
235/234 [==============================] - 143s 608ms/step - loss: 0.1263 - accuracy: 0.9626 - recall: 0.9658 - precision: 0.9462 - val_loss: 0.2923 - val_accuracy: 0.9498 - val_recall: 0.9670 - val_precision: 0.9495
Epoch 5/10
235/234 [==============================] - 142s 603ms/step - loss: 0.1078 - accuracy: 0.9664 - recall: 0.9680 - precision: 0.9522 - val_loss: 1.9153 - val_accuracy: 0.7938 - val_recall: 0.9639 - val_precision: 0.9547
Epoch 6/10
235/234 [==============================] - 142s 603ms/step - loss: 0.0930 - accuracy: 0.9685 - recall: 0.9602 - precision: 0.9567 - val_loss: 0.0131 - val_accuracy: 0.9712 - val_recall: 0.9621 - val_precision: 0.9588
Epoch 7/10
235/234 [==============================] - 142s 604ms/step - loss: 0.0762 - accuracy: 0.9760 - recall: 0.9635 - precision: 0.9608 - val_loss: 0.0028 - val_accuracy: 0.9348 - val_recall: 0.9639 - val_precision: 0.9625
Epoch 8/10
235/234 [==============================] - 142s 603ms/step - loss: 0.0817 - accuracy: 0.9728 - recall: 0.9646 - precision: 0.9636 - val_loss: 0.0415 - val_accuracy: 0.9562 - val_recall: 0.9659 - val_precision: 0.9644
Epoch 9/10
235/234 [==============================] - 142s 603ms/step - loss: 0.0833 - accuracy: 0.9731 - recall: 0.9668 - precision: 0.9651 - val_loss: 0.2688 - val_accuracy: 0.9466 - val_recall: 0.9679 - val_precision: 0.9654
Epoch 10/10
235/234 [==============================] - 142s 603ms/step - loss: 0.0750 - accuracy: 0.9747 - recall: 0.9689 - precision: 0.9657 - val_loss: 0.1207 - val_accuracy: 0.9615 - val_recall: 0.9697 - val_precision: 0.9663</code></pre>
<section id="training-performance" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="training-performance">Training performance</h2>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot training and validation accuracy by epoch</span></span>
<span id="cb11-2">acc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_history.history[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'accuracy'</span>]</span>
<span id="cb11-3">val_acc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_history.history[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_accuracy'</span>]</span>
<span id="cb11-4"></span>
<span id="cb11-5">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(acc))</span>
<span id="cb11-6"></span>
<span id="cb11-7">plt.plot(epochs, acc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Training accuracy'</span>)</span>
<span id="cb11-8">plt.plot(epochs, val_acc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Validation accuracy'</span>)</span>
<span id="cb11-9">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Training and validation accuracy'</span>)</span>
<span id="cb11-10">plt.legend()</span>
<span id="cb11-11">plt.figure()</span></code></pre></div>
<pre><code>&lt;Figure size 432x288 with 0 Axes&gt;</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/04/output_16_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<pre><code>&lt;Figure size 432x288 with 0 Axes&gt;</code></pre>
</section>
</section>
<section id="model-evaluation" class="level1 page-columns page-full">
<h1>Model evaluation</h1>
<p>Now we’ll evaluate the model using the test set.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">test_datagen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataGenerator(rescale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>,</span>
<span id="cb14-2">                                    rotation_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb14-3">                                    width_shift_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb14-4">                                    height_shift_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb14-5"></span>
<span id="cb14-6">test_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_datagen.flow_from_directory(</span>
<span id="cb14-7">    directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>,</span>
<span id="cb14-8">    target_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(SIZE, SIZE),</span>
<span id="cb14-9">    class_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"binary"</span>,</span>
<span id="cb14-10">    shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb14-11">    batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH</span>
<span id="cb14-12">)</span>
<span id="cb14-13"></span>
<span id="cb14-14">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict_generator(generator<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>test_generator) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get proba predictions</span></span>
<span id="cb14-15">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert proba to classes</span></span></code></pre></div>
<pre><code>Found 1172 images belonging to 2 classes.</code></pre>
<section id="confusion-matrix" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="confusion-matrix">Confusion matrix</h2>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> confusion_matrix</span>
<span id="cb16-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mlxtend.plotting <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> plot_confusion_matrix</span>
<span id="cb16-3">CM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> confusion_matrix(test_generator.classes, labels)</span>
<span id="cb16-4">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_confusion_matrix(conf_mat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>CM ,  figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb16-5">plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/04/output_21_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
</section>
<section id="classification-report" class="level2">
<h2 class="anchored" data-anchor-id="classification-report">Classification report</h2>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> classification_report</span>
<span id="cb17-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(classification_report(test_generator.classes, labels))</span></code></pre></div>
<pre><code>              precision    recall  f1-score   support

           0       0.95      0.92      0.94       317
           1       0.97      0.98      0.98       855

    accuracy                           0.97      1172
   macro avg       0.96      0.95      0.96      1172
weighted avg       0.97      0.97      0.97      1172</code></pre>


<!-- -->

</section>
</section>

 ]]></description>
  <category>machine-learning</category>
  <category>python</category>
  <guid>https://tylerburleigh.com/blog/2020/04/04/</guid>
  <pubDate>Sat, 04 Apr 2020 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2020/04/04/social-image.png" medium="image" type="image/png" height="108" width="144"/>
</item>
<item>
  <title>Using tensorflow with EfficientNet to predict plant diseases</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2020/04/01/</link>
  <description><![CDATA[ 





<p>As I continue to practice using tensorflow for image recognition tasks, I thought I would experiment with the <a href="https://www.kaggle.com/c/plant-pathology-2020-fgvc7">Plant Pathology</a> dataset on Kaggle. Like MNIST, this is an image recognition challenge. But in contrast to the simplicity of MNIST, this challenge is about making “fine-grained” visual discriminations. The images are larger and in RGB color, and the features are smaller and more nuanced.</p>
<p>I ran into a few challenges here because the task was so compute intensive. The first challenge was getting tensorflow setup and working with my ultrabook’s GPU instead of the CPU. This was an important step to speed up how quickly I could iterate on models. The second challenge was getting past the initial poor performance of a custom convolutional neural network. I noticed that some Kagglers were using <a href="https://github.com/qubvel/efficientnet#about-efficientnet-models">EfficientNet</a> as a base model, so I decided to give that a try.</p>
<p><a href="https://github.com/qubvel/efficientnet">EfficientNet</a> is a CNN derived from ImageNet with similar accuracy but “an order of magnitude fewer parameters and FLOPS”. In other words, it’s a really efficient drop-in replacement for ImageNet. Once I added this as a base model, I quickly reached high validation accuracy in relatively few epochs.</p>
<p>I’m starting to understand better the value of training these models with lots of compute power. My ultrabook’s GPU only has 4GB memory, which imposed a significant limitation on the batch size and image size that I could train the model with. In comparison to this, when I used a GPU-powered notebook on Kaggle that has 15GB of GPU memory, I was able to train on batch sizes and image sizes almost twice as large, which allowed the model to reach higher validation accuracy.</p>
<p>Using the code below, I was able to reach 91% validation accuracy. With large batch and image size settings on Kaggle, this model reached 94% test accuracy (<a href="https://www.kaggle.com/bluewizard/plant-pathology-prediction-with-efficientnet">see here</a>).</p>
<section id="read-in-datalibraries" class="level1 page-columns page-full">
<h1>Read in data/libraries</h1>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#!kaggle competitions download -c plant-pathology-2020-fgvc7</span></span></code></pre></div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-3"></span>
<span id="cb2-4">train <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>)</span>
<span id="cb2-5">test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Append ".jpg" to make things easier later</span></span>
<span id="cb2-8">train[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.jpg'</span></span>
<span id="cb2-9">test[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.jpg'</span></span></code></pre></div>
<p>Check devices available. Hopefully we see a GPU :)</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tensorflow <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tf</span>
<span id="cb3-2"></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check devices</span></span>
<span id="cb3-4">tf.config.list_physical_devices(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span></code></pre></div>
<pre><code>[PhysicalDevice(name='/physical_device:CPU:0', device_type='CPU'),
 PhysicalDevice(name='/physical_device:GPU:0', device_type='GPU')]</code></pre>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">train.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
image_id
</th>
<th>
healthy
</th>
<th>
multiple_diseases
</th>
<th>
rust
</th>
<th>
scab
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Train_0.jpg
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Train_1.jpg
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Train_2.jpg
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
</tr>
<tr>
<th>
3
</th>
<td>
Train_3.jpg
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
<td>
0
</td>
</tr>
<tr>
<th>
4
</th>
<td>
Train_4.jpg
</td>
<td>
1
</td>
<td>
0
</td>
<td>
0
</td>
<td>
0
</td>
</tr>
</tbody>
</table>
</div>
<p>Let’s take a look at some of these images.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> image <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mpimg</span>
<span id="cb6-3"></span>
<span id="cb6-4">IMG_PATH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'images/'</span></span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>):</span>
<span id="cb6-7">    plt.imshow(mpimg.imread(IMG_PATH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> train.iloc[i,:][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>]))</span>
<span id="cb6-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> train.iloc[i,:][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'healthy'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb6-9">        plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'healthy'</span>)</span>
<span id="cb6-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> train.iloc[i,:][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'multiple_diseases'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb6-11">        plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'multiple_diseases'</span>)</span>
<span id="cb6-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> train.iloc[i,:][<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rust'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb6-13">        plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rust'</span>)</span>
<span id="cb6-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb6-15">        plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'scab'</span>)</span>
<span id="cb6-16">    plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/01/output_7_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/01/output_7_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/01/output_7_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/01/output_7_3.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/01/output_7_4.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
</section>
<section id="model-with-efficientnet-transfer-learning" class="level1 page-columns page-full">
<h1>Model with EfficientNet Transfer Learning</h1>
<p>Now we’ll train a model using EfficientNet transfer learning.</p>
<p>For this model, we will use the following:</p>
<ul>
<li>A variety of image augmentations</li>
<li>A ModelCheckpoint callback, so we can load the best model at the end</li>
<li>ReduceLROnPlateau to reduce the learning rate when the training gets stuck</li>
<li>SigmoidFocalCrossEntropy loss function, which is good for imbalanced classes</li>
<li>128x128 image sizes, because my GPU only has 4GB of memory :)</li>
</ul>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training-validation split</span></span>
<span id="cb7-4">training, validation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(train, </span>
<span id="cb7-5">                                        test_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb7-6">                                        random_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span></code></pre></div>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tensorflow.keras.preprocessing.image <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ImageDataGenerator</span>
<span id="cb8-2"></span>
<span id="cb8-3">SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb8-4">BATCH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb8-5">TARGETS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'healthy'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'multiple_diseases'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rust'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'scab'</span>]</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># image augmentations</span></span>
<span id="cb8-8">image_gen <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataGenerator(rescale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>,</span>
<span id="cb8-9">                                rotation_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>,</span>
<span id="cb8-10">                                width_shift_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb8-11">                                height_shift_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb8-12">                                zoom_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>,</span>
<span id="cb8-13">                                brightness_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>],</span>
<span id="cb8-14">                                horizontal_flip<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb8-15">                                vertical_flip<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb8-16"></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># flow_from_dataframe generators</span></span>
<span id="cb8-18">train_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image_gen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-19">    .flow_from_dataframe(train,</span>
<span id="cb8-20">                        directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>IMG_PATH,</span>
<span id="cb8-21">                        target_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(SIZE, SIZE),</span>
<span id="cb8-22">                        x_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_id"</span>,</span>
<span id="cb8-23">                        y_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>TARGETS,</span>
<span id="cb8-24">                        class_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'raw'</span>,</span>
<span id="cb8-25">                        shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb8-26">                        batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH)</span>
<span id="cb8-27"></span>
<span id="cb8-28">validation_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image_gen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-29">    .flow_from_dataframe(validation,</span>
<span id="cb8-30">                        directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>IMG_PATH,</span>
<span id="cb8-31">                        target_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(SIZE, SIZE),</span>
<span id="cb8-32">                        x_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_id"</span>,</span>
<span id="cb8-33">                        y_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>TARGETS,</span>
<span id="cb8-34">                        class_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'raw'</span>,</span>
<span id="cb8-35">                        shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb8-36">                        batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH)</span>
<span id="cb8-37"></span>
<span id="cb8-38">test_generator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> image_gen<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-39">    .flow_from_dataframe(test,</span>
<span id="cb8-40">                        directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>IMG_PATH,</span>
<span id="cb8-41">                        target_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(SIZE, SIZE),</span>
<span id="cb8-42">                        x_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"image_id"</span>,</span>
<span id="cb8-43">                        y_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb8-44">                        class_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb8-45">                        shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb8-46">                        batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH)</span></code></pre></div>
<pre><code>Found 1821 validated image filenames.
Found 365 validated image filenames.
Found 1821 validated image filenames.</code></pre>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> efficientnet.keras <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> efn </span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tensorflow_addons <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tfa</span>
<span id="cb10-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tensorflow.keras.callbacks <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Callback</span>
<span id="cb10-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.models <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Model</span>
<span id="cb10-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.layers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Dense, GlobalAveragePooling2D</span>
<span id="cb10-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.callbacks <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ReduceLROnPlateau, ModelCheckpoint</span>
<span id="cb10-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> keras.optimizers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Adadelta</span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Callbacks</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Keep the best model</span></span>
<span id="cb10-11">mc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ModelCheckpoint(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model.hdf5'</span>, save_best_only<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, monitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_loss'</span>, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min'</span>)</span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Reduce learning rate if it gets stuck in a plateau</span></span>
<span id="cb10-14">rlr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ReduceLROnPlateau(monitor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_loss'</span>, factor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, patience<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, min_lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.000001</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-15"></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Define the base model with EfficientNet weights</span></span>
<span id="cb10-18">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> efn.EfficientNetB4(weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imagenet'</span>, </span>
<span id="cb10-19">                           include_top <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, </span>
<span id="cb10-20">                           input_shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (SIZE, SIZE, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb10-21"></span>
<span id="cb10-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Output layer</span></span>
<span id="cb10-23">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.output</span>
<span id="cb10-24">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GlobalAveragePooling2D()(x)</span>
<span id="cb10-25">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dense(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"relu"</span>)(x)</span>
<span id="cb10-26">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dense(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"relu"</span>)(x)</span>
<span id="cb10-27">predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dense(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, activation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"softmax"</span>)(x)</span>
<span id="cb10-28"></span>
<span id="cb10-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Compile and run</span></span>
<span id="cb10-30">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Model(inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>predictions)</span>
<span id="cb10-31"></span>
<span id="cb10-32">model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">compile</span>(optimizer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'adam'</span>,</span>
<span id="cb10-33">              loss<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tfa.losses.SigmoidFocalCrossEntropy(), </span>
<span id="cb10-34">              metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'accuracy'</span>])</span>
<span id="cb10-35"></span>
<span id="cb10-36">model_history <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.fit(train_generator,</span>
<span id="cb10-37">                            validation_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>validation_generator,</span>
<span id="cb10-38">                            steps_per_epoch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>train_generator.n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>BATCH,</span>
<span id="cb10-39">                            validation_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>validation_generator.n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>BATCH,</span>
<span id="cb10-40">                            epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb10-41">                            verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb10-42">                            callbacks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rlr, mc])</span></code></pre></div>
<pre><code>Epoch 1/7
114/113 [==============================] - 96s 844ms/step - loss: 0.1770 - accuracy: 0.6425 - val_loss: 0.2638 - val_accuracy: 0.7589
Epoch 2/7
114/113 [==============================] - 68s 595ms/step - loss: 0.1193 - accuracy: 0.8034 - val_loss: 0.1677 - val_accuracy: 0.7890
Epoch 3/7
114/113 [==============================] - 68s 597ms/step - loss: 0.1116 - accuracy: 0.8276 - val_loss: 0.1171 - val_accuracy: 0.8137
Epoch 4/7
114/113 [==============================] - 68s 597ms/step - loss: 0.0851 - accuracy: 0.8655 - val_loss: 0.1628 - val_accuracy: 0.8630
Epoch 5/7
114/113 [==============================] - 69s 601ms/step - loss: 0.0758 - accuracy: 0.8836 - val_loss: 0.0551 - val_accuracy: 0.9068
Epoch 6/7
114/113 [==============================] - 68s 600ms/step - loss: 0.0724 - accuracy: 0.8984 - val_loss: 0.0455 - val_accuracy: 0.9096
Epoch 7/7
114/113 [==============================] - 69s 602ms/step - loss: 0.0714 - accuracy: 0.8874 - val_loss: 0.0827 - val_accuracy: 0.8959</code></pre>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load best model</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#model.load_weights("model.hdf5")</span></span></code></pre></div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot training and validation accuracy</span></span>
<span id="cb13-2">acc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_history.history[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'accuracy'</span>]</span>
<span id="cb13-3">val_acc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_history.history[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_accuracy'</span>]</span>
<span id="cb13-4">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_history.history[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'loss'</span>]</span>
<span id="cb13-5">val_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_history.history[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val_loss'</span>]</span>
<span id="cb13-6"></span>
<span id="cb13-7">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(acc))</span>
<span id="cb13-8"></span>
<span id="cb13-9">plt.plot(epochs, acc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Training accuracy'</span>)</span>
<span id="cb13-10">plt.plot(epochs, val_acc, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Validation accuracy'</span>)</span>
<span id="cb13-11">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Training and validation accuracy'</span>)</span>
<span id="cb13-12">plt.legend()</span>
<span id="cb13-13">plt.figure()</span></code></pre></div>
<pre><code>&lt;Figure size 432x288 with 0 Axes&gt;</code></pre>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/04/01/output_13_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<pre><code>&lt;Figure size 432x288 with 0 Axes&gt;</code></pre>
</section>
<section id="make-predictions" class="level1">
<h1>Make predictions</h1>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make predictions</span></span>
<span id="cb16-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.predict(test_generator, steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>test_generator.n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>BATCH)</span></code></pre></div>
</section>
<section id="prepare-submission" class="level1">
<h1>Prepare submission</h1>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make submission</span></span>
<span id="cb17-2">sample_sub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>)</span>
<span id="cb17-3"></span>
<span id="cb17-4">submission <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>: sample_sub[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>],</span>
<span id="cb17-5">                           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'healthy'</span>: preds[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb17-6">                           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'multiple_diseases'</span>: preds[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb17-7">                           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rust'</span>: preds[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb17-8">                           <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'scab'</span>: preds[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb17-9">                         })</span>
<span id="cb17-10">submission.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"submission.csv"</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb17-11">submission.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
image_id
</th>
<th>
healthy
</th>
<th>
multiple_diseases
</th>
<th>
rust
</th>
<th>
scab
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Test_0
</td>
<td>
0.092860
</td>
<td>
0.169678
</td>
<td>
0.656923
</td>
<td>
0.080539
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Test_1
</td>
<td>
0.111859
</td>
<td>
0.198063
</td>
<td>
0.606325
</td>
<td>
0.083752
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Test_2
</td>
<td>
0.026520
</td>
<td>
0.044308
</td>
<td>
0.003016
</td>
<td>
0.926157
</td>
</tr>
<tr>
<th>
3
</th>
<td>
Test_3
</td>
<td>
0.604854
</td>
<td>
0.147050
</td>
<td>
0.111277
</td>
<td>
0.136820
</td>
</tr>
<tr>
<th>
4
</th>
<td>
Test_4
</td>
<td>
0.078862
</td>
<td>
0.118420
</td>
<td>
0.750966
</td>
<td>
0.051751
</td>
</tr>
</tbody>
</table>
</div>


<!-- -->

</section>

 ]]></description>
  <category>machine-learning</category>
  <category>python</category>
  <guid>https://tylerburleigh.com/blog/2020/04/01/</guid>
  <pubDate>Wed, 01 Apr 2020 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2020/04/01/social-image.png" medium="image" type="image/png" height="101" width="144"/>
</item>
<item>
  <title>COVID-19 case growth and the Big 5 Personality traits</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2020/03/21/</link>
  <description><![CDATA[ 





<p>Here I pose the following question:</p>
<blockquote class="blockquote">
<p>Does the growth in COVID-19 cases have anything to do with Big 5 Personality traits?</p>
</blockquote>
<p>To answer this question, I will need country-level aggregates on the Big 5 test, and a country-level aggregate that represents for “growth” over time in coronavirus cases.</p>
<p>Here’s how I operationalize it: I take all the countries that reached at least 50 “confirmed cases” of the coronavirus, using data that’s up to date as of March 20, 2020. Then I take the number of cases those countries had 14-days after reaching 50 confirmed cases. This gives an estimate of growth within a country that can be compared across countries, because it puts them all on a level playing-field.</p>
<p>Next, I compute country-level averages on the Big 5 Personality Test using data from the Open Source Psychometrics Project, and I only include countries with at least 1000 observations.</p>
<p>Finally, I look at the correlation between Confirmed Cases at Day 14 and average scores on each of the Big 5 personality traits (openness, conscientiousness, extraversion, agreeableness, neuroticism [a.k.a. emotional stability]).</p>
<p>For easy reference, the following datasets are used:</p>
<ul>
<li><a href="https://www.kaggle.com/c/covid19-global-forecasting-week-1/data">COVID19 Global Forecasting (Week 1)</a></li>
<li><a href="https://www.kaggle.com/tunguz/big-five-personality-test">Big Five Personality Test</a></li>
<li><a href="https://www.kaggle.com/juanumusic/countries-iso-codes">Countries ISO Codes</a></li>
</ul>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pearsonr</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> kaggle</span></code></pre></div>
<section id="covid-19-data" class="level1">
<h1>COVID-19 Data</h1>
<p>For the COVID-19 data, we’ll get the number of cases at 2-weeks after the first 50 confirmed cases.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from kaggle</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !kaggle competitions download -f train.csv covid19-global-forecasting-week-1</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !kaggle competitions download -f test.csv covid19-global-forecasting-week-1</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Join the training and test sets</span></span>
<span id="cb2-6">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.concat([pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>), pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>)])</span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sort by date</span></span>
<span id="cb2-8">covid19.sort_values(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>)</span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter to the columns we need</span></span>
<span id="cb2-10">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19.loc[:, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ConfirmedCases'</span>]]</span>
<span id="cb2-11"></span>
<span id="cb2-12">covid19.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Country/Region
</th>
<th>
Date
</th>
<th>
ConfirmedCases
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Afghanistan
</td>
<td>
2020-01-22
</td>
<td>
0.0
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Afghanistan
</td>
<td>
2020-01-23
</td>
<td>
0.0
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Afghanistan
</td>
<td>
2020-01-24
</td>
<td>
0.0
</td>
</tr>
<tr>
<th>
3
</th>
<td>
Afghanistan
</td>
<td>
2020-01-25
</td>
<td>
0.0
</td>
</tr>
<tr>
<th>
4
</th>
<td>
Afghanistan
</td>
<td>
2020-01-26
</td>
<td>
0.0
</td>
</tr>
</tbody>
</table>
</div>
<section id="filter" class="level2">
<h2 class="anchored" data-anchor-id="filter">Filter</h2>
<p>Next we’ll filter to countries that reached at least 50 confirmed cases, and had at least 14 days of data beyond reaching that point.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19[covid19.ConfirmedCases <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>]</span>
<span id="cb3-2">covid19_numdays <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19.loc[:, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>]]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-3">    .drop_duplicates()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-4">    .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-5">    .count()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-6">    .rename_axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-7">    .reset_index()</span>
<span id="cb3-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(covid19_numdays.head())</span>
<span id="cb3-9"></span>
<span id="cb3-10">covid19_mindays <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19_numdays[covid19_numdays.Date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>].reset_index()</span>
<span id="cb3-11">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19[covid19[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>].isin(covid19_mindays.country)].reset_index()</span></code></pre></div>
<pre><code>     country  Date
0    Albania     5
1    Algeria     5
2    Andorra     2
3  Argentina     5
4    Armenia     5</code></pre>
<p>What/how many countries does that leave us with?</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(covid19[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>].values))))</span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(covid19[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>].values))</span></code></pre></div>
<pre><code>21
{'Cruise Ship', 'Spain', 'United Kingdom', 'Singapore', 'Sweden', 'Kuwait', 'Bahrain', 'Germany', 'Iraq', 'Austria', 'Korea, South', 'Norway', 'China', 'Netherlands', 'Belgium', 'France', 'Malaysia', 'Switzerland', 'Iran', 'Japan', 'Italy'}</code></pre>
<p>Obviously “Cruise Ship” isn’t a country. I won’t worry about it at this point, since it will get filtered out in later steps.</p>
</section>
<section id="compute-growth-over-14-days" class="level2">
<h2 class="anchored" data-anchor-id="compute-growth-over-14-days">Compute growth over 14 days</h2>
<p>Next, we’ll compute the growth in cases for each country, from the date they reached 50 Confirmed Cases to the 14th day following that date. First we’ll need to collapse over province, since some countries are represented multiple times under different provinces.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">covid19[covid19[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'China'</span>].head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
index
</th>
<th>
Country/Region
</th>
<th>
Date
</th>
<th>
ConfirmedCases
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
47
</th>
<td>
2777
</td>
<td>
China
</td>
<td>
2020-01-26
</td>
<td>
60.0
</td>
</tr>
<tr>
<th>
48
</th>
<td>
2778
</td>
<td>
China
</td>
<td>
2020-01-27
</td>
<td>
70.0
</td>
</tr>
<tr>
<th>
49
</th>
<td>
2779
</td>
<td>
China
</td>
<td>
2020-01-28
</td>
<td>
106.0
</td>
</tr>
<tr>
<th>
50
</th>
<td>
2780
</td>
<td>
China
</td>
<td>
2020-01-29
</td>
<td>
152.0
</td>
</tr>
<tr>
<th>
51
</th>
<td>
2781
</td>
<td>
China
</td>
<td>
2020-01-30
</td>
<td>
200.0
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">covid19_collapse_province <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-2">    .groupby([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Date'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-3">    .<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb8-4">    .reset_index()</span>
<span id="cb8-5">covid19_collapse_province[covid19_collapse_province[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'China'</span>].head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Country/Region
</th>
<th>
Date
</th>
<th>
index
</th>
<th>
ConfirmedCases
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
47
</th>
<td>
China
</td>
<td>
2020-01-22
</td>
<td>
3540
</td>
<td>
444.0
</td>
</tr>
<tr>
<th>
48
</th>
<td>
China
</td>
<td>
2020-01-23
</td>
<td>
3541
</td>
<td>
444.0
</td>
</tr>
<tr>
<th>
49
</th>
<td>
China
</td>
<td>
2020-01-24
</td>
<td>
6612
</td>
<td>
602.0
</td>
</tr>
<tr>
<th>
50
</th>
<td>
China
</td>
<td>
2020-01-25
</td>
<td>
14172
</td>
<td>
958.0
</td>
</tr>
<tr>
<th>
51
</th>
<td>
China
</td>
<td>
2020-01-26
</td>
<td>
26818
</td>
<td>
1628.0
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19_collapse_province<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb9-2">    .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb9-3">    .head(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb9-4">    .groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb9-5">    .tail(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-6"></span>
<span id="cb9-7">covid19</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Country/Region
</th>
<th>
Date
</th>
<th>
index
</th>
<th>
ConfirmedCases
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
13
</th>
<td>
Austria
</td>
<td>
2020-03-19
</td>
<td>
1060
</td>
<td>
2013.0
</td>
</tr>
<tr>
<th>
28
</th>
<td>
Bahrain
</td>
<td>
2020-03-17
</td>
<td>
1176
</td>
<td>
228.0
</td>
</tr>
<tr>
<th>
45
</th>
<td>
Belgium
</td>
<td>
2020-03-19
</td>
<td>
1414
</td>
<td>
1795.0
</td>
</tr>
<tr>
<th>
60
</th>
<td>
China
</td>
<td>
2020-02-04
</td>
<td>
90949
</td>
<td>
23524.0
</td>
</tr>
<tr>
<th>
119
</th>
<td>
Cruise Ship
</td>
<td>
2020-02-20
</td>
<td>
5103
</td>
<td>
634.0
</td>
</tr>
<tr>
<th>
162
</th>
<td>
France
</td>
<td>
2020-03-12
</td>
<td>
6009
</td>
<td>
2281.0
</td>
</tr>
<tr>
<th>
184
</th>
<td>
Germany
</td>
<td>
2020-03-13
</td>
<td>
6718
</td>
<td>
3675.0
</td>
</tr>
<tr>
<th>
205
</th>
<td>
Iran
</td>
<td>
2020-03-08
</td>
<td>
7657
</td>
<td>
6566.0
</td>
</tr>
<tr>
<th>
231
</th>
<td>
Iraq
</td>
<td>
2020-03-20
</td>
<td>
7728
</td>
<td>
208.0
</td>
</tr>
<tr>
<th>
245
</th>
<td>
Italy
</td>
<td>
2020-03-06
</td>
<td>
7891
</td>
<td>
4636.0
</td>
</tr>
<tr>
<th>
273
</th>
<td>
Japan
</td>
<td>
2020-02-29
</td>
<td>
8003
</td>
<td>
241.0
</td>
</tr>
<tr>
<th>
307
</th>
<td>
Korea, South
</td>
<td>
2020-03-04
</td>
<td>
8302
</td>
<td>
5621.0
</td>
</tr>
<tr>
<th>
337
</th>
<td>
Kuwait
</td>
<td>
2020-03-15
</td>
<td>
8431
</td>
<td>
112.0
</td>
</tr>
<tr>
<th>
356
</th>
<td>
Malaysia
</td>
<td>
2020-03-19
</td>
<td>
8907
</td>
<td>
900.0
</td>
</tr>
<tr>
<th>
371
</th>
<td>
Netherlands
</td>
<td>
2020-03-18
</td>
<td>
9909
</td>
<td>
2051.0
</td>
</tr>
<tr>
<th>
387
</th>
<td>
Norway
</td>
<td>
2020-03-17
</td>
<td>
10144
</td>
<td>
1463.0
</td>
</tr>
<tr>
<th>
404
</th>
<td>
Singapore
</td>
<td>
2020-02-26
</td>
<td>
11481
</td>
<td>
93.0
</td>
</tr>
<tr>
<th>
441
</th>
<td>
Spain
</td>
<td>
2020-03-14
</td>
<td>
11793
</td>
<td>
6391.0
</td>
</tr>
<tr>
<th>
461
</th>
<td>
Sweden
</td>
<td>
2020-03-18
</td>
<td>
12033
</td>
<td>
1279.0
</td>
</tr>
<tr>
<th>
477
</th>
<td>
Switzerland
</td>
<td>
2020-03-16
</td>
<td>
12090
</td>
<td>
2200.0
</td>
</tr>
<tr>
<th>
495
</th>
<td>
United Kingdom
</td>
<td>
2020-03-16
</td>
<td>
16456
</td>
<td>
1543.0
</td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="country-abbreviations" class="level1">
<h1>Country Abbreviations</h1>
<p>Next we’ll join in the country abbreviation codes. The source data here comes from the Kaggle <a href="https://www.kaggle.com/juanumusic/countries-iso-codes">Countries ISO Codes dataset</a>, and the original source is Wikipedia. This will allow us to join to the Big 5 dataset later.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !kaggle datasets download juanumusic/countries-iso-codes -f wikipedia-iso-country-codes.csv</span></span>
<span id="cb10-2">country_isos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'wikipedia-iso-country-codes.csv'</span>)</span>
<span id="cb10-3">country_isos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> country_isos.rename(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"English short name lower case"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Country/Region"</span>, </span>
<span id="cb10-4">                                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Alpha-2 code"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country_abbr"</span>})</span>
<span id="cb10-5">country_isos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> country_isos.loc[:, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_abbr'</span>]]</span>
<span id="cb10-6">country_isos.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Country/Region
</th>
<th>
country_abbr
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Afghanistan
</td>
<td>
AF
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Åland Islands
</td>
<td>
AX
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Albania
</td>
<td>
AL
</td>
</tr>
<tr>
<th>
3
</th>
<td>
Algeria
</td>
<td>
DZ
</td>
</tr>
<tr>
<th>
4
</th>
<td>
American Samoa
</td>
<td>
AS
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19.merge(country_isos, left_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>, right_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Country/Region'</span>)</span>
<span id="cb11-2">covid19 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19.dropna()</span>
<span id="cb11-3">covid19.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Country/Region
</th>
<th>
Date
</th>
<th>
index
</th>
<th>
ConfirmedCases
</th>
<th>
country_abbr
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Austria
</td>
<td>
2020-03-19
</td>
<td>
1060
</td>
<td>
2013.0
</td>
<td>
AT
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Bahrain
</td>
<td>
2020-03-17
</td>
<td>
1176
</td>
<td>
228.0
</td>
<td>
BH
</td>
</tr>
<tr>
<th>
2
</th>
<td>
Belgium
</td>
<td>
2020-03-19
</td>
<td>
1414
</td>
<td>
1795.0
</td>
<td>
BE
</td>
</tr>
<tr>
<th>
3
</th>
<td>
China
</td>
<td>
2020-02-04
</td>
<td>
90949
</td>
<td>
23524.0
</td>
<td>
CN
</td>
</tr>
<tr>
<th>
4
</th>
<td>
France
</td>
<td>
2020-03-12
</td>
<td>
6009
</td>
<td>
2281.0
</td>
<td>
FR
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="big-five-personality-data" class="level1 page-columns page-full">
<h1>Big Five Personality Data</h1>
<p>Next, we’ll fetch the <a href="https://www.kaggle.com/tunguz/big-five-personality-test">Big Five Personality Test data from Kaggle</a>. This dataset contains ~1M answers collected online by <a href="https://openpsychometrics.org/tests/IPIP-BFFM">Open Psychometrics</a>. I’m interested in this dataset because it also labels the country in which the respondant is located. We can use this dataset to get country-level aggregate data on personality traits, and then see if those traits map onto the COVID-19 outcomes that we’re seeing.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !kaggle datasets download tunguz/big-five-personality-test -f IPIP-FFM-data-8Nov2018/data-final.csv</span></span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The file was zipped because it was so big, so unzip it</span></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import zipfile</span></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with zipfile.ZipFile('data-final.csv.zip', 'r') as zip_ref:</span></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     zip_ref.extractall()</span></span>
<span id="cb12-8"></span>
<span id="cb12-9">big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data-final.csv'</span>, sep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<section id="scoring-the-big-five-personality-test-items" class="level2">
<h2 class="anchored" data-anchor-id="scoring-the-big-five-personality-test-items">Scoring the Big Five Personality Test items</h2>
<p>The Big 5 personality inventory contains 5 factors. Like most personality scales, the Big 5 has a mix of items that positively and negatively load onto these personality factors. For example, the factor Extraversion describes someone who is outgoing, energetic, talkative, and enjoys human interaction. The first Extraversion item [<code>EXT1</code>] is “I am the life of the party.”, a positively-keyed item; whereas the second item [<code>EXT2</code>] is “I don’t talk a lot.”, a negatively-keyed item.</p>
<p>To find out which items are positively or negatively keyed, we can look at the scale documentation on the IPIP website: https://ipip.ori.org/newBigFive5broadKey.htm</p>
</section>
<section id="reverse-coding" class="level2">
<h2 class="anchored" data-anchor-id="reverse-coding">Reverse-coding</h2>
<p>Before analyzing the data from a personality test, a psychologist will generally “reverse-code” the items that are negatively-keyed. This results in a dataset where the item values all have a common direction and interpretetion (i.e., a higher value corresponds with more of that trait). Mathematically, it allows you to then compute sums and averages for each of the factors. For example, after scoring the test items, we could compute an individual’s average for Extraversion items to get their Extraversion score.</p>
<p>This version of the Big 5 scale asks individuals to rate their level of agreement from 1 to 5, where 1 is strong disagreement and 5 is strong agreement. Reverse-coding is as simple as subtracting 6 from every reverse-keyed item.</p>
<p>The code below will accomplish this task.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">positively_keyed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT5'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT7'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT9'</span>,</span>
<span id="cb13-2">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST5'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST6'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST7'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST8'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST9'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST10'</span>,</span>
<span id="cb13-3">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR4'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR6'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR8'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR9'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR10'</span>,</span>
<span id="cb13-4">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN5'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN7'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN9'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN10'</span>, </span>
<span id="cb13-5">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN5'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN7'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN8'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN9'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN10'</span>]</span>
<span id="cb13-6"></span>
<span id="cb13-7">negatively_keyed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT4'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT6'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT8'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT10'</span>,</span>
<span id="cb13-8">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST4'</span>,</span>
<span id="cb13-9">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR5'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR7'</span>, </span>
<span id="cb13-10">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN4'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN6'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN8'</span>, </span>
<span id="cb13-11">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN4'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN6'</span>]</span></code></pre></div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">big5.loc[:, negatively_keyed] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> big5.loc[:, negatively_keyed]</span></code></pre></div>
</section>
<section id="country-level-big-5-aggregates" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="country-level-big-5-aggregates">Country-Level Big 5 Aggregates</h2>
<p>First, we should eliminate any country that doesn’t have very many observations. Somewhat arbitrarily, we’ll draw a line at N = 1000.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">big5_country_count <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.country<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-2">    .value_counts()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-3">    .rename_axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb15-4">    .reset_index(name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'counts'</span>)</span>
<span id="cb15-5"></span>
<span id="cb15-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(big5_country_count[big5_country_count.counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>]))</span>
<span id="cb15-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(big5_country_count[big5_country_count.counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>].country.values)</span></code></pre></div>
<pre><code>58
['US' 'GB' 'CA' 'AU' 'PH' 'IN' 'DE' 'NONE' 'NZ' 'NO' 'MY' 'MX' 'SE' 'NL'
 'SG' 'ID' 'BR' 'FR' 'DK' 'IE' 'IT' 'ES' 'PL' 'FI' 'RO' 'BE' 'ZA' 'CO'
 'HK' 'PK' 'RU' 'AR' 'CH' 'AE' 'TR' 'PT' 'GR' 'VN' 'HR' 'AT' 'CL' 'RS'
 'CZ' 'TH' 'JP' 'PE' 'KR' 'HU' 'IL' 'KE' 'CN' 'BG' 'VE' 'EC' 'LT' 'SA'
 'EG' 'EE']</code></pre>
<p>There are 58 countries with at least 1000 observations. Let’s go with these.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5[big5.country.isin(big5_country_count[big5_country_count.counts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>].country.values)]</span>
<span id="cb17-2"></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter on the columns we're going to use</span></span>
<span id="cb17-4">big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:,[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> positively_keyed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> negatively_keyed]</span></code></pre></div>
<section id="factor-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="factor-aggregation">Factor aggregation</h3>
<p>Next, we’ll compute averages for each of the five factors at the level of the individual.</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">EXT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)]</span>
<span id="cb18-2">EST <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)]</span>
<span id="cb18-3">AGR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)]</span>
<span id="cb18-4">CSN <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)]</span>
<span id="cb18-5">OPN <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(i) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)]</span></code></pre></div>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">big5[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:, EXT].mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-2">big5[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:, EST].mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-3">big5[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:, AGR].mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-4">big5[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:, CSN].mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-5">big5[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:, OPN].mean(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-6">big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.loc[:, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>]]</span></code></pre></div>
<p>Drop NAs, and any with country = ‘NONE’</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1">big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.dropna()</span>
<span id="cb20-2">big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5[big5.country <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NONE'</span>]</span></code></pre></div>
</section>
<section id="country-level-averages" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="country-level-averages">Country-level averages</h3>
<p>Now we can calculate the country-level averages.</p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">big5_cavgs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> big5.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb21-2">                    .mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb21-3">                    .rename_axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb21-4">                    .reset_index()</span></code></pre></div>
<p>Just to illustrate, these are the top 5 countries by country-level Extraversion scores.</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1">big5_cavgs.loc[:, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>]]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb22-2">    .sort_values(by<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb22-3">    .tail()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb22-4">    .plot(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>, </span>
<span id="cb22-5">          y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>, </span>
<span id="cb22-6">          kind<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'barh'</span>, </span>
<span id="cb22-7">          legend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb22-8"></span>
<span id="cb22-9">plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_35_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="joining-big-5-country-data-to-covid-19-data" class="level1 page-columns page-full">
<h1>Joining Big 5 Country Data to COVID-19 Data</h1>
<p>Next we’ll merge the COVID-19 dataset to the Big 5, country-level dataset.</p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1">covid19_big5 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> covid19.merge(big5_cavgs, left_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_abbr'</span>, right_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>)</span>
<span id="cb23-2">covid19_big5.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Country/Region
</th>
<th>
Date
</th>
<th>
index
</th>
<th>
ConfirmedCases
</th>
<th>
country_abbr
</th>
<th>
country
</th>
<th>
EXT
</th>
<th>
EST
</th>
<th>
AGR
</th>
<th>
CSN
</th>
<th>
OPN
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
Austria
</td>
<td>
2020-03-19
</td>
<td>
1060
</td>
<td>
2013.0
</td>
<td>
AT
</td>
<td>
AT
</td>
<td>
2.992051
</td>
<td>
2.985863
</td>
<td>
3.678952
</td>
<td>
3.238528
</td>
<td>
4.056052
</td>
</tr>
<tr>
<th>
1
</th>
<td>
Belgium
</td>
<td>
2020-03-19
</td>
<td>
1414
</td>
<td>
1795.0
</td>
<td>
BE
</td>
<td>
BE
</td>
<td>
3.002726
</td>
<td>
3.049043
</td>
<td>
3.761206
</td>
<td>
3.197772
</td>
<td>
3.906212
</td>
</tr>
<tr>
<th>
2
</th>
<td>
China
</td>
<td>
2020-02-04
</td>
<td>
90949
</td>
<td>
23524.0
</td>
<td>
CN
</td>
<td>
CN
</td>
<td>
3.025746
</td>
<td>
2.947836
</td>
<td>
3.725448
</td>
<td>
3.310373
</td>
<td>
3.590299
</td>
</tr>
<tr>
<th>
3
</th>
<td>
France
</td>
<td>
2020-03-12
</td>
<td>
6009
</td>
<td>
2281.0
</td>
<td>
FR
</td>
<td>
FR
</td>
<td>
2.885782
</td>
<td>
3.126319
</td>
<td>
3.688029
</td>
<td>
3.193485
</td>
<td>
4.066059
</td>
</tr>
<tr>
<th>
4
</th>
<td>
Germany
</td>
<td>
2020-03-13
</td>
<td>
6718
</td>
<td>
3675.0
</td>
<td>
DE
</td>
<td>
DE
</td>
<td>
2.874198
</td>
<td>
3.007398
</td>
<td>
3.616373
</td>
<td>
3.220910
</td>
<td>
4.089598
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>]</span>
<span id="cb24-2">factor_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Extraversion'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Emotional Stability'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Agreeableness'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Conscientiousness'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Openness'</span>]</span>
<span id="cb24-3"></span>
<span id="cb24-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, factor <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>]):</span>
<span id="cb24-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the correlation coefficient</span></span>
<span id="cb24-6">    corr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pearsonr(covid19_big5[factor], covid19_big5.ConfirmedCases)</span>
<span id="cb24-7">    corr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(c, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> corr]</span>
<span id="cb24-8">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, p=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (corr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], corr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb24-9">    </span>
<span id="cb24-10">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.regplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>factor, </span>
<span id="cb24-11">                y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ConfirmedCases"</span>, </span>
<span id="cb24-12">                data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>covid19_big5)</span>
<span id="cb24-13">    </span>
<span id="cb24-14">    ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Confirmed cases at 14 days after first 50 cases "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-15">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> by average score on Big 5 factor "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> factor_names[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb24-16">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> text)</span>
<span id="cb24-17">    plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_38_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_38_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_38_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_38_3.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_38_4.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<p>China is perhaps an atypical outlier here because it was where the outbreak started.</p>
<p>Let’s see the plots again without China.</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>]</span>
<span id="cb25-2">factor_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Extraversion'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Emotional Stability'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Agreeableness'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Conscientiousness'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Openness'</span>]</span>
<span id="cb25-3"></span>
<span id="cb25-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, factor <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EXT'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'EST'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AGR'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CSN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>]):</span>
<span id="cb25-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the correlation coefficient</span></span>
<span id="cb25-6">    corr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pearsonr(covid19_big5[covid19_big5.country <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>][factor], </span>
<span id="cb25-7">                    covid19_big5[covid19_big5.country <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>].ConfirmedCases)</span>
<span id="cb25-8">    corr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(c, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> corr]</span>
<span id="cb25-9">    text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, p=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (corr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], corr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb25-10">    </span>
<span id="cb25-11">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.regplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>factor, </span>
<span id="cb25-12">                y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ConfirmedCases"</span>, </span>
<span id="cb25-13">                data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>covid19_big5[covid19_big5.country <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CN'</span>])</span>
<span id="cb25-14">    </span>
<span id="cb25-15">    ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Confirmed cases at 14 days after first 50 cases "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-16">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> by average score on Big 5 factor "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> factor_names[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb25-17">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> text)</span>
<span id="cb25-18">    plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_40_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_40_1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_40_2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_40_3.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/21/output_40_4.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">png</figcaption>
</figure>
</div>
<p>As we see here, the only Big 5 factor that seems to show a pattern was Openness: Countries with higher levels of openness saw more growth over the 14-day period.</p>
<p>Although a skeptic might point out that the countries lower on OPN had too much influence in the model, given how far they are set apart from the other data points, they artificially inflate the degree of fit.</p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">covid19_big5<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb26-2">    .loc[:, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ConfirmedCases'</span>]]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb26-3">    .sort_values(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'OPN'</span>, ascending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb26-4">    .merge(country_isos, </span>
<span id="cb26-5">           left_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>, </span>
<span id="cb26-6">           right_on<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_abbr'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb26-7">    .drop([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country_abbr'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'country'</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
OPN
</th>
<th>
ConfirmedCases
</th>
<th>
Country/Region
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
4.089598
</td>
<td>
3675.0
</td>
<td>
Germany
</td>
</tr>
<tr>
<th>
1
</th>
<td>
4.066059
</td>
<td>
2281.0
</td>
<td>
France
</td>
</tr>
<tr>
<th>
2
</th>
<td>
4.056052
</td>
<td>
2013.0
</td>
<td>
Austria
</td>
</tr>
<tr>
<th>
3
</th>
<td>
4.015059
</td>
<td>
2200.0
</td>
<td>
Switzerland
</td>
</tr>
<tr>
<th>
4
</th>
<td>
3.991518
</td>
<td>
4636.0
</td>
<td>
Italy
</td>
</tr>
<tr>
<th>
5
</th>
<td>
3.974855
</td>
<td>
6391.0
</td>
<td>
Spain
</td>
</tr>
<tr>
<th>
6
</th>
<td>
3.965763
</td>
<td>
1279.0
</td>
<td>
Sweden
</td>
</tr>
<tr>
<th>
7
</th>
<td>
3.942170
</td>
<td>
2051.0
</td>
<td>
Netherlands
</td>
</tr>
<tr>
<th>
8
</th>
<td>
3.916673
</td>
<td>
1463.0
</td>
<td>
Norway
</td>
</tr>
<tr>
<th>
9
</th>
<td>
3.906212
</td>
<td>
1795.0
</td>
<td>
Belgium
</td>
</tr>
<tr>
<th>
10
</th>
<td>
3.901462
</td>
<td>
1543.0
</td>
<td>
United Kingdom
</td>
</tr>
<tr>
<th>
11
</th>
<td>
3.794982
</td>
<td>
241.0
</td>
<td>
Japan
</td>
</tr>
<tr>
<th>
12
</th>
<td>
3.643089
</td>
<td>
93.0
</td>
<td>
Singapore
</td>
</tr>
<tr>
<th>
13
</th>
<td>
3.590299
</td>
<td>
23524.0
</td>
<td>
China
</td>
</tr>
<tr>
<th>
14
</th>
<td>
3.422120
</td>
<td>
900.0
</td>
<td>
Malaysia
</td>
</tr>
</tbody>
</table>
</div>


<!-- -->

</section>

 ]]></description>
  <category>python</category>
  <guid>https://tylerburleigh.com/blog/2020/03/21/</guid>
  <pubDate>Sat, 21 Mar 2020 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2020/03/21/social-image.png" medium="image" type="image/png" height="111" width="144"/>
</item>
<item>
  <title>Using a logistic regression model to predict heart disease</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2020/03/20/</link>
  <description><![CDATA[ 





<p>I decided to explore and model the <a href="https://www.kaggle.com/ronitf/heart-disease-uci">Heart Disease UCI dataset</a> from Kaggle. The original source can be found at the <a href="https://archive.ics.uci.edu/ml/datasets/Heart+Disease">UCI Machine Learning Repository</a>. The dataset contains 303 individuals and 14 attribute observations (the original source data contains additional features). The features included various heart disease-related measurements, like chest pain and resting ECG, as well as age and sex, and represented a mix of binary, categorical, ordinal, and numeric data. The outcome variable represented the presence or absence of heart disease.</p>
<p>I applied a fairly standard machine learning process, beginning with understanding what the data represented – this involved looking at the raw data and reading the data dictionary and other documentation – followed by splitting the data into training and test sets, Exploratory Data Analysis to understand how the features relate to the outcome, feature encoding, model fitting (logistic regression), and model evaluation.</p>
<p>Ultimately, the model was 75% accurate in predicting heart disease. It correctly predicted 46 out of the 61 test cases. Of the errors it made, 5 were false-positive errors and 10 were false-negative errors.</p>
<section id="imports" class="level1">
<h1>Imports</h1>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> kaggle</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># !kaggle datasets download ronitf/heart-disease-uci -f heart.csv -p heart_uci</span></span></code></pre></div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'heart.csv'</span>)</span>
<span id="cb2-2">df.head()</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
age
</th>
<th>
sex
</th>
<th>
cp
</th>
<th>
trestbps
</th>
<th>
chol
</th>
<th>
fbs
</th>
<th>
restecg
</th>
<th>
thalach
</th>
<th>
exang
</th>
<th>
oldpeak
</th>
<th>
slope
</th>
<th>
ca
</th>
<th>
thal
</th>
<th>
target
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
63
</td>
<td>
1
</td>
<td>
3
</td>
<td>
145
</td>
<td>
233
</td>
<td>
1
</td>
<td>
0
</td>
<td>
150
</td>
<td>
0
</td>
<td>
2.3
</td>
<td>
0
</td>
<td>
0
</td>
<td>
1
</td>
<td>
1
</td>
</tr>
<tr>
<th>
1
</th>
<td>
37
</td>
<td>
1
</td>
<td>
2
</td>
<td>
130
</td>
<td>
250
</td>
<td>
0
</td>
<td>
1
</td>
<td>
187
</td>
<td>
0
</td>
<td>
3.5
</td>
<td>
0
</td>
<td>
0
</td>
<td>
2
</td>
<td>
1
</td>
</tr>
<tr>
<th>
2
</th>
<td>
41
</td>
<td>
0
</td>
<td>
1
</td>
<td>
130
</td>
<td>
204
</td>
<td>
0
</td>
<td>
0
</td>
<td>
172
</td>
<td>
0
</td>
<td>
1.4
</td>
<td>
2
</td>
<td>
0
</td>
<td>
2
</td>
<td>
1
</td>
</tr>
<tr>
<th>
3
</th>
<td>
56
</td>
<td>
1
</td>
<td>
1
</td>
<td>
120
</td>
<td>
236
</td>
<td>
0
</td>
<td>
1
</td>
<td>
178
</td>
<td>
0
</td>
<td>
0.8
</td>
<td>
2
</td>
<td>
0
</td>
<td>
2
</td>
<td>
1
</td>
</tr>
<tr>
<th>
4
</th>
<td>
57
</td>
<td>
0
</td>
<td>
0
</td>
<td>
120
</td>
<td>
354
</td>
<td>
0
</td>
<td>
1
</td>
<td>
163
</td>
<td>
1
</td>
<td>
0.6
</td>
<td>
2
</td>
<td>
0
</td>
<td>
2
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
</div>
<p>When I started to explore the data, I noticed that many of the parameters that I would expect from my lay knowledge of heart disease to be positively correlated, were actually pointed in the opposite direction. After reading through some comments in the Kaggle discussion forum, I discovered that others had come to a similar conclusion: the target variable was reversed.</p>
<p>So here I flip it back to how it should be (1 = heart disease; 0 = no heart disease).</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">df.target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.target.replace({<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>})</span></code></pre></div>
<p>I’ll check the target classes to see how balanced they are.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">df.target.value_counts()</span></code></pre></div>
<pre><code>0    165
1    138
Name: target, dtype: int64</code></pre>
<p>Not particularly unbalanced, but we’ll stratify in the train-test split later anyway.</p>
</section>
<section id="feature-descriptions" class="level1">
<h1>Feature descriptions</h1>
<p>First I’ll put the features into groups based on the type of data contained. In order to make these groupings, I’ve used the data dictionary, as well as some helpful comments on Kaggle notebooks and discussion. Some of the documentation turned out to be incorrect, as I learned in my own examination of the data dictionary and confirmed by reading discussions on Kaggle. For example, the target was coded incorrectly (originally, 0 was “had heart disease”), and many of the categorical variable labels were missing.</p>
<section id="binary" class="level2">
<h2 class="anchored" data-anchor-id="binary">Binary</h2>
<ul>
<li><code>sex</code> (0 = female; 1 = male)</li>
<li><code>fbs</code>: Fasting blood sugar &gt; 120 mg/dl</li>
<li><code>exang</code>: Exercise induced angina (0 = no; 1 = yes)</li>
</ul>
</section>
<section id="categorical" class="level2">
<h2 class="anchored" data-anchor-id="categorical">Categorical</h2>
<ul>
<li><code>cp</code>: Chest pain type (0 = Asymptomatic angina; 1 = Atypical angina; 2 = Non-angina; 3 = Typical angina)</li>
<li><code>restecg</code>: Resting ECG (0 = Left ventricular hypertrophy; 1 = Normal; 2 = ST-T wave abnormality)</li>
<li><code>slope</code>: Slope of the peak exercise ST segment (0 = downsloping; 1 = upsloping; 2 = flat)</li>
<li><code>thal</code>: Thalium stress test result (0 = NA; 1 = Fixed defect; 2 = Normal; 3 = Reversible defect)</li>
</ul>
</section>
<section id="ordinal" class="level2">
<h2 class="anchored" data-anchor-id="ordinal">Ordinal</h2>
<ul>
<li><code>ca</code>: number of major vessels (0-3) colored by flourosopy</li>
</ul>
</section>
<section id="numeric" class="level2">
<h2 class="anchored" data-anchor-id="numeric">Numeric</h2>
<ul>
<li><code>age</code></li>
<li><code>oldpeak</code>: ST depression induced by exercise relative to rest</li>
<li><code>trestbps</code>: Resting blood pressure</li>
<li><code>chol</code>: Serum cholestoral in mg/dl</li>
<li><code>thalach</code>: Maximum heart rate achieved during thalium stress test</li>
</ul>
</section>
<section id="target" class="level2">
<h2 class="anchored" data-anchor-id="target">Target</h2>
<ul>
<li><code>target</code>: 1 = heart disease; 0 = no heart disease</li>
</ul>
<p>I’ll create arrays so the features are easier to access later by type.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fbs'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exang'</span>]</span>
<span id="cb6-2">cats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'restecg'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'slope'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thal'</span>]</span>
<span id="cb6-3">ords <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ca'</span>]</span>
<span id="cb6-4">nums <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'age'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'oldpeak'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trestbps'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'chol'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thalach'</span>]</span>
<span id="cb6-5">target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'target'</span>]</span></code></pre></div>
<p>I’ll recode the categorical variables so the data exploration is easier.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">df.cp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.cp.replace({<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Asympt.'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Atypical'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Non'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Typical'</span>})</span>
<span id="cb7-2">df.restecg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.restecg.replace({<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LV hyper'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ST-T wave'</span>})</span>
<span id="cb7-3">df.slope <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.slope.replace({<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'down'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'up'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'flat'</span>})</span>
<span id="cb7-4">df.thal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.thal.replace({<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NA'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fixed'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Revers.'</span>})</span></code></pre></div>
</section>
</section>
<section id="train-test-split" class="level1">
<h1>Train-test split</h1>
<p>Before exploring the data, I’ll split them into train and test sets.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">X_train, X_test, y_train, y_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(df, </span>
<span id="cb8-2">                                                    df.target, </span>
<span id="cb8-3">                                                    test_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, </span>
<span id="cb8-4">                                                    random_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb8-5">                                                    stratify <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.target)</span></code></pre></div>
</section>
<section id="exploratory-data-analysis" class="level1 page-columns page-full">
<h1>Exploratory data analysis</h1>
<section id="numeric-and-ordinal-descriptives" class="level2">
<h2 class="anchored" data-anchor-id="numeric-and-ordinal-descriptives">Numeric and ordinal descriptives</h2>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">X_train[X_train.target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].drop(cats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> target, </span>
<span id="cb9-2">                                  axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).describe().loc[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mean'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'std'</span>]]</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
age
</th>
<th>
trestbps
</th>
<th>
chol
</th>
<th>
thalach
</th>
<th>
oldpeak
</th>
<th>
ca
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
mean
</th>
<td>
52.598485
</td>
<td>
129.000000
</td>
<td>
247.340909
</td>
<td>
158.280303
</td>
<td>
0.585606
</td>
<td>
0.30303
</td>
</tr>
<tr>
<th>
std
</th>
<td>
9.366058
</td>
<td>
16.414944
</td>
<td>
56.661824
</td>
<td>
18.929082
</td>
<td>
0.759282
</td>
<td>
0.73036
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">X_train[X_train.target <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].drop(cats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> target, </span>
<span id="cb10-2">                                  axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).describe().loc[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mean'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'std'</span>]]</span></code></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
age
</th>
<th>
trestbps
</th>
<th>
chol
</th>
<th>
thalach
</th>
<th>
oldpeak
</th>
<th>
ca
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
mean
</th>
<td>
56.554545
</td>
<td>
134.236364
</td>
<td>
252.190909
</td>
<td>
139.718182
</td>
<td>
1.616364
</td>
<td>
1.090909
</td>
</tr>
<tr>
<th>
std
</th>
<td>
8.085082
</td>
<td>
18.436067
</td>
<td>
49.041547
</td>
<td>
21.377400
</td>
<td>
1.314669
</td>
<td>
1.018593
</td>
</tr>
</tbody>
</table>
</div>
<p>Here we see that individuals with heart disease are/have…</p>
<ul>
<li>Older [<code>age</code>]</li>
<li>Higher resting blood pressure [<code>trestbps</code>]</li>
<li>Higher cholesterol [<code>chol</code>]</li>
<li>Lower maximum heart rate [<code>thalach</code>]</li>
<li>Higher exercise-induced ST depression [<code>oldpeak</code>]</li>
<li>More vessels colored by fluoroscopy [<code>ca</code>]</li>
</ul>
</section>
<section id="categorical-and-boolean-counts" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="categorical-and-boolean-counts">Categorical and boolean counts</h2>
<section id="categorical-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="categorical-1">Categorical</h3>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb11-2">fig.subplots_adjust(hspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, wspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(cats):</span>
<span id="cb11-5">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-6">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, i)</span>
<span id="cb11-7">    ax.set_xticklabels(ax.get_xticklabels(), rotation<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>)</span>
<span id="cb11-8">    sns.countplot(data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_train, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> var, hue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'target'</span>, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax)</span>
<span id="cb11-9"></span>
<span id="cb11-10">plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/20/output_23_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Relationship between categorical variables and outcome.</figcaption>
</figure>
</div>
<p>Here we see that individuals with heart disease are/have…</p>
<ul>
<li>More likely to present with asymptomatic angina [<code>cp</code>]</li>
<li>Less likely to present with atypical or no angina [<code>cp</code>]</li>
<li>Less likely to present with normal resting ECG [<code>restecg</code>]</li>
<li>More likely to present with an up slope [<code>slope</code>]</li>
<li>Less likely to present with a flat slope [<code>slope</code>]</li>
<li>More likely to preset with a reversible defect [<code>thal</code>]</li>
<li>Less likely to present with a normal result on the thalium test [<code>thal</code>]</li>
</ul>
<section id="combining-sparse-classes" class="level4">
<h4 class="anchored" data-anchor-id="combining-sparse-classes">Combining sparse classes</h4>
<p>Some of the categorical feature classes are sparse. There are instances where it might also make conceptual sense to collapse them. For example, the resting ECG test [<code>restecg</code>] has values that essentially correspond with “normal” and “abnormal”. The “ST-T wave” class is relatively rare, but it behaves similar to “LV hyper”. So this is a case where it might make sense to collapse the two abnormal classes.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">df.restecg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.restecg.replace({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LV hyper'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ST-T wave'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})</span>
<span id="cb12-2">df.thal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.thal.replace({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'NA'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normal'</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fixed'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Revers.'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>})</span>
<span id="cb12-3">X_train, X_test, y_train, y_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(df, </span>
<span id="cb12-4">                                                    df.target, </span>
<span id="cb12-5">                                                    test_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, </span>
<span id="cb12-6">                                                    random_state <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb12-7">                                                    stratify <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.target)</span></code></pre></div>
<p>We’ll also re-classify the features for which we just now collapsed classes to binary, and remove them from the categorical feature list.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">bins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sex'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fbs'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exang'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thal'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'restecg'</span>]</span>
<span id="cb13-2">cats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'slope'</span>]</span></code></pre></div>
</section>
</section>
<section id="binary-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="binary-1">Binary</h3>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb14-2">fig.subplots_adjust(hspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, wspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span>
<span id="cb14-3"></span>
<span id="cb14-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, var <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(bins):</span>
<span id="cb14-5">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb14-6">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.add_subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, i)</span>
<span id="cb14-7">    sns.countplot(data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X_train, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> var, hue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'target'</span>, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax)</span>
<span id="cb14-8"></span>
<span id="cb14-9">plt.show()</span></code></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="https://tylerburleigh.com/blog/2020/03/20/output_30_0.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">Relationship between binary variables and outcome.</figcaption>
</figure>
</div>
<p>Here we see that individuals with heart disease are/have…</p>
<ul>
<li>More likely to be male [<code>sex</code>]</li>
<li>Less likely to present with fbs &lt;= 120 mg/dl [<code>fbs</code>]</li>
<li>More likely to experience exercise-induced angina [<code>exang</code>]</li>
<li>More likely to have an abnormal reading on the thalium test [<code>thal</code>]</li>
<li>Less likely to have a normal reading on the resting ECG test [<code>restecg</code>]</li>
</ul>
</section>
</section>
</section>
<section id="feature-encoding" class="level1">
<h1>Feature encoding</h1>
<p>Next, we’ll need to encode the variables. For the numeric variables [<code>nums</code>] we’ll use a StandardScaler. This will “mean center” the variable such that it has a mean of 0 and an SD of 1. Each value will then represent a stnadardized difference from the mean. For the categorical variables [<code>cats</code>], we’ll use one-hot encoding. This creates N-1 new columns for each of the values represented in a feature, and those new columns contain binary values to encode presence or absence of the feature-value.</p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StandardScaler, OneHotEncoder</span>
<span id="cb15-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.compose <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_column_transformer</span>
<span id="cb15-3">clt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_column_transformer(</span>
<span id="cb15-4">    (StandardScaler(), nums),</span>
<span id="cb15-5">    (OneHotEncoder(), cats)</span>
<span id="cb15-6">)</span>
<span id="cb15-7"></span>
<span id="cb15-8">clt.fit(X_train)</span>
<span id="cb15-9">X_train_transformed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> clt.transform(X_train)</span>
<span id="cb15-10">X_test_transformed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> clt.transform(X_test)</span></code></pre></div>
</section>
<section id="logistic-regression" class="level1">
<h1>Logistic regression</h1>
<p>Side-note: When I tried fitting a Logistic Regression model to the data before standardizing the numeric variables in the previous step, it would not converge. If it had converged, it probably would have given too much weight to those variables.</p>
<section id="fit-the-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-the-model">Fit the model</h2>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.linear_model <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LogisticRegression</span>
<span id="cb16-2">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LogisticRegression()</span>
<span id="cb16-3">lr.fit(X_train_transformed, y_train)</span></code></pre></div>
<pre><code>LogisticRegression(C=1.0, class_weight=None, dual=False, fit_intercept=True,
                   intercept_scaling=1, l1_ratio=None, max_iter=100,
                   multi_class='auto', n_jobs=None, penalty='l2',
                   random_state=None, solver='lbfgs', tol=0.0001, verbose=0,
                   warm_start=False)</code></pre>
</section>
<section id="score-the-model" class="level2">
<h2 class="anchored" data-anchor-id="score-the-model">Score the model</h2>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">lr.score(X_test_transformed, y_test)</span></code></pre></div>
<pre><code>0.7540983606557377</code></pre>
<p>75% is not terrible, but not terribly great either. Generally 80% and above is considered acceptable, though of course it depends on the application, and specific kinds of errors might be important here. We fell short of this rule of thumb but not by a huge margin.</p>
</section>
<section id="confusion-matrix" class="level2">
<h2 class="anchored" data-anchor-id="confusion-matrix">Confusion matrix</h2>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> confusion_matrix</span>
<span id="cb20-2">y_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lr.predict(X_test_transformed)</span>
<span id="cb20-3">confusion_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> confusion_matrix(y_test, y_pred)</span>
<span id="cb20-4">confusion_matrix</span></code></pre></div>
<pre><code>array([[28,  5],
       [10, 18]])</code></pre>
<p>Here we can see where the mistakes were made. We made 46 (28+18) correct predictions and 15 (10+5) incorrect predictions. 5 errors were false-positive errors and 10 were false-negative errors. Depending on how we plan to use this data, one of these types of errors might be more important than the other. For example, maybe we want to minimize false-negatives, because we don’t want to run the risk of missing a diagnosis and taking proactive measures to treat it.</p>


<!-- -->

</section>
</section>

 ]]></description>
  <category>machine-learning</category>
  <category>python</category>
  <guid>https://tylerburleigh.com/blog/2020/03/20/</guid>
  <pubDate>Fri, 20 Mar 2020 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2020/03/20/social-image.png" medium="image" type="image/png" height="138" width="144"/>
</item>
<item>
  <title>Predicting t-shirt size from height and weight</title>
  <dc:creator>Tyler Burleigh</dc:creator>
  <link>https://tylerburleigh.com/blog/2019/09/27/</link>
  <description><![CDATA[ 





<p>Today I was given a task that sounded pretty straight-forward: What t-shirt size would you send to someone if you don’t know their shirt size, but instead you know their height, weight, and gender?</p>
<p>In fact, it seemed <em>so straight-forward</em> that I was sure there must be prior art out there that I could re-use. A StackOverflow, a mathematical formula, a GitHub repo, a blog post – there had to be something! To my surprise, there wasn’t any, not that I could find anyway.</p>
<p>I guess this is a problem that hasn’t received a lot of attention. Or at least, it’s not the sort of problem that someone in the open source / open science community has tackled.</p>
<p>So I set out to build my own predictive algorithm.</p>
<section id="the-model-and-the-data" class="level1">
<h1>The model and the data</h1>
<p>First I would need to model the problem and identify data to build the model. What are the inputs and the outputs? How do the inputs map onto the outputs?</p>
<p>I knew that the only information I’d have to predict shirt sizes from was: gender, height and weight. Sometimes I’d have body mass index (BMI) instead of height and weight.</p>
<p>I also knew that I’d be sending “unisex” t-shirts. I’ve done my share of online t-shirt shopping, so it occurred to me to look at how online clothing stores solve this problem – enter the “size chart”. Okay, so now I’d found a measurement that could be used to classify shirt sizes: <strong>chest size</strong>.</p>
<p><img src="https://tylerburleigh.com/blog/2019/09/27/gildan_unisex_size_chart.png" class="margin-caption img-fluid"></p>
<p>So now I just had to find a way to get from gender, height, and weight to chest size.</p>
<p>I know from experience that there are several large public datasets that contain health and health-related measurements. One of these is the <a href="https://www.cdc.gov/nchs/nhanes">The National Health and Nutrition Examination Survey (NHANES)</a>, which is run by the CDC. I decided to poke around there and see what I could find. I found the <a href="https://wwwn.cdc.gov/nchs/nhanes/Search/default.aspx">variable search tool</a> and started keying in some of these variables: “height”, “weight”, “chest”, “bmi”, “gender”.</p>
<p>Of course they would have gender, height, weight and BMI. It would be a pretty odd health and nutrition study if they didn’t have basic demographics and measurements. But chest measurement? The context seemed a bit odd. What does chest circumference have to do with health and nutrition?</p>
<p>Maybe chest circumference is important if we’re talking about breathing? Eureka! NHANES does have chest measurements for inhalation and exhalation as part of the arthritis datasets!</p>
<p>The final piece of the puzzle was identifying a single year cohort that contained all of these measures together, because I would want the data to be at the level of individual persons. I found all of these measurements were contained in the <a href="https://wwwn.cdc.gov/nchs/nhanes/Search/DataPage.aspx?Component=Examination&amp;CycleBeginYear=2009">2009-2010 cohort</a>, so I downloaded the dataset files for that cohort.</p>
<p><img src="https://tylerburleigh.com/blog/2019/09/27/nhanes_chest.png" class="margin-caption img-fluid"></p>
<p>Now my model was complete. I would run a linear regression that predicts chest circumference from gender, height and weight (or bmi). I would train this model on the NHANES data, and I would then use the predicted chest circumference to determine shirt size.</p>
</section>
<section id="data-wrangling" class="level1">
<h1>Data wrangling</h1>
<section id="read-in-the-data" class="level2">
<h2>Read in the data</h2>
<p>Of course the data had to be in a SAS format. 🙄</p>
<p>Luckily there’s an R package for reading SAS data files.</p>
<div class="cell">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(foreign)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MASS)</span>
<span id="cb1-4"></span>
<span id="cb1-5">a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.xport</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ARX_F.XPT"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Arthritis data</span></span>
<span id="cb1-6">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.xport</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BMX_F.XPT"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Body measurements</span></span>
<span id="cb1-7">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read.xport</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DEMO_F.XPT"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Demographics</span></span></code></pre></div>
</div>
<p>These are the variables I’ll pull out from the different dataframes.</p>
<ul>
<li>SEQN - Participant ID</li>
<li>ARXCCIN - Inhale chest circumference in CM</li>
<li>BMXWT - Weight in KG</li>
<li>BMXHT - Height in CM</li>
<li>BMXBMI - Body Mass Index (BMI)</li>
<li>DMDHRGND - Gender of participant (1 = Male, 2 = Female)</li>
</ul>
<p>I’m using the inhale chest circumference because I found in some exploratory analyses (not reported here) that it has a stronger correlation to the other measurements. I guess the exhale circumference was more noisy for some reason?</p>
<div class="cell">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1">a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> SEQN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chest_in_cm =</span> ARXCCIN) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> chest_measures</span>
<span id="cb2-2">b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> SEQN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> BMXWT, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> BMXHT, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> BMXBMI) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> height_weight</span>
<span id="cb2-3">d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> SEQN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> DMDHRGND) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> gender</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Join datasets and select only the rows that have all measurements</span></span>
<span id="cb2-7">chest_measures <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(., height_weight, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(., gender, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(chest_in_cm),</span>
<span id="cb2-11">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(height_cm), </span>
<span id="cb2-12">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(weight_kg),</span>
<span id="cb2-13">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(gender), </span>
<span id="cb2-14">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(bmi)) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> df</span></code></pre></div>
</div>
</section>
</section>
<section id="correlations" class="level1">
<h1>Correlations</h1>
<p>I’ll check some basic correlations and descriptives. I see that men have larger chests than women, on average. And importantly, BMI does not correlate with chest size as well as weight.</p>
<div class="cell">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>weight_kg, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chest_in_cm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9006851</code></pre>
</div>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>height_cm, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chest_in_cm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4174028</code></pre>
</div>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bmi, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chest_in_cm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7850526</code></pre>
</div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb9-1">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(gender) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(chest_in_cm))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  gender  mean
  &lt;chr&gt;  &lt;dbl&gt;
1 F       95.1
2 M       98.0</code></pre>
</div>
</div>
</section>
<section id="model-building" class="level1">
<h1>Model building</h1>
<p>I decided to build two models because sometimes I know a person’s height and weight but not their BMI, and other times I know their BMI but not their height and weight.</p>
<p>Although I could take all of the heights and weights and convert them into BMIs, I’m guessing this could lead a loss of information. The correlation above suggests that weight is the best predictor of chest size (better than BMI), so that tells me it might be better to use height and weight when it’s available, but use BMI as a fallback when height and weight are not available.</p>
<section id="height-and-weight-model" class="level2">
<h2>Height and weight model</h2>
<p>To build a model, I’ll run a stepwise linear regression to determine the model of best fit. I’ll enter height, weight, and gender as predictors and allow interaction terms. I’ll use AIC (Akaike’s Information Criterion) for model selection, since it penalizes models with added complexity and I want a parsimonious model that doesn’t overfit the data.</p>
<p>I see that the best model includes all terms, including <code>weight*height</code> and <code>weight*gender</code> interaction terms.</p>
<div class="cell">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">select=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(chest_in_cm, height_cm, weight_kg, gender)), </span>
<span id="cb11-2">   chest_in_cm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> mod</span>
<span id="cb11-3">step.model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stepAIC</span>(mod, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"both"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scope =</span> . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start:  AIC=14857.43
chest_in_cm ~ height_cm + weight_kg + gender

                      Df Sum of Sq    RSS   AIC
+ height_cm:weight_kg  1       220 115291 14851
- height_cm            1         2 115513 14856
+ weight_kg:gender     1        89 115421 14856
&lt;none&gt;                             115510 14857
+ height_cm:gender     1         7 115503 14859
- gender               1      2052 117563 14937
- weight_kg            1    397116 512627 21725

Step:  AIC=14850.64
chest_in_cm ~ height_cm + weight_kg + gender + height_cm:weight_kg

                      Df Sum of Sq    RSS   AIC
+ weight_kg:gender     1    144.02 115147 14847
&lt;none&gt;                             115291 14851
+ height_cm:gender     1     13.37 115277 14852
- height_cm:weight_kg  1    219.87 115510 14857
- gender               1   2064.63 117355 14930

Step:  AIC=14846.88
chest_in_cm ~ height_cm + weight_kg + gender + height_cm:weight_kg + 
    weight_kg:gender

                      Df Sum of Sq    RSS   AIC
&lt;none&gt;                             115147 14847
+ height_cm:gender     1     3.499 115143 14849
- weight_kg:gender     1   144.020 115291 14851
- height_cm:weight_kg  1   274.743 115421 14856</code></pre>
</div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(step.model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = chest_in_cm ~ height_cm + weight_kg + gender + height_cm:weight_kg + 
    weight_kg:gender, data = subset(df, select = c(chest_in_cm, 
    height_cm, weight_kg, gender)))

Residuals:
     Min       1Q   Median       3Q      Max 
-21.3179  -3.2347   0.2087   3.4462  15.4911 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         41.491415   4.708485   8.812  &lt; 2e-16 ***
height_cm            0.086786   0.028263   3.071 0.002148 ** 
weight_kg            0.666925   0.055507  12.015  &lt; 2e-16 ***
genderM             -0.030639   0.599462  -0.051 0.959239    
height_cm:weight_kg -0.001087   0.000328  -3.314 0.000925 ***
weight_kg:genderM    0.016955   0.007065   2.400 0.016449 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.001 on 4604 degrees of freedom
Multiple R-squared:  0.8152,    Adjusted R-squared:  0.815 
F-statistic:  4061 on 5 and 4604 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the model for later</span></span>
<span id="cb15-2">height_weight_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> step.model</span></code></pre></div>
</div>
</section>
<section id="body-mass-index-bmi-model" class="level2">
<h2>Body Mass Index (BMI) model</h2>
<p>Now I’ll do the same with BMI and gender.</p>
<div class="cell">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb16-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">select=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(chest_in_cm, bmi, gender)), chest_in_cm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> mod</span>
<span id="cb16-2">step.model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stepAIC</span>(mod, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"both"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scope =</span> . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start:  AIC=17986.13
chest_in_cm ~ bmi + gender

             Df Sum of Sq    RSS   AIC
+ bmi:gender  1       725 227076 17973
&lt;none&gt;                    227801 17986
- gender      1     11229 239030 18206
- bmi         1    385144 612946 22547

Step:  AIC=17973.44
chest_in_cm ~ bmi + gender + bmi:gender

             Df Sum of Sq    RSS   AIC
&lt;none&gt;                    227076 17973
- bmi:gender  1    724.73 227801 17986</code></pre>
</div>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(step.model)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = chest_in_cm ~ bmi + gender + bmi:gender, data = subset(df, 
    select = c(chest_in_cm, bmi, gender)))

Residuals:
     Min       1Q   Median       3Q      Max 
-26.7682  -5.0630   0.2613   5.2463  23.2969 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 56.77733    0.66042  85.971  &lt; 2e-16 ***
bmi          1.31235    0.02203  59.573  &lt; 2e-16 ***
genderM     -0.34122    0.92789  -0.368 0.713084    
bmi:genderM  0.11906    0.03105   3.834 0.000128 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 7.021 on 4606 degrees of freedom
Multiple R-squared:  0.6355,    Adjusted R-squared:  0.6353 
F-statistic:  2677 on 3 and 4606 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the model for later</span></span>
<span id="cb20-2">bmi_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> step.model</span></code></pre></div>
</div>
</section>
</section>
<section id="predicting-chest-size-from-height-weight-bmi-and-gender" class="level1">
<h1>Predicting chest size from height, weight, BMI, and gender</h1>
<p>Now that I have the models, I can use them to generate chest size predictions.</p>
<section id="predict-chest-size-given-height-weight-and-gender" class="level2">
<h2>Predict chest size given height, weight, and gender</h2>
<p>Next we’ll take the final model selected from the above procedure and use it to predict chest circumference, in inches, given height, weight, and gender.</p>
<p>To test the model, I’ll use average values.</p>
<div class="cell">
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>weight_kg)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 82.48026</code></pre>
</div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>height_cm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 168.0299</code></pre>
</div>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bmi)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 29.12334</code></pre>
</div>
</div>
<section id="height-weight-and-gender" class="level3">
<h3>Height, weight, and gender</h3>
<div class="cell">
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb27-1">input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb27-2"></span>
<span id="cb27-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 cm = 0.393701 inches</span></span>
<span id="cb27-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(height_weight_model, input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
37.90109 </code></pre>
</div>
</div>
</section>
<section id="bmi-and-gender" class="level3">
<h3>BMI and gender</h3>
<div class="cell">
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb29-1">input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb29-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(bmi_model, input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       1 
37.33684 </code></pre>
</div>
</div>
</section>
</section>
<section id="chest-size-to-shirt-size" class="level2">
<h2>Chest size to shirt size</h2>
<p>Finally, I’ll need to take the chest size prediction and convert it to a shirt size. Remember the size chart?</p>
<p><img src="https://tylerburleigh.com/blog/2019/09/27/gildan_unisex_size_chart.png" class="margin-caption img-fluid"></p>
<p>For some reason the chart leaves out “XS” and the ranges lso don’t provide full coverage of the possible chest size values (34-36” and then 38-40”???). So I’ll extend the upper bound of each range to meet the lower bound of each size above it. This will cause the predictions to err on the size of larger sizes rather than smaller sizes, which I think is better because if a shirt is too big, at least you can still wear it!</p>
<div class="cell">
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb31-1">input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chest =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(height_weight_model,input)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb31-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shirt_size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb31-5">          chest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XS"</span>,</span>
<span id="cb31-6">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>,</span>
<span id="cb31-7">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,</span>
<span id="cb31-8">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>,</span>
<span id="cb31-9">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XL"</span>,</span>
<span id="cb31-10">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2XL"</span>,</span>
<span id="cb31-11">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3XL"</span>,</span>
<span id="cb31-12">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4XL"</span>,</span>
<span id="cb31-13">          chest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5XL"</span></span>
<span id="cb31-14">    )</span>
<span id="cb31-15">)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     chest shirt_size
1 37.90109          M</code></pre>
</div>
</div>
</section>
</section>
<section id="wrapping-it-up-in-a-function" class="level1">
<h1>Wrapping it up in a function</h1>
<p>And finally, I can put it in a function that will select the model to use for me, based on the information it’s been given.</p>
<div class="cell">
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb33-1">predict_shirt_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(height_cm, weight_kg, bmi, gender){</span>
<span id="cb33-2">  </span>
<span id="cb33-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(height_cm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(weight_kg)){</span>
<span id="cb33-4">    input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> height_cm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> weight_kg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> gender)</span>
<span id="cb33-5">    chest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(height_weight_model, input)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span>
<span id="cb33-6">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(bmi)){</span>
<span id="cb33-7">    input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> bmi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> gender)</span>
<span id="cb33-8">    chest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(bmi_model, input)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span>
<span id="cb33-9">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb33-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just in case height, weight, and BMI are all missing</span></span>
<span id="cb33-11">    chest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A value that gets ignored below</span></span>
<span id="cb33-12">  }</span>
<span id="cb33-13">  </span>
<span id="cb33-14">  shirt_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb33-15">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XS"</span>,</span>
<span id="cb33-16">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>,</span>
<span id="cb33-17">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,</span>
<span id="cb33-18">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>,</span>
<span id="cb33-19">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XL"</span>,</span>
<span id="cb33-20">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2XL"</span>,</span>
<span id="cb33-21">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3XL"</span>,</span>
<span id="cb33-22">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4XL"</span>,</span>
<span id="cb33-23">              chest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5XL"</span>,</span>
<span id="cb33-24">              </span>
<span id="cb33-25">              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Defaults in case height, weight, BMI are missing</span></span>
<span id="cb33-26">              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># but gender is not</span></span>
<span id="cb33-27">              gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,</span>
<span id="cb33-28">              gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>,</span>
<span id="cb33-29">              </span>
<span id="cb33-30">              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Last resort</span></span>
<span id="cb33-31">              <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span></span>
<span id="cb33-32">            )</span>
<span id="cb33-33">  </span>
<span id="cb33-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(shirt_size)</span>
<span id="cb33-35">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict_shirt_size</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "M"</code></pre>
</div>
</div>
<div id="quarto-navigation-envelope" class="hidden">
<p><span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1zaWRlYmFyLXRpdGxl">Tyler Burleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXItdGl0bGU=">Tyler Burleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6QWJvdXQ=">About</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2luZGV4Lmh0bWw=">/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6Q1Y=">CV</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2N2L2luZGV4Lmh0bWw=">/cv/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6QmxvZw==">Blog</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L2Jsb2cvaW5kZXguaHRtbA==">/blog/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6UmVzZWFyY2g=">Research</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6L3Jlc2VhcmNoL2luZGV4Lmh0bWw=">/research/index.html</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6aHR0cHM6Ly9mb3NzdG9kb24ub3JnL3VzZXJzL3R5bGVyYnVybGVpZ2g=">https://fosstodon.org/users/tylerburleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6aHR0cHM6Ly9ic2t5LmFwcC9wcm9maWxlL3R5bGVyYnVybGVpZ2guYnNreS5zb2NpYWw=">https://bsky.app/profile/tylerburleigh.bsky.social</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6aHR0cHM6Ly9naXRodWIuY29tL3R5bGVyYnVybGVpZ2g=">https://github.com/tylerburleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6aHR0cHM6Ly93d3cubGlua2VkaW4uY29tL2luL3R5bGVyYnVybGVpZ2g=">https://www.linkedin.com/in/tylerburleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLWludC1uYXZiYXI6bWFpbHRvOnR5bGVyYnVybGVpZ2hAZ21haWwuY29t">mailto:tylerburleigh@gmail.com</span></p>
<div class="hidden quarto-markdown-envelope-contents" data-render-id="Zm9vdGVyLWxlZnQ=">
<p><span class="faux-block"><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i></a> 2014–2025 Tyler Burleigh</span></p>
</div>
<div class="hidden quarto-markdown-envelope-contents" data-render-id="Zm9vdGVyLXJpZ2h0">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i>, <a href="https://quarto.org/">Quarto</a>, and the <a href="https://github.com/andrewheiss/ath-quarto">ath-quarto</a> theme</span></p>
</div>
</div>
<div id="quarto-meta-markdown" class="hidden">
<p><span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW1ldGF0aXRsZQ==">Predicting t-shirt size from height and weight | Tyler Burleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLXR3aXR0ZXJjYXJkdGl0bGU=">Predicting t-shirt size from height and weight | Tyler Burleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW9nY2FyZHRpdGxl">Predicting t-shirt size from height and weight | Tyler Burleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW1ldGFzaXRlbmFtZQ==">Tyler Burleigh</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLXR3aXR0ZXJjYXJkZGVzYw==">Using body measurement data from the National Health and Nutrition Examination Survey (NHANES), I created a model that predicts Gildan t-shirt sizes from height and weight.</span> <span class="hidden quarto-markdown-envelope-contents" data-render-id="cXVhcnRvLW9nY2FyZGRkZXNj">Using body measurement data from the National Health and Nutrition Examination Survey (NHANES), I created a model that predicts Gildan t-shirt sizes from height and weight.</span></p>
</div>
<!-- -->
<div class="quarto-embedded-source-code">
<div class="sourceCode" id="cb36" data-shortcodes="false" style="background: #f1f3f5;"><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb36-2"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">title:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> 'Predicting t-shirt size from height and weight'</span></span>
<span id="cb36-3"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">date:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> 2019-09-27</span></span>
<span id="cb36-4"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">description:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> "Using body measurement data from the National Health and Nutrition Examination Survey (NHANES), I created a model that predicts Gildan t-shirt sizes from height and weight."</span></span>
<span id="cb36-5"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">image:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> gildan_unisex_size_chart.png</span></span>
<span id="cb36-6"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">twitter-card:</span></span>
<span id="cb36-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  image: "gildan_unisex_size_chart.png"</span></span>
<span id="cb36-8"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">open-graph:</span></span>
<span id="cb36-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  image: "gildan_unisex_size_chart.png"</span></span>
<span id="cb36-10"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">categories:</span></span>
<span id="cb36-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  - machine-learning</span></span>
<span id="cb36-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  - R</span></span>
<span id="cb36-13"><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">freeze:</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> true</span></span>
<span id="cb36-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">---</span></span>
<span id="cb36-15"></span>
<span id="cb36-16">Today I was given a task that sounded pretty straight-forward: What t-shirt size would you send to someone if you don't know their shirt size, but instead you know their height, weight, and gender? </span>
<span id="cb36-17"></span>
<span id="cb36-18">In fact, it seemed *so straight-forward* that I was sure there must be prior art out there that I could re-use. A StackOverflow, a mathematical formula, a GitHub repo, a blog post -- there had to be something! To my surprise, there wasn't any, not that I could find anyway. </span>
<span id="cb36-19"></span>
<span id="cb36-20">I guess this is a problem that hasn't received a lot of attention. Or at least, it's not the sort of problem that someone in the open source / open science community has tackled.</span>
<span id="cb36-21"></span>
<span id="cb36-22">So I set out to build my own predictive algorithm. </span>
<span id="cb36-23"></span>
<span id="cb36-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># The model and the data</span></span>
<span id="cb36-25"></span>
<span id="cb36-26">First I would need to model the problem and identify data to build the model. What are the inputs and the outputs? How do the inputs map onto the outputs?</span>
<span id="cb36-27"></span>
<span id="cb36-28">I knew that the only information I'd have to predict shirt sizes from was: gender, height and weight. Sometimes I'd have body mass index (BMI) instead of height and weight.</span>
<span id="cb36-29"></span>
<span id="cb36-30">I also knew that I'd be sending "unisex" t-shirts. I've done my share of online t-shirt shopping, so it occurred to me to look at how online clothing stores solve this problem -- enter the "size chart". Okay, so now I'd found a measurement that could be used to classify shirt sizes: **chest size**.</span>
<span id="cb36-31"></span>
<span id="cb36-32"><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">![](gildan_unisex_size_chart.png)</span></span>
<span id="cb36-33"></span>
<span id="cb36-34">So now I just had to find a way to get from gender, height, and weight to chest size.</span>
<span id="cb36-35"></span>
<span id="cb36-36">I know from experience that there are several large public datasets that contain health and health-related measurements. One of these is the <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">The National Health and Nutrition Examination Survey (NHANES)</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](https://www.cdc.gov/nchs/nhanes)</span>, which is run by the CDC. I decided to poke around there and see what I could find. I found the <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">variable search tool</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](https://wwwn.cdc.gov/nchs/nhanes/Search/default.aspx)</span> and started keying in some of these variables: "height", "weight", "chest", "bmi", "gender".</span>
<span id="cb36-37"></span>
<span id="cb36-38">Of course they would have gender, height, weight and BMI. It would be a pretty odd health and nutrition study if they didn't have basic demographics and measurements. But chest measurement? The context seemed a bit odd. What does chest circumference have to do with health and nutrition?</span>
<span id="cb36-39"></span>
<span id="cb36-40">Maybe chest circumference is important if we're talking about breathing? Eureka! NHANES does have chest measurements for inhalation and exhalation as part of the arthritis datasets!</span>
<span id="cb36-41"></span>
<span id="cb36-42">The final piece of the puzzle was identifying a single year cohort that contained all of these measures together, because I would want the data to be at the level of individual persons. I found all of these measurements were contained in the <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">2009-2010 cohort</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">](https://wwwn.cdc.gov/nchs/nhanes/Search/DataPage.aspx?Component=Examination&amp;CycleBeginYear=2009)</span>, so I downloaded the dataset files for that cohort.</span>
<span id="cb36-43"></span>
<span id="cb36-44"><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">![](nhanes_chest.png)</span></span>
<span id="cb36-45"></span>
<span id="cb36-46">Now my model was complete. I would run a linear regression that predicts chest circumference from gender, height and weight (or bmi). I would train this model on the NHANES data, and I would then use the predicted chest circumference to determine shirt size.</span>
<span id="cb36-47"></span>
<span id="cb36-48"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Data wrangling</span></span>
<span id="cb36-49"></span>
<span id="cb36-50"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Read in the data</span></span>
<span id="cb36-51"></span>
<span id="cb36-52">Of course the data had to be in a SAS format. 🙄</span>
<span id="cb36-53"></span>
<span id="cb36-54">Luckily there's an R package for reading SAS data files.</span>
<span id="cb36-55"></span>
<span id="cb36-56"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{r, warning = FALSE, message = FALSE}</span></span>
<span id="cb36-57"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">library(foreign)</span></span>
<span id="cb36-58"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">library(tidyverse)</span></span>
<span id="cb36-59"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">library(MASS)</span></span>
<span id="cb36-60"></span>
<span id="cb36-61"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">a &lt;- read.xport("ARX_F.XPT") # Arthritis data</span></span>
<span id="cb36-62"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">b &lt;- read.xport("BMX_F.XPT") # Body measurements</span></span>
<span id="cb36-63"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">d &lt;- read.xport("DEMO_F.XPT") # Demographics</span></span>
<span id="cb36-64"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-65"></span>
<span id="cb36-66">These are the variables I'll pull out from the different dataframes.</span>
<span id="cb36-67"></span>
<span id="cb36-68"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>SEQN - Participant ID</span>
<span id="cb36-69"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>ARXCCIN - Inhale chest circumference in CM</span>
<span id="cb36-70"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>BMXWT - Weight in KG</span>
<span id="cb36-71"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>BMXHT - Height in CM</span>
<span id="cb36-72"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>BMXBMI - Body Mass Index (BMI)</span>
<span id="cb36-73"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">- </span>DMDHRGND - Gender of participant (1 = Male, 2 = Female)</span>
<span id="cb36-74"></span>
<span id="cb36-75">I'm using the inhale chest circumference because I found in some exploratory analyses (not reported here) that it has a stronger correlation to the other measurements. I guess the exhale circumference was more noisy for some reason?</span>
<span id="cb36-76"></span>
<span id="cb36-77">quarto-executable-code-5450563D</span>
<span id="cb36-78"></span>
<span id="cb36-79"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-80">a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> SEQN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chest_in_cm =</span> ARXCCIN) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> chest_measures</span>
<span id="cb36-81">b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> SEQN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> BMXWT, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> BMXHT, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> BMXBMI) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> height_weight</span>
<span id="cb36-82">d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> SEQN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> DMDHRGND) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-83">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> gender</span>
<span id="cb36-84"></span>
<span id="cb36-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Join datasets and select only the rows that have all measurements</span></span>
<span id="cb36-86">chest_measures <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-87">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(., height_weight, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-88">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(., gender, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-89">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(chest_in_cm),</span>
<span id="cb36-90">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(height_cm), </span>
<span id="cb36-91">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(weight_kg),</span>
<span id="cb36-92">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(gender), </span>
<span id="cb36-93">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(bmi)) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> df</span>
<span id="cb36-94"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-95"></span>
<span id="cb36-96"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Correlations</span></span>
<span id="cb36-97"></span>
<span id="cb36-98">I'll check some basic correlations and descriptives. I see that men have larger chests than women, on average. And importantly, BMI does not correlate with chest size as well as weight.</span>
<span id="cb36-99"></span>
<span id="cb36-100">quarto-executable-code-5450563D</span>
<span id="cb36-101"></span>
<span id="cb36-102"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-103"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>weight_kg, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chest_in_cm)</span>
<span id="cb36-104"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>height_cm, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chest_in_cm)</span>
<span id="cb36-105"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bmi, df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>chest_in_cm)</span>
<span id="cb36-106"></span>
<span id="cb36-107">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-108">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(gender) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-109">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(chest_in_cm))</span>
<span id="cb36-110"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-111"></span>
<span id="cb36-112"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Model building</span></span>
<span id="cb36-113"></span>
<span id="cb36-114">I decided to build two models because sometimes I know a person's height and weight but not their BMI, and other times I know their BMI but not their height and weight. </span>
<span id="cb36-115"></span>
<span id="cb36-116">Although I could take all of the heights and weights and convert them into BMIs, I'm guessing this could lead a loss of information. The correlation above suggests that weight is the best predictor of chest size (better than BMI), so that tells me it might be better to use height and weight when it's available, but use BMI as a fallback when height and weight are not available.</span>
<span id="cb36-117"></span>
<span id="cb36-118"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Height and weight model</span></span>
<span id="cb36-119"></span>
<span id="cb36-120">To build a model, I'll run a stepwise linear regression to determine the model of best fit. I'll enter height, weight, and gender as predictors and allow interaction terms. I'll use AIC (Akaike's Information Criterion) for model selection, since it penalizes models with added complexity and I want a parsimonious model that doesn't overfit the data. </span>
<span id="cb36-121"></span>
<span id="cb36-122">I see that the best model includes all terms, including <span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">`weight*height`</span> and <span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">`weight*gender`</span> interaction terms.</span>
<span id="cb36-123"></span>
<span id="cb36-124">quarto-executable-code-5450563D</span>
<span id="cb36-125"></span>
<span id="cb36-126"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-127"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">select=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(chest_in_cm, height_cm, weight_kg, gender)), </span>
<span id="cb36-128">   chest_in_cm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> mod</span>
<span id="cb36-129">step.model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stepAIC</span>(mod, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"both"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scope =</span> . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb36-130"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(step.model)</span>
<span id="cb36-131"></span>
<span id="cb36-132"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the model for later</span></span>
<span id="cb36-133">height_weight_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> step.model</span>
<span id="cb36-134"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-135"></span>
<span id="cb36-136"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Body Mass Index (BMI) model</span></span>
<span id="cb36-137"></span>
<span id="cb36-138">Now I'll do the same with BMI and gender.</span>
<span id="cb36-139"></span>
<span id="cb36-140">quarto-executable-code-5450563D</span>
<span id="cb36-141"></span>
<span id="cb36-142"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-143"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">select=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(chest_in_cm, bmi, gender)), chest_in_cm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> mod</span>
<span id="cb36-144">step.model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stepAIC</span>(mod, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">direction =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"both"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scope =</span> . <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb36-145"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(step.model)</span>
<span id="cb36-146"></span>
<span id="cb36-147"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the model for later</span></span>
<span id="cb36-148">bmi_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> step.model</span>
<span id="cb36-149"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-150"></span>
<span id="cb36-151"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Predicting chest size from height, weight, BMI, and gender</span></span>
<span id="cb36-152"></span>
<span id="cb36-153">Now that I have the models, I can use them to generate chest size predictions.</span>
<span id="cb36-154"></span>
<span id="cb36-155"></span>
<span id="cb36-156"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Predict chest size given height, weight, and gender</span></span>
<span id="cb36-157"></span>
<span id="cb36-158">Next we'll take the final model selected from the above procedure and use it to predict chest circumference, in inches, given height, weight, and gender.</span>
<span id="cb36-159"></span>
<span id="cb36-160">To test the model, I'll use average values.</span>
<span id="cb36-161"></span>
<span id="cb36-162">quarto-executable-code-5450563D</span>
<span id="cb36-163"></span>
<span id="cb36-164"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-165"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>weight_kg)</span>
<span id="cb36-166"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>height_cm)</span>
<span id="cb36-167"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>bmi)</span>
<span id="cb36-168"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-169"></span>
<span id="cb36-170"></span>
<span id="cb36-171"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### Height, weight, and gender</span></span>
<span id="cb36-172"></span>
<span id="cb36-173">quarto-executable-code-5450563D</span>
<span id="cb36-174"></span>
<span id="cb36-175"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-176">input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb36-177"></span>
<span id="cb36-178"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1 cm = 0.393701 inches</span></span>
<span id="cb36-179"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(height_weight_model, input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span>
<span id="cb36-180"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-181"></span>
<span id="cb36-182"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">### BMI and gender</span></span>
<span id="cb36-183"></span>
<span id="cb36-184">quarto-executable-code-5450563D</span>
<span id="cb36-185"></span>
<span id="cb36-186"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-187">input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb36-188"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(bmi_model, input) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span>
<span id="cb36-189"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-190"></span>
<span id="cb36-191"></span>
<span id="cb36-192"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">## Chest size to shirt size</span></span>
<span id="cb36-193"></span>
<span id="cb36-194">Finally, I'll need to take the chest size prediction and convert it to a shirt size. Remember the size chart? </span>
<span id="cb36-195"></span>
<span id="cb36-196"><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">![](gildan_unisex_size_chart.png)</span></span>
<span id="cb36-197"></span>
<span id="cb36-198">For some reason the chart leaves out "XS" and the ranges lso don't provide full coverage of the possible chest size values (34-36" and then 38-40"???). So I'll extend the upper bound of each range to meet the lower bound of each size above it. This will cause the predictions to err on the size of larger sizes rather than smaller sizes, which I think is better because if a shirt is too big, at least you can still wear it!</span>
<span id="cb36-199"></span>
<span id="cb36-200">quarto-executable-code-5450563D</span>
<span id="cb36-201"></span>
<span id="cb36-202"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-203">input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb36-204"></span>
<span id="cb36-205"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chest =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(height_weight_model,input)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb36-206">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shirt_size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb36-207">          chest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XS"</span>,</span>
<span id="cb36-208">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>,</span>
<span id="cb36-209">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,</span>
<span id="cb36-210">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>,</span>
<span id="cb36-211">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XL"</span>,</span>
<span id="cb36-212">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2XL"</span>,</span>
<span id="cb36-213">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3XL"</span>,</span>
<span id="cb36-214">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4XL"</span>,</span>
<span id="cb36-215">          chest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5XL"</span></span>
<span id="cb36-216">    )</span>
<span id="cb36-217">)</span>
<span id="cb36-218"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-219"></span>
<span id="cb36-220"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;"># Wrapping it up in a function</span></span>
<span id="cb36-221"></span>
<span id="cb36-222">And finally, I can put it in a function that will select the model to use for me, based on the information it's been given.</span>
<span id="cb36-223"></span>
<span id="cb36-224">quarto-executable-code-5450563D</span>
<span id="cb36-225"></span>
<span id="cb36-226"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-227">predict_shirt_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(height_cm, weight_kg, bmi, gender){</span>
<span id="cb36-228">  </span>
<span id="cb36-229">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(height_cm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(weight_kg)){</span>
<span id="cb36-230">    input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> height_cm, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> weight_kg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> gender)</span>
<span id="cb36-231">    chest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(height_weight_model, input)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span>
<span id="cb36-232">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(bmi)){</span>
<span id="cb36-233">    input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bmi =</span> bmi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> gender)</span>
<span id="cb36-234">    chest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(bmi_model, input)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.393701</span></span>
<span id="cb36-235">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> {</span>
<span id="cb36-236">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just in case height, weight, and BMI are all missing</span></span>
<span id="cb36-237">    chest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A value that gets ignored below</span></span>
<span id="cb36-238">  }</span>
<span id="cb36-239">  </span>
<span id="cb36-240">  shirt_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb36-241">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XS"</span>,</span>
<span id="cb36-242">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>,</span>
<span id="cb36-243">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,</span>
<span id="cb36-244">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>,</span>
<span id="cb36-245">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">44</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XL"</span>,</span>
<span id="cb36-246">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2XL"</span>,</span>
<span id="cb36-247">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3XL"</span>,</span>
<span id="cb36-248">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(chest, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">56</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4XL"</span>,</span>
<span id="cb36-249">              chest <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5XL"</span>,</span>
<span id="cb36-250">              </span>
<span id="cb36-251">              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Defaults in case height, weight, BMI are missing</span></span>
<span id="cb36-252">              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># but gender is not</span></span>
<span id="cb36-253">              gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,</span>
<span id="cb36-254">              gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>,</span>
<span id="cb36-255">              </span>
<span id="cb36-256">              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Last resort</span></span>
<span id="cb36-257">              <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span></span>
<span id="cb36-258">            )</span>
<span id="cb36-259">  </span>
<span id="cb36-260">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(shirt_size)</span>
<span id="cb36-261">}</span>
<span id="cb36-262"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-263"></span>
<span id="cb36-264">quarto-executable-code-5450563D</span>
<span id="cb36-265"></span>
<span id="cb36-266"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```r</span></span>
<span id="cb36-267"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict_shirt_size</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height_cm =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">168</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weight_kg =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">83</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb36-268"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span>
<span id="cb36-269"></span>
<span id="cb36-270"></span></code></pre></div>
</div>
</section>

 ]]></description>
  <category>machine-learning</category>
  <category>R</category>
  <guid>https://tylerburleigh.com/blog/2019/09/27/</guid>
  <pubDate>Fri, 27 Sep 2019 04:00:00 GMT</pubDate>
  <media:content url="https://tylerburleigh.com/blog/2019/09/27/gildan_unisex_size_chart.png" medium="image" type="image/png" height="102" width="144"/>
</item>
</channel>
</rss>
